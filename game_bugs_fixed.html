<!DOCTYPE html>

<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Print &amp; Profit – 3D Print Tycoon v17.6.4</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow+Condensed:wght@300;500;700;900&display=swap');

:root {
  --grid-bg: repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px), repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px);
  --bg:         #0d0f14;
  --bg2:        #13161e;
  --bg3:        #1a1e2a;
  --panel:      #161b26;
  --border:     #2a3045;
  --accent:     #00e5ff;
  --accent2:    #ff6b35;
  --accent3:    #7fff6e;
  --warn:       #ffcc00;
  --danger:     #ff3d5a;
  --pro:        #a78bfa;
  --pro-dark:   #7c3aed;
  --pro-glow:   rgba(167,139,250,0.25);
  --text:       #d4dae8;
  --text-dim:   #5a6480;
  --text-bright:#ffffff;
  --pla:        #4fc3f7;
  --petg:       #ce93d8;
  --pa6:        #ffab40;
  --radius:     6px;
  --mono:       'Space Mono', monospace;
  --display:    'Barlow Condensed', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  min-height: 100vh;
  overflow-x: hidden;
  background-image:
    radial-gradient(ellipse 80% 40% at 50% -10%, rgba(0,229,255,0.06) 0%, transparent 70%),
    repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px),
    repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px);
}

/* ── TOP BAR ── */
#topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px; height: 56px;
  background: var(--panel); border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100; gap: 12px; flex-wrap: wrap;
}
.logo {
  font-family: var(--display); font-weight: 900; font-size: 22px;
  letter-spacing: 2px; color: var(--accent); text-transform: uppercase;
  white-space: nowrap; text-shadow: 0 0 20px rgba(0,229,255,0.4);
}
.logo span { color: var(--accent2); }
.stat-pill {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 20px; padding: 5px 14px;
  font-family: var(--display); font-weight: 700; font-size: 16px;
}
.stat-pill .label { color: var(--text-dim); font-size: 10px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; }
#money-val { color: var(--accent3); }
#rep-val   { color: var(--warn); }
#level-val { color: var(--accent); }
.topbar-right { display: flex; gap: 8px; align-items: center; }

/* PRO BUTTON */
.btn-pro {
  background: linear-gradient(135deg, var(--pro-dark), var(--pro));
  color: white;
  border: none; border-radius: var(--radius);
  padding: 7px 14px; cursor: pointer;
  font-family: var(--mono); font-size: 11px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  box-shadow: 0 0 20px var(--pro-glow);
  transition: all 0.2s;
}
.btn-pro:hover { box-shadow: 0 0 30px rgba(167,139,250,0.5); transform: translateY(-1px); }
.btn-pro.owned { background: linear-gradient(135deg,#2d1b69,#4c1d95); color: var(--pro); cursor: default; }

/* SOUND TOGGLE */
.sound-btn {
  width: 34px; height: 34px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; transition: all 0.15s;
}
.sound-btn:hover { border-color: var(--accent); }
.sound-btn.muted { opacity: 0.4; }

/* ── SPEED CONTROL ── */
.speed-control {
  display: flex; align-items: center; gap: 2px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden;
}
.speed-btn {
  padding: 5px 9px; background: transparent; border: none;
  color: var(--text-dim); cursor: pointer;
  font-family: var(--mono); font-size: 10px; font-weight: 700;
  letter-spacing: 0.5px; transition: all 0.12s;
}
.speed-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.speed-btn.active { background: var(--accent); color: var(--bg); }
.speed-btn.active.fast { background: var(--warn); color: var(--bg); }
.speed-btn.active.turbo { background: var(--danger); color: white; }

/* ── BANKRUPTCY WARNING BANNER ── */
#bankruptcy-banner {
  display: none; position: fixed; bottom: 0; left: 0; right: 0;
  z-index: 800; padding: 10px 20px;
  background: linear-gradient(90deg, rgba(255,61,90,0.92), rgba(180,20,50,0.92));
  backdrop-filter: blur(4px);
  color: white; text-align: center;
  animation: bankBannerPulse 1.2s ease-in-out infinite;
  font-family: var(--display); font-weight: 700; font-size: 14px;
  letter-spacing: 1px; text-transform: uppercase;
  border-top: 2px solid var(--danger);
}
#bankruptcy-banner.visible { display: block; }
@keyframes bankBannerPulse {
  0%,100% { box-shadow: 0 -4px 30px rgba(255,61,90,0.4); }
  50%      { box-shadow: 0 -4px 50px rgba(255,61,90,0.9); }
}
#bankruptcy-banner span { color: var(--warn); font-size: 16px; }

/* ── GAME OVER OVERLAY ── */
#gameover-overlay {
  position: fixed; inset: 0; z-index: 1200;
  background: rgba(13,15,20,0.95); backdrop-filter: blur(12px);
  display: none; flex-direction: column;
  align-items: center; justify-content: center; gap: 20px;
}
#gameover-overlay.visible { display: flex; }
.gameover-title {
  font-family: var(--display); font-weight: 900; font-size: 64px;
  color: var(--danger); letter-spacing: 8px; text-transform: uppercase;
  text-shadow: 0 0 60px rgba(255,61,90,0.8), 0 0 120px rgba(255,61,90,0.4);
  animation: gameoverGlitch 3s steps(1) infinite;
}
@keyframes gameoverGlitch {
  0%,90%,100% { transform: translate(0); filter: none; }
  91% { transform: translate(-3px,1px); filter: hue-rotate(60deg); }
  93% { transform: translate(3px,-1px); filter: hue-rotate(-40deg); }
  95% { transform: translate(-2px,2px); filter: none; }
}
.gameover-amount {
  font-family: var(--display); font-weight: 900; font-size: 38px;
  color: white; letter-spacing: 2px;
}
.gameover-sub {
  color: var(--text-dim); font-size: 12px; letter-spacing: 2px;
  text-transform: uppercase; text-align: center; line-height: 1.8;
  max-width: 380px;
}
.gameover-stats {
  display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;
}
.gameover-stat {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 18px; text-align: center;
}
.gameover-stat-label { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; }
.gameover-stat-value { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--text-bright); margin-top: 2px; }
.gameover-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
.pause-btn {
  width: 40px; height: 40px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; transition: all 0.15s;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}
.pause-btn:hover { border-color: var(--warn); }
.pause-btn.paused {
  background: rgba(255,204,0,0.15); border-color: var(--warn);
  animation: pausePulse 1.8s ease-in-out infinite;
}
@keyframes pausePulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(255,204,0,0.4); }
  50%      { box-shadow: 0 0 0 6px rgba(255,204,0,0); }
}

/* Idle countdown ring op de pauzeknop */
.pause-btn .idle-ring {
  position: absolute; inset: -3px;
  border-radius: inherit;
  pointer-events: none;
}
.pause-btn .idle-ring circle {
  fill: none;
  stroke: var(--warn);
  stroke-width: 2.5;
  stroke-linecap: round;
  stroke-dasharray: 138; /* ≈ omtrek van 40px vierkant met radius 8 */
  stroke-dashoffset: 138;
  transform-origin: center;
  transform: rotate(-90deg);
  transition: stroke-dashoffset 1s linear, opacity 0.3s;
  opacity: 0;
}
.pause-btn.idle-counting .idle-ring circle {
  opacity: 1;
}

/* ── PAUSE OVERLAY ── */
#pause-overlay {
  position: fixed; inset: 0; z-index: 999;
  background: rgba(13,15,20,0.82); backdrop-filter: blur(6px);
  display: none; flex-direction: column;
  align-items: center; justify-content: center; gap: 16px;
  pointer-events: none;
}
#pause-overlay.visible { 
  display: flex; 
  pointer-events: all; 
  cursor: pointer;   /* maakt het duidelijk tappable */
}

.pause-overlay-title {
  font-family: var(--display);
  font-weight: 900;
  font-size: clamp(28px, 8vw, 48px); /* responsive */
  color: var(--warn);
  letter-spacing: 4px;
  text-transform: uppercase;
  text-align: center;
  text-shadow: 0 0 30px rgba(255,204,0,0.6);
  animation: pauseTitlePulse 2s ease-in-out infinite;
}
@keyframes pauseTitlePulse {
  0%,100% { opacity: 1; } 50% { opacity: 0.6; }
}
.pause-overlay-sub {
  font-size: 12px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase;
}
.pause-overlay-saved {
  font-size: 10px; color: var(--accent3); letter-spacing: 1px;
  opacity: 0; transition: opacity 0.4s;
}
.pause-overlay-saved.show { opacity: 1; }

/* ── MAIN LAYOUT ── */
#main{
  display:flex;
  flex-direction:column;
  gap: 12px;
  padding: 12px;
  margin: 0;
  min-height: calc(100vh - 56px);
}

/* ── PANELS ── */
.panel { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column; }
.panel-header {
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  font-family: var(--display); font-weight: 700; font-size: 14px;
  letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim);
  display: flex; align-items: center; gap: 8px;
}
.panel-header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); }
.panel-body { padding: 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

/* ── TABS ── */
.tab-row { display: flex; gap: 4px; padding: 8px 12px 0; }
.tab {
  padding: 5px 12px; border-radius: 4px 4px 0 0; cursor: pointer;
  font-family: var(--display); font-size: 12px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase; color: var(--text);
  border: 1px solid transparent; border-bottom: none; transition: all 0.15s;
}
.tab.active { color: var(--text-bright); background: var(--bg3); border-color: var(--border); }
.tab-content { display: none; flex-direction: column; gap: 10px; }
.tab-content.active { display: flex; }

/* ── PANEL TABS (left panel) ── */
.ptab-row { display: flex; border-bottom: 1px solid var(--border); }
.ptab {
  flex: 1; padding: 8px 0; text-align: center; cursor: pointer;
  font-family: var(--display); font-weight: 700; font-size: 12px;
  letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim);
  border-bottom: 2px solid transparent; transition: all 0.15s;
}
.ptab.active { color: var(--accent); border-bottom-color: var(--accent); }
.ptab .badge {
  display: inline-block; background: var(--danger); color: white;
  border-radius: 50%; width: 15px; height: 15px; line-height: 15px;
  text-align: center; font-size: 9px; margin-left: 4px; vertical-align: middle;
}
.ptab .cbadge {
  display: inline-block; background: var(--warn); color: var(--bg);
  border-radius: 50%; width: 15px; height: 15px; line-height: 15px;
  text-align: center; font-size: 9px; margin-left: 4px; vertical-align: middle;
}
.ptab-body { display: none; flex: 1; overflow-y: auto; padding: 10px; flex-direction: column; gap: 8px; }
.ptab-body.active { display: flex; }

/* ── PRINTER CARDS ── */
.printer-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px; position: relative;
  transition: border-color 0.3s;
}
.printer-card.active { border-color: var(--accent); }
.printer-card.error  { border-color: var(--danger); }
.printer-name {
  font-family: var(--display); font-weight: 700; font-size: 15px; letter-spacing: 1px;
  margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;
}
.printer-status {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
  padding: 2px 8px; border-radius: 10px;
}
.status-idle     { background: rgba(90,100,128,0.2); color: var(--text-dim); }
.status-printing { background: rgba(0,229,255,0.1);  color: var(--accent); }
.status-error    { background: rgba(255,61,90,0.15); color: var(--danger); }

.progress-wrap { margin: 8px 0 4px; }
.progress-label { display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--text-dim); font-size: 10px; }
.progress-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; }
.progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 3px; transition: width 0.5s linear; position: relative;
  will-change: width;
}
.progress-fill::after {
  content: ''; position: absolute; right: 0; top: 0; width: 4px; height: 100%;
  background: white; opacity: 0.7; border-radius: 2px; box-shadow: 0 0 6px white;
}

.printer-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; }
.pstat { background: var(--bg); border-radius: 4px; padding: 6px 8px; }
.pstat-label { color: var(--text-dim); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
.pstat-value { font-family: var(--display); font-weight: 700; font-size: 15px; color: var(--text-bright); }
.health-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; margin-top: 6px; }
.health-fill { height: 100%; border-radius: 2px; transition: width 0.5s, background 0.5s; will-change: width; }

/* ── ORDER CARDS ── */
.order-card {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px; cursor: pointer; transition: border-color 0.2s, transform 0.15s;
  position: relative; overflow: hidden;
}
.order-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.order-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
.order-pla::before   { background: var(--pla); }
.order-petg::before  { background: var(--petg); }
.order-pa6::before   { background: var(--pa6); }
.order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
.order-name   { font-family: var(--display); font-weight: 700; font-size: 13px; letter-spacing: 0.5px; }
.order-reward { font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--accent3); }
.order-meta   { display: flex; gap: 8px; flex-wrap: wrap; }
.tag { font-size: 11px; letter-spacing: 1px; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; }
.tag-pla   { background: rgba(79,195,247,0.15);  color: var(--pla);  }
.tag-petg  { background: rgba(206,147,216,0.15); color: var(--petg); }
.tag-pa6   { background: rgba(255,171,64,0.15);  color: var(--pa6);  }
.tag-time  { background: rgba(255,204,0,0.1);    color: var(--warn); }
.tag-diff  { background: rgba(255,61,90,0.1);    color: var(--danger); }
.order-timer      { height: 2px; background: var(--bg); margin-top: 8px; border-radius: 1px; overflow: hidden; }
.order-timer-fill { height: 100%; background: var(--warn); border-radius: 1px; transition: width 1s linear; }
.no-orders { text-align: center; color: var(--text-dim); padding: 30px 0; font-size: 11px; line-height: 1.8; }

/* ── CONTRACT CARDS ── */
.contract-card {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px; position: relative; overflow: hidden;
  transition: border-color 0.2s;
}
.contract-card.daily  { border-color: rgba(255,204,0,0.4); }
.contract-card.active-c { border-color: var(--accent3); }
.contract-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--warn);
}
.contract-card.regular::before { background: var(--accent2); }
.contract-card.completed-c { opacity: 0.5; pointer-events: none; }
.contract-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
.contract-name { font-family: var(--display); font-weight: 700; font-size: 13px; }
.contract-reward { font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--warn); }
.contract-daily-badge {
  font-size: 9px; letter-spacing: 1px; text-transform: uppercase;
  padding: 2px 6px; border-radius: 3px;
  background: rgba(255,204,0,0.15); color: var(--warn);
  margin-left: 6px;
}
.contract-req { margin: 6px 0; }
.contract-req-item {
  display: flex; align-items: center; gap: 8px; font-size: 10px; margin-bottom: 4px;
}
.contract-req-bar { flex: 1; height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.contract-req-fill { height: 100%; border-radius: 2px; transition: width 0.5s; background: var(--accent3); }
.contract-req-label { color: var(--text-dim); white-space: nowrap; }
.contract-actions { display: flex; gap: 6px; margin-top: 8px; }
.contract-timer { font-size: 10px; color: var(--warn); margin-top: 4px; }

/* ── CENTER ── */
#center-panel { display: flex; flex-direction: column; gap: 12px; }
.job-display { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; flex: 1; display: flex; flex-direction: column; gap: 12px; }
.job-title { font-family: var(--display); font-weight: 900; font-size: 28px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-bright); }
.job-subtitle { color: var(--text-dim); font-size: 11px; letter-spacing: 1px; }

/* printer visual */
/* ══════════════════════════════════════════════════════════
   v15: RICH PRODUCT PROGRESS VISUALIZATION
   ══════════════════════════════════════════════════════════ */

/* ── MAIN PRINT STAGE ── */
.print-stage {
  position: relative; width: 100%;
  background: var(--bg3); border-radius: 12px;
  border: 1px solid var(--border); overflow: hidden;
  transition: border-color 0.3s;
}
.print-stage.printing { border-color: rgba(0,229,255,0.3); }
.print-stage.success-flash { border-color: rgba(127,255,110,0.6); box-shadow:0 0 24px rgba(127,255,110,0.15); }
.print-stage.fail-flash { border-color: rgba(255,61,90,0.65); box-shadow:0 0 26px rgba(255,61,90,0.18); }

@keyframes stagePop {
  0%   { transform: scale(1); }
  35%  { transform: scale(1.015); }
  100% { transform: scale(1); }
}
.print-stage.stage-pop { animation: stagePop 520ms cubic-bezier(0.2,0.9,0.2,1); }

@keyframes stageFailPulse {
  0%   { transform: scale(1); filter:saturate(1); }
  20%  { transform: scale(0.992); filter:saturate(1.35); }
  45%  { transform: scale(1.01); filter:saturate(1.15); }
  100% { transform: scale(1); filter:saturate(1); }
}
.print-stage.stage-fail { animation: stageFailPulse 520ms ease-out; }

/* ── STAGE HEADER (job name + status) ── */
.stage-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px 0; gap: 8px;
}
.stage-job-name {
  font-family: var(--display); font-weight: 900; font-size: 15px;
  color: var(--text-bright); letter-spacing: 0.5px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex:1;
}
.stage-status-badge {
  font-size: 9px; letter-spacing: 2px; text-transform: uppercase;
  padding: 3px 8px; border-radius: 20px;
  background: rgba(0,229,255,0.12); color: var(--accent); border: 1px solid rgba(0,229,255,0.25);
  white-space: nowrap; flex-shrink:0;
}
.stage-status-badge.idle    { background:rgba(100,100,100,0.12); color:var(--text-dim); border-color:rgba(100,100,100,0.2); }
.stage-status-badge.configuring { background:rgba(255,204,0,0.12); color:var(--warn); border-color:rgba(255,204,0,0.3); }
.stage-status-badge.done    { background:rgba(127,255,110,0.12); color:var(--accent3); border-color:rgba(127,255,110,0.3); }

/* ── 3D PRODUCT CANVAS AREA ── */
.product-canvas-wrap {
  position: relative; width: 100%; height: 240px;
  display: flex; align-items: flex-end; justify-content: center;
  padding: 0 0 8px;
}
.product-canvas-wrap canvas { position:absolute; inset:0; width:100%; height:100%; }

/* ── TELEMETRY STRIP ── */
.telem-strip {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 1px; background: var(--border);
  border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
}
.telem-cell {
  background: var(--bg3); padding: 8px 10px;
  display: flex; flex-direction: column; gap: 2px;
}
.telem-label { font-size: 10px; letter-spacing: 1.5px; text-transform:uppercase; color: var(--text-dim); }
.telem-value { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--text-bright); line-height:1; }
.telem-value.hot   { color: #ff6b35; text-shadow: 0 0 8px rgba(255,107,53,0.5); }
.telem-value.cool  { color: var(--accent); text-shadow: 0 0 8px rgba(0,229,255,0.3); }
.telem-value.ok    { color: var(--accent3); }
.telem-sub  { font-size: 10px; color: var(--text-dim); }

/* ── ARC PROGRESS ── */
.arc-progress-wrap {
  padding: 10px 14px; display: flex; align-items: center; gap: 14px;
}
.arc-svg { flex-shrink:0; width:64px; height:64px; }
.arc-info { flex:1; min-width:0; }
.arc-pct { font-family:var(--display); font-weight:900; font-size:28px; color:var(--text-bright); line-height:1; }
.arc-label { font-size:11px; letter-spacing:1.5px; text-transform:uppercase; color:var(--text-dim); margin-top:3px; }
.arc-time { font-size:11px; color:var(--text); margin-top:6px; }
.arc-time strong { color:var(--accent); font-family:var(--display); }

/* ── LAYER STACK INDICATOR ── */
.layer-stack {
  padding: 0 14px 12px;
  display: flex; align-items: center; gap: 10px;
}
.layer-track {
  flex:1; height:6px; background:var(--bg); border-radius:3px;
  position:relative; overflow:hidden; border:1px solid var(--border);
}
.layer-fill {
  position:absolute; top:0; left:0; height:100%; border-radius:3px;
  background: linear-gradient(90deg, #00b4d8, var(--accent));
  transition: width 0.4s linear;
  box-shadow: 0 0 8px rgba(0,229,255,0.4);
}
.layer-count { font-family:var(--display); font-weight:700; font-size:12px; color:var(--accent); white-space:nowrap; }

/* ── OLD printer-visual (keep for legacy) ── */
.printer-visual {
  position: relative; height: 0; background: var(--bg3); border-radius: var(--radius);
  overflow: hidden; display: none; align-items: center; justify-content: center;
  border: 1px solid var(--border);
}
.print-head {
  position: absolute; top: 30px; width: 40px; height: 8px;
  background: var(--accent); border-radius: 2px;
  box-shadow: 0 0 12px var(--accent), 0 0 4px white;
  transition: left 0.5s ease-in-out;
}
.print-layer {
  position: absolute; bottom: 30px; left: 20px; right: 20px; height: 0;
  background: linear-gradient(0deg, var(--accent2), var(--accent));
  border-radius: 2px; transition: height 0.5s linear; opacity: 0.7;
}
.scan-line { display:none; }
.nozzle-dot { display:none; }

/* job stats */
.job-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.jstat { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; text-align: center; }
.jstat-label { color: var(--text-dim); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.jstat-value { font-family: var(--display); font-weight: 700; font-size: 20px; color: var(--text-bright); }

/* big progress (now hidden, replaced by arc) */
.big-progress-bar { display:none; }
.big-progress-fill { height: 100%; background: linear-gradient(90deg,#00b4d8,var(--accent),#00e5ff); background-size: 200%; animation: shimmer 1.5s linear infinite; border-radius: 12px; transition: width 0.5s linear; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.big-progress-text { display:none; }

/* filament + quality */
.filament-row, .quality-row { display: flex; gap: 6px; }
.filament-btn {
  flex: 1; padding: 8px 6px; border: 1px solid var(--border); background: var(--bg3);
  border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.15s;
}
.filament-btn:hover { border-color: var(--accent); }
.filament-btn.selected-pla  { border-color: var(--pla);  background: rgba(79,195,247,0.1);  }
.filament-btn.selected-petg { border-color: var(--petg); background: rgba(206,147,216,0.1); }

.filament-btn.selected-pa6  { border-color: var(--pa6);  background: rgba(255,171,64,0.1);  }
.filament-btn.locked-fil { opacity: 0.3; cursor: not-allowed; }
.fil-name { font-family: var(--display); font-weight: 700; font-size: 13px; }
.fil-pla { color: var(--pla); } .fil-petg { color: var(--petg); } .fil-pa6 { color: var(--pa6); }
.fil-cf   { color: #9ca3af; } .fil-glow { color: #ffffff; }
.fil-stat { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.quality-btn { flex: 1; padding: 8px 6px; border: 1px solid var(--border); background: var(--bg3); border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.15s; font-family: var(--mono); font-size: 10px; }
.quality-btn:hover { border-color: var(--accent2); }
.quality-btn.selected { border-color: var(--accent2); background: rgba(255,107,53,0.1); color: var(--accent2); }
.quality-label { font-family: var(--display); font-weight: 700; font-size: 12px; }

/* printer tabs (center) */
.printer-tabs { display: flex; gap: 6px; }
.printer-tab { flex: 1; padding: 7px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-family: var(--display); font-weight: 700; font-size: 12px; letter-spacing: 1px; text-align: center; transition: all 0.15s; color: var(--text-dim); }
.printer-tab:hover { border-color: var(--accent); color: var(--text); }
.printer-tab.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.08); }
.printer-tab.active-printing { border-color: var(--accent3); color: var(--accent3); background: rgba(127,255,110,0.06); }
.tab-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
.tab-dot.printing { background: var(--accent3); box-shadow: 0 0 6px var(--accent3); animation: blink 1s infinite; }
.tab-dot.idle { background: var(--text-dim); }
.tab-dot.error { background: var(--danger); }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.3;} }

.mode-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; padding: 3px 8px; border-radius: 3px; display: inline-block; margin-bottom: 6px; }
.mode-configure { background: rgba(255,107,53,0.15); color: var(--accent2); }
.mode-monitor   { background: rgba(0,229,255,0.1);   color: var(--accent); }

/* ── SHOP ── */
.upgrade-card { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; display: flex; flex-direction: column; gap: 6px; transition: border-color 0.2s; }
.upgrade-card.affordable  { border-color: rgba(0,229,255,0.3); }
.upgrade-card.owned       { border-color: var(--accent3); opacity: 0.7; }
.upgrade-card.locked-upg  { opacity: 0.4; }
.upgrade-card.pro-locked  { border-color: rgba(167,139,250,0.4); opacity: 0.9; }
.upgrade-header { display: flex; justify-content: space-between; align-items: flex-start; }
.upgrade-name   { font-family: var(--display); font-weight: 700; font-size: 14px; letter-spacing: 0.5px; color: var(--text-bright); }
.upgrade-cost   { font-family: var(--display); font-weight: 900; font-size: 17px; color: var(--accent3); }
.upgrade-desc   { color: var(--text-dim); font-size: 10px; line-height: 1.5; }
.upgrade-effect { color: var(--accent); font-size: 10px; }
.pro-badge {
  display: inline-block; background: linear-gradient(135deg,var(--pro-dark),var(--pro));
  color: white; font-size: 9px; font-weight: 700; letter-spacing: 1px;
  padding: 2px 7px; border-radius: 10px; text-transform: uppercase;
  box-shadow: 0 0 10px var(--pro-glow);
}

/* biz level */
.biz-level { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; text-align: center; }
.biz-level-name { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--accent); letter-spacing: 2px; }
.biz-level-sub  { color: var(--text-dim); font-size: 12px; margin-top: 4px; margin-bottom: 8px; }
.biz-xp-bar  { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.biz-xp-fill { height: 100%; background: linear-gradient(90deg,var(--accent2),var(--warn)); border-radius: 4px; transition: width 0.5s; }

/* ── GRAPH / STATS ── */
.graph-container { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; }
.graph-label { font-family: var(--display); font-weight: 700; font-size: 13px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; }
#income-canvas { display: block; width: 100%; border-radius: 4px; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.stat-box { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; }
.stat-box-label { color: var(--text-dim); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.stat-box-value { font-family: var(--display); font-weight: 700; font-size: 22px; color: var(--text-bright); }
.stat-box-sub   { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

/* ── LOG ── */
.log-entry { font-size: 11px; padding: 4px 0; border-bottom: 1px solid rgba(42,48,69,0.5); display: flex; gap: 8px; animation: fadeIn 0.3s ease; }
.log-time   { color: var(--text-dim); white-space: nowrap; }
.log-msg.success{ color: var(--accent3); } .log-msg.error { color: var(--danger); }
.log-msg.warn   { color: var(--warn);    } .log-msg.info  { color: var(--accent); }
.log-msg.money  { color: var(--accent3); } .log-msg.contract { color: var(--warn); }
@keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }

/* ── POPUPS / MODALS ── */
#popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
#popup-overlay.visible { display: flex; }
.popup { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 24px; max-width: 380px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: popIn 0.25s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes popIn { from{transform:scale(0.8);opacity:0;}to{transform:scale(1);opacity:1;} }
.popup-title { font-family: var(--display); font-weight: 900; font-size: 22px; margin-bottom: 8px; letter-spacing: 1px; }
.popup-body  { color: var(--text); line-height: 1.6; margin-bottom: 16px; font-size: 11px; }
.popup-actions { display: flex; gap: 8px; justify-content: flex-end; }

/* PRO MODAL */
.pro-modal { border-color: var(--pro); }
.pro-modal .popup-title { color: var(--pro); }
.pro-features { list-style: none; margin: 10px 0; }
.pro-features li { padding: 5px 0; font-size: 11px; color: var(--text); }
.pro-features li::before { content: '⚡ '; color: var(--pro); }
.pro-price { font-family: var(--display); font-weight: 900; font-size: 32px; color: var(--pro); text-align: center; margin: 12px 0 4px; }
.pro-price-sub { text-align: center; color: var(--text-dim); font-size: 10px; letter-spacing: 1px; }

/* ── ACHIEVEMENT TOAST ── */
.achievement-toast {
  position: fixed; bottom: 20px; right: 20px;
  background: var(--panel); border: 1px solid var(--accent3); border-radius: var(--radius);
  padding: 12px 16px; z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(127,255,110,0.2);
  animation: toastIn 0.4s cubic-bezier(0.34,1.56,0.64,1); max-width: 280px;
}
@keyframes toastIn { from{transform:translateX(100px);opacity:0;}to{transform:translateX(0);opacity:1;} }
.achievement-toast .ach-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent3); margin-bottom: 4px; }
.achievement-toast .ach-name  { font-family: var(--display); font-weight: 700; font-size: 15px; color: var(--text-bright); }
.achievement-toast .ach-desc  { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

/* CONTRACT TOAST */
.contract-toast {
  position: fixed; bottom: 20px; left: 20px;
  background: var(--panel); border: 1px solid var(--warn); border-radius: var(--radius);
  padding: 12px 16px; z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(255,204,0,0.2);
  animation: toastInLeft 0.4s cubic-bezier(0.34,1.56,0.64,1); max-width: 280px;
}
@keyframes toastInLeft { from{transform:translateX(-100px);opacity:0;}to{transform:translateX(0);opacity:1;} }

/* ── BUTTONS ── */
.btn { padding: 8px 14px; border: none; border-radius: var(--radius); cursor: pointer; font-family: var(--mono); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; transition: all 0.15s; }
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: var(--bg); box-shadow: 0 0 16px rgba(0,229,255,0.3); }
.btn-primary:hover { background: #33ecff; box-shadow: 0 0 24px rgba(0,229,255,0.5); }
.btn-primary:disabled { background: var(--bg3); color: rgba(212,218,232,0.45); cursor: not-allowed; box-shadow: none; border: 1px solid rgba(255,255,255,0.06); }
.btn-danger { background: var(--danger); color: white; }
.btn-warn   { background: var(--warn);   color: var(--bg); }
.btn-ghost  { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
.btn-ghost:hover { color: var(--text-bright); border-color: var(--text-dim); }
.btn-sm   { padding: 5px 10px; font-size: 10px; }
.btn-full { width: 100%; text-align: center; }

/* ── FAILURE ANIMATION ── */
#fail-flash { position: fixed; inset: 0; background: rgba(255,30,60,0); pointer-events: none; z-index: 500; }
#fail-flash.flashing { animation: failFlashAnim 0.7s ease-out forwards; }
@keyframes failFlashAnim { 0%{background:rgba(255,30,60,0);}10%{background:rgba(255,30,60,0.35);}30%{background:rgba(255,30,60,0.22);}60%{background:rgba(255,30,60,0.10);}100%{background:rgba(255,30,60,0);} }
@keyframes printerShake { 0%{transform:translateX(0);}15%{transform:translateX(-7px) rotate(-1.5deg);}30%{transform:translateX(7px) rotate(1.5deg);}45%{transform:translateX(-5px) rotate(-1deg);}60%{transform:translateX(5px) rotate(1deg);}75%{transform:translateX(-3px);}90%{transform:translateX(3px);}100%{transform:translateX(0);} }
.printer-card.shaking { animation: printerShake 0.5s ease-out; }
.spaghetti-overlay { position: absolute; inset: 0; background: rgba(13,15,20,0.88); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; border-radius: var(--radius); animation: fadeIn 0.3s ease; }
.spaghetti-text { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--danger); letter-spacing: 3px; text-shadow: 0 0 20px rgba(255,61,90,0.8); margin-top: 8px; }
.spaghetti-sub  { font-size: 10px; color: var(--text-dim); margin-top: 4px; letter-spacing: 1px; }
@keyframes successPulse { 0%{box-shadow:inset 0 0 0 0 rgba(127,255,110,0);}30%{box-shadow:inset 0 0 0 3px rgba(127,255,110,0.6);}100%{box-shadow:inset 0 0 0 0 rgba(127,255,110,0);} }
.printer-visual.success-pulse { animation: successPulse 0.8s ease-out; }

/* ── MISC ── */
.idle-ticker { position: fixed; pointer-events: none; font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--accent3); text-shadow: 0 0 10px var(--accent3); z-index: 400; animation: tickerFloat 1.2s ease-out forwards; }
@keyframes tickerFloat { 0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-50px);} }
@keyframes glow-pulse { 0%{box-shadow:0 0 0 0 rgba(127,255,110,0.6);}70%{box-shadow:0 0 0 12px rgba(127,255,110,0);}100%{box-shadow:0 0 0 0 rgba(127,255,110,0);} }
.money-gained { animation: glow-pulse 0.6s ease-out; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* active-effect banners */
.effect-banner { display: flex; gap: 6px; flex-wrap: wrap; }
.effect-tag { font-size: 11px; letter-spacing: 1px; padding: 3px 8px; border-radius: 3px; animation: fadeIn 0.3s; }
.effect-bulk  { background: rgba(127,255,110,0.12); color: var(--accent3); border: 1px solid rgba(127,255,110,0.2); }
.effect-disc  { background: rgba(0,229,255,0.1);   color: var(--accent);  border: 1px solid rgba(0,229,255,0.2); }
.effect-warn  { background: rgba(255,61,90,0.1);   color: var(--danger);  border: 1px solid rgba(255,61,90,0.2); }

/* ── MARKET TICKER ── */
.market-bar {
  display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
  padding: 4px 16px; background: rgba(13,15,20,0.8);
  border-bottom: 1px solid var(--border); font-size: 10px;
}
.market-pill {
  display: flex; align-items: center; gap: 5px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 2px 10px;
  font-family: var(--display); font-weight: 700; font-size: 12px;
  transition: all 0.5s;
}
.market-pill .m-label { color: var(--text-dim); font-size: 10px; letter-spacing: 1px; text-transform: uppercase; font-family: var(--mono); }
.market-up   { color: var(--accent3); }
.market-down { color: var(--danger); }
.market-flat { color: var(--text); }
.market-arrow { font-size: 10px; }
#market-label { color: var(--text-dim); font-size: 10px; letter-spacing: 1px; text-transform: uppercase; }

/* ── TUTORIAL OVERLAY ── */
#tutorial-overlay {
  position: fixed; inset: 0; z-index: 999; pointer-events: none;
}
.tut-spotlight {
  position: absolute; background: rgba(0,229,255,0.08);
  border: 2px solid var(--accent); border-radius: 8px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55), 0 0 30px rgba(0,229,255,0.3);
  pointer-events: none;
  transition: all 0.4s cubic-bezier(0.34,1.2,0.64,1);
  animation: tutPulse 1.5s ease-in-out infinite;
}
@keyframes tutPulse { 0%,100%{box-shadow:0 0 0 9999px rgba(0,0,0,0.55),0 0 20px rgba(0,229,255,0.2);} 50%{box-shadow:0 0 0 9999px rgba(0,0,0,0.55),0 0 40px rgba(0,229,255,0.5);} }
.tut-tooltip {
  position: absolute; background: var(--panel); border: 1px solid var(--accent);
  border-radius: 10px; padding: 14px 18px; max-width: 260px; pointer-events: all;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.tut-tooltip::before {
  content: ''; position: absolute; width: 10px; height: 10px;
  background: var(--accent); border-radius: 2px;
  top: -6px; left: 20px; transform: rotate(45deg);
}
.tut-step { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 6px; }
.tut-title { font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--text-bright); margin-bottom: 6px; }
.tut-body { font-size: 11px; color: var(--text); line-height: 1.6; margin-bottom: 12px; }
.tut-actions { display: flex; justify-content: space-between; align-items: center; }
.tut-skip { font-size: 10px; color: var(--text-dim); cursor: pointer; border: none; background: none; font-family: var(--mono); }
.tut-skip:hover { color: var(--text); }

/* .kbd kept for tutorial only */
.kbd {
  display: inline-block; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 4px; padding: 1px 6px; font-family: var(--mono);
  font-size: 9px; color: var(--text-dim); vertical-align: middle;
}

/* ── AUTO-SAVE INDICATOR ── */
#save-indicator {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 9px; letter-spacing: 1px; color: var(--text-dim);
  opacity: 0; transition: opacity 0.4s;
  padding: 4px 8px; background: var(--bg3); border-radius: 4px;
  border: 1px solid var(--border);
}
#save-indicator.visible { opacity: 1; }
#save-indicator.saving { color: var(--accent3); border-color: rgba(127,255,110,0.3); }

/* ── SETTINGS TAB ── */
.settings-section { display: flex; flex-direction: column; gap: 10px; }
.settings-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius);
}
.settings-label { font-family: var(--display); font-weight: 700; font-size: 13px; }
.settings-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
.settings-danger-zone {
  background: rgba(255,61,90,0.06); border: 1px solid rgba(255,61,90,0.25);
  border-radius: var(--radius); padding: 12px;
}
.settings-danger-title { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--danger); margin-bottom: 8px; }

/* ── MARKET BONUS BADGE on order card ── */
.market-bonus { font-size: 9px; padding: 1px 5px; border-radius: 3px; background: rgba(127,255,110,0.15); color: var(--accent3); font-family: var(--mono); margin-left: 4px; }
.market-malus { background: rgba(255,61,90,0.12); color: var(--danger); }

/* ── STREAK COUNTER ── */
.streak-pill {
  display: flex; align-items: center; gap: 6px;
  background: linear-gradient(135deg, rgba(255,204,0,0.12), rgba(255,107,53,0.08));
  border: 1px solid rgba(255,204,0,0.3);
  border-radius: 20px; padding: 5px 14px;
  font-family: var(--display); font-weight: 700; font-size: 16px;
}
.streak-pill .label { color: var(--text-dim); font-size: 10px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; }
#streak-val { color: var(--warn); }

/* ── NIGHT MODE indicator ── */
.night-badge {
  font-size: 9px; padding: 2px 8px; border-radius: 10px;
  background: rgba(167,139,250,0.15); color: var(--pro);
  border: 1px solid rgba(167,139,250,0.3); letter-spacing: 1px;
  text-transform: uppercase; display: none;
}
.night-badge.active { display: inline-block; }

/* ── PRINTER SKINS ── */
.skin-midnight .print-head { background: var(--pro) !important; box-shadow: 0 0 12px var(--pro) !important; }
.skin-midnight .print-layer { background: linear-gradient(0deg, var(--pro-dark), var(--pro)) !important; }
.skin-midnight #printer-visual { border-color: rgba(167,139,250,0.4) !important; background: #0f0a1f !important; }
.skin-lava .print-head { background: var(--danger) !important; box-shadow: 0 0 12px var(--danger) !important; }
.skin-lava .print-layer { background: linear-gradient(0deg, #8b0000, var(--danger)) !important; }
.skin-lava #printer-visual { border-color: rgba(255,61,90,0.4) !important; background: #1a0808 !important; }
.skin-forest .print-head { background: var(--accent3) !important; box-shadow: 0 0 12px var(--accent3) !important; }
.skin-forest .print-layer { background: linear-gradient(0deg, #1a4020, var(--accent3)) !important; }
.skin-forest #printer-visual { border-color: rgba(127,255,110,0.4) !important; background: #080f08 !important; }
.skin-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 2px solid rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.15s; }
.skin-dot:hover { transform: scale(1.3); }
.skin-dot.active-skin { outline: 2px solid white; outline-offset: 2px; }
.skin-selector { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.skin-label { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; }

/* ── BREAKDOWN MINI-GAME ── */
#minigame-overlay {
  position: fixed; inset: 0; z-index: 600;
  background: rgba(0,0,0,0.88); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center;
}
#minigame-overlay.active { display: flex; }
.minigame-box {
  background: var(--panel); border: 2px solid var(--danger);
  border-radius: 12px; padding: 28px 32px; max-width: 420px; width: 90%;
  box-shadow: 0 0 60px rgba(255,61,90,0.3);
  animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1); text-align: center;
}
.mg-title { font-family: var(--display); font-weight: 900; font-size: 26px; color: var(--danger); letter-spacing: 2px; margin-bottom: 6px; }
.mg-sub { color: var(--text-dim); font-size: 11px; margin-bottom: 20px; line-height: 1.6; }
.mg-sequence { display: flex; gap: 8px; justify-content: center; margin-bottom: 18px; min-height: 40px; align-items: center; flex-wrap: wrap; }
.mg-key { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid var(--border); background: var(--bg3); }
.mg-buttons { display: flex; gap: 14px; justify-content: center; margin-bottom: 18px; }
.mg-btn { width: 68px; height: 68px; border-radius: 14px; border: 2px solid var(--border); cursor: pointer; font-size: 26px; transition: all 0.1s; display: flex; align-items: center; justify-content: center; background: var(--bg3); }
.mg-btn:active, .mg-btn.pressed { transform: scale(0.88); filter: brightness(1.5); }
.mg-timer-bar { height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; margin-bottom: 14px; border: 1px solid var(--border); }
.mg-timer-fill { height: 100%; background: linear-gradient(90deg, var(--accent3), var(--warn), var(--danger)); border-radius: 3px; transition: width 0.1s linear; }
.mg-progress { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.mg-feedback { font-family: var(--display); font-weight: 900; font-size: 16px; min-height: 22px; margin-bottom: 4px; }

/* ── CUSTOMER QUOTE TOAST ── */
.quote-toast {
  position: fixed; top: 76px; left: 50%; transform: translateX(-50%);
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 20px; z-index: 350;
  max-width: 360px; width: 90%; pointer-events: none;
  animation: quoteSlide 0.4s cubic-bezier(0.34,1.4,0.64,1) forwards;
}
@keyframes quoteSlide { from{opacity:0;transform:translateX(-50%) translateY(-16px);}to{opacity:1;transform:translateX(-50%) translateY(0);} }
.quote-toast .q-name { font-family: var(--display); font-weight: 700; font-size: 12px; color: var(--accent); margin-bottom: 4px; letter-spacing: 1px; }
.quote-toast .q-text { font-size: 11px; color: var(--text-dim); font-style: italic; line-height: 1.5; }

/* ── KLANTEN CHAT SYSTEEM ── */
#chat-notification {
  position: fixed; bottom: calc(60px + env(safe-area-inset-bottom) + 12px);
  right: 14px; z-index: 450;
  width: 270px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.04);
  overflow: hidden;
  transform: translateX(300px) scale(0.9);
  opacity: 0;
  transition: transform 0.4s cubic-bezier(0.34,1.4,0.64,1), opacity 0.3s ease;
  pointer-events: none;
}
#chat-notification.visible {
  transform: translateX(0) scale(1);
  opacity: 1;
  pointer-events: all;
}
.chat-notif-header {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 12px 7px;
  background: rgba(0,229,255,0.05);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}
.chat-notif-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: var(--bg3);
  border: 1.5px solid var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; flex-shrink: 0;
}
.chat-notif-name {
  font-family: var(--display); font-weight: 700; font-size: 13px;
  color: var(--accent); flex: 1;
}
.chat-notif-close {
  color: var(--text-dim); font-size: 16px; cursor: pointer; padding: 0 2px;
  line-height: 1;
}
.chat-notif-close:hover { color: var(--text); }
.chat-messages {
  padding: 10px 12px; display: flex; flex-direction: column; gap: 6px;
  max-height: 140px; overflow-y: auto; scrollbar-width: none;
}
.chat-msg {
  max-width: 85%; padding: 7px 10px;
  border-radius: 10px; font-size: 10px; line-height: 1.5;
  animation: chatMsgIn 0.25s ease;
}
@keyframes chatMsgIn {
  from { opacity:0; transform:translateY(6px); }
  to   { opacity:1; transform:translateY(0); }
}
.chat-msg.them {
  background: var(--bg3); color: var(--text);
  border-radius: 10px 10px 10px 2px;
  align-self: flex-start;
  border: 1px solid var(--border);
}
.chat-msg.me {
  background: rgba(0,229,255,0.12); color: var(--accent);
  border-radius: 10px 10px 2px 10px;
  align-self: flex-end;
  border: 1px solid rgba(0,229,255,0.25);
  text-align: right;
}
.chat-msg.typing {
  background: var(--bg3); padding: 8px 12px;
  align-self: flex-start; border: 1px solid var(--border);
  border-radius: 10px 10px 10px 2px;
}
.chat-typing-dots {
  display: flex; gap: 3px; align-items: center; height: 12px;
}
.chat-typing-dots span {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--text-dim); display: block;
  animation: typingBounce 1.2s ease-in-out infinite;
}
.chat-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%,60%,100% { transform: translateY(0); opacity:0.4; }
  30%          { transform: translateY(-4px); opacity:1; }
}
.chat-replies {
  display: flex; flex-direction: column; gap: 4px;
  padding: 8px 12px 10px;
  border-top: 1px solid var(--border);
  background: rgba(0,0,0,0.2);
}
.chat-reply-btn {
  padding: 6px 10px; border-radius: 8px;
  font-size: 10px; font-family: var(--mono);
  cursor: pointer; text-align: left; line-height: 1.4;
  border: 1px solid var(--border);
  background: var(--bg3); color: var(--text);
  transition: all 0.12s;
}
.chat-reply-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.06); }
.chat-reply-btn.good  { border-color: rgba(127,255,110,0.3); }
.chat-reply-btn.bad   { border-color: rgba(255,61,90,0.3);   }
.chat-reply-btn.risky { border-color: rgba(255,204,0,0.3);   }
.chat-reply-btn:hover.good  { border-color: var(--accent3); color: var(--accent3); background: rgba(127,255,110,0.06); }
.chat-reply-btn:hover.bad   { border-color: var(--danger);  color: var(--danger);  background: rgba(255,61,90,0.06);  }
.chat-reply-btn:hover.risky { border-color: var(--warn);    color: var(--warn);    background: rgba(255,204,0,0.06);  }

/* ── URGENT ORDER PULSE ── */
@keyframes urgentPulse {
  0%,100% { border-color: var(--danger); box-shadow: 0 0 0 0 rgba(255,61,90,0.5), inset 0 0 0 0 rgba(255,61,90,0); }
  50%     { border-color: #ff7090;       box-shadow: 0 0 8px 2px rgba(255,61,90,0.2), inset 0 0 8px rgba(255,61,90,0.05); }
}
.order-card.urgent-card { animation: urgentPulse 1s ease-in-out infinite; }

/* ── LEADERBOARD ── */
#tab-leaderboard { overflow-y: auto; }
.lb-row { display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 6px; }
.lb-rank { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--text-dim); width: 30px; text-align: center; }
.lb-rank.gold   { color: #ffd700; text-shadow: 0 0 8px rgba(255,215,0,0.5); }
.lb-rank.silver { color: #c0c0c0; }
.lb-rank.bronze { color: #cd7f32; }
.lb-name  { flex: 1; }
.lb-name-main { font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--text-bright); }
.lb-name-sub  { font-size: 9px; color: var(--text-dim); margin-top: 1px; }
.lb-score { text-align: right; }
.lb-score-val { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--accent3); }
.lb-score-sub { font-size: 9px; color: var(--text-dim); }
.lb-you   { border-color: var(--accent); background: rgba(0,229,255,0.06); }
.lb-empty { text-align: center; color: var(--text-dim); padding: 24px 0; font-size: 11px; line-height: 1.8; }

/* ── LOYALTY BADGE ── */
.loyalty-badge { font-size: 9px; padding: 1px 6px; border-radius: 3px; background: rgba(255,204,0,0.15); color: var(--warn); margin-left: 4px; vertical-align: middle; }

/* ── PIE CHART ── */
#pie-canvas { display: block; margin: 0 auto; }
.pie-legend { display: flex; gap: 14px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
.pie-legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-dim); }
.pie-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

/* ── NOTIFICATION BELL ── */
.notif-btn { width: 34px; height: 34px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; transition: all 0.15s; position: relative; }
.notif-btn:hover { border-color: var(--accent); }
.notif-dot { position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; border-radius: 50%; background: var(--danger); display: none; }
.notif-btn.has-notif .notif-dot { display: block; animation: blink 1s infinite; }

/* ── COMBO SYSTEM ── */
#combo-display {
  position: fixed; top: 70px; right: 20px; z-index: 400;
  font-family: var(--display); font-weight: 900;
  pointer-events: none; text-align: right;
}
.combo-number {
  font-size: 48px; line-height: 1;
  background: linear-gradient(135deg, var(--warn), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 12px rgba(255,204,0,0.6));
  animation: comboPop 0.3s cubic-bezier(0.34,1.8,0.64,1);
}
@keyframes comboPop { 0%{transform:scale(0.6);}100%{transform:scale(1);} }
.combo-label { font-size: 11px; color: var(--warn); letter-spacing: 3px; text-transform: uppercase; margin-top: -4px; }
.combo-mult  { font-size: 14px; color: var(--accent3); letter-spacing: 1px; }
.combo-bar-wrap { width: 80px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-left: auto; margin-top: 4px; overflow: hidden; }
.combo-bar-fill { height: 100%; background: linear-gradient(90deg,var(--warn),var(--accent2)); border-radius: 2px; transition: width 0.1s linear; }

/* ── DAILY GOALS ── */
.goal-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 12px;
  display: flex; align-items: center; gap: 10px;
}
.goal-card.goal-done { border-color: var(--accent3); opacity: 0.7; }
.goal-icon { font-size: 20px; flex-shrink: 0; }
.goal-info { flex: 1; min-width: 0; }
.goal-name { font-family: var(--display); font-weight: 700; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.goal-desc { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.goal-progress { margin-top: 5px; }
.goal-prog-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.goal-prog-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--accent), var(--accent3)); transition: width 0.4s; }
.goal-prog-text { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.goal-reward { font-family: var(--display); font-weight: 900; font-size: 15px; color: var(--warn); flex-shrink: 0; }
.goal-done-check { font-size: 18px; flex-shrink: 0; }

/* ── SPEEDRUN MODE ── */
#speedrun-bar {
  display: none; align-items: center; justify-content: space-between;
  padding: 6px 16px; background: rgba(255,61,90,0.12);
  border-bottom: 1px solid rgba(255,61,90,0.3); gap: 12px;
}
#speedrun-bar.active { display: flex; }
.sr-timer { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--danger); letter-spacing: 2px; }
.sr-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--danger); }
.sr-score { font-family: var(--display); font-weight: 700; font-size: 15px; color: var(--warn); }
.sr-end-btn { font-family: var(--mono); font-size: 10px; padding: 4px 10px; border: 1px solid var(--danger); background: transparent; color: var(--danger); border-radius: var(--radius); cursor: pointer; }
.sr-end-btn:hover { background: rgba(255,61,90,0.15); }

/* ── ACHIEVEMENT PROGRESS ── */
.achiev-card {
  padding: 10px 12px; background: var(--bg3);
  border: 1px solid var(--border); border-radius: var(--radius);
  margin-bottom: 8px; transition: border-color 0.2s;
}
.achiev-card.unlocked { border-color: var(--accent3); }
.achiev-card.locked   { opacity: 0.5; }
.achiev-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.achiev-icon  { font-size: 18px; }
.achiev-title { font-family: var(--display); font-weight: 700; font-size: 14px; }
.achiev-desc  { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; }
.achiev-prog-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.achiev-prog-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--accent2), var(--warn)); }
.achiev-prog-text { font-size: 9px; color: var(--text-dim); margin-top: 3px; text-align: right; }

/* ── SEASON BANNER ── */
#season-banner {
  display: none; align-items: center; gap: 10px;
  padding: 6px 16px; border-bottom: 1px solid var(--border);
  font-size: 11px; animation: fadeIn 0.5s;
}
#season-banner.active { display: flex; }
.season-icon { font-size: 18px; }
.season-text { flex: 1; }
.season-name { font-family: var(--display); font-weight: 700; font-size: 14px; }
.season-effect { color: var(--text-dim); font-size: 10px; }

/* ── SMART TIP ── */
#smart-tip {
  position: fixed; bottom: calc(60px + env(safe-area-inset-bottom) + 16px); left: 50%; transform: translateX(-50%);
  background: var(--panel); border: 1px solid var(--accent);
  border-radius: 10px; padding: 10px 18px; z-index: 1100;
  max-width: 380px; width: 90%; pointer-events: none; display: none;
  max-height: calc(100vh - 160px); overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 20px rgba(0,229,255,0.15);
  animation: tipSlide 0.4s cubic-bezier(0.34,1.4,0.64,1) forwards;
}
@keyframes tipSlide { from{opacity:0;transform:translateX(-50%) translateY(12px);}to{opacity:1;transform:translateX(-50%) translateY(0);} }
#smart-tip.visible { display: block; }
.tip-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 4px; }
.tip-text  { font-size: 11px; color: var(--text-bright); line-height: 1.5; }

/* ── PRINTER RENAME ── */
.printer-name-btn { background: none; border: none; cursor: pointer; font-size: 10px; color: var(--text-dim); padding: 0 4px; transition: color 0.15s; }
.printer-name-btn:hover { color: var(--accent); }
.printer-name-input { background: var(--bg); border: 1px solid var(--accent); border-radius: 4px; color: var(--text-bright); font-family: var(--display); font-weight: 700; font-size: 14px; padding: 2px 6px; width: 120px; }

/* ── DYNAMIC BACKGROUND ── */
body.level-5  { background-image: radial-gradient(ellipse 80% 40% at 50% -10%, rgba(0,229,255,0.09) 0%, transparent 70%), var(--grid-bg); }
body.level-6  { background-image: radial-gradient(ellipse 80% 40% at 50% -10%, rgba(167,139,250,0.1) 0%, transparent 70%), var(--grid-bg); }
body.level-7  { background-image: radial-gradient(ellipse 80% 40% at 50% -10%, rgba(255,107,53,0.1) 0%, transparent 70%), var(--grid-bg); }
body.level-8  { background-image: radial-gradient(ellipse 100% 60% at 50% -10%, rgba(127,255,110,0.12) 0%, rgba(255,204,0,0.04) 50%, transparent 70%), var(--grid-bg); }

/* ── PRESTIGE SYSTEM ── */
.prestige-btn {
  background: linear-gradient(135deg,#7c2d12,#ea580c,#fbbf24);
  border: none; border-radius: var(--radius); color: white;
  font-family: var(--mono); font-weight: 700; font-size: 11px;
  letter-spacing: 1px; text-transform: uppercase; padding: 8px 16px;
  cursor: pointer; width: 100%; margin-top: 8px;
  box-shadow: 0 0 20px rgba(234,88,12,0.4); transition: all 0.2s;
}
.prestige-btn:hover { box-shadow: 0 0 32px rgba(234,88,12,0.6); transform: translateY(-1px); }
.prestige-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.prestige-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: linear-gradient(135deg,rgba(124,45,18,0.3),rgba(251,191,36,0.15));
  border: 1px solid rgba(251,191,36,0.4); border-radius: 12px;
  padding: 3px 10px; font-size: 10px; color: #fbbf24;
  font-family: var(--display); font-weight: 700;
}
#prestige-pill { display: none; }
#prestige-pill.active { display: flex; }

/* ── PRINTER SPECIALIZATION ── */
.spec-btn { flex: 1; padding: 6px 4px; border: 1px solid var(--border); background: var(--bg3); border-radius: var(--radius); cursor: pointer; font-size: 9px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text-dim); transition: all 0.15s; text-align: center; font-family: var(--mono); }
.spec-btn:hover { border-color: var(--accent); color: var(--text); }
.spec-btn.active-spec { font-weight: 700; }
.spec-speed   { border-color: var(--accent3) !important; color: var(--accent3) !important; background: rgba(127,255,110,0.08) !important; }
.spec-quality { border-color: var(--pro) !important;    color: var(--pro) !important;    background: rgba(167,139,250,0.08) !important; }
.spec-economy { border-color: var(--warn) !important;   color: var(--warn) !important;   background: rgba(255,204,0,0.08) !important; }
.spec-tag { font-size: 10px; padding: 1px 5px; border-radius: 3px; margin-left: 4px; vertical-align: middle; }
.spec-tag-speed   { background: rgba(127,255,110,0.15); color: var(--accent3); }
.spec-tag-quality { background: rgba(167,139,250,0.15); color: var(--pro); }
.spec-tag-economy { background: rgba(255,204,0,0.15);  color: var(--warn); }

/* ── ACHIEVEMENT PROGRESS CARDS ── */
.achiev-title-text { font-family:var(--display); font-weight:700; font-size:13px; flex:1; }
.achiev-desc  { font-size:10px; color:var(--text-dim); margin-bottom:5px; line-height:1.4; }
.achiev-prog-bar  { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; }
.achiev-prog-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--accent2),var(--warn)); }
.achiev-prog-text { font-size:9px; color:var(--text-dim); margin-top:2px; text-align:right; }

/* ── RENAME INPUT ── */
.printer-name-editable { cursor: pointer; border-bottom: 1px dashed var(--text-dim); transition: border-color 0.15s; }
.printer-name-editable:hover { border-color: var(--accent); color: var(--accent); }

/* ── MOBILE RESPONSIVE ── */
@media (max-width: 768px) {
  #main { grid-template-columns: 1fr !important; padding: 8px; gap: 8px; }
  #topbar { height: auto; padding: 8px 12px; gap: 8px; flex-wrap: wrap; }
  .logo { font-size: 17px; }
  .market-bar { padding: 4px 10px; gap: 4px; overflow-x: auto; white-space: nowrap; flex-wrap: nowrap; }
  /* Nieuwe volgorde: center (print station) staat al als eerste in HTML */
  #center-panel { order: 0; }
  #main > div:nth-child(2) { order: 1; }
  #log-panel-container { order: 2; }
  #main > div:last-child { order: 3; }
  .job-title { font-size: 20px; }
  .printer-visual { height: 110px; }
  .panel-body { padding: 8px; }
  .topbar-right { gap: 4px; }
  .btn-sm { padding: 4px 8px; font-size: 9px; }
  .stat-pill { padding: 4px 10px; font-size: 13px; }
  .streak-pill { padding: 4px 10px; font-size: 13px; }
}

/* ── NIEUWS-TICKER ── */
#news-ticker {
  background: rgba(0,229,255,0.04); border-bottom: 1px solid var(--border);
  padding: 5px 0; overflow: hidden; white-space: nowrap;
  font-size: 10px; color: var(--text-dim); position: relative;
}
.ticker-inner { display: inline-block; animation: tickerScroll 50s linear infinite; padding-left: 100%; }
@keyframes tickerScroll { 0%{transform:translateX(0);}100%{transform:translateX(-100%);} }
.ticker-item { display: inline-block; margin-right: 80px; }
.ticker-item span { color: var(--accent); }

/* ── PRINT WACHTRIJ ── */
.queue-slot { display:flex; align-items:center; gap:8px; padding:6px 10px; background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:4px; transition:all 0.2s; }
.queue-slot.filled { border-color:rgba(0,229,255,0.3); }
.queue-slot-num { font-family:var(--display); font-weight:900; font-size:16px; color:var(--text-dim); width:20px; }
.queue-slot-name { flex:1; font-size:11px; color: var(--text); }
.queue-slot-fil { font-size:9px; padding:1px 6px; border-radius:3px; }
.queue-slot-remove { background:none; border:none; cursor:pointer; color:var(--text-dim); font-size:14px; padding:0 4px; }
.queue-slot-remove:hover { color:var(--danger); }

/* ── MEDEWERKERS ── */
.employee-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; margin-bottom:8px; }
.employee-card.hired { border-color:rgba(0,229,255,0.3); }
.employee-header { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.employee-avatar { font-size:22px; }
.employee-name { font-family:var(--display); font-weight:700; font-size:14px; flex:1; }
.employee-wage { font-size:10px; color:var(--text-dim); }
.employee-desc { font-size:10px; color:var(--text-dim); line-height:1.5; margin-bottom:6px; }
.employee-status { font-size:9px; letter-spacing:1px; text-transform:uppercase; }
.employee-status.working { color:var(--accent3); }
.employee-status.idle    { color:var(--text-dim); }

/* ── LOOTBOX / PRINT TOKENS ── */
.token-pill { display:flex; align-items:center; gap:6px; background:var(--bg3); border:1px solid rgba(251,191,36,0.3); border-radius:20px; padding:4px 12px; font-family:var(--display); font-weight:700; font-size:15px; color:#fbbf24; }
.lootbox-card { background:linear-gradient(135deg,rgba(124,45,18,0.2),rgba(251,191,36,0.08)); border:1px solid rgba(251,191,36,0.3); border-radius:var(--radius); padding:14px; text-align:center; margin-bottom:8px; }
.lootbox-icon { font-size:36px; margin-bottom:6px; }
.lootbox-name { font-family:var(--display); font-weight:900; font-size:18px; color:#fbbf24; }
.lootbox-cost { font-size:11px; color:var(--text-dim); margin:4px 0 10px; }

/* ── PRODUCTIEKETENS ── */
.chain-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; margin-bottom:8px; }
.chain-header { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.chain-name { font-family:var(--display); font-weight:700; font-size:14px; flex:1; }
.chain-steps { display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
.chain-step { display:flex; align-items:center; gap:4px; font-size:10px; }
.chain-arrow { color:var(--text-dim); }
.chain-progress { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; margin-bottom:4px; }
.chain-prog-fill { height:100%; background:linear-gradient(90deg,var(--pla),var(--petg),var(--pa6)); border-radius:2px; transition:width 0.5s; }
.chain-reward { font-family:var(--display); font-weight:900; font-size:14px; color:var(--accent3); }

/* ── v9: RIVAL COMPETITOR ── */
.rival-banner {
  display: none; align-items: center; justify-content: space-between;
  padding: 6px 16px; background: rgba(255,61,90,0.08);
  border-bottom: 1px solid rgba(255,61,90,0.25); gap: 12px; font-size: 11px;
}
.rival-banner.active { display: flex; }
.rival-name { font-family: var(--display); font-weight: 900; font-size: 14px; color: var(--danger); }
.rival-score { font-family: var(--display); font-weight: 700; color: var(--warn); }
.rival-steal { animation: rivalSteal 0.4s ease; }
@keyframes rivalSteal { 0%{background:rgba(255,61,90,0.3);}100%{background:transparent;} }

/* ── v9: LOAN SYSTEM ── */
.loan-card {
  background: linear-gradient(135deg,rgba(255,61,90,0.08),rgba(255,204,0,0.04));
  border: 1px solid rgba(255,61,90,0.3); border-radius: var(--radius); padding: 12px; margin-bottom:8px;
}
.loan-interest { color: var(--danger); font-size: 10px; }
.loan-due { font-family: var(--display); font-weight: 700; color: var(--warn); font-size: 16px; }

/* ── v9: DEMAND SURGE ── */
.surge-banner {
  display: none; align-items: center; gap: 12px; padding: 8px 16px;
  background: linear-gradient(90deg,rgba(127,255,110,0.08),rgba(0,229,255,0.06));
  border-bottom: 1px solid rgba(127,255,110,0.3); font-size: 11px;
}
.surge-banner.active { display: flex; }
.surge-name { font-family: var(--display); font-weight: 900; font-size: 15px; color: var(--accent3); }
.surge-progress { flex: 1; }
.surge-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-top: 3px; }
.surge-fill { height: 100%; background: linear-gradient(90deg, var(--accent3), var(--accent)); border-radius: 3px; transition: width 0.5s; }
.surge-reward { font-family: var(--display); font-weight: 900; color: var(--warn); font-size: 14px; }
.surge-timer { color: var(--danger); font-size: 10px; }

/* ── v9: CLOG MINIGAME ── */
#clog-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75);
  z-index: 9100; align-items: center; justify-content: center; backdrop-filter: blur(4px);
}
#clog-overlay.active { display: flex; }
.clog-box {
  background: var(--panel); border: 2px solid var(--danger); border-radius: 10px;
  padding: 24px; width: 320px; text-align: center;
  box-shadow: 0 0 40px rgba(255,61,90,0.4);
}
.clog-title { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--danger); letter-spacing: 2px; margin-bottom: 6px; }
.clog-desc  { font-size: 10px; color: var(--text-dim); margin-bottom: 16px; line-height: 1.5; }
.clog-mash  { display: flex; justify-content: center; gap: 12px; margin: 14px 0; }
.clog-mash-btn {
  width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--danger);
  background: rgba(255,61,90,0.1); cursor: pointer; font-size: 28px;
  transition: all 0.1s; box-shadow: 0 0 16px rgba(255,61,90,0.3);
}
.clog-mash-btn:active { transform: scale(0.88); background: rgba(255,61,90,0.3); }
.clog-timer-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin: 8px 0; }
.clog-timer-fill { height: 100%; background: var(--danger); border-radius: 3px; transition: width 0.1s linear; }
.clog-progress-text { font-family: var(--display); font-weight: 700; font-size: 18px; color: var(--text-bright); margin: 8px 0; }

/* ── v9: POWER OUTAGE ── */
.outage-flash { position: fixed; inset: 0; background: black; z-index: 9050; pointer-events: none; opacity: 0; animation: outageFlash 1.5s ease forwards; }
@keyframes outageFlash { 0%{opacity:0;}10%{opacity:0.95;}40%{opacity:0.7;}70%{opacity:0.3;}100%{opacity:0;} }

/* ── v9: SABOTAGE ── */
.sabotage-toast {
  position: fixed; top: 70px; right: 16px; z-index: 9999;
  background: linear-gradient(135deg,rgba(255,61,90,0.2),rgba(124,45,18,0.15));
  border: 1px solid var(--danger); border-radius: 8px; padding: 10px 16px;
  max-width: 260px; animation: slideInRight 0.4s ease;
}
@keyframes slideInRight { from{transform:translateX(40px);opacity:0;}to{transform:translateX(0);opacity:1;} }

/* ── v10: TAX SYSTEM ── */
.tax-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 9200; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.tax-overlay.active { display: flex; }
.tax-box {
  background: var(--panel); border: 2px solid var(--warn);
  border-radius: 12px; padding: 28px; width: 340px; text-align: center;
  box-shadow: 0 0 60px rgba(255,204,0,0.3);
  animation: taxDrop 0.5s cubic-bezier(0.34,1.4,0.64,1);
}
@keyframes taxDrop { from{transform:translateY(-40px) scale(0.8);opacity:0;} to{transform:none;opacity:1;} }
.tax-title { font-family: var(--display); font-weight: 900; font-size: 26px; color: var(--warn); letter-spacing: 2px; }
.tax-amount { font-family: var(--display); font-weight: 900; font-size: 48px; color: var(--danger); margin: 12px 0; line-height:1; }
.tax-sub { font-size: 10px; color: var(--text-dim); line-height: 1.6; margin-bottom: 16px; }
.tax-breakdown { background: var(--bg3); border-radius: var(--radius); padding: 10px; margin: 10px 0; text-align: left; }
.tax-row { display: flex; justify-content: space-between; font-size: 10px; padding: 3px 0; border-bottom: 1px solid var(--border); }
.tax-row:last-child { border-bottom: none; font-weight: 700; color: var(--warn); }

/* ── v10: CLIENT COMPLAINT ── */
.complaint-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.65);
  z-index: 9150; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
}
.complaint-overlay.active { display: flex; }
.complaint-box {
  background: var(--panel); border: 2px solid var(--danger);
  border-radius: 12px; padding: 24px; width: 320px; text-align: center;
  box-shadow: 0 0 40px rgba(255,61,90,0.35);
  animation: complaintShake 0.5s ease;
}
@keyframes complaintShake {
  0%,100%{transform:translateX(0);}
  15%{transform:translateX(-8px);}
  30%{transform:translateX(8px);}
  45%{transform:translateX(-6px);}
  60%{transform:translateX(6px);}
  75%{transform:translateX(-3px);}
  90%{transform:translateX(3px);}
}
.complaint-face { font-size: 48px; margin-bottom: 8px; }
.complaint-title { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--danger); }
.complaint-msg { font-size: 11px; color: var(--text); margin: 8px 0 14px; line-height: 1.6; font-style: italic; }
.complaint-choices { display: flex; gap: 8px; }
.complaint-choices .btn { flex: 1; }

/* ── v10: LEGACY PERKS ── */
.perk-card {
  background: linear-gradient(135deg, rgba(167,139,250,0.08), rgba(124,45,18,0.06));
  border: 1px solid rgba(167,139,250,0.3); border-radius: var(--radius);
  padding: 14px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
  position: relative; overflow: hidden;
}
.perk-card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(167,139,250,0.0), rgba(167,139,250,0.12));
  opacity: 0; transition: opacity 0.2s;
}
.perk-card:hover::before { opacity: 1; }
.perk-card.perk-owned { border-color: var(--accent3); opacity: 0.65; cursor: default; }
.perk-card.perk-owned::after { content: '✓ ACTIVE'; position: absolute; top: 8px; right: 10px; font-size: 9px; color: var(--accent3); letter-spacing: 1px; font-weight: 700; }
.perk-icon { font-size: 28px; margin-bottom: 6px; }
.perk-name { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--pro); }
.perk-desc { font-size: 10px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }
.perk-effect { font-size: 10px; color: var(--accent3); margin-top: 6px; font-weight: 700; }

/* ── v10: FRANCHISE ── */
.franchise-card {
  background: linear-gradient(135deg, rgba(255,107,53,0.08), rgba(255,204,0,0.05));
  border: 1px solid rgba(255,107,53,0.35); border-radius: var(--radius); padding: 14px; margin-bottom: 8px;
}
.franchise-name { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--accent2); }
.franchise-income { font-family: var(--display); font-weight: 700; font-size: 22px; color: var(--accent3); }
.franchise-bar { height: 5px; background: var(--bg); border-radius: 3px; overflow: hidden; margin: 6px 0; }
.franchise-fill { height: 100%; background: linear-gradient(90deg, var(--accent2), var(--warn)); border-radius: 3px; transition: width 0.5s; }

/* ── v10: RECYCLING ── */
.recycle-pill {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(127,255,110,0.08); border: 1px solid rgba(127,255,110,0.25);
  border-radius: 20px; padding: 4px 12px;
  font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--accent3);
}

/* ── v10: HALL OF FAME ── */
.hof-entry {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px 14px; margin-bottom: 8px;
  display: flex; align-items: center; gap: 12px;
}
.hof-rank { font-family: var(--display); font-weight: 900; font-size: 28px; color: var(--text-dim); width: 36px; flex-shrink: 0; }
.hof-rank.gold   { color: #ffd700; }
.hof-rank.silver { color: #c0c0c0; }
.hof-rank.bronze { color: #cd7f32; }
.hof-info { flex: 1; }
.hof-run-name { font-family: var(--display); font-weight: 700; font-size: 14px; }
.hof-run-sub  { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.hof-score { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--accent3); }
.hof-perks { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
.hof-perk-tag { font-size: 8px; padding: 1px 5px; border-radius: 3px; background: rgba(167,139,250,0.15); color: var(--pro); }

/* ── v10: CLIENT TIERS ── */
.client-tier-badge {
  display: inline-block; padding: 2px 7px; border-radius: 10px; font-size: 9px;
  font-family: var(--display); font-weight: 700; letter-spacing: 1px; vertical-align: middle;
}
.tier-bronze   { background: rgba(205,127,50,0.2);  color: #cd7f32; border: 1px solid rgba(205,127,50,0.4); }
.tier-silver   { background: rgba(192,192,192,0.15); color: #c0c0c0; border: 1px solid rgba(192,192,192,0.35); }
.tier-gold     { background: rgba(255,215,0,0.15);   color: #ffd700; border: 1px solid rgba(255,215,0,0.4); }
.tier-platinum { background: rgba(0,229,255,0.1);    color: var(--accent); border: 1px solid rgba(0,229,255,0.35); }

/* ── v10: MORALE ── */
.morale-bar-wrap { margin-top: 5px; }
.morale-bar { height: 3px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.morale-fill { height: 100%; border-radius: 2px; transition: width 0.5s, background 0.5s; }

/* ── v10: SUBSCRIPTION ORDER ── */
.order-card.order-subscription { border-left: 3px solid #00e5ff !important; }
.tag-subscription { background: rgba(0,229,255,0.12); color: var(--accent); }

/* ── v10: ANIMATED MONEY ── */
@keyframes moneyPop { 0%{transform:scale(1);}30%{transform:scale(1.18);}100%{transform:scale(1);} }
.money-pop { animation: moneyPop 0.25s ease; }

/* ── v10: INSURANCE ── */
.insurance-card {
  background: linear-gradient(135deg, rgba(0,229,255,0.06), rgba(127,255,110,0.04));
  border: 1px solid rgba(0,229,255,0.25); border-radius: var(--radius); padding: 12px; margin-bottom: 8px;
}
.insurance-active { border-color: var(--accent3) !important; }

/* ── v10: SCRAP COUNTER ── */
.scrap-pill {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,107,53,0.08); border: 1px solid rgba(255,107,53,0.25);
  border-radius: 20px; padding: 4px 12px;
  font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--accent2);
}

/* ── v10: PRESTIGE PERK SELECT OVERLAY ── */
.perk-select-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  z-index: 9300; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(6px);
}
.perk-select-overlay.active { display: flex; }
.perk-select-box {
  background: var(--panel); border: 2px solid var(--pro);
  border-radius: 14px; padding: 28px; width: min(500px, 95vw);
  box-shadow: 0 0 80px rgba(167,139,250,0.4);
  animation: taxDrop 0.4s cubic-bezier(0.34,1.4,0.64,1);
}
.perk-select-title { font-family: var(--display); font-weight: 900; font-size: 24px; color: var(--pro); text-align: center; margin-bottom: 6px; }
.perk-select-sub { font-size: 10px; color: var(--text-dim); text-align: center; margin-bottom: 18px; }
.perk-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media(max-width:500px){ .perk-select-grid { grid-template-columns: 1fr; } }
.perk-choice {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 14px; cursor: pointer; transition: all 0.18s; text-align: center;
}
.perk-choice:hover { border-color: var(--pro); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(167,139,250,0.2); }
.perk-choice-icon { font-size: 30px; margin-bottom: 6px; }
.perk-choice-name { font-family: var(--display); font-weight: 900; font-size: 14px; color: var(--pro); }
.perk-choice-desc { font-size: 9px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }

@keyframes confettiDrop { 0%{transform:translateY(-20px) rotate(0deg);opacity:1;} 100%{transform:translateY(110vh) rotate(540deg);opacity:0;} }
.confetti-piece { position:fixed; top:-20px; pointer-events:none; z-index:9999; border-radius:2px; animation:confettiDrop linear forwards; }

/* ── LEVEL-UP FLASH ── */
@keyframes lvlFlash { 0%,100%{opacity:0;} 10%,60%{opacity:1;} }
.levelup-flash { position:fixed; inset:0; z-index:8000; pointer-events:none; display:flex; align-items:center; justify-content:center; animation:lvlFlash 2.5s ease forwards; }
.levelup-text { font-family:var(--display); font-weight:900; font-size:56px; color:var(--warn); text-shadow:0 0 40px rgba(255,204,0,0.9); letter-spacing:4px; text-align:center; line-height:1.2; }

/* ── SMOOTH HOVER ── */
.order-card { transition:transform 0.15s, box-shadow 0.15s; }
.order-card:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.35); }
.upgrade-card { transition:transform 0.12s, border-color 0.2s; }
.upgrade-card:hover:not(.owned) { transform:translateY(-1px); }

/* ── PRINTER TEMP ── */
.temp-bar-wrap { margin-top:5px; }
.temp-bar-label { font-size:9px; color:var(--text-dim); display:flex; justify-content:space-between; margin-bottom:2px; }
.temp-bar { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; }
.temp-fill { height:100%; border-radius:2px; transition:width 0.8s, background 0.8s; }

/* ── EINDSPEL ── */
.printgod-banner { background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(234,88,12,0.06)); border:1px solid rgba(251,191,36,0.4); border-radius:var(--radius); padding:14px; text-align:center; margin:8px 0; }
.printgod-title { font-family:var(--display); font-weight:900; font-size:20px; color:#fbbf24; letter-spacing:2px; }
.printgod-desc { font-size:10px; color:var(--text-dim); line-height:1.6; margin-top:4px; }

/* ── v7: LEVERANCIERS ── */
.supplier-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px; margin-bottom: 8px;
  transition: border-color 0.2s;
}
.supplier-card.preferred { border-color: rgba(0,229,255,0.4); }
.supplier-card.trusted   { border-color: rgba(127,255,110,0.4); }
.supplier-card.crisis    { border-color: rgba(255,61,90,0.5); animation: supplierCrisis 1s ease-in-out infinite; }
@keyframes supplierCrisis { 0%,100%{border-color:rgba(255,61,90,0.3);} 50%{border-color:rgba(255,61,90,0.9);} }
.supplier-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.supplier-avatar { font-size:24px; }
.supplier-name { font-family:var(--display); font-weight:700; font-size:15px; flex:1; }
.supplier-relation { font-size:9px; letter-spacing:1px; text-transform:uppercase; padding:2px 8px; border-radius:10px; }
.supplier-rel-neutral  { background:rgba(90,100,128,0.2); color:var(--text-dim); }
.supplier-rel-preferred{ background:rgba(0,229,255,0.1); color:var(--accent); }
.supplier-rel-trusted  { background:rgba(127,255,110,0.1); color:var(--accent3); }
.supplier-prices { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px; }
.supplier-price-item { background:var(--bg); border-radius:4px; padding:6px 8px; }
.supplier-price-label { font-size:9px; color:var(--text-dim); margin-bottom:2px; }
.supplier-price-val { font-family:var(--display); font-weight:700; font-size:14px; color: var(--text-bright); }
.supplier-price-trend { font-size:9px; margin-left:4px; }
.trend-up   { color:var(--danger); }
.trend-down { color:var(--accent3); }
.supplier-stock-label { font-size:9px; color:var(--text-dim); margin-bottom:4px; letter-spacing:1px; text-transform:uppercase; }
.supplier-stock-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.supplier-stock-name { font-size:10px; min-width:50px; }
.stock-bar { flex:1; height:5px; background:var(--bg); border-radius:3px; overflow:hidden; }
.stock-fill { height:100%; border-radius:3px; transition:width 0.4s; }
.stock-low  { background: var(--danger); }
.stock-mid  { background: var(--warn); }
.stock-high { background: var(--accent3); }
.supplier-order-row { display:flex; gap:6px; margin-top:8px; }
.supplier-order-qty { width:50px; background:var(--bg); border:1px solid var(--border); border-radius:4px; color:var(--text); font-family:var(--mono); padding:4px 6px; font-size:11px; }

/* ── v7: FILAMENT VOORRAAD INDICATOR ── */
.stock-pill {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; padding: 2px 8px; border-radius: 10px;
  border: 1px solid var(--border); background: var(--bg3);
}
.stock-pill.low  { border-color:rgba(255,61,90,0.5); color:var(--danger); }
.stock-pill.mid  { border-color:rgba(255,204,0,0.4); color:var(--warn); }
.stock-pill.high { border-color:rgba(127,255,110,0.3); color:var(--accent3); }
#stock-bar {
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  padding:4px 16px; background:rgba(13,15,20,0.9);
  border-bottom: 1px solid var(--border); font-size:10px;
}
.stock-label { color:var(--text-dim); font-size:9px; letter-spacing:1px; text-transform:uppercase; }

/* ── v7: VIP KLANTEN ── */
.vip-badge {
  display:inline-flex; align-items:center; gap:3px;
  font-size:9px; padding:2px 7px; border-radius:10px;
  background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(234,88,12,0.1));
  border:1px solid rgba(251,191,36,0.4); color:#fbbf24;
  font-family:var(--display); font-weight:700; letter-spacing:1px;
  text-transform:uppercase;
}
.customer-panel {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px 12px; margin-bottom:8px;
}
.customer-row {
  display:flex; align-items:center; gap:8px; padding:6px 0;
  border-bottom:1px solid rgba(42,48,69,0.4);
}
.customer-row:last-child { border-bottom:none; }
.customer-name-main { font-family:var(--display); font-weight:700; font-size:13px; flex:1; }
.customer-satisfaction { display:flex; gap:2px; }
.sat-star { color:var(--warn); font-size:11px; }
.sat-star.empty { color:var(--border); }
.customer-jobs-count { font-size:10px; color:var(--text-dim); white-space:nowrap; }
.vip-bonus-label { font-size:9px; color:var(--accent3); margin-left:4px; }

/* ── v7: MARKTCRISIS ── */
.crisis-banner {
  display:none; align-items:center; gap:10px;
  padding:8px 16px; border-bottom:2px solid var(--danger);
  background:rgba(255,61,90,0.08); animation:fadeIn 0.3s;
}
.crisis-banner.active { display:flex; }
.crisis-icon { font-size:20px; animation: blink 0.8s infinite; }
.crisis-text { flex:1; }
.crisis-name { font-family:var(--display); font-weight:900; font-size:15px; color:var(--danger); }
.crisis-desc { font-size:10px; color:var(--text-dim); }
.crisis-timer { font-family:var(--display); font-weight:700; font-size:14px; color:var(--danger); }

/* ── v7: CHALLENGE MODE ── */
.challenge-card {
  background:linear-gradient(135deg,rgba(167,139,250,0.08),rgba(124,58,237,0.04));
  border:1px solid rgba(167,139,250,0.3);
  border-radius:var(--radius); padding:12px; margin-bottom:8px;
}
.challenge-card.active-challenge { border-color:var(--pro); background:rgba(167,139,250,0.1); }
.challenge-name { font-family:var(--display); font-weight:700; font-size:14px; color:var(--pro); }
.challenge-desc { font-size:10px; color:var(--text-dim); margin:4px 0; line-height:1.5; }
.challenge-reward { font-family:var(--display); font-weight:900; font-size:16px; color:var(--warn); }
.challenge-prog-bar { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; margin-top:6px; }
.challenge-prog-fill { height:100%; background:linear-gradient(90deg,var(--pro-dark),var(--pro)); border-radius:2px; transition:width 0.4s; }
.challenge-timer { font-size:9px; color:var(--pro); margin-top:4px; }

/* ── v7: FILAMENT UPGRADE VISUAL ── */
.fil-tpu  { color: #ff9f43; }
.fil-resin { color: #ee5a24; }
.tag-tpu   { background:rgba(255,159,67,0.15); color:#ff9f43; }
.tag-resin { background:rgba(238,90,36,0.12);  color:#ee5a24; }
.tag-cf    { background:rgba(74,74,74,0.3);    color:#9ca3af; }
.tag-glow  { background:rgba(204,255,0,0.12);  color:#ccff00; }
.order-tpu::before   { background: #ff9f43; }
.order-resin::before { background: #ee5a24; }
.filament-btn.selected-tpu   { border-color:#ff9f43; background:rgba(255,159,67,0.1); }
.filament-btn.selected-resin { border-color:#ee5a24; background:rgba(238,90,36,0.08); }

/* ── v7: UPGRADE CATEGORY HEADERS ── */
.upgrade-category {
  font-family:var(--display); font-weight:700; font-size:11px;
  letter-spacing:2px; text-transform:uppercase;
  color:var(--text-dim); padding:8px 4px 4px;
  border-bottom:1px solid var(--border); margin-bottom:6px; margin-top:10px;
}

/* ── NEW TAB ROW v2 ── */
.tab-row-v2 {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  padding: 8px 10px 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  align-items: center;
}
.tab-row-v2 .tab {
  padding: 4px 10px;
  border-radius: 4px 4px 0 0;
  cursor: pointer;
  font-family: var(--display);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--text-dim);
  border: 1px solid transparent;
  border-bottom: none;
  transition: all 0.15s;
  white-space: nowrap;
}
.tab-row-v2 .tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.tab-row-v2 .tab.active {
  color: var(--text-bright);
  background: var(--bg3);
  border-color: var(--border);
  border-bottom: 2px solid var(--accent);
}
.tab-group-label {
  font-size: 8px;
  font-family: var(--mono);
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(90,100,128,0.6);
  padding: 0 4px;
  border-left: 1px solid var(--border);
  margin-left: 4px;
  line-height: 1;
  align-self: center;
}
.tab-group-label:first-child {
  border-left: none;
  margin-left: 0;
  padding-left: 0;
}

/* ── v7: BETERE TOPBAR STATS ── */
.stat-pill.danger  { border-color:rgba(255,61,90,0.4); }
.stat-pill.success { border-color:rgba(127,255,110,0.3); }

/* ── SVG PRINTER ANIMATIONS ── */
@keyframes headTravel { 0%{transform:translateX(-70px)} 50%{transform:translateX(70px)} 100%{transform:translateX(-70px)} }
@keyframes fanSpin { 0%{stroke-dashoffset:0} 100%{stroke-dashoffset:16} }
@keyframes nozzleGlow { 0%,100%{opacity:0.4;r:4} 50%{opacity:1;r:7} }
@keyframes strandPulse { 0%,100%{stroke-width:2;opacity:0.5} 50%{stroke-width:3;opacity:0.9} }
.printing #svg-head { animation: headTravel 2s ease-in-out infinite; }
.printing #fan-circle { animation: fanSpin 0.3s linear infinite; }
.printing #nozzle-glow { animation: nozzleGlow 1s ease-in-out infinite; fill: rgba(255,107,53,0.4); }
.printing #svg-strand { stroke: rgba(255,107,53,0.7); animation: strandPulse 2s ease-in-out infinite; }
.printing #svg-nozzle { fill: rgba(255,130,60,1); }
.success-pulse #printer-svg { filter: drop-shadow(0 0 8px rgba(127,255,110,0.8)); }

/* ── v8: SVG PRINTER LAYER GROW ── */
/* controlled via JS setAttribute */

/* ── v7: NOTIFICATION CENTER ── */
.notif-center {
  position:fixed; top:60px; right:16px; z-index:500;
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; width:280px;
  box-shadow:0 12px 40px rgba(0,0,0,0.5);
  display:none; animation:popIn 0.25s cubic-bezier(0.34,1.56,0.64,1);
  max-height:400px; overflow-y:auto;
}
.notif-center.open { display:block; }
.notif-center-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; border-bottom:1px solid var(--border);
  font-family:var(--display); font-weight:700; font-size:13px;
}
.notif-item {
  padding:10px 14px; border-bottom:1px solid rgba(42,48,69,0.4);
  font-size:10px; line-height:1.5;
}
.notif-item:last-child { border-bottom:none; }
.notif-item-title { font-family:var(--display); font-weight:700; font-size:12px; color:var(--text-bright); }
.notif-item-time { font-size:9px; color:var(--text-dim); float:right; }
.notif-clear { padding:8px 14px; text-align:center; color:var(--text-dim); font-size:10px; cursor:pointer; }
.notif-clear:hover { color:var(--danger); }

/* ── v7: SMOOTHERE PROGRESS BARS ── */
.big-progress-fill {
  transition: width 0.3s linear !important;
}

/* ── v8: RESEARCH TREE ── */
.research-tree { display:flex; flex-direction:column; gap:8px; }
.research-tier { margin-bottom:4px; }
.research-tier-label { font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); padding:4px 0; border-bottom:1px solid var(--border); margin-bottom:6px; }
.research-row { display:flex; gap:6px; flex-wrap:wrap; }
.research-node {
  flex:1; min-width:110px; background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px; cursor:pointer;
  transition:all 0.2s; position:relative; overflow:hidden;
}
.research-node::before { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:var(--border); }
.research-node.researched::before { background:var(--accent3); }
.research-node.researching::before { background:var(--accent); animation:researchPulse 1s ease-in-out infinite; }
.research-node.available { border-color:rgba(0,229,255,0.35); }
.research-node.researched { border-color:var(--accent3); opacity:0.75; }
.research-node.locked-node { opacity:0.3; cursor:not-allowed; }
.research-node:hover:not(.locked-node):not(.researched) { border-color:var(--accent); transform:translateY(-1px); }
.research-icon { font-size:20px; margin-bottom:4px; }
.research-name { font-family:var(--display); font-weight:700; font-size:12px; color:var(--text-bright); }
.research-desc { font-size:9px; color:var(--text-dim); margin-top:3px; line-height:1.4; }
.research-cost { font-size:10px; color:var(--warn); margin-top:4px; font-family:var(--display); font-weight:700; }
.research-time { font-size:9px; color:var(--text-dim); }
.research-progress { height:3px; background:var(--bg); border-radius:2px; margin-top:6px; overflow:hidden; }
.research-prog-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.5s; }
@keyframes researchPulse { 0%,100%{opacity:1;}50%{opacity:0.4;} }
.active-research-banner {
  background:rgba(0,229,255,0.06); border:1px solid rgba(0,229,255,0.2);
  border-radius:var(--radius); padding:10px 12px; display:flex; gap:10px; align-items:center;
  margin-bottom:8px;
}
.arb-icon { font-size:22px; }
.arb-name { font-family:var(--display); font-weight:700; font-size:13px; }
.arb-sub { font-size:9px; color:var(--text-dim); }
.arb-bar { flex:1; height:5px; background:var(--bg); border-radius:3px; overflow:hidden; margin-top:4px; }
.arb-fill { height:100%; background:linear-gradient(90deg,var(--accent2),var(--accent)); border-radius:3px; transition:width 0.5s; }

/* ── v8: SPECIAL ORDER TYPES ── */
.order-card.order-vip { border-left:3px solid #ffd700 !important; }
.order-card.order-rush { border-left:3px solid var(--danger) !important; }
.order-card.order-bulk { border-left:3px solid var(--accent3) !important; }
.order-card.order-mystery { border-left:3px solid var(--pro) !important; }
.tag-vip   { background:rgba(255,215,0,0.15); color:#ffd700; }
.tag-rush  { background:rgba(255,61,90,0.15);  color:var(--danger); }
.tag-bulk  { background:rgba(127,255,110,0.15);color:var(--accent3); }
.tag-mystery { background:rgba(167,139,250,0.15);color:var(--pro); }
.special-order-glow-vip { box-shadow:0 0 12px rgba(255,215,0,0.25); }
.special-order-glow-rush { animation:urgentPulse 0.8s ease-in-out infinite; }

/* ── v8: MILESTONE SYSTEM ── */
.milestone-banner {
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.8);
  background:var(--panel); border:2px solid var(--warn);
  border-radius:16px; padding:28px 36px; z-index:9000;
  box-shadow:0 0 80px rgba(255,204,0,0.4);
  text-align:center; max-width:400px; width:90%;
  animation:milestonePop 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
@keyframes milestonePop { 0%{transform:translate(-50%,-50%) scale(0.5);opacity:0;} 100%{transform:translate(-50%,-50%) scale(1);opacity:1;} }
.milestone-icon { font-size:52px; margin-bottom:8px; }
.milestone-title { font-family:var(--display); font-weight:900; font-size:26px; color:var(--warn); letter-spacing:2px; }
.milestone-desc { color:var(--text-dim); font-size:12px; margin:8px 0; line-height:1.6; }
.milestone-reward { font-family:var(--display); font-weight:900; font-size:32px; color:var(--accent3); margin:12px 0 4px; }
.milestone-reward-sub { font-size:10px; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; }
#milestone-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:8999; display:none; backdrop-filter:blur(3px); }

/* ── v8: EQUIPMENT EVENTS ── */
.equip-event-card {
  background:rgba(255,61,90,0.06); border:1px solid rgba(255,61,90,0.3);
  border-radius:var(--radius); padding:12px; margin-bottom:8px;
  animation:fadeIn 0.3s ease;
}
.equip-event-title { font-family:var(--display); font-weight:900; font-size:14px; color:var(--danger); }
.equip-event-desc { font-size:10px; color:var(--text-dim); margin:4px 0 8px; line-height:1.5; }

/* ── v8: DASHBOARD TAB ── */
.dashboard-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
.dash-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; }
.dash-card-label { font-size:9px; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
.dash-card-value { font-family:var(--display); font-weight:900; font-size:22px; color:var(--text-bright); }
.dash-card-trend { font-size:10px; margin-top:2px; }
.dash-trend-up { color:var(--accent3); }
.dash-trend-down { color:var(--danger); }
.dash-efficiency-bar { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; margin-top:6px; }
.dash-eff-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--danger),var(--warn),var(--accent3)); }
.kpi-row { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
.kpi-pill { flex:1; min-width:70px; background:var(--bg3); border:1px solid var(--border); border-radius:20px; padding:6px 12px; text-align:center; }
.kpi-val { font-family:var(--display); font-weight:900; font-size:16px; color:var(--accent); }
.kpi-lbl { font-size:10px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; }

/* ── v8: REPUTATION TIERS ── */
.rep-tier-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:10px; font-size:9px; font-family:var(--display); font-weight:700; letter-spacing:1px; text-transform:uppercase; }
.rep-tier-0 { background:rgba(90,100,128,0.2); color:var(--text-dim); }
.rep-tier-1 { background:rgba(0,229,255,0.12); color:var(--accent); border:1px solid rgba(0,229,255,0.25); }
.rep-tier-2 { background:rgba(255,204,0,0.12); color:var(--warn); border:1px solid rgba(255,204,0,0.25); }
.rep-tier-3 { background:rgba(127,255,110,0.12); color:var(--accent3); border:1px solid rgba(127,255,110,0.25); }
.rep-tier-4 { background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,107,53,0.1)); color:#ffd700; border:1px solid rgba(255,215,0,0.35); }

/* ── v8: ORDER DIFFICULTY STARS ── */
.difficulty-stars { display:inline-flex; gap:1px; margin-left:4px; vertical-align:middle; }
.diff-star { font-size:8px; }
.diff-star.filled { color:var(--warn); }
.diff-star.empty  { color:var(--border); }

/* ── v8: MARKET TREND SPARKLINE ── */
.sparkline-wrap { margin-top:6px; }
.sparkline-svg { display:block; }

/* ── v8: LATE GAME UPGRADE GLOW ── */
.upgrade-card.tier3 { border-color:rgba(255,107,53,0.4); }
.upgrade-card.tier3 .upgrade-name { color:var(--accent2); }
.upgrade-card.tier4 { border-color:rgba(167,139,250,0.5); background:linear-gradient(135deg,rgba(167,139,250,0.04),transparent); }
.upgrade-card.tier4 .upgrade-name { color:var(--pro); }

/* ── v8: RUSH ORDER COUNTDOWN ── */
@keyframes rushFlash { 0%,100%{background:rgba(255,61,90,0.04);}50%{background:rgba(255,61,90,0.12);} }
.order-card.order-rush { animation:rushFlash 0.6s ease-in-out infinite; }
.order-card.order-flash { border:2px solid #ffd700 !important; animation:rushFlash 0.4s ease-in-out infinite; background:rgba(255,215,0,0.07) !important; }
.flash-countdown { font-family:var(--display); font-weight:900; font-size:13px; color:#ffd700; text-shadow:0 0 8px rgba(255,215,0,0.6); }

/* ── v8: PRINTER HEAT GLOW ── */
.printer-card.overheating { box-shadow:0 0 16px rgba(255,107,53,0.4); border-color:var(--accent2) !important; }

/* ── v8: NOTIFICATION FEED ── */
.notif-feed-item { display:flex; gap:8px; align-items:flex-start; padding:8px 0; border-bottom:1px solid rgba(42,48,69,0.4); }
.notif-feed-item:last-child { border-bottom:none; }
.notif-feed-icon { font-size:16px; flex-shrink:0; margin-top:1px; }
.notif-feed-body { flex:1; }
.notif-feed-title { font-size:11px; font-family:var(--display); font-weight:700; color:var(--text-bright); }
.notif-feed-sub { font-size:9px; color:var(--text-dim); margin-top:1px; }
.notif-feed-time { font-size:9px; color:var(--text-dim); white-space:nowrap; flex-shrink:0; }

/* ── v8: BOUNTY BOARD ── */
.bounty-card {
  background:linear-gradient(135deg,rgba(255,215,0,0.06),rgba(255,107,53,0.03));
  border:1px solid rgba(255,215,0,0.3); border-radius:var(--radius);
  padding:12px; margin-bottom:8px; position:relative; overflow:hidden;
}
.bounty-card::before { content:'BOUNTY'; position:absolute; top:6px; right:8px; font-size:8px; letter-spacing:2px; color:rgba(255,215,0,0.4); font-family:var(--display); font-weight:900; }
.bounty-name { font-family:var(--display); font-weight:900; font-size:15px; color:#ffd700; margin-bottom:4px; }
.bounty-req { font-size:10px; color:var(--text-dim); line-height:1.6; }
.bounty-reward { font-family:var(--display); font-weight:900; font-size:20px; color:var(--accent3); }
.bounty-expires { font-size:9px; color:var(--danger); margin-top:4px; }
.bounty-claimed { opacity:0.4; pointer-events:none; }

/* ── v8: LIVE EFFICIENCY METER ── */
#efficiency-display {
  position:fixed; bottom:16px; left:16px; z-index:100;
  background:var(--panel); border:1px solid var(--border);
  border-radius:8px; padding:8px 14px; display:none;
  font-size:10px; color:var(--text-dim);
  transition:opacity 0.3s;
}
#efficiency-display.active { display:block; }
.eff-label { font-size:10px; letter-spacing:2px; text-transform:uppercase; margin-bottom:3px; }
.eff-value { font-family:var(--display); font-weight:900; font-size:20px; color:var(--accent3); }
.eff-sub { font-size:9px; color:var(--text-dim); }

/* ── v7: FILAMENT STOCK WARNING ── */
@keyframes stockWarn { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
.stock-critical { animation:stockWarn 1s infinite; }
.stock-fil-dot { width:7px; height:7px; border-radius:50%; display:inline-block; flex-shrink:0; }

/* ── v7: SUPPLIER CRISIS TOAST ── */
.crisis-toast {
  position:fixed; top:76px; right:20px;
  background:var(--panel); border:2px solid var(--danger);
  border-radius:var(--radius); padding:12px 16px; z-index:400;
  max-width:280px; box-shadow:0 8px 32px rgba(255,61,90,0.3);
  animation:toastIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
}

/* ══════════════════════════════════════════════════════════
   v14: VISUAL JUICE & NARRATIVE EVENTS
   ══════════════════════════════════════════════════════════ */

/* ── MONEY SHOWER PARTICLES ── */
.money-particle {
  position: fixed; pointer-events: none; z-index: 9998;
  font-family: var(--display); font-weight: 900;
  animation: moneyFly var(--dur,1.2s) cubic-bezier(0.22,0.61,0.36,1) forwards;
  will-change: transform, opacity;
}
@keyframes moneyFly {
  0%   { opacity:1; transform: translateY(0) scale(1) rotate(var(--r,0deg)); }
  60%  { opacity:1; }
  100% { opacity:0; transform: translateY(var(--dy,-140px)) translateX(var(--dx,0px)) scale(0.5) rotate(var(--r2,30deg)); }
}

/* ── SPARK PARTICLES (nozzle) ── */
.spark-canvas { position:absolute; inset:0; pointer-events:none; z-index:10; border-radius:var(--radius); }

/* ── SUCCESS BURST ── */
.success-burst {
  position: fixed; pointer-events:none; z-index:9997;
  width: 6px; height: 6px; border-radius:50%;
  animation: burstFly var(--dur,0.9s) ease-out forwards;
  will-change: transform, opacity;
}
@keyframes burstFly {
  0%   { opacity:1; transform:translate(0,0) scale(1); }
  100% { opacity:0; transform:translate(var(--tx,0px), var(--ty,0px)) scale(0); }
}

/* ── SCREEN SUCCESS FLASH ── */
.screen-success-flash {
  position:fixed; inset:0; pointer-events:none; z-index:9996;
  background: radial-gradient(ellipse at center, rgba(127,255,110,0.18) 0%, transparent 70%);
  animation: flashFade 0.7s ease-out forwards;
}
@keyframes flashFade { 0%{opacity:1} 100%{opacity:0} }

/* ── SCREEN FAIL FLASH (improved shake) ── */
@keyframes screenShake {
  0%,100%{ transform:translateX(0); }
  15%    { transform:translateX(-8px) rotate(-0.5deg); }
  30%    { transform:translateX(8px)  rotate(0.5deg); }
  45%    { transform:translateX(-5px); }
  60%    { transform:translateX(5px); }
  75%    { transform:translateX(-2px); }
}
body.shaking { animation: screenShake 0.5s ease-out; }

/* ── COMBO VISUAL UPGRADE ── */
#combo-display {
  border: 1px solid var(--warn);
  box-shadow: 0 0 20px rgba(255,204,0,0.3), inset 0 0 20px rgba(255,204,0,0.05);
}

/* ── NARRATIVE EVENT OVERLAY ── */
#narrative-overlay {
  display: none; position: fixed; inset: 0; z-index: 8000;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(6px);
  align-items: center; justify-content: center;
}
#narrative-overlay.active { display: flex; }
.narrative-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  max-width: 500px; width: 92%;
  box-shadow: 0 24px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.04);
  animation: narrativePop 0.4s cubic-bezier(0.34,1.4,0.64,1) forwards;
  overflow: hidden;
}
@keyframes narrativePop {
  0%  { transform: scale(0.85) translateY(24px); opacity:0; }
  100%{ transform: scale(1) translateY(0);       opacity:1; }
}
.narrative-header {
  padding: 20px 24px 0;
  display: flex; align-items: flex-start; gap: 16px;
}
.narrative-portrait {
  width: 64px; height: 64px; border-radius: 50%;
  background: var(--bg3); border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; flex-shrink: 0;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
.narrative-meta { flex: 1; }
.narrative-tag {
  font-size: 9px; letter-spacing: 2px; text-transform: uppercase;
  color: var(--text-dim); margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
}
.narrative-tag::before { content:''; display:inline-block; width:6px; height:6px; border-radius:50%; background:var(--accent); box-shadow:0 0 6px var(--accent); }
.narrative-title {
  font-family: var(--display); font-weight: 900; font-size: 22px;
  color: var(--text-bright); line-height: 1.2; letter-spacing: 0.5px;
}
.narrative-body {
  padding: 16px 24px 20px;
  font-size: 12px; color: var(--text); line-height: 1.8;
  border-bottom: 1px solid var(--border);
}
.narrative-body em { color: var(--warn); font-style: normal; font-weight: 700; }
.narrative-body strong { color: var(--accent); }
.narrative-choices { padding: 16px 24px; display: flex; flex-direction: column; gap: 8px; }
.narrative-btn {
  display: flex; align-items: center; gap: 12px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 16px; cursor: pointer;
  transition: all 0.15s; text-align: left;
}
.narrative-btn:hover { border-color: var(--accent); background: rgba(0,229,255,0.05); transform: translateX(2px); }
.narrative-btn.good:hover  { border-color: var(--accent3); background: rgba(127,255,110,0.06); }
.narrative-btn.bad:hover   { border-color: var(--danger);  background: rgba(255,61,90,0.06);  }
.narrative-btn.risky:hover { border-color: var(--warn);    background: rgba(255,204,0,0.06);  }
.narrative-btn-icon { font-size: 20px; flex-shrink:0; }
.narrative-btn-text { flex: 1; }
.narrative-btn-label { font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--text-bright); }
.narrative-btn-effect { font-size: 10px; color: var(--text-dim); margin-top: 2px; letter-spacing: 0.5px; }
.narrative-btn.good  .narrative-btn-effect { color: var(--accent3); }
.narrative-btn.bad   .narrative-btn-effect { color: var(--danger);  }
.narrative-btn.risky .narrative-btn-effect { color: var(--warn);    }

/* ── OUTCOME TOAST (after narrative choice) ── */
.outcome-toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  background: var(--panel); border-radius: 12px;
  padding: 14px 24px; z-index: 9000; text-align: center;
  font-family: var(--display); font-weight: 700; font-size: 16px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  animation: outcomePop 0.4s cubic-bezier(0.34,1.5,0.64,1) forwards;
  pointer-events: none;
}
@keyframes outcomePop {
  0%  { opacity:0; transform:translateX(-50%) scale(0.8) translateY(10px); }
  100%{ opacity:1; transform:translateX(-50%) scale(1)   translateY(0);     }
}

/* ── LEVEL-UP SEQUENCE UPGRADE ── */
.levelup-flash {
  position:fixed; inset:0; z-index:9500; pointer-events:none;
  display:flex; align-items:center; justify-content:center;
  animation: lvlFade 2.6s ease-out forwards;
  background: radial-gradient(ellipse at center, rgba(0,229,255,0.2) 0%, transparent 70%);
}
@keyframes lvlFade { 0%{opacity:0} 10%{opacity:1} 70%{opacity:1} 100%{opacity:0} }
.levelup-text {
  font-family:var(--display); font-weight:900; font-size:52px;
  text-align:center; color:var(--text-bright); letter-spacing:4px;
  text-shadow:0 0 40px var(--accent), 0 0 80px rgba(0,229,255,0.5);
  animation: lvlPulse 0.6s ease-out;
}
@keyframes lvlPulse { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }

/* ── PRINTER CARD GLOW WHEN PRINTING ── */
.printer-card.active {
  box-shadow: 0 0 0 1px rgba(0,229,255,0.4), 0 4px 24px rgba(0,229,255,0.12);
}

/* ── ORDER CARD FILAMENT GLOW ── */
.order-card.order-pla:hover  { box-shadow: 0 0 16px rgba(79,195,247,0.2);  }
.order-card.order-petg:hover { box-shadow: 0 0 16px rgba(206,147,216,0.2); }
.order-card.order-pa6:hover  { box-shadow: 0 0 16px rgba(255,171,64,0.2);  }

/* ── TOPBAR MONEY FLASH ── */
@keyframes moneyGainPulse {
  0%  { color:#7fff6e; transform:scale(1.2); text-shadow:0 0 12px #7fff6e; }
  100%{ color:inherit; transform:scale(1);   text-shadow:none; }
}
.money-gained { animation: moneyGainPulse 0.45s ease-out forwards; }

/* ── NARRATIVE SKIP LINK ── */
.narrative-skip { text-align:center; padding:0 24px 16px; }
.narrative-skip-btn { font-size:9px; color:var(--text-dim); cursor:pointer; letter-spacing:1px; text-transform:uppercase; background:none; border:none; }
.narrative-skip-btn:hover { color:var(--danger); }

:root{
  --g: clamp(10px, 2.5vw, 16px);
  --r: 16px;
  --text: clamp(14px, 2.8vw, 16px);
  --h1: clamp(18px, 4.2vw, 26px);
  --nav-h: 62px;

  /* Visual polish (v14.1) */
  --radius: var(--r);
  --radius-sm: 12px;
  --shadow-1: 0 10px 30px rgba(0,0,0,0.35);
  --shadow-2: 0 18px 55px rgba(0,0,0,0.55);
  --glow-cyan: 0 0 28px rgba(0,229,255,0.18);
  --glow-green: 0 0 28px rgba(127,255,110,0.18);
  --glass: rgba(19,22,30,0.72);
  --glass2: rgba(22,27,38,0.72);
}

/* Global typography */
body{ font-size: var(--text); }
.panel, .stat-pill, .telem-cell, .printer-card, .order-card { border-radius: var(--r); }
.panel-body{ gap: var(--g); }

/* Premium cards & buttons */
body{
  background-image:
    radial-gradient(ellipse 90% 45% at 50% -15%, rgba(0,229,255,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 70% 35% at 10% 10%, rgba(167,139,250,0.06) 0%, transparent 62%),
    radial-gradient(ellipse 60% 30% at 90% 18%, rgba(255,107,53,0.05) 0%, transparent 65%),
    repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.22) 39px, rgba(42,48,69,0.22) 40px),
    repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.22) 39px, rgba(42,48,69,0.22) 40px);
}

.panel{
  box-shadow: var(--shadow-1);
  border-color: rgba(42,48,69,0.85);
  background: linear-gradient(180deg, rgba(22,27,38,0.95), rgba(18,22,31,0.92));
}
.panel-header{
  background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
}

.stat-pill{
  box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  background: linear-gradient(180deg, rgba(26,30,42,0.9), rgba(19,22,30,0.9));
  border-color: rgba(42,48,69,0.8);
}

.btn{
  box-shadow: 0 10px 22px rgba(0,0,0,0.28);
  border: 1px solid rgba(255,255,255,0.06);
  backdrop-filter: blur(6px);
  -webkit-tap-highlight-color: transparent;
}
.btn-primary{
  background: linear-gradient(135deg, rgba(0,229,255,1), rgba(0,229,255,0.75));
}
.btn-ghost{
  background: linear-gradient(180deg, rgba(26,30,42,0.9), rgba(19,22,30,0.9));
}
.btn:focus-visible{
  outline: 2px solid rgba(0,229,255,0.55);
  outline-offset: 2px;
}

/* Pop animation utility */
@keyframes uiPop{ 0%{ transform: scale(0.98); } 55%{ transform: scale(1.03); } 100%{ transform: scale(1); } }
.ui-pop{ animation: uiPop 420ms cubic-bezier(.2,.9,.2,1); }

/* Safe area */
#topbar{
  padding-top: calc(10px + env(safe-area-inset-top));
}
#main{
  padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
}

/* Printer stage: keep consistent ratio and avoid squish */
.print-stage{
  width: 100%;
}
.product-canvas-wrap{
  width: 100%;
  aspect-ratio: 16 / 10;
  max-height: min(56vh, 520px);
  border-radius: 18px;
  overflow: hidden;
}
#print-canvas{
  width: 100%;
  height: 100%;
  display: block;
  touch-action: pan-y;
}

/* Telemetry strip wraps nicely */
.telem-strip{ gap: 10px; }
.telem-cell{ min-width: 0; }

/* Prevent layout overflow from long labels on mobile */
*{ min-width: 0; }

/* Prefer reduced motion support */
@media (prefers-reduced-motion: reduce){
  *{ animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
}

@media (max-width: 900px){
  /* Main becomes one column */
  #main{
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
    padding-left: var(--g);
    padding-right: var(--g);
    padding-bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 14px);
  }

  /* Reduce topbar clutter a bit */
  #topbar .logo{ font-size: 18px; }
  #topbar{ gap: 8px; }
  #topbar .stat-pill{ padding: 8px 10px; }

  /* Bottom nav: turn right-column tab row into fixed app nav */
  .main-nav{
    position: fixed;
    left: 10px;
    right: 10px;
    bottom: calc(env(safe-area-inset-bottom) + 10px);
    height: var(--nav-h);
    z-index: 1000;
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    overflow-x: auto;
    gap: 10px !important;

    padding: 10px 10px;
    border-radius: 18px;
    background: rgba(10, 12, 18, 0.88);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 10px 40px rgba(0,0,0,0.45);
  }
  .main-nav::-webkit-scrollbar{ display:none; }

  .main-nav .tab-group-label{ display:none !important; }

  .main-nav .tab{
    flex: 0 0 auto;
    height: calc(var(--nav-h) - 20px);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 12px !important;
    border-radius: 14px !important;
    font-size: 14px;
    line-height: 1;
    white-space: nowrap;
    min-width: 92px;
  }

  /* Make primary actions easier to hit */
  button, .btn{
    min-height: 44px;
    padding: 12px 14px;
    border-radius: 14px;
  }

  /* Panels: reduce dense headers */
  .panel-header{
    padding: 12px 12px;
  }
  .panel-body{
    padding: 12px;
  }

  /* Telemetry: 2x2 grid feel */
  .telem-strip{
    display: grid;
    grid-template-columns: 1fr 1fr;
  }
}

/* Super small phones */
@media (max-width: 420px){
  .main-nav .tab{ min-width: 84px; font-size: 13px; }
  .product-canvas-wrap{ max-height: 48vh; }
}

:root{
  --gap: clamp(10px, 2.6vw, 16px);
  --radius-lg: 16px;
  --shadow-1: 0 10px 24px rgba(0,0,0,.35);
  --shadow-2: 0 18px 40px rgba(0,0,0,.45);
  --glass: rgba(255,255,255,.06);
  --glass-2: rgba(255,255,255,.09);
  --muted: rgba(212,218,232,.72);
}

html, body { background: var(--bg); color: var(--text); }
body{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

h1,h2,h3,h4,.biz-level-name,.job-title,.stage-job-name,.tab,.graph-label,
.printer-title,.printer-name,.shop-item-title,.upgrade-name,.research-node-title{
  color: var(--text-bright) !important;
}

.small, .muted, .text-dim, .telem-label, .telem-sub, .tab-group-label{
  color: var(--muted) !important;
}

.panel, .card, .tab-content{
  background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadow-1);
}

.panel{ border-radius: var(--radius-lg); }
.tab-content{ border-radius: var(--radius-lg); }

button, .btn, .tab{
  min-height: 44px;
  border-radius: 14px;
}

.tab{
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.tab:active{ transform: scale(.98); }

input, select{
  color: var(--text-bright);
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 12px;
}

input::placeholder{ color: rgba(212,218,232,.45); }

a{ color: var(--accent); }

/* make sure scroll areas remain usable */
.panel-body{ min-width: 0; }

@media (max-width: 900px){
  /* ensure content not hidden behind bottom nav */
  body{ padding-bottom: calc(72px + env(safe-area-inset-bottom)); }
  .tab-row-v2.main-nav{
    position: fixed;
    left: 10px;
    right: 10px;
    bottom: calc(10px + env(safe-area-inset-bottom));
    z-index: 80;
    display: flex;
    flex-direction: row;
    gap: 8px;
    padding: 10px;
    border-radius: 18px;
    overflow-x: auto;
    background: rgba(10,14,24,.65);
    border: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    box-shadow: var(--shadow-2);
  }
  .tab-row-v2.main-nav::-webkit-scrollbar{ height: 0px; }
  .tab-row-v2.main-nav .tab-group-label{ display:none !important; }
  .tab-row-v2.main-nav .tab{
    flex: 0 0 auto;
    padding: 10px 12px;
    font-size: 14px;
    line-height: 1;
    white-space: nowrap;
  }
  .tab-row-v2.main-nav .tab.more{
    background: rgba(255,255,255,.07);
    border: 1px solid rgba(255,255,255,.14);
  }
  /* the main page layout should become single column */
  #main{ flex-direction: column !important; }
}

/* More modal */
.more-modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  z-index: 300;
}
.more-modal.open{ display:flex; flex-direction:column; }
.more-sheet{
  margin-top: auto;
  width: 100%;
  max-height: 72vh;
  background: rgba(14,18,30,.92);
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  border: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow: var(--shadow-2);
  overflow: hidden;
}
.more-sheet-header{
  display:flex;
  justify-content: space-between;
  align-items:center;
  padding: 14px 16px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.more-sheet-title{ font-family: var(--display); font-weight: 800; letter-spacing: .6px; color: var(--text-bright); }
.more-sheet-body{
  padding: 10px 12px 14px;
  overflow:auto;
}
.more-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.more-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding: 12px 10px;
  border-radius: 16px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: var(--text-bright);
}
.more-btn:active{ transform: scale(.98); }
@media (max-width: 420px){
  .more-grid{ grid-template-columns: 1fr; }
}

/* ensure printer title not black anywhere */
#biz-level-name, .biz-level-name, .job-title, .job-subtitle, .stage-job-name,
#stage-job-name, #job-title, #job-subtitle{
  color: var(--text-bright) !important;
}

.tab-content{ display:none; }
.tab-content.active{ display:block; }

/* ── FLOATING TEXT JUICE ─────────────────────────────────── */
#float-layer{position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:visible;}
.float-text{
  position:absolute; left:0; top:0;
  transform:translate(-50%,-50%);
  font-family:var(--display, system-ui);
  font-weight:900;
  font-size:12px;
  letter-spacing:0.2px;
  padding:2px 6px;
  border-radius:10px;
  color:var(--text-bright);
  background:rgba(0,0,0,0.28);
  border:1px solid rgba(255,255,255,0.10);
  box-shadow:0 10px 26px rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  opacity:0;
  will-change: transform, opacity, filter;
  animation: floatUp 900ms ease-out forwards;
}
.float-text.good{ color:#d7ffe5; border-color: rgba(120,255,190,0.25); background: rgba(0, 120, 60, 0.18); }
.float-text.bad{  color:#ffd7d7; border-color: rgba(255,120,120,0.25); background: rgba(120, 0, 0, 0.16); }
.float-text.big{ font-size:14px; padding:3px 8px; }

@keyframes floatUp{
  0%   { opacity:0; transform:translate(-50%,-35%) scale(0.96); filter: blur(0px); }
  12%  { opacity:1; transform:translate(-50%,-50%) scale(1.00); }
  100% { opacity:0; transform:translate(-50%,-95%) scale(1.02); filter: blur(0.3px); }
}

/* ── Smoother progress bars (printer cards + all bars) ───── */
.progress-fill,
.combo-bar-fill{
  transition: width 260ms ease;
}

/* ── Mobile visibility safety ─────────────────────────────── */
.tab-content{min-width:0;}
.tab-content.active{display:block;}
@media (max-width: 900px){
  .tab-content{padding-bottom: calc(env(safe-area-inset-bottom) + 96px) !important;}
  #main{min-height: calc(100vh - 110px);}
}

/* ── MOBILE: essentials above bottom nav ── */
body.layout-mobile #orders-contracts-panel{ min-height: 52vh; }
body.layout-mobile .ptab-body{ padding-bottom: calc(env(safe-area-inset-bottom) + 84px); }

/* ─────────────────────────────────────────────────────────────
   MOBILE TAB VISIBILITY FIX
   - Make the main tab row always reachable on mobile:
     becomes a bottom nav, horizontally scrollable.
   - Prevent content being hidden behind the bar.
   ───────────────────────────────────────────────────────────── */
@media (max-width: 900px){
  .tab-row{
    position: fixed;
    left: 0; right: 0;
    bottom: 0;
    z-index: 2000;
    padding: 8px 10px calc(env(safe-area-inset-bottom) + 10px);
    background: rgba(10, 14, 22, 0.82);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.10);
    border-bottom: none;

    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
    gap: 8px;
  }
  .tab-row .tab{
    flex: 0 0 auto;
    white-space: nowrap;
    padding: 10px 12px;
    min-height: 44px;
    border-radius: 14px;
  }

  /* If you have group labels like CORE / MANAGE, hide them on mobile */
  .tab-row .tab-group,
  .tab-row .tab-group-label{
    display: none !important;
  }

  /* Ensure main content isn't covered by the fixed bottom bar */
  #main,
  .app,
  .panel,
  .panel-body{
    padding-bottom: calc(env(safe-area-inset-bottom) + 84px);
  }
}

body.layout-mobile .tab-row{
  position: fixed;
  left: 0; right: 0;
  bottom: 0;
  z-index: 2000;
  padding: 8px 10px calc(env(safe-area-inset-bottom) + 10px);
  background: rgba(10, 14, 22, 0.82);
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(255,255,255,0.10);
  overflow-x: auto;
  white-space: nowrap;
  gap: 8px;
}
body.layout-mobile .tab-row .tab{
  flex: 0 0 auto;
  min-height: 44px;
  padding: 10px 12px;
  border-radius: 14px;
}
body.layout-mobile #main {
  padding-bottom: calc(env(safe-area-inset-bottom) + 84px);
}

/* ── MOBILE BUTTON SYSTEM (polished) ── */
.btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    position: relative; overflow: hidden;
    border-radius: 16px !important;
    padding: 13px 18px !important;
    font-size: 13px !important;
    font-weight: 800 !important;
    letter-spacing: 0.4px;
    border: none !important;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease !important;
    /* Solid base shadow for depth */
    box-shadow: 0 5px 0 rgba(0,0,0,0.55), 0 8px 20px rgba(0,0,0,0.3) !important;
}
/* Ripple on active press */
.btn::after {
    content: '';
    position: absolute; inset: 0; border-radius: inherit;
    background: radial-gradient(circle at center, rgba(255,255,255,0.22) 0%, transparent 70%);
    opacity: 0; transition: opacity 0.15s;
    pointer-events: none;
}
.btn:active::after { opacity: 1; }
.btn:active {
    transform: translateY(4px) !important;
    box-shadow: 0 1px 0 rgba(0,0,0,0.55), 0 3px 8px rgba(0,0,0,0.3) !important;
    filter: brightness(0.92) !important;
}
.btn:disabled {
    opacity: 0.45 !important; cursor: not-allowed !important;
    transform: none !important; box-shadow: none !important;
}
/* Primary: vibrant cyan pill */
.btn-primary {
    background: linear-gradient(160deg, #1aefff 0%, #00c8e8 55%, #00a8c8 100%) !important;
    color: #001820 !important;
    box-shadow: 0 5px 0 #006a84, 0 8px 20px rgba(0,229,255,0.35) !important;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
}
.btn-primary:active { box-shadow: 0 1px 0 #006a84, 0 2px 8px rgba(0,229,255,0.2) !important; }
/* Danger */
.btn-danger {
    background: linear-gradient(160deg, #ff6b7a 0%, #ff3d5a 60%, #e0002a 100%) !important;
    color: white !important;
    box-shadow: 0 5px 0 #8a0020, 0 8px 20px rgba(255,61,90,0.35) !important;
}
.btn-danger:active { box-shadow: 0 1px 0 #8a0020, 0 2px 8px rgba(255,61,90,0.2) !important; }
/* Warn/secondary */
.btn-warn {
    background: linear-gradient(160deg, #ffd84d 0%, #ffcc00 60%, #e0aa00 100%) !important;
    color: #1a1000 !important;
    box-shadow: 0 5px 0 #7a5c00, 0 8px 20px rgba(255,204,0,0.35) !important;
}
.btn-warn:active { box-shadow: 0 1px 0 #7a5c00, 0 2px 8px rgba(255,204,0,0.2) !important; }
/* Ghost/subtle */
.btn-ghost {
    background: linear-gradient(180deg, rgba(40,48,70,0.95), rgba(26,30,44,0.95)) !important;
    color: var(--text) !important;
    border: 1px solid rgba(255,255,255,0.10) !important;
    box-shadow: 0 4px 0 rgba(0,0,0,0.5), 0 6px 16px rgba(0,0,0,0.25) !important;
}
.btn-ghost:active { box-shadow: 0 1px 0 rgba(0,0,0,0.5) !important; }
/* Small variant */
.btn-sm {
    padding: 9px 14px !important; font-size: 12px !important;
    border-radius: 12px !important;
    box-shadow: 0 3px 0 rgba(0,0,0,0.5), 0 5px 12px rgba(0,0,0,0.25) !important;
}
.btn-sm:active { box-shadow: 0 0px 0 rgba(0,0,0,0.5) !important; transform: translateY(3px) !important; }

/* Cards: subtle depth */
.panel, .printer-card, .upgrade-card, .order-card {
    border-radius: 16px !important;
    box-shadow: 0 6px 20px rgba(0,0,0,0.35) !important;
}

/* Bigger, thumb-friendly progress bars */
.progress-bar, .biz-xp-bar, .health-bar {
    height: 10px !important;
    border-radius: 5px !important;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.4) !important;
}
.progress-fill {
    border-radius: 5px !important;
    box-shadow: 0 1px 3px rgba(255,255,255,0.15) !important;
}

/* Always run the mobile app layout */
body{ overscroll-behavior: none; }
body.layout-mobile #main{
  grid-template-columns: 1fr !important;
  gap: 12px !important;
  padding: 12px !important;
  max-width: none !important;
  margin: 0 !important;
}

@media (min-width: 700px){
  body{
    display:flex;
    justify-content:center;
  }
  /* Constrain the whole UI to a phone-like width */
  #topbar, .market-bar, #main, #speedrun-bar, #season-banner{
    width: min(480px, 100%);
    margin-left: auto;
    margin-right: auto;
  }
  #topbar{
    left: auto;
    right: auto;
  }
  /* Add subtle side gutters (outside the "phone") */
  body::before, body::after{
    content:"";
    flex: 1 1 auto;
  }
}

/* Typography + taps: slightly bigger for thumb use */
:root{
  --nav-h: 66px;
}
body{ font-size: 13px; }
.btn{ min-height: 42px; }
.btn-sm{ min-height: 36px; }
.sound-btn, .notif-btn{ width: 40px; height: 40px; }

/* Bottom nav: more TikTok-like (compact labels, easy thumb reach) */
body.layout-mobile .main-nav{
  left: 10px !important;
  right: 10px !important;
  height: var(--nav-h) !important;
  padding: 10px 10px !important;
  border-radius: 22px !important;
}
body.layout-mobile .main-nav .tab-group-label{ display:none !important; }
body.layout-mobile .main-nav .tab{
  min-width: 92px;
  padding: 10px 12px !important;
  font-size: 12px !important;
  line-height: 1.1;
  display:flex !important;
  flex-direction: column !important;
  justify-content:center !important;
  align-items:center !important;
  gap: 4px !important;
}

/* Make the current "job" / print stage feel like the hero area */
.print-stage{ border-radius: 16px !important; }
.product-canvas-wrap{ height: 280px !important; }

/* layout-toggle removed */

details.acc {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}
details.acc + details.acc { margin-top: 10px; }

details.acc > summary {
  list-style: none;
  cursor: pointer;
  padding: 14px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  font-family: var(--display);
  font-weight: 900;
  font-size: 14px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-bright);
  background: rgba(0,0,0,0.12);
}
details.acc > summary::-webkit-details-marker { display:none; }

.acc-left {
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.acc-title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.acc-sub {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 0.5px;
  text-transform: none;
  color: var(--warn);
  opacity: 0.95;
  white-space: nowrap;
}
.acc-caret {
  width: 28px; height: 28px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.10);
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0;
  transition: transform 0.18s ease;
  font-size: 14px;
  color: var(--text-dim);
}
details.acc[open] .acc-caret { transform: rotate(180deg); color: var(--accent); border-color: rgba(0,229,255,0.35); }

.acc-body {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 65vh;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.acc-hint {
  font-size: 10px;
  color: var(--text-dim);
  line-height: 1.6;
}

/* ── ENHANCED NARRATIVE BUTTONS ── */
.narrative-btn {
  position: relative; overflow: hidden;
  background: linear-gradient(160deg, rgba(26,30,44,0.98), rgba(18,22,32,0.98)) !important;
  border: 1px solid rgba(255,255,255,0.09) !important;
  border-radius: 14px !important;
  transition: transform 0.12s ease, box-shadow 0.12s ease !important;
  box-shadow: 0 4px 0 rgba(0,0,0,0.45), 0 6px 16px rgba(0,0,0,0.25) !important;
  -webkit-tap-highlight-color: transparent;
}
.narrative-btn:active {
  transform: translateY(4px) !important;
  box-shadow: 0 0px 0 rgba(0,0,0,0.45), 0 2px 6px rgba(0,0,0,0.2) !important;
}
.narrative-btn.good  { border-left: 3px solid var(--accent3) !important; }
.narrative-btn.bad   { border-left: 3px solid var(--danger) !important; }
.narrative-btn.risky { border-left: 3px solid var(--warn) !important; }
.narrative-btn.good:hover  { background: linear-gradient(160deg, rgba(127,255,110,0.10), rgba(26,30,44,0.98)) !important; border-color: rgba(127,255,110,0.3) !important; }
.narrative-btn.bad:hover   { background: linear-gradient(160deg, rgba(255,61,90,0.10), rgba(26,30,44,0.98)) !important; border-color: rgba(255,61,90,0.3) !important; }
.narrative-btn.risky:hover { background: linear-gradient(160deg, rgba(255,204,0,0.08), rgba(26,30,44,0.98)) !important; border-color: rgba(255,204,0,0.3) !important; }

/* ── ENHANCED CHAT REPLY BUTTONS ── */
.chat-reply-btn {
  padding: 9px 12px !important;
  border-radius: 10px !important;
  font-size: 11px !important;
  font-family: var(--display) !important;
  font-weight: 700 !important;
  letter-spacing: 0.3px !important;
  border: 1.5px solid var(--border) !important;
  background: linear-gradient(160deg, rgba(28,33,50,0.98), rgba(20,24,36,0.98)) !important;
  color: var(--text) !important;
  transition: transform 0.1s, box-shadow 0.1s !important;
  box-shadow: 0 3px 0 rgba(0,0,0,0.4), 0 5px 14px rgba(0,0,0,0.2) !important;
  -webkit-tap-highlight-color: transparent;
}
.chat-reply-btn:active {
  transform: translateY(3px) !important;
  box-shadow: 0 0px 0 rgba(0,0,0,0.4) !important;
}
.chat-reply-btn.good  { border-color: rgba(127,255,110,0.4) !important; color: var(--accent3) !important; }
.chat-reply-btn.bad   { border-color: rgba(255,61,90,0.4) !important;   color: var(--danger) !important; }
.chat-reply-btn.risky { border-color: rgba(255,204,0,0.4) !important;   color: var(--warn) !important; }

/* ── START / REPAIR BUTTON HERO STYLE ── */
#start-job-btn {
  background: linear-gradient(160deg, #1aefff 0%, #00c8e8 55%, #00a8c8 100%) !important;
  color: #001820 !important;
  font-size: 15px !important; font-weight: 900 !important;
  letter-spacing: 1px !important;
  border-radius: 18px !important;
  min-height: 52px !important;
  box-shadow: 0 6px 0 #006a84, 0 10px 28px rgba(0,229,255,0.4) !important;
  animation: startBtnPulse 2.5s ease-in-out infinite;
}
#start-job-btn:active { animation: none !important; }
#start-job-btn:disabled { animation: none !important; opacity: 0.45 !important; box-shadow: none !important; }
@keyframes startBtnPulse {
  0%,100% { box-shadow: 0 6px 0 #006a84, 0 10px 28px rgba(0,229,255,0.3); }
  50%      { box-shadow: 0 6px 0 #006a84, 0 10px 38px rgba(0,229,255,0.6); }
}

/* ── FILAMENT BUTTONS: BIGGER TAP TARGETS ── */
.filament-btn {
  min-height: 52px !important; padding: 10px 8px !important;
  border-radius: 14px !important;
  font-size: 12px !important;
  color: var(--text) !important;
  background: linear-gradient(160deg, rgba(26,30,44,0.98), rgba(18,22,32,0.95)) !important;
  box-shadow: 0 3px 0 rgba(0,0,0,0.4), 0 5px 12px rgba(0,0,0,0.2) !important;
  transition: transform 0.1s, box-shadow 0.1s !important;
  -webkit-tap-highlight-color: transparent;
}
.filament-btn:active { transform: translateY(3px) !important; box-shadow: 0 0px 0 rgba(0,0,0,0.4) !important; }
.filament-btn.selected-pla  { box-shadow: 0 3px 0 rgba(36,110,155,0.8), 0 6px 16px rgba(79,195,247,0.25) !important; }
.filament-btn.selected-petg { box-shadow: 0 3px 0 rgba(100,50,120,0.8), 0 6px 16px rgba(206,147,216,0.25) !important; }
.filament-btn.selected-pa6  { box-shadow: 0 3px 0 rgba(140,80,0,0.8), 0 6px 16px rgba(255,171,64,0.25) !important; }

/* ── QUALITY BUTTONS ── */
.quality-btn {
  min-height: 48px !important; border-radius: 14px !important;
  font-size: 12px !important;
  color: var(--text) !important;
  background: linear-gradient(160deg, rgba(26,30,44,0.98), rgba(18,22,32,0.95)) !important;
  box-shadow: 0 3px 0 rgba(0,0,0,0.4) !important;
  transition: transform 0.1s !important;
  -webkit-tap-highlight-color: transparent;
}
.quality-btn:active { transform: translateY(3px) !important; box-shadow: 0 0px 0 rgba(0,0,0,0.4) !important; }
.quality-btn.selected { box-shadow: 0 3px 0 rgba(180,60,0,0.8), 0 6px 16px rgba(255,107,53,0.25) !important; }

/* ── ORDER CARDS: BIGGER, MORE TAPPABLE ── */
.order-card {
  min-height: 72px !important;
  border-radius: 16px !important;
  padding: 14px !important;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.12s ease, box-shadow 0.12s ease !important;
}
.order-card:active { transform: scale(0.98) !important; }

/* ── UPGRADE CARDS ── */
.upgrade-card {
  border-radius: 16px !important;
  transition: transform 0.12s, box-shadow 0.12s !important;
}
.upgrade-card:not(.owned):active { transform: scale(0.98) !important; }

/* ── PRINTER TAB BUTTONS ── */
.printer-tab {
  min-height: 44px !important;
  border-radius: 14px !important;
  font-size: 13px !important;
  font-weight: 800 !important;
  transition: transform 0.1s, background 0.15s, border-color 0.15s !important;
  -webkit-tap-highlight-color: transparent;
}
.printer-tab:active { transform: scale(0.97) !important; }

/* ── SPEC BUTTONS ── */
.spec-btn {
  min-height: 40px !important;
  border-radius: 12px !important;
  font-size: 10px !important;
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.1s !important;
}
.spec-btn:active { transform: scale(0.96) !important; }

/* ── PRO BUTTON ── */
.btn-pro {
  min-height: 40px !important;
  border-radius: 14px !important;
  box-shadow: 0 4px 0 rgba(60,0,140,0.6), 0 6px 20px rgba(167,139,250,0.3) !important;
  transition: transform 0.1s, box-shadow 0.1s !important;
}
.btn-pro:active { transform: translateY(4px) !important; box-shadow: 0 0px 0 rgba(60,0,140,0.6) !important; }

/* ── CONTRACT ACTIONS ── */
.contract-actions .btn {
  flex: 1;
  min-height: 42px !important;
}

/* ── PAUSE BUTTON ── */
.pause-btn, .sound-btn {
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.1s !important;
}
.pause-btn:active, .sound-btn:active { transform: scale(0.9) !important; }

/* ── BOTTOM NAV ACTIVE STATE GLOW ── */
.tab-row-v2.main-nav .tab[data-primary="1"].active .tab-emoji {
  filter: drop-shadow(0 0 6px var(--accent));
}

/* ── 1. TOPBAR: Compacte 2-rijen layout op kleine schermen ── */
@media (max-width: 600px) {
  #topbar {
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    padding: 8px 12px;
    height: auto;
    gap: 6px;
  }
  .logo {
    font-size: 16px;
    letter-spacing: 1px;
    grid-column: 1;
    grid-row: 1;
    align-self: center;
  }
  .topbar-right {
    grid-column: 2;
    grid-row: 1;
    gap: 6px;
  }
  /* Verberg Save/Reset/keyboard/Pro in topbar — via Settings tab */
  .topbar-right .btn:not(#pro-btn),
  .topbar-right .sound-btn:last-of-type {
    display: none;
  }
  /* Stat pills: kompakter, 2e rij full-width scroll */
  #topbar > div:nth-child(2) {
    grid-column: 1 / -1;
    grid-row: 2;
    overflow-x: auto;
    flex-wrap: nowrap;
    gap: 6px;
    padding-bottom: 2px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  #topbar > div:nth-child(2)::-webkit-scrollbar { display: none; }
  .stat-pill {
    flex-shrink: 0;
    padding: 5px 10px;
    font-size: 13px;
  }
  .stat-pill .label { font-size: 9px; }
  /* Verberg Expenses in topbar — te rommelig op klein scherm */
  #burn-pill { display: none !important; }
}

/* ── 2. STOCK BAR: Scrollbaar, groter klik-doel ── */
#stock-bar {
  overflow-x: auto;
  scrollbar-width: none;
  -webkit-overflow-scrolling: touch;
  flex-wrap: nowrap !important;
}
#stock-bar::-webkit-scrollbar { display: none; }
.stock-pill {
  flex-shrink: 0;
  min-height: 36px;
  padding: 4px 10px;
  cursor: pointer;
}

/* ── 3. MINIGAME KNOPPEN: Veel groter voor thumbs ── */
.mg-btn {
  min-width: 72px !important;
  min-height: 72px !important;
  font-size: 28px !important;
  border-radius: 20px !important;
}
.mg-buttons {
  gap: 14px !important;
  padding: 8px 0 !important;
}
@media (max-width: 400px) {
  .mg-btn {
    min-width: 60px !important;
    min-height: 60px !important;
    font-size: 24px !important;
  }
}

/* ── 4. CLOG MASH KNOP: Groot en duidelijk ── */
.clog-mash-btn {
  min-width: 100px !important;
  min-height: 100px !important;
  font-size: 42px !important;
  border-radius: 24px !important;
}

/* ── 5. POPUP: Beter op kleine schermen ── */
@media (max-width: 500px) {
  .popup {
    width: calc(100vw - 32px) !important;
    max-width: none !important;
    margin: 16px;
    border-radius: 20px;
    max-height: 85vh;
    overflow-y: auto;
  }
  .popup-actions {
    flex-direction: column;
    gap: 10px;
  }
  .popup-actions .btn {
    width: 100%;
    min-height: 50px;
  }
}

/* ── 6. BOTTOM NAV: Emoji-only op heel kleine schermen ── */
@media (max-width: 380px) {
  .main-nav .tab {
    min-width: 52px !important;
    padding: 8px 6px !important;
    font-size: 18px !important;
  }
  /* Verberg tekst, houd emoji */
  .main-nav .tab {
    /* Toon alleen emoji (eerste 2 tekens) via clip */
    overflow: hidden;
    white-space: nowrap;
  }
}

/* ── 7. ORDER CARDS: Grotere tap zone ── */
.order-card {
  min-height: 60px;
  padding: 12px !important;
}
.order-card .order-name {
  font-size: 13px !important;
}

/* ── 8. PRINTER CARDS: Meer ruimte voor health bar / knoppen ── */
@media (max-width: 600px) {
  .printer-card {
    padding: 12px !important;
  }
  /* Repair / View knoppen full-width op mobiel */
  .printer-card .btn-full {
    min-height: 46px;
    font-size: 13px;
  }
}

/* ── 9. SHOP ITEMS: Grid van 1 kolom op telefoon ── */
@media (max-width: 480px) {
  #shop-upgrades {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px;
  }
  .shop-item, .upgrade-card {
    width: 100% !important;
  }
  /* Koop knop altijd vol breed */
  .shop-item .btn,
  .upgrade-card .btn {
    width: 100%;
    min-height: 48px;
    font-size: 14px;
  }
}

/* ── 10. CENTER PANEL: Grotere actie knoppen ── */
@media (max-width: 600px) {
  #start-btn, #cancel-btn, #repair-btn,
  button[onclick*="startJob"], button[onclick*="cancelJob"] {
    min-height: 52px !important;
    font-size: 15px !important;
    border-radius: 16px !important;
  }
  /* Filament & Quality selectors makkelijker te tikken */
  .fil-btn, .qual-btn {
    min-height: 44px !important;
    padding: 10px 12px !important;
  }
}

/* ── 11. MORE-SHEET: 3 kolommen i.p.v. 2 op grotere telefoons ── */
@media (min-width: 420px) and (max-width: 900px) {
  .more-grid {
    grid-template-columns: 1fr 1fr 1fr;
  }
}
.more-btn {
  min-height: 52px;
  font-size: 13px;
  gap: 6px;
}

/* ── 12. LOG PANEL: Leesbaar op klein scherm ── */
@media (max-width: 600px) {
  #log-panel {
    font-size: 11px;
    max-height: 140px;
  }
  .log-entry {
    padding: 4px 8px;
  }
}

/* ── 13. TELEMETRY STRIP: 2x2 grid ── */
@media (max-width: 600px) {
  .telem-strip {
    grid-template-columns: 1fr 1fr !important;
    gap: 6px;
  }
  .telem-cell {
    padding: 8px !important;
  }
}

/* ── 14. MARKET BAR: Verberg lange beschrijving ── */
@media (max-width: 600px) {
  .market-bar > span:last-child {
    display: none;
  }
  .market-bar {
    gap: 6px;
    padding: 4px 12px;
  }
}

/* ── 15. PROGRESS ARC / Job view: volle breedte ── */
@media (max-width: 600px) {
  .arc-wrap {
    width: 100px !important;
    height: 100px !important;
  }
  .active-job-panel {
    padding: 12px !important;
  }
  .job-title {
    font-size: 16px !important;
  }
}

/* ── 16. SAFE AREA: iPhone notch / Dynamic Island ── */
@supports (padding-top: env(safe-area-inset-top)) {
  #topbar {
    padding-top: max(8px, env(safe-area-inset-top));
  }
  .main-nav {
    bottom: max(calc(env(safe-area-inset-bottom) + 10px), 18px) !important;
    padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
  }
  #main {
    padding-bottom: max(calc(var(--nav-h) + env(safe-area-inset-bottom) + 20px), 100px) !important;
  }
}

/* ── 17. LANDSCAPE MODUS ── */
@media (max-height: 500px) and (orientation: landscape) {
  #topbar { padding: 4px 12px; }
  .logo { font-size: 14px; }
  .product-canvas-wrap { max-height: 35vh !important; }
  .acc-body { max-height: 45vh; }
  .main-nav {
    height: 52px !important;
    border-radius: 14px !important;
  }
  .main-nav .tab {
    height: 38px !important;
    min-width: 80px !important;
    font-size: 11px !important;
  }
}

/* ── 18. Actieve tab indicator — duidelijker op mobiel ── */
@media (max-width: 900px) {
  .main-nav .tab.active {
    background: var(--accent) !important;
    color: #000 !important;
    font-weight: 700;
  }
  .main-nav .tab.active::after {
    display: none;
  }
}

/* ── 19. Scroll indicator op nav ── */
.main-nav::after {
  content: '';
  position: sticky;
  right: 0;
  top: 0;
  bottom: 0;
  width: 24px;
  flex-shrink: 0;
  background: linear-gradient(to right, transparent, rgba(10,12,18,0.85));
  pointer-events: none;
}

/* ── 20. Input velden: beter toetsenbord UX ── */
input[type="text"], input[type="number"], select {
  font-size: 16px !important; /* voorkomt iOS auto-zoom */
  min-height: 44px;
  padding: 10px 12px;
}

@media (max-width: 900px) {

  /* Verberg ALLE non-primary tabs in de nav balk */
  .tab-row-v2.main-nav .tab:not([data-primary="1"]):not(.more) {
    display: none !important;
  }

  /* Verberg groeplabels volledig */
  .tab-row-v2.main-nav .tab-group-label {
    display: none !important;
  }

  /* De nav balk zelf: fixed onderaan, flex-row, gelijkmatig verdeeld */
  .tab-row-v2.main-nav {
    position: fixed !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    height: calc(60px + env(safe-area-inset-bottom)) !important;
    padding: 0 0 env(safe-area-inset-bottom) 0 !important;
    border-radius: 0 !important;
    border-top: 1px solid rgba(255,255,255,0.10) !important;
    border-left: none !important;
    border-right: none !important;
    border-bottom: none !important;
    background: rgba(10,12,20,0.96) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    box-shadow: 0 -4px 24px rgba(0,0,0,0.5) !important;
    display: flex !important;
    flex-direction: row !important;
    align-items: stretch !important;
    gap: 0 !important;
    overflow: visible !important;
    z-index: 200 !important;
  }

  /* Elke primaire tab: gelijke breedte, emoji boven / label onder */
  .tab-row-v2.main-nav .tab[data-primary="1"] {
    flex: 1 1 0 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 3px !important;
    padding: 8px 4px !important;
    height: 60px !important;
    border-radius: 0 !important;
    font-size: 11px !important;
    font-weight: 600 !important;
    letter-spacing: 0.3px !important;
    color: rgba(212,218,232,0.6) !important;
    border: none !important;
    background: transparent !important;
    white-space: nowrap !important;
    min-width: 0 !important;
    position: relative;
    transition: color 0.15s;
  }

  /* Emoji groot, label klein eronder */
  .tab-row-v2.main-nav .tab[data-primary="1"] .tab-emoji {
    font-size: 22px !important;
    line-height: 1 !important;
    display: block !important;
  }
  .tab-row-v2.main-nav .tab[data-primary="1"] .tab-label {
    font-size: 10px !important;
    display: block !important;
    color: inherit !important;
  }

  /* Actieve tab: accent kleur + subtiel top-streepje */
  .tab-row-v2.main-nav .tab[data-primary="1"].active {
    color: var(--accent) !important;
    background: transparent !important;
    font-weight: 700 !important;
  }
  .tab-row-v2.main-nav .tab[data-primary="1"].active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 20%;
    right: 20%;
    height: 2px;
    background: var(--accent);
    border-radius: 0 0 2px 2px;
  }

  /* More knop: zelfde stijl als primaire tabs */
  .tab-row-v2.main-nav .tab.more {
    flex: 1 1 0 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    height: 60px !important;
    border-radius: 0 !important;
    font-size: 22px !important;
    font-weight: 400 !important;
    color: rgba(212,218,232,0.6) !important;
    border: none !important;
    background: transparent !important;
    padding: 8px 4px !important;
    gap: 3px !important;
    min-width: 0 !important;
  }
  .tab-row-v2.main-nav .tab.more::after {
    content: 'More';
    font-size: 10px !important;
    font-weight: 600;
    color: rgba(212,218,232,0.6);
    display: block;
    letter-spacing: 0.3px;
  }
  /* More actief wanneer een niet-primary tab open is */
  .tab-row-v2.main-nav .tab.more.active {
    color: var(--accent) !important;
  }
  .tab-row-v2.main-nav .tab.more.active::after {
    color: var(--accent) !important;
  }

  /* Inhoud boven de nav: genoeg ruimte */
  #main {
    padding-bottom: calc(60px + env(safe-area-inset-bottom) + 12px) !important;
  }
  body {
    padding-bottom: 0 !important;
  }

  /* Als actieve tab NIET primary is → toon hem tijdelijk in de balk */
  /* Dit doet de JS al door data-tab te matchen — de active class blijft werken */
}

/* Landscape: lagere nav */
@media (max-width: 900px) and (max-height: 500px) and (orientation: landscape) {
  .tab-row-v2.main-nav {
    height: calc(48px + env(safe-area-inset-bottom)) !important;
  }
  .tab-row-v2.main-nav .tab[data-primary="1"],
  .tab-row-v2.main-nav .tab.more {
    height: 48px !important;
  }
  .tab-row-v2.main-nav .tab[data-primary="1"] .tab-emoji {
    font-size: 18px !important;
  }
  .tab-row-v2.main-nav .tab[data-primary="1"] .tab-label {
    font-size: 9px !important;
  }
}

/* ── SIDE-BY-SIDE LAYOUT OVERRIDE ── */
#main {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
}
#main > #center-panel,
#main > div[style*="flex-direction:column"] {
  /* these two become grid children */
}
#station-row-wrapper {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: start;
}
@media (max-width: 600px) {
  #station-row-wrapper { grid-template-columns: 1fr; }
}
/* Remove the phone-width constraint */
@media (min-width: 700px) {
  #topbar, .market-bar, #main, #speedrun-bar, #season-banner {
    width: 100% !important;
    max-width: 100% !important;
  }
  body { justify-content: unset !important; }
  body::before, body::after { display: none !important; }
}
</style>
</head>
<body class="layout-mobile">
<div id=\"float-layer\" aria-hidden=\"true\"></div>
<div id="fail-flash"></div>
<!-- TOP BAR -->
<div id="topbar">
<div class="logo">Print <span>&amp;</span> Profit <span style="font-size:11px;color:var(--text-dim);letter-spacing:1px;font-weight:300">v17.4</span></div>
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
<div class="stat-pill"><span class="label">Cash</span><span class="value" id="money-val" style="transition:color 0.2s,transform 0.2s">€0.00</span></div>
<div class="stat-pill"><span class="label">Rep</span><span class="value" id="rep-val">★ 0</span></div>
<div class="stat-pill"><span class="label">Lvl</span><span class="value" id="level-val">1</span></div>
<div class="stat-pill" id="passive-pill" style="display:none"><span class="label">Passive/h</span><span class="value" id="passive-val" style="color:var(--accent3)">€0</span></div>
<div class="stat-pill" id="burn-pill" style="display:flex"><span class="label">Expenses/m</span><span class="value" id="burn-val" style="color:var(--danger)">€0</span></div>
<div class="streak-pill" id="streak-pill" style="display:none"><span class="label">🔥 Streak</span><span id="streak-val">0</span></div>
<span class="night-badge" id="night-badge">🌙 Night Shift</span>
<div class="prestige-badge" id="prestige-pill">🔥 <span id="prestige-val">P1</span></div>
<div class="token-pill" id="token-pill" style="display:none;">🎲 <span id="token-val">0</span></div>
<div class="stat-pill" id="debt-pill" style="display:none;border-color:rgba(255,61,90,0.4)"><span class="label">💳 Debt</span><span class="value" id="debt-val" style="color:var(--danger)">€0</span></div>
<div class="scrap-pill" id="scrap-pill" style="display:none">♻️ <span id="scrap-val">0</span> scrap</div>
</div>
<div class="topbar-right">
<!-- layout toggle removed: mobile-only TikTok vertical -->
<div id="save-indicator">💾 Saved</div>
<!-- Speed control -->
<div class="speed-control" title="Spelsnelheid">
  <button class="speed-btn active" id="speed-1x" onclick="Game.setSpeed(1)" title="1× snelheid">1×</button>
  <button class="speed-btn fast"   id="speed-2x" onclick="Game.setSpeed(2)" title="2× snelheid">2×</button>
  <button class="speed-btn turbo"  id="speed-5x" onclick="Game.setSpeed(5)" title="5× snelheid">5×</button>
</div>
<div class="notif-btn" id="notif-btn" onclick="Notifications.toggle()" title="Browser notifications">🔔<div class="notif-dot"></div></div>
<div class="pause-btn" id="pause-btn" onclick="Game.togglePause()" title="Pauzeer spel">⏸<svg class="idle-ring" viewBox="0 0 46 46" xmlns="http://www.w3.org/2000/svg"><circle cx="23" cy="23" r="21" id="idle-ring-circle"/></svg></div>
<div class="sound-btn" id="sound-btn" onclick="Sound.toggle()" title="Toggle sound">🔊</div>
<button class="btn-pro" id="pro-btn" onclick="Game.showProModal()">⚡ Pro</button>
<button class="btn btn-primary btn-sm" onclick="Game.saveGame(true)" title="Save game">💾</button>
</div>
</div>
<!-- NIEUWS TICKER -->
<div id="news-ticker">
<div class="ticker-inner" id="ticker-inner">
<span class="ticker-item">📈 <span>Marktupdate:</span> PLA stabiel op ×1.0</span>
<span class="ticker-item">🏭 <span>Tip:</span> Hogere kwaliteit = meer reputatie</span>
<span class="ticker-item">🎯 <span>Dagelijks doel:</span> Check je doelen tab!</span>
<span class="ticker-item">🔥 <span>Combo:</span> Druk snel achter elkaar voor bonussen</span>
<span class="ticker-item">💡 <span>Pro-tip:</span> PA6 filament heeft de hoogste winstmarge</span>
<span class="ticker-item">🧾 <span>Tip:</span> Betaal je BTW-rekening op tijd — anders verlies je reputatie!</span>
<span class="ticker-item">🥇 <span>Tip:</span> Bereik Platinum-klantstatus voor +35% beloningen per job</span>
<span class="ticker-item">🏭 <span>Tip:</span> Ontgrendel Franchise-mode na 2 Prestiges — passief inkomen!</span>
<span class="ticker-item">⭐ <span>Tip:</span> Elk prestige levert een permanent Legacy-voordeel op</span>
<span class="ticker-item">♻️ <span>Tip:</span> Koop de Recycler-upgrade om mislukte prints om te zetten in schroot</span>
<span class="ticker-item">😴 <span>Tip:</span> Personeelsmoreel daalt met de tijd — koop Team Lunch om het te herstellen</span>
<span class="ticker-item">🛡 <span>Tip:</span> Bedrijfsverzekering dekt catastrofale storingen voor €50/cyclus</span>
<span class="ticker-item">📋 <span>Tip:</span> Abonnementsklanten sturen automatisch herhaalopdrachten</span>
</div>
</div>
<!-- SEASON BANNER -->
<div id="season-banner">
<div class="season-icon" id="season-icon">🎄</div>
<div class="season-text">
<div class="season-name" id="season-name">Holiday Rush</div>
<div class="season-effect" id="season-effect">Figurines &amp; decorations +40% reward · Extra urgent orders</div>
</div>
<span style="font-size:11px;color:var(--text-dim)">Seizoenscyclus</span>
</div>
<!-- MARKTCRISIS BANNER -->
<div class="crisis-banner" id="crisis-banner">
<div class="crisis-icon" id="crisis-icon">⚠️</div>
<div class="crisis-text">
<div class="crisis-name" id="crisis-name">Filament Shortage!</div>
<div class="crisis-desc" id="crisis-desc">PLA stock depleted globally — prices spiked</div>
</div>
<div class="crisis-timer" id="crisis-timer">2:30</div>
</div>
<!-- FILAMENT STOCK BAR -->
<div id="stock-bar">
<span class="stock-label">📦 Filament</span>
<div class="stock-pill" id="stock-pla" title="PLA stock — click Suppliers tab to restock"><span class="stock-fil-dot" style="background:var(--pla)"></span><span>PLA</span><span id="sval-pla">100</span></div>
<div class="stock-pill" id="stock-petg" title="PETG stock"><span class="stock-fil-dot" style="background:var(--petg)"></span><span>PETG</span><span id="sval-petg">80</span></div>
<div class="stock-pill" id="stock-pa6" title="PA6-GF stock"><span class="stock-fil-dot" style="background:var(--pa6)"></span><span>PA6</span><span id="sval-pa6">50</span></div>
<div class="stock-pill" id="stock-tpu" title="TPU stock — unlock with Direct Drive upgrade"><span class="stock-fil-dot" style="background:#ff9f43"></span><span>TPU</span><span id="sval-tpu">—</span></div>
<div class="stock-pill" id="stock-resin" title="Resin stock — unlock SLA Resin Printer first"><span class="stock-fil-dot" style="background:#ee5a24"></span><span>Resin</span><span id="sval-resin">—</span></div>
<div class="stock-pill" id="stock-cf" title="Carbon Fiber — needs CF Nozzle upgrade"><span class="stock-fil-dot" style="background:#8888aa"></span><span>CF</span><span id="sval-cf">—</span></div>
<div class="stock-pill" id="stock-glow" title="Glow filament — unlock with Glow upgrade"><span class="stock-fil-dot" style="background:#ccff00"></span><span>GLOW</span><span id="sval-glow">—</span></div>
<span onclick="switchTab('suppliers')" style="font-size:11px;color:var(--text-dim);margin-left:auto;cursor:pointer" title="Ga naar Leveranciers">⬆ Bijvullen →</span>
</div>
<!-- RIVAL BANNER -->
<div class="rival-banner" id="rival-banner">
<div>
<div class="rival-name">🤖 PrintBot stole an order!</div>
<div id="rival-msg" style="font-size:11px;color:var(--text-dim)">Accepteer orders sneller om de concurrentie te verslaan.</div>
</div>
<div style="text-align:right">
<div style="font-size:11px;color:var(--text-dim)">Rivaal Jobs</div>
<div class="rival-score">PrintBot: <span id="rival-score">0</span> | You: <span id="rival-player-score">0</span></div>
</div>
</div>
<!-- DEMAND SURGE BANNER -->
<div class="surge-banner" id="surge-banner">
<div>
<div class="surge-name" id="surge-name">🔥 DEMAND SURGE</div>
<div class="surge-timer" id="surge-timer">⏳ 2:00 resterend</div>
</div>
<div class="surge-progress">
<div style="font-size:11px;color:var(--text-dim)">Progress: <span id="surge-progress-text">0/5</span></div>
<div class="surge-bar"><div class="surge-fill" id="surge-fill" style="width:0%"></div></div>
</div>
<div class="surge-reward" id="surge-reward">€250 Bonus</div>
</div>
<!-- TRENDING PRODUCTS BANNER -->
<div id="trend-banner" style="display:none;background:linear-gradient(90deg,rgba(255,204,0,0.12),rgba(255,140,0,0.08));border:1px solid rgba(255,204,0,0.4);border-radius:var(--radius);padding:8px 14px;margin:0 8px 6px;align-items:center;justify-content:space-between;gap:8px;">
<div>
<div id="trend-name" style="font-family:var(--display);font-weight:900;font-size:13px;color:var(--warn)">🔥 TRENDING</div>
<div id="trend-timer" style="font-size:11px;color:var(--text-dim)">⏳ 180s resterend</div>
</div>
<div style="font-size:10px;color:var(--text-dim)">Matching orders verdienen multiplier!</div>
</div>
<!-- SPEEDRUN BAR -->
<div id="speedrun-bar">
<div>
<div class="sr-label">⚡ SPEEDRUN MODE</div>
<div class="sr-timer" id="sr-timer">10:00</div>
</div>
<div style="text-align:center">
<div class="sr-label">Verdiend</div>
<div class="sr-score" id="sr-score">€0</div>
</div>
<div style="text-align:center">
<div class="sr-label">Jobs</div>
<div class="sr-score" id="sr-jobs">0</div>
</div>
<button class="sr-end-btn" onclick="Speedrun.end(true)">Stoppen</button>
</div>
<!-- COMBO DISPLAY -->
<div id="combo-display" style="display:none;">
<div class="combo-number" id="combo-number">2×</div>
<div class="combo-label">COMBO!</div>
<div class="combo-mult" id="combo-mult">+10% bonus</div>
<div class="combo-bar-wrap"><div class="combo-bar-fill" id="combo-bar" style="width:100%"></div></div>
</div>
<!-- SMART TIP -->
<div id="smart-tip">
<div class="tip-label">💡 Tip</div>
<div class="tip-text" id="tip-text"></div>
</div>
<div class="market-bar">
<span id="market-label">📈 Market</span>
<div class="market-pill" id="market-pla"><span class="m-label">PLA</span><span class="market-flat" id="mval-pla">×1.00</span><span class="market-arrow" id="marr-pla">→</span></div>
<div class="market-pill" id="market-petg"><span class="m-label">PETG</span><span class="market-flat" id="mval-petg">×1.00</span><span class="market-arrow" id="marr-petg">→</span></div>
<div class="market-pill" id="market-pa6"><span class="m-label">PA6</span><span class="market-flat" id="mval-pa6">×1.00</span><span class="market-arrow" id="marr-pa6">→</span></div>
<span style="color:var(--text-dim);font-size:11px;margin-left:8px;">Update elke 2 min · beïnvloedt orderbeloningen</span>
</div>
<!-- KEYBOARD HINT -->

<!-- TUTORIAL OVERLAY -->
<div id="tutorial-overlay" style="display:none;"></div>
<!-- BREAKDOWN MINI-GAME -->
<div id="minigame-overlay">
<div class="minigame-box">
<div class="mg-title">🔧 PRINTER BREAKDOWN</div>
<div class="mg-sub" id="mg-sub">Je printer werkt niet goed! Volg de kalibratiereeks om gratis te repareren — of sla over (kost geld).</div>
<div class="mg-progress" id="mg-progress">Step 0 / 0</div>
<div class="mg-sequence" id="mg-sequence"></div>
<div class="mg-timer-bar"><div class="mg-timer-fill" id="mg-timer-fill" style="width:100%"></div></div>
<div class="mg-feedback" id="mg-feedback"></div>
<div class="mg-buttons">
<div class="mg-btn" onclick="MiniGame.press('🔴')" style="border-color:var(--danger)">🔴</div>
<div class="mg-btn" onclick="MiniGame.press('🔵')" style="border-color:var(--accent)">🔵</div>
<div class="mg-btn" onclick="MiniGame.press('🟢')" style="border-color:var(--accent3)">🟢</div>
<div class="mg-btn" onclick="MiniGame.press('🟡')" style="border-color:var(--warn)">🟡</div>
</div>
<button class="btn btn-ghost btn-sm" onclick="MiniGame.skip()">Overslaan (betaal reparatiekosten)</button>
</div>
</div>
<!-- MAIN -->
<div id="main">
<div id="station-row-wrapper">
<div id="center-panel">
<!-- ACTIVE JOB -->
<div class="panel" style="flex:2;">
<div class="panel-header"><div class="dot" style="background:var(--accent3);box-shadow:0 0 8px var(--accent3);"></div> Print Station</div>
<div class="panel-body" id="active-job-panel">
<div id="job-empty" style="text-align:center;padding:20px 0;color:var(--text-dim);">
<svg style="width:120px;height:90px;opacity:0.2;margin-bottom:8px;" viewbox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
<rect fill="#4fc3f7" height="5" rx="2" width="100" x="10" y="72"></rect>
<rect fill="#2a3045" height="64" rx="2" width="4" x="8" y="12"></rect>
<rect fill="#2a3045" height="64" rx="2" width="4" x="108" y="12"></rect>
<rect fill="#2a3045" height="5" rx="2" width="104" x="8" y="9"></rect>
<rect fill="#1a2030" height="2" rx="1" width="76" x="22" y="26"></rect>
<rect fill="#161f30" height="10" rx="2" stroke="#2a3045" stroke-width="1" width="20" x="50" y="20"></rect>
<polygon fill="#ff6b35" opacity="0.6" points="54,30 66,30 64,36 56,36"></polygon>
</svg>
<div style="font-family:var(--display);font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text)">Printer Ready</div>
<div style="font-size:11px;opacity:0.7;margin-bottom:12px;">Kies een order of contract om te starten</div>
<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
  <button onclick="switchPTab('orders');document.getElementById('ptab-orders').scrollIntoView({behavior:'smooth',block:'nearest'})" style="background:rgba(0,229,255,0.12);border:1px solid rgba(0,229,255,0.35);color:var(--accent);padding:8px 14px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">📬 Orders</button>
  <button onclick="switchPTab('contracts');document.getElementById('ptab-contracts').scrollIntoView({behavior:'smooth',block:'nearest'})" style="background:rgba(127,255,110,0.10);border:1px solid rgba(127,255,110,0.30);color:var(--accent3);padding:8px 14px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">📋 Contracts</button>
</div>
</div>
<div id="job-content" style="display:none;flex-direction:column;gap:10px;">
<div class="printer-tabs" id="center-printer-tabs"></div>
<div>
<div class="job-title" id="job-title">Job Name</div>
<div class="job-subtitle" id="job-subtitle">…</div>
</div>
<!-- v15: Rich product print stage -->
<div class="print-stage" id="print-stage">
<div class="stage-header">
<div class="stage-job-name" id="stage-job-name">Printer gereed</div>
<div class="stage-status-badge idle" id="stage-badge">IDLE</div>
</div>
<!-- Product + printer canvas -->
<div class="product-canvas-wrap" id="product-canvas-wrap">
<canvas id="print-canvas"></canvas>
</div>
<!-- Telemetry strip -->
<div class="telem-strip" id="telem-strip">
<div class="telem-cell">
<div class="telem-label">Laag</div>
<div class="telem-value" id="telem-layer">—</div>
<div class="telem-sub" id="telem-layer-sub">/ —</div>
</div>
<div class="telem-cell">
<div class="telem-label">Nozzle</div>
<div class="telem-value hot" id="telem-nozzle">—°C</div>
<div class="telem-sub">doel: 220°C</div>
</div>
<div class="telem-cell">
<div class="telem-label">Bed</div>
<div class="telem-value cool" id="telem-bed">—°C</div>
<div class="telem-sub">doel: 60°C</div>
</div>
<div class="telem-cell">
<div class="telem-label">Snelheid</div>
<div class="telem-value ok" id="telem-speed">—</div>
<div class="telem-sub">mm/s</div>
</div>
</div>
<!-- Arc progress + layer track -->
<div class="arc-progress-wrap">
<svg class="arc-svg" viewbox="0 0 64 64">
<circle cx="32" cy="32" fill="none" r="26" stroke="rgba(255,255,255,0.05)" stroke-width="6"></circle>
<circle cx="32" cy="32" fill="none" id="arc-track" r="26" stroke="var(--accent)" stroke-dasharray="163.4" stroke-dashoffset="163.4" stroke-linecap="round" stroke-width="6" style="transition:stroke-dashoffset 0.5s linear;filter:drop-shadow(0 0 4px var(--accent))" transform="rotate(-90 32 32)"></circle>
</svg>
<div class="arc-info">
<div class="arc-pct" id="arc-pct">—</div>
<div class="arc-label">Voortgang</div>
<div class="arc-time" id="arc-time">Selecteer een order om te beginnen</div>
</div>
</div>
<div class="layer-stack">
<div class="layer-count" id="layer-count-text">Laag 0 / 0</div>
<div class="layer-track"><div class="layer-fill" id="layer-fill-bar" style="width:0%"></div></div>
</div>
</div>
<!-- hidden legacy elements (used by old JS refs) -->
<div id="printer-visual" style="display:none"></div>
<div id="print-head" style="display:none"></div>
<div id="nozzle-dot" style="display:none"></div>
<div id="print-layer" style="display:none"></div>
<div id="big-prog-fill" style="display:none"></div>
<div id="big-prog-text" style="display:none"></div>
<div id="svg-layer" style="display:none"></div>
<div id="svg-strand" style="display:none"></div>
<div id="nozzle-glow" style="display:none"></div>
<div id="fan-circle" style="display:none"></div>
<div class="job-stats">
<div class="jstat"><div class="jstat-label">Filament</div><div class="jstat-value" id="jstat-filament">—</div></div>
<div class="jstat"><div class="jstat-label">Quality</div><div class="jstat-value" id="jstat-quality">—</div></div>
<div class="jstat"><div class="jstat-label">Time Left</div><div class="jstat-value" id="jstat-time">—</div></div>
<div class="jstat"><div class="jstat-label">Profit</div><div class="jstat-value" id="jstat-profit" style="color:var(--accent3)">—</div></div>
</div>
<div>
<div class="big-progress-bar">
<div class="big-progress-fill" id="big-prog-fill" style="width:0%"></div>
<div class="big-progress-text" id="big-prog-text">Ready</div>
</div>
</div>
<!-- active effects banner -->
<div class="effect-banner" id="effect-banner"></div>
<div>
<div style="color:var(--text-dim);font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Filament</div>
<div class="filament-row" id="filament-row"></div>
</div>
<div>
<div style="color:var(--text-dim);font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Quality</div>
<div class="quality-row" id="quality-row"></div>
</div>
<button class="btn btn-primary btn-full" id="start-job-btn" onclick="Game.startJob()" style="min-height:54px;font-size:16px;letter-spacing:1px;">▶ START PRINT</button>
<button class="btn btn-full btn-danger btn-sm" id="cancel-job-btn" onclick="Game.cancelJob()" style="display:none;min-height:46px;font-size:14px;">✕ Cancel Job</button>
</div>
</div>
</div>
</div>
<!-- right column -->
<div id="right-column" style="display:flex;flex-direction:column;gap:12px;">
<!-- PRINTERS -->
<div class="panel">
<div class="panel-header"><div class="dot"></div> Printers</div>
<div class="panel-body" id="printers-panel"></div>
</div>
<!-- ORDERS + CONTRACTS (tabbed) -->
<div class="panel" id="orders-contracts-panel" style="flex:2;overflow:hidden;">
<div class="ptab-row">
<div class="ptab active" id="ptab-orders" onclick="switchPTab('orders')">Orders <span class="badge" id="order-badge" style="display:none">0</span></div>
<div class="ptab" id="ptab-contracts" onclick="switchPTab('contracts')">Contracts <span class="cbadge" id="contract-badge" style="display:none">0</span></div>
<div class="ptab" id="ptab-queue" onclick="switchPTab('queue')" title="Print queue — jobs start automatically when a printer is free">Queue 📋</div>
</div>
<div class="ptab-body active" id="ptab-body-orders">
<div class="no-orders" id="no-orders-msg">Orders komen zo…<br/><span style="font-size:11px">Nieuwe orders elke 15–30s</span></div>
</div>
<div class="ptab-body" id="ptab-body-contracts">
<div class="no-orders" id="no-contracts-msg">Geen actieve contracten.<br/><span style="font-size:11px">Contracten worden automatisch vernieuwd</span></div>
</div>
<div class="ptab-body" id="ptab-body-queue">
<div id="queue-pro-gate" style="display:none;text-align:center;padding:20px 12px;background:linear-gradient(135deg,rgba(124,58,237,0.15),rgba(167,139,250,0.08));border:1px solid rgba(167,139,250,0.4);border-radius:var(--radius);margin-bottom:8px;">
  <div style="font-size:32px;margin-bottom:8px">📋⚡</div>
  <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--pro);margin-bottom:6px">Print Queue — Pro Functie</div>
  <div style="font-size:11px;color:var(--text-dim);line-height:1.7;margin-bottom:12px">
    <strong style="color:var(--text)">Wat doet de Queue?</strong><br>
    Voeg meerdere orders toe aan een wachtrij. Zodra een printer vrij komt, start het volgende job <strong>automatisch</strong>.<br><br>
    🚀 <span style="color:var(--accent3)">Tot 8 jobs tegelijk in de wachtrij</span><br>
    ⚡ <span style="color:var(--accent3)">Automatisch starten bij vrije printer</span><br>
    💰 <span style="color:var(--accent3)">Maximale inkomsten, minimale aandacht</span>
  </div>
  <button class="btn-pro" onclick="Game.showProModal()" style="width:100%;padding:12px;font-size:13px;">⚡ Unlock Pro — €4.99</button>
</div>
<div id="queue-pro-info" style="display:none;font-size:10px;color:var(--text-dim);margin-bottom:8px;line-height:1.6;background:rgba(0,229,255,0.05);border:1px solid rgba(0,229,255,0.15);border-radius:var(--radius);padding:8px;">
  💡 <strong style="color:var(--accent)">Auto-Queue:</strong> Voeg orders toe, jobs starten automatisch bij vrije printer.
</div>
<div id="queue-slots"></div>
<div id="queue-hint" style="margin-top:8px;font-size:10px;color:var(--text-dim);text-align:center;">
  Tik <strong>Queue</strong> op een order-kaart om toe te voegen.
</div>
</div>
</div>
</div>
</div><!-- /#right-column -->
</div><!-- /#station-row-wrapper -->
<!-- LOG: uitklapbaar onderaan -->
<div class="panel" id="log-panel-container" style="margin-top:0;">
<div class="panel-header" onclick="this.parentElement.querySelector('#log-panel-wrap').style.display = this.parentElement.querySelector('#log-panel-wrap').style.display==='none' ? 'block' : 'none'" style="cursor:pointer;user-select:none;">
  <div class="dot" style="background:var(--text-dim);box-shadow:none;"></div> 
  📋 Event Log 
  <span style="margin-left:auto;font-size:11px;color:var(--text-dim)">▾</span>
</div>
<div id="log-panel-wrap" style="display:none">
  <div class="panel-body" id="log-panel" style="max-height:180px;gap:0;"></div>
</div>
</div>
<div style="display:flex;flex-direction:column;gap:12px;">
<div class="panel" style="flex:1;">
<div class="tab-row-v2 main-nav" id="main-nav">
<div class="tab-group-label">CORE</div>
<div class="tab active" data-tab="shop"       data-primary="1" onclick="switchTab('shop')"       title="Shop"><span class="tab-emoji">🛒</span><span class="tab-label">Shop</span></div>
<div class="tab"        data-tab="stats"      data-primary="1" onclick="switchTab('stats')"      title="Stats"><span class="tab-emoji">📊</span><span class="tab-label">Stats</span></div>
<div class="tab"        data-tab="achiev"     data-primary="1" onclick="switchTab('achiev')"     title="Badges"><span class="tab-emoji">🏅</span><span class="tab-label">Badges</span></div>
<div class="tab-group-label">MANAGE</div>
<div class="tab"        data-tab="doelen"     data-primary="1" onclick="switchTab('doelen')"     title="Goals"><span class="tab-emoji">🎯</span><span class="tab-label">Goals</span></div>
<div class="tab"        data-tab="suppliers"  data-primary="1" onclick="switchTab('suppliers')"  title="Supply"><span class="tab-emoji">🏭</span><span class="tab-label">Supply</span></div>
<div class="tab"        data-tab="personeel"             onclick="switchTab('personeel')"  title="Staff"><span class="tab-emoji">👥</span><span class="tab-label">Staff</span></div>
<div class="tab"        data-tab="ketens"                onclick="switchTab('ketens')"     title="Chains"><span class="tab-emoji">🔗</span><span class="tab-label">Chains</span></div>
<div class="tab"        data-tab="klanten"               onclick="switchTab('klanten')"    title="Clients"><span class="tab-emoji">⭐</span><span class="tab-label">Clients</span></div>
<div class="tab"        data-tab="voorraad"              onclick="switchTab('voorraad')"   title="Stock"><span class="tab-emoji">📦</span><span class="tab-label">Stock</span></div>
<div class="tab-group-label">BUSINESS</div>
<div class="tab"        data-tab="dashboard"             onclick="switchTab('dashboard')"  title="Dashboard"><span class="tab-emoji">📈</span><span class="tab-label">Dash</span></div>
<div class="tab"        data-tab="loans"                 onclick="switchTab('loans')"      title="Finance"><span class="tab-emoji">💳</span><span class="tab-label">Finance</span></div>
<div class="tab"        data-tab="franchise"             onclick="switchTab('franchise')"  title="Franchise"><span class="tab-emoji">🏭</span><span class="tab-label">Franchise</span></div>
<div class="tab-group-label">CHALLENGE</div>
<div class="tab"        data-tab="challenges"            onclick="switchTab('challenges')" title="Challenges"><span class="tab-emoji">🏆</span><span class="tab-label">Challenges</span></div>
<div class="tab"        data-tab="research"              onclick="switchTab('research')"   title="Research"><span class="tab-emoji">⚗️</span><span class="tab-label">Research</span></div>
<div class="tab"        data-tab="bounties"              onclick="switchTab('bounties')"   title="Bounties"><span class="tab-emoji">🎯</span><span class="tab-label">Bounties</span></div>
<div class="tab"        data-tab="equipment"             onclick="switchTab('equipment')"  title="Equipment"><span class="tab-emoji">🔧</span><span class="tab-label">Equipment</span></div>
<div class="tab-group-label">RECORDS</div>
<div class="tab"        data-tab="leaderboard"           onclick="switchTab('leaderboard')" title="Board"><span class="tab-emoji">🥇</span><span class="tab-label">Board</span></div>
<div class="tab"        data-tab="legacy"                onclick="switchTab('legacy')"     title="Legacy"><span class="tab-emoji">✨</span><span class="tab-label">Legacy</span></div>
<div class="tab"        data-tab="hof"                   onclick="switchTab('hof')"        title="HOF"><span class="tab-emoji">🏆</span><span class="tab-label">HOF</span></div>
<div class="tab-group-label">SYS</div>
<div class="tab"        data-tab="settings"  data-primary="1" onclick="switchTab('settings')"   title="Settings"><span class="tab-emoji">⚙️</span><span class="tab-label">Settings</span></div>
<div class="tab more"   data-tab="more"                  onclick="UI.openMore()"           title="More">⋯</div>
</div>
<div class="panel-body">
<div class="tab-content active" id="tab-shop">
<div class="biz-level">
<div class="biz-level-name" id="biz-level-name">GARAGE TINKERER</div>
<div class="biz-level-sub" id="biz-level-sub">Level 1 · 0 / 100 XP</div>
<div class="biz-xp-bar"><div class="biz-xp-fill" id="biz-xp-fill" style="width:0%"></div></div>
</div>
<div id="shop-upgrades"></div>
</div>
<div class="tab-content" id="tab-stats">
<div class="graph-container">
<div class="graph-label">📈 Income History</div>
<canvas height="120" id="income-canvas"></canvas>
</div>
<div class="graph-container" style="margin-top:0">
<div class="graph-label">🥧 Filament Mix</div>
<canvas height="120" id="pie-canvas" width="120"></canvas>
<div class="pie-legend" id="pie-legend"></div>
</div>
<div class="stat-grid" id="stats-panel"></div>
</div>
<div class="tab-content" id="tab-achiev">
<div id="achiev-list"></div>
</div>
<div class="tab-content" id="tab-doelen">
  <details class="acc" open>
    <summary>
      <span class="acc-left">
        <span class="acc-title">🎯 Goals</span>
        <span class="acc-sub" id="goals-reset-timer"></span>
      </span>
      <span class="acc-caret">⌄</span>
    </summary>
    <div class="acc-body">
      <div class="acc-hint">
        Dagelijkse uitdagingen — worden gereset om middernacht.
      </div>
      <div id="daily-goals-list"></div>
      <div style="margin-top:0;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);text-align:center;">
        <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Vandaag verzameld</div>
        <div id="goals-earned" style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--warn)">€0</div>
      </div>
    </div>
  </details>
</div><div class="tab-content" id="tab-leaderboard">
<div id="leaderboard-list"></div>
</div>
<div class="tab-content" id="tab-suppliers">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Koop filament bij leveranciers. Prijzen fluctueren — koop goedkoop in! Bouw relaties op voor kortingen.
          </div>
<div id="supplier-list"></div>
</div>
<div class="tab-content" id="tab-klanten">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            VIP klanten geven tot <strong style="color:var(--warn)">+40% loyaliteitsbonus</strong>. Houd ze tevreden!
          </div>
<div id="customer-panel"></div>
<div id="crm-panel" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"></div>
</div>
<div class="tab-content" id="tab-challenges">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Wekelijkse uitdagingen voor grote beloningen en exclusieve badges.
          </div>
<div id="challenge-list"></div>
</div>
<div class="tab-content" id="tab-personeel">
  <details class="acc" open>
    <summary>
      <span class="acc-left">
        <span class="acc-title">👥 Staff</span>
      </span>
      <span class="acc-caret">⌄</span>
    </summary>
    <div class="acc-body">
      <div class="acc-hint">
        Huur medewerkers om je drukkerij te automatiseren. Loon wordt per minuut betaald.
      </div>
      <div id="employee-list"></div>
    </div>
  </details>
</div><div class="tab-content" id="tab-ketens">
  <details class="acc" open>
    <summary>
      <span class="acc-left">
        <span class="acc-title">🔗 Chains</span>
      </span>
      <span class="acc-caret">⌄</span>
    </summary>
    <div class="acc-body">
      <div class="acc-hint">
        Productieketens combineren meerdere filamenttypes voor een megabeloning. Voltooi alle stappen!
      </div>
      <div id="chain-list"></div>
    </div>
  </details>

  <details class="acc">
    <summary>
      <span class="acc-left">
        <span class="acc-title">🎲 Tokens</span>
      </span>
      <span class="acc-caret">⌄</span>
    </summary>
    <div class="acc-body">
      <div id="token-display" style="font-family:var(--display);font-weight:900;font-size:18px;color:#fbbf24">0 Tokens</div>
      <div class="acc-hint">Verdien tokens door ketens te voltooien.</div>
      <button class="btn btn-sm" onclick="LootBox.open()" style="width:100%;background:linear-gradient(135deg,rgba(124,45,18,0.3),rgba(251,191,36,0.1));border:1px solid rgba(251,191,36,0.3);color:#fbbf24;">
        🎲 Open Lootbox (10 tokens)
      </button>
    </div>
  </details>
</div><div class="tab-content" id="tab-franchise">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            🏭 <strong style="color:var(--accent2)">Franchise Vestigingen</strong> verdienen automatisch passief inkomen. Ontgrendel na Prestige 2.
          </div>
<div id="franchise-panel"></div>
</div>
<div class="tab-content" id="tab-legacy">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ⭐ <strong style="color:var(--pro)">Legacy-voordelen</strong> zijn permanente bonussen die je kiest bij elk prestige. Ze overleven alle resets.
          </div>
<div id="legacy-panel"></div>
</div>
<div class="tab-content" id="tab-hof">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            🏆 <strong style="color:var(--warn)">Hall of Fame</strong> — jouw beste runs ooit, doorheen alle prestiges.
          </div>
<div id="hof-panel"></div>
</div>
<div class="tab-content" id="tab-loans">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            💳 <strong style="color:var(--warn)">Bedrijfsleningen</strong> geven direct cash — maar je betaalt terug met rente. Laat schulden niet ophopen!
          </div>
<div id="loan-panel"></div>
<div id="loan-debt-panel" style="display:none">
<div style="font-size:11px;color:var(--danger);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">⚠ Huidige Schuld</div>
<div id="loan-debt-display" style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--danger)">€0.00</div>
<div style="font-size:11px;color:var(--text-dim);margin:4px 0">Rente wordt elke 60 seconden bijgeschreven</div>
<button class="btn btn-danger btn-sm btn-full" onclick="Loans.repayAll()" style="margin-top:6px">💳 Repay All Debt</button>
<!-- v15: Operating expenses (Idle Economy Layer 1) -->
<div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">🏢 Operating Expenses</div>
<div id="expenses-panel"></div>
</div>
</div>
<!-- v10: Recycling section inside loans tab -->
<div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">♻️ Recycling</div>
<div id="recycle-panel"></div>
</div>
<!-- v10: Subscriptions section -->
<div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">📋 Subscription Clients</div>
<div id="subscription-panel"></div>
</div>
<!-- v10: Morale section -->
<div id="morale-section" style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">😊 Staff Morale</div>
<div id="morale-panel"></div>
<button class="btn btn-primary btn-sm btn-full" onclick="Morale.buyLunch()" style="margin-top:6px">🍕 Team Lunch — €80 (restore all morale)</button>
</div>
</div>
<div class="tab-content" id="tab-voorraad">
<div id="inventory-panel"></div>
</div>
<div class="tab-content" id="tab-settings">
<div class="settings-section">
<div class="settings-row">
<div>
<div class="settings-label">🔊 Sound</div>
<div class="settings-sub">Synthesized audio feedback</div>
</div>
<button class="btn btn-ghost btn-sm" onclick="Sound.toggle()">Toggle</button>
</div>
<div class="settings-row">
<div>
<div class="settings-label">🎨 Printer Skin</div>
<div class="settings-sub">Visual theme for the print station</div>
<div class="skin-selector">
<span class="skin-label">Theme:</span>
<span class="skin-dot active-skin" id="skin-default" onclick="Skins.set('default')" style="background:#00e5ff" title="Default"></span>
<span class="skin-dot" id="skin-midnight" onclick="Skins.set('midnight')" style="background:#a78bfa" title="Midnight"></span>
<span class="skin-dot" id="skin-lava" onclick="Skins.set('lava')" style="background:#ff3d5a" title="Lava"></span>
<span class="skin-dot" id="skin-forest" onclick="Skins.set('forest')" style="background:#7fff6e" title="Forest"></span>
</div>
</div>
</div>
<div class="settings-row">
<div>
<div class="settings-label">🔔 Notifications</div>
<div class="settings-sub">Alert when print finishes</div>
</div>
<button class="btn btn-ghost btn-sm" onclick="Notifications.toggle()">Enable</button>
</div>
<div class="settings-row">
<div>
<div class="settings-label">⏸ Auto-pauze</div>
<div class="settings-sub">Pauzeert automatisch na 30s inactiviteit</div>
</div>
<button class="btn btn-ghost btn-sm" onclick="Game.saveGame(true)">Actief ✓</button>
</div>
<div class="settings-row">
<div>
<div class="settings-label">📖 Tutorial</div>
<div class="settings-sub">Restart the onboarding</div>
</div>
<button class="btn btn-ghost btn-sm" onclick="Tutorial.start()">Restart</button>
</div>
<div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:8px;">
<div class="settings-label">💾 Save / Export</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;width:100%">
<button class="btn btn-ghost btn-sm" onclick="Game.saveGame(true)" style="flex:1">Manual Save</button>
<button class="btn btn-ghost btn-sm" onclick="Game.exportSave()" style="flex:1">📤 Export JSON</button>
</div>
<label class="btn btn-ghost btn-sm" style="flex:1;cursor:pointer;text-align:center;width:100%">
                📥 Import Save <input accept=".json" onchange="Game.importSave(event)" style="display:none" type="file"/>
</label>
</div>
<div class="settings-danger-zone">
<div class="settings-danger-title">⚠ Danger Zone</div>
<button class="btn btn-danger btn-sm btn-full" onclick="Game.resetGame()">↺ Reset All Progress</button>
</div>
<div id="prestige-section" style="margin-top:8px;"></div>
</div>
</div>
<!-- v8: RESEARCH TAB -->
<div class="tab-content" id="tab-research">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ⚗️ Investeer in <strong style="color:var(--accent)">Onderzoek</strong> voor krachtige upgrades en permanente bonussen. Één project tegelijk.
          </div>
<div id="research-panel"></div>
</div>
<!-- v8: BOUNTIES TAB -->
<div class="tab-content" id="tab-bounties">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            🎯 <strong style="color:#ffd700">Opdrachten</strong> zijn speciale uitdagingen met hoge beloning. Elke 10 minuten vernieuwd.
          </div>
<div id="bounty-panel"></div>
</div>
<!-- v8: DASHBOARD TAB -->
<div class="tab-content" id="tab-dashboard">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            📈 Jouw bedrijf in één oogopslag — KPI's, efficiëntie, mijlpalen en records.
          </div>
<div id="dashboard-panel"></div>
</div>
<!-- v8: EQUIPMENT EVENTS TAB -->
<div class="tab-content" id="tab-equipment">
<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            🔧 <strong style="color:var(--danger)">Equipment Events</strong> vereisen je aandacht. Los problemen snel op om productie soepel te laten lopen.
          </div>
<div id="equip-events-panel"></div>
<div style="margin-top:12px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);">
<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Mijlpalen</div>
<div id="milestone-progress-list"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- v8: MILESTONE OVERLAY -->
<div id="milestone-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:8999;backdrop-filter:blur(3px)">
<div class="milestone-banner" id="milestone-banner" style="display:none"></div>
</div>
<!-- v10: TAX OVERLAY -->
<div class="tax-overlay" id="tax-overlay">
<div class="tax-box">
<div style="font-size:36px;margin-bottom:6px">🧾</div>
<div class="tax-title">VAT BILL!</div>
<div class="tax-amount" id="tax-amount">€0.00</div>
<div class="tax-sub">De overheid wil zijn deel.<br/>Buy an <strong style="color:var(--warn)">Accountant</strong> to reduce VAT by 40%.</div>
<div class="tax-breakdown" id="tax-breakdown"></div>
<button class="btn btn-primary btn-full" onclick="TaxSystem.pay()" style="margin-top:4px">💳 Pay Tax Bill</button>
<div id="tax-warning" style="font-size:11px;color:var(--danger);margin-top:6px"></div>
</div>
</div>
<!-- v10: COMPLAINT OVERLAY -->
<div class="complaint-overlay" id="complaint-overlay">
<div class="complaint-box">
<div class="complaint-face" id="complaint-face">😤</div>
<div class="complaint-title">KLANTKLACHT!</div>
<div id="complaint-client" style="font-size:10px;color:var(--text-dim);margin-top:4px">TechHobbyist99</div>
<div class="complaint-msg" id="complaint-msg">"I paid good money for this and it came out like spaghetti!"</div>
<div class="complaint-choices">
<button class="btn btn-danger btn-sm" onclick="Complaints.refund()">💸 Refund (−€<span id="complaint-refund">25</span>)</button>
<button class="btn btn-ghost btn-sm" onclick="Complaints.ignore()">🙄 Ignore (−<span id="complaint-rep">10</span> Rep)</button>
</div>
</div>
</div>
<!-- v10: PRESTIGE PERK SELECT -->
<div class="perk-select-overlay" id="perk-select-overlay">
<div class="perk-select-box">
<div class="perk-select-title">⭐ LEGACY PERK</div>
<div class="perk-select-sub">Choose one permanent bonus that survives all future prestiges.</div>
<div class="perk-select-grid" id="perk-select-grid"></div>
</div>
</div>
<!-- v9: CLOG MINI-GAME -->
<div id="clog-overlay">
<div class="clog-box">
<div class="clog-title">🔴 NOZZLE VERSTOPT!</div>
<div class="clog-desc">Je nozzle is verstopt tijdens een print! Tik snel op de knop om hem vrij te maken!<br/><span style="color:var(--danger);font-size:10px">Printer: <span id="clog-printer-name">Printer #1</span></span></div>
<div class="clog-progress-text"><span id="clog-clicks">0</span> / <span id="clog-target">20</span> presses</div>
<div class="clog-timer-bar"><div class="clog-timer-fill" id="clog-timer-fill" style="width:100%"></div></div>
<div class="clog-mash">
<button class="clog-mash-btn" id="clog-btn" onclick="ClogMinigame.press()">🔧</button>
</div>
<div id="clog-feedback" style="font-size:10px;color:var(--text-dim);margin-top:4px">Tik snel op de knop!</div>
<button class="btn btn-ghost btn-sm" onclick="ClogMinigame.skip()" style="margin-top:10px;width:100%">Overslaan (job mislukt)</button>
</div>
</div>
<!-- POPUP -->
<div id="popup-overlay">
<div class="popup" id="popup-box">
<div class="popup-title" id="popup-title">Event!</div>
<div class="popup-body" id="popup-body">Something happened.</div>
<div class="popup-actions">
<button class="btn btn-ghost btn-sm" id="popup-cancel" onclick="closePopup()" style="display:none;">Cancel</button>
<button class="btn btn-primary" id="popup-ok" onclick="closePopup()">OK</button>
</div>
</div>
</div>
<!-- v14: Narrative Event Overlay -->
<div id="narrative-overlay">
<div class="narrative-card" id="narrative-card">
<div class="narrative-header">
<div class="narrative-portrait" id="narrative-portrait">🧑‍💼</div>
<div class="narrative-meta">
<div class="narrative-tag" id="narrative-tag">Event</div>
<div class="narrative-title" id="narrative-title">Something happened</div>
</div>
</div>
<div class="narrative-body" id="narrative-body">A moment that changes everything...</div>
<div class="narrative-choices" id="narrative-choices"></div>
<div class="narrative-skip">
<button class="narrative-skip-btn" onclick="NarrativeEvents.dismiss()">skip →</button>
</div>
</div>
</div>
<script>

// ── CONFIG ───────────────────────────────────────────────────
const APP_VERSION = 17.6;

// ── UTILITY HELPERS ──────────────────────────────────────────
/** Round to 2 decimal places (€ values) */
const r2 = (v) => Math.round((Number(v) || 0) * 100) / 100;
/** Round to 0 decimal places */
const r0 = (v) => Math.round(Number(v) || 0);
/** getElementById shorthand */
const el  = id => document.getElementById(id);
const $el = el; // alias for use inside functions that shadow `el`
/** Clamp a value between min and max */
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
/** Get CSS filament class from filament key */
const filClass = f => ({ 'PA6':'pa6', 'PA6-GF':'pa6', 'TPU':'tpu', 'RESIN':'resin', 'PETG':'petg', 'PLA':'pla' }[f] ?? f.toLowerCase());
/** Format € with 2 decimals */
const fmtEur = v => `€${r2(v).toFixed(2)}`;
/** Format time in m:ss */
const fmtTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

const CONFIG = {
  TICK_MS:            500,
  ORDER_MIN_SEC:      6,
  ORDER_MAX_SEC:      12,
  MAX_ORDERS:         7,
  ORDER_EXPIRE_S:     90,
  STARTING_MONEY:     50,
  REP_PER_SUCCESS:    2,
  REP_PER_FAILURE:    -3,
  REP_PER_EXPIRED:    -1,
  MAX_REP:            200,
  REPAIR_COST_PER_HP: 0.5,
  CONTRACT_REFRESH_S: 100,   // contracts refresh 
  DAILY_REFRESH_S:    86400, // daily contract every 24h (real time)
  INCOME_HISTORY_MAX: 40,    // data points in graph

  PRINTER_MODELS: {
    BASIC: { name:'Ender Clone',          speedMult:1.0, failAdd:0.00,  cost:0,    desc:'Standaard. Goedkoop en redelijk.' },
    SPEED: { name:'CoreXY Speedster',     speedMult:0.5, failAdd:0.18,  cost:1500, desc:'Extreem snel (50% tijd), maar faalt veel vaker.' },
    TANK:  { name:'Industrial Workhorse', speedMult:1.5, failAdd:-0.15, cost:2500, desc:'Traag (150% tijd), maar faalt vrijwel nooit.' },
    DELTA: { name:'Delta Titan',          speedMult:0.7, failAdd:-0.05, cost:0,    desc:'Grote delta printer. Snel én betrouwbaar. Exclusief voor Titan #5.' },
  },

  TRENDING_PRODUCTS: [
    { trigger:'Fidget',        item:'Fidget',        mult:2.5, desc:'Fidgets zijn viraal gegaan op TikTok! Marges ×2.5' },
    { trigger:'Mask',          item:'Mask',          mult:3.0, desc:'Comic Con weekend! Cosplay props schieten in prijs omhoog.' },
    { trigger:'Fan Shroud',    item:'Fan Shroud',    mult:2.0, desc:'Hittegolf! Iedereen wil ventilator-onderdelen.' },
    { trigger:'Bracket',       item:'Bracket',       mult:1.8, desc:'School seizoen! Houders en brackets zijn hot.' },
    { trigger:'Figurine',      item:'Figurine',      mult:2.8, desc:'Kickstarter-campagne explosiefgroei! Figurines gewild.' },
    { trigger:'Phone Stand',   item:'Phone Stand',   mult:2.2, desc:'Viral desk-setup trend op sociale media!' },
    { trigger:'Gear',          item:'Gear',          mult:2.4, desc:'Robotica-competitie! Tandwielen en onderdelen in trek.' },
    { trigger:'Trophy',        item:'Trophy Ornament',mult:2.6,desc:'Award-seizoen! Trofeeën en ornamenten zijn hot.' },
    { trigger:'Miniature',     item:'Miniature',     mult:3.2, desc:'Tabletop gaming boom! Miniaturen in enorme vraag.' },
    { trigger:'Phone Bumper',  item:'Phone Bumper',  mult:1.9, desc:'Nieuw flagship-telefoon uitgebracht! Hoesjes gewild.' },
    { trigger:'Drone',         item:'Drone Frame',   mult:2.7, desc:'Drone racing seizoen gestart! Frames gewild.' },
    { trigger:'Vase',          item:'Vase',          mult:2.0, desc:'Home decor trend — vazen en potten zijn viraal.' },
  ],

  FILAMENTS: {
    PLA:   { name:'PLA',                  costPerJob:2,  failBase:0.05, profitMult:1.0, repBonus:1.0, color:'var(--pla)',   desc:'Cheap & reliable',                  unlockRep:0,   stockUse:3  },
    PETG:  { name:'PETG',                 costPerJob:5,  failBase:0.12, profitMult:1.5, repBonus:1.3, color:'var(--petg)',  desc:'Strong & flexible',                 unlockRep:20,  stockUse:4  },
    PA6:   { name:'PA6-GF',               costPerJob:12, failBase:0.25, profitMult:2.5, repBonus:2.0, color:'var(--pa6)',   desc:'Engineering grade',                 unlockRep:60,  stockUse:5  },
    TPU:   { name:'TPU',                  costPerJob:8,  failBase:0.18, profitMult:2.0, repBonus:1.6, color:'#80cbc4',      desc:'Flexible & durable',                unlockRep:40,  stockUse:4, special:'flex' },
    RESIN: { name:'Resin',                costPerJob:15, failBase:0.30, profitMult:3.5, repBonus:2.5, color:'#ce93d8',      desc:'Ultra-detail SLA prints',           unlockRep:80,  stockUse:6, special:'detail', requiresUpgrade:'resin_printer' },
    CF:    { name:'Carbon Fiber (PA-CF)', costPerJob:25, failBase:0.35, profitMult:5.0, repBonus:3.0, color:'#90a4ae',      desc:'Extreme marges, maar vernielt nozzles (35% faalkans)', unlockRep:120, stockUse:5, special:'abrasive' },
    GLOW:  { name:'Glow-in-the-Dark',     costPerJob:10, failBase:0.15, profitMult:2.5, repBonus:1.5, color:'#69ff47',      desc:'Perfect voor speelgoed-klanten en nachttarieven',      unlockRep:50,  stockUse:3  },
  },

  QUALITY: {
    DRAFT:  { name:'Draft',  timeMult:0.6,  failAdd:0.05,  profitMult:0.8,  repMult:0.8  },
    NORMAL: { name:'Normal', timeMult:1.0,  failAdd:0.00,  profitMult:1.0,  repMult:1.0  },
    FINE:   { name:'Fine',   timeMult:1.6,  failAdd:-0.04, profitMult:1.3,  repMult:1.2  },
    ULTRA:  { name:'Ultra',  timeMult:2.5,  failAdd:-0.06, profitMult:1.7,  repMult:1.5  },
  },

  UPGRADES: [
    // ── BETROUWBAARHEID ──
    { id:'bed_leveling',   name:'Auto Bed Leveling',   desc:'ABL probe eliminates first-layer failures.',        effect:'−8% fail chance',          cost:80,   unlockLevel:1, category:'reliability', premium:false, apply:(s)=>{ s.failBonus -= 0.08; } },
    { id:'hardened_nozzle',name:'Hardened Nozzle',      desc:'Wear-resistant — reduces abrasive filament clogs.', effect:'−10% fail (PETG/PA6)',       cost:150,  unlockLevel:2, category:'reliability', premium:false, apply:(s)=>{ s.abrasiveBonus -= 0.10; } },
    { id:'enclosure',      name:'Printer Enclosure',    desc:'Enclosed volume reduces warping dramatically.',      effect:'−12% fail globally',        cost:350,  unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ s.failBonus -= 0.12; } },
    { id:'dryer',          name:'Filament Dryer',       desc:'Dry filament = fewer PA6-GF and PETG failures.',    effect:'−15% fail (hygroscopic)',    cost:280,  unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ s.dryerBonus -= 0.15; } },
    { id:'ups_system',     name:'UPS Battery System',  desc:'Uninterruptible power supply. Prevents all power outages from disrupting prints.',  effect:'Immune to power outages', cost:1200, unlockLevel:4, category:'reliability', premium:false, apply:(s)=>{ /* flag is checked by PowerOutage module */ } },
    { id:'accountant',     name:'Accountant',          desc:'Part-time accountant files your taxes optimally. VAT reduced from 15% to 9%.',       effect:'VAT cut to 9%',           cost:2000, unlockLevel:4, category:'profit',      premium:false, apply:(s)=>{ s.hasAccountant=true; s.taxRate=0.09; } },
    { id:'insurance',      name:'Business Insurance',  desc:'Monthly premium of €50. Covers catastrophic equipment failures and power outages.',   effect:'Failures covered by insurance', cost:500, unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ s.hasInsurance=true; } },
    { id:'recycler',       name:'Filament Recycler',   desc:'Turns failed print scrap into usable filament. Collect scrap, convert to stock.',     effect:'Convert scrap→filament',  cost:900,  unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ /* checked by Recycling module */ } },
    { id:'subscription_sys',name:'Subscription System',desc:'Enables recurring print subscriptions. Some clients auto-send weekly orders.',        effect:'Unlock subscription clients', cost:3500, unlockLevel:5, category:'profit', premium:false, apply:(s)=>{ Subscriptions.unlock(); } },
    // ── SNELHEID ──
    { id:'faster_extruder',name:'Volcano Extruder',     desc:'High-flow hotend prints 30% faster.',               effect:'−30% print time',           cost:200,  unlockLevel:2, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.70; } },
    { id:'cloud_slicer',   name:'Cloud Slicer',         desc:'AI-optimised slicing cuts print time significantly.',effect:'-20% print time (all)',      cost:4000, unlockLevel:6, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.80; } },
    { id:'direct_drive',   name:'Direct Drive',         desc:'Better filament control — faster retraction & flex filaments.',effect:'-15% time, TPU unlock',   cost:500,  unlockLevel:3, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.85; s.tpuUnlocked = true; } },
    { id:'klipper',        name:'Klipper Firmware',     desc:'Input shaping eliminates ringing — up to 40% speed gain.',  effect:'-25% print time, -5% fail',cost:2500,unlockLevel:5, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.75; s.failBonus -= 0.05; } },
    // ── WINST ──
    { id:'ams',            name:'AMS Multi-Material',   desc:'Automated Material System. Opens premium orders.',  effect:'+25% all rewards',          cost:500,  unlockLevel:3, category:'profit',      premium:false, apply:(s)=>{ s.rewardMult += 0.25; } },
    { id:'passive_income', name:'Online Store',         desc:'Print-on-demand store generates passive income.',   effect:'+€10/min passive',          cost:800,  unlockLevel:4, category:'profit',      premium:false, apply:(s)=>{ s.passivePerMin += 10; } },
    { id:'auto_package',   name:'Automated Packaging',  desc:'Robotic packaging arm. Every job earns +1 rep.',   effect:'+1 Rep per completed job',   cost:2200, unlockLevel:5, category:'profit',      premium:false, apply:(s)=>{ s.packagingBonus = true; } },
    { id:'etsy_store',     name:'Etsy Empire',          desc:'Full e-commerce store. Massive passive income.',   effect:'+€40/min passive',           cost:8000, unlockLevel:7, category:'profit',      premium:false, apply:(s)=>{ s.passivePerMin += 40; } },
    { id:'bulk_deals',     name:'Bulk Deal Contracts',  desc:'Negotiate bulk pricing — filament costs −20% permanently.', effect:'−20% filament costs',  cost:1800, unlockLevel:4, category:'profit',      premium:false, apply:(s)=>{ s.bulkDealActive = true; } },
    // ── UITBREIDING ──
    { id:'printer2',       name:'2nd Printer',          desc:'Run two jobs simultaneously. True idle income.',     effect:'Second printer slot',       cost:1200, unlockLevel:4, category:'expansion',   premium:false, apply:(s)=>{ s.printerCount = 2; } },
    { id:'printer3',       name:'3rd Printer',          desc:'Scale up to three simultaneous print jobs.',        effect:'Third printer slot',         cost:3500, unlockLevel:5, category:'expansion',   premium:false, apply:(s)=>{ s.printerCount = 3; } },
    { id:'printer4',       name:'4th Printer (Farm)',   desc:'Industrial scale — four printers running 24/7.',    effect:'Fourth printer slot',        cost:8000, unlockLevel:7, category:'expansion',   premium:false, apply:(s)=>{ s.printerCount = 4; } },
    { id:'resin_printer',  name:'SLA Resin Printer',    desc:'Add a stereolithography printer for ultra-detailed miniatures and jewelry.',  effect:'Unlock Resin filament',  cost:2800, unlockLevel:5, category:'expansion',   premium:false, apply:(s)=>{ s.resinUnlocked = true; } },
    { id:'uv_station',     name:'UV Curing Station',    desc:'Post-cure resin prints for max quality. −25% fail on Resin.', effect:'Resin fail −25%',       cost:400,  unlockLevel:5, category:'expansion',   premium:false, apply:(s)=>{ s.uvCuring = true; s.failBonus -= 0.05; } },
    { id:'flex_bed',       name:'Flexible Print Bed',   desc:'PEI-coated spring steel sheet. TPU prints peel off perfectly.', effect:'TPU fail −20%',         cost:120,  unlockLevel:2, category:'expansion',   premium:false, apply:(s)=>{ s.flexBed = true; } },
    // ── PRINTER MODELS ──
    { id:'model_speed',     name:'Upgrade to CoreXY',         desc:'Vervang Printer #2 met een CoreXY Speedster. 50% sneller, maar +18% faalkans.', effect:'Printer #2: 2× speed, +18% fail', cost:1500, unlockLevel:3, category:'speed',       premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===1); if(p) p.model='SPEED'; } },
    { id:'model_tank',      name:'Industrial Workhorse',       desc:'Zet Printer #2 om naar Industrial Workhorse. Betrouwbaar en stabiel.', effect:'Printer #2: 1.5× time, −15% fail', cost:2500, unlockLevel:4, category:'reliability',  premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===1); if(p) p.model='TANK'; } },
    { id:'model_speed_p3',  name:'CoreXY voor Printer #3',     desc:'Zet Printer #3 om naar CoreXY Speedster voor maximale doorvoer.', effect:'Printer #3: 2× speed, +18% fail', cost:1500, unlockLevel:5, category:'speed',       premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===2); if(p) p.model='SPEED'; } },
    { id:'model_tank_p3',   name:'Workhorse voor Printer #3',  desc:'Zet Printer #3 om naar Industrial Workhorse voor stabiele lange runs.', effect:'Printer #3: 1.5× time, −15% fail', cost:2500, unlockLevel:6, category:'reliability', premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===2); if(p) p.model='TANK'; } },
    // ── NICHE FILAMENTS ──
    { id:'glow_filament',   name:'Glow-in-the-Dark Filament',  desc:'Ontgrendel Glow-in-the-Dark filament. Perfect voor speelgoed en nacht-items.', effect:'Unlock GLOW filament', cost:600,  unlockLevel:3, category:'expansion',   premium:false, apply:(s)=>{ s.glowUnlocked=true; } },
    { id:'cf_nozzle',       name:'CF Nozzle + Enclosure',      desc:'Hardened nozzle en enclosure voor Carbon Fiber. Vermindert de 35% faalkans met 20% → ~15% effectief.', effect:'Unlock CF filament, −20% CF fail', cost:1800, unlockLevel:5, category:'expansion', premium:false, apply:(s)=>{ s.cfUnlocked=true; s.cfNozzle=true; } },
    // ── PRO UPGRADES ──
    { id:'smart_queue',    name:'Smart Queue',          desc:'AI auto-assigns the highest-value pending order to the next free printer.',  effect:'Auto-assign orders', cost:0, unlockLevel:1, category:'pro', premium:true, apply:(s)=>{ s.smartQueue = true; } },
    { id:'ai_quality',     name:'AI Quality Control',  desc:'Computer vision detects failures mid-print and cancels early.',              effect:'−50% failure damage',  cost:0, unlockLevel:1, category:'pro', premium:true, apply:(s)=>{ s.aiQuality = true; } },
    { id:'supplier_ai',    name:'Supplier AI',         desc:'AI monitors market and auto-buys filament when prices are low.',             effect:'Auto-buy cheap filament', cost:0, unlockLevel:3, category:'pro', premium:true, apply:(s)=>{ s.supplierAI = true; } },
  ],

  BIZ_LEVELS: [
    { name:'Garage Tinkerer', xp:0,    level:1 },
    { name:'Hobbyist',        xp:100,  level:2 },
    { name:'Side Hustler',    xp:300,  level:3 },
    { name:'Print Studio',    xp:700,  level:4 },
    { name:'Pro Workshop',    xp:1500, level:5 },
    { name:'Factory Floor',   xp:3000, level:6 },
    { name:'Print Empire',    xp:6000, level:7 },
    { name:'Industry Titan',  xp:12000,level:8 },
  ],

  ACHIEVEMENTS: [
    { id:'first_print',   name:'First Layer',      desc:'Complete your first print.',            check:(s)=>s.stats.jobsDone>=1        },
    { id:'five_jobs',     name:'Getting Warm',      desc:'Complete 5 jobs.',                      check:(s)=>s.stats.jobsDone>=5        },
    { id:'hundred',       name:'Centurion',         desc:'Earn €100 total.',                      check:(s)=>s.stats.totalEarned>=100   },
    { id:'first_fail',    name:'Spaghetti!',        desc:'Experience your first failure.',        check:(s)=>s.stats.jobsFailed>=1      },
    { id:'first_upgrade', name:'Upgrader',          desc:'Buy your first upgrade.',               check:(s)=>s.stats.upgradesBought>=1  },
    { id:'rep_50',        name:'Reliable',          desc:'Reach 50 reputation.',                  check:(s)=>s.reputation>=50           },
    { id:'rep_100',       name:'Trusted Brand',     desc:'Reach 100 reputation.',                 check:(s)=>s.reputation>=100          },
    { id:'thousand',      name:'Grand',             desc:'Earn €1,000 total.',                    check:(s)=>s.stats.totalEarned>=1000  },
    { id:'pa6_success',   name:'Engineering Grade', desc:'Successfully print PA6-GF.',            check:(s)=>s.stats.pa6Done>=1         },
    { id:'dual_printer',  name:'Scale-Up',          desc:'Own two printers.',                     check:(s)=>s.printerCount>=2          },
    { id:'ten_k',         name:'Print Baron',       desc:'Earn €10,000 total.',                   check:(s)=>s.stats.totalEarned>=10000 },
    { id:'first_contract',name:'Under Contract',    desc:'Complete your first contract.',         check:(s)=>s.stats.contractsDone>=1   },
    { id:'five_contracts', name:'Contractor',       desc:'Complete 5 contracts.',                 check:(s)=>s.stats.contractsDone>=5   },
    { id:'daily_done',    name:'Daily Grind',       desc:'Complete a daily special contract.',    check:(s)=>s.stats.dailyDone>=1       },
    // ── NEW v2.0 ──
    { id:'streak_5',      name:'On a Roll',         desc:'Complete 5 jobs in a row without failure.', check:(s)=>s.stats.longestStreak>=5   },
    { id:'streak_10',     name:'Hot Streak',        desc:'10-job streak — flawless.',             check:(s)=>s.stats.longestStreak>=10  },
    { id:'night_owl',     name:'Night Owl',         desc:'Print a job after 22:00.',              check:(s)=>s.stats.nightShiftJobs>=1  },
    { id:'speed_demon',   name:'Speed Demon',       desc:'Complete a job in under 18 seconds.',   check:(s)=>s.stats.fastestJob>0&&s.stats.fastestJob<=18 },
    { id:'fifty_jobs',    name:'Assembly Line',     desc:'Complete 50 jobs.',                     check:(s)=>s.stats.jobsDone>=50       },
    { id:'hundred_jobs',  name:'Print Marathon',    desc:'Complete 100 jobs.',                    check:(s)=>s.stats.jobsDone>=100      },
    { id:'twenty_k',      name:'Print Mogul',       desc:'Earn €20,000 total.',                   check:(s)=>s.stats.totalEarned>=20000 },
    { id:'market_master', name:'Market Watcher',    desc:'Sell 10 jobs during a market surge (×1.2+).', check:(s)=>s.stats.marketSurgeJobs>=10 },
    { id:'triple_printer',name:'Print Farm',        desc:'Own three printers.',                   check:(s)=>s.printerCount>=3          },
    { id:'rep_150',       name:'Industry Legend',   desc:'Reach 150 reputation.',                 check:(s)=>s.reputation>=150          },
    { id:'petg_ten',      name:'PETG Pro',          desc:'Complete 10 PETG jobs.',                check:(s)=>s.stats.petgDone>=10       },
    { id:'passive_earner',name:'Passive Income',    desc:'Earn €100 from passive sources.',       check:(s)=>s.stats.passiveEarned>=100 },
    { id:'all_upgrades',  name:'Maxed Out',         desc:'Own 8 or more upgrades.',               check:(s)=>s.ownedUpgrades.length>=8  },
    { id:'prestige_1',    name:'Fresh Start',        desc:'Prestige for the first time.',           check:(s)=>s.prestige>=1              },
    { id:'combo_10',      name:'Combo Master',       desc:'Reach a 10× combo.',                    check:(s)=>s.stats.maxCombo>=10       },
    { id:'speedrun_win',  name:'Speed Printer',      desc:'Earn €200 in a single speedrun.',       check:(s)=>s.stats.bestSpeedrun>=200  },
    { id:'all_specs',     name:'Specialist Farm',    desc:'Give all 3 printers a specialization.', check:(s)=>Object.keys(s.printerSpecs).length>=3 },
    // ── v7 NEW ──
    { id:'tpu_first',     name:'Flex Master',        desc:'Print your first TPU flexible job.',    check:(s)=>(s.stats.tpuDone||0)>=1   },
    { id:'resin_first',   name:'Precision Artisan',  desc:'Print your first Resin SLA job.',       check:(s)=>(s.stats.resinDone||0)>=1 },
    { id:'tpu_ten',       name:'Rubber King',        desc:'Complete 10 TPU jobs.',                 check:(s)=>(s.stats.tpuDone||0)>=10  },
    { id:'resin_five',    name:'SLA Expert',         desc:'Complete 5 Resin jobs.',                check:(s)=>(s.stats.resinDone||0)>=5 },
    { id:'all_filaments', name:'Material Master',    desc:'Use 5 or more different filament types.',      check:(s)=>(s.stats.filamentsUsed||[]).length>=5 },
    { id:'supplier_trust',name:'Trusted Partner',    desc:'Reach Trusted status with a supplier.', check:(s)=>Object.values(s.supplierRelations||{}).some(r=>r>=2) },
    { id:'crisis_survivor',name:'Crisis Survivor',   desc:'Complete 5 jobs during a market crisis.',check:(s)=>(s.stats.crisisJobsDone||0)>=5 },
    { id:'challenge_one', name:'Challenger',         desc:'Complete your first weekly challenge.', check:(s)=>(s.stats.challengesDone||0)>=1 },
    { id:'printer4_own',  name:'Print Farm',         desc:'Own four printers.',                   check:(s)=>s.printerCount>=4          },
    { id:'ultra_ten',     name:'Ultra Perfectionist',desc:'Complete 10 Ultra quality jobs.',       check:(s)=>(s.stats.ultraJobs||0)>=10 },
    // ── v9 NEW ──
    { id:'beat_rival',    name:'Beat the Bot',        desc:'Complete 20 more jobs than PrintBot.',  check:(s)=>s.stats.jobsDone > (s.rivalScore||0)+20 },
    { id:'surge_hero',    name:'Surge Warrior',        desc:'Complete 3 demand surges successfully.', check:(s)=>(s.stats.surgesDone||0)>=3 },
    { id:'debt_free',     name:'Debt Destroyer',       desc:'Repay a loan in full.',                 check:(s)=>(s.stats.loansRepaid||0)>=1 },
    { id:'clog_champ',    name:'Clog Champion',        desc:'Win 5 nozzle clog mini-games.',         check:(s)=>(s.stats.clogWins||0)>=5 },
    { id:'no_outage',     name:'Blackout Proof',        desc:'Buy the UPS upgrade.',                  check:(s)=>s.ownedUpgrades.includes('ups_system') },
    // ── v10 NEW ──
    { id:'tax_man',       name:'Tax Man',               desc:'Pay 5 VAT bills without penalty.',      check:(s)=>(s.stats_v10?.taxPaid||0) >= 250 },
    { id:'platinum_client',name:'Platinum Standard',   desc:'Reach Platinum tier with any client.',  check:(s)=>Object.values(s.clientTiers||{}).includes('platinum') },
    { id:'franchise_boss',name:'Franchise Boss',        desc:'Open your first franchise branch.',     check:(s)=>(s.franchiseBranches||[]).length >= 1 },
    { id:'legacy_master', name:'Legacy Master',         desc:'Earn 3 Legacy Perks.',                  check:(s)=>(s.legacyPerks||[]).length >= 3 },
    { id:'hall_of_famer', name:'Hall of Famer',         desc:'Appear in the Hall of Fame.',           check:(s)=>(s.prestige||0)>=1 },
    { id:'scrap_king',    name:'Scrap King',             desc:'Recycle 10 batches of scrap.',          check:(s)=>(s.stats_v10?.scrapsRecycled||0)>=10 },
    { id:'team_spirit',   name:'Team Spirit',           desc:'Buy 3 Team Lunches.',                   check:(s)=>(s.stats.lunchesBought||0)>=3 },
    { id:'subscriber',    name:'Subscriber',             desc:'Complete 20 subscription orders.',      check:(s)=>(s.stats_v10?.subscriptionJobsDone||0)>=20 },
    // v12 achievements
    { id:'night_grinder', name:'Nachtdienst Pro',         desc:'Print 25 jobs tijdens het nachtshift.',  check:(s)=>(s.stats.nightShiftJobs||0)>=25 },
    { id:'cf_master',     name:'CF Meester',               desc:'Voltooi 5 Carbon Fiber jobs.',           check:(s)=>(s.stats.cfDone||0)>=5 },
    { id:'researcher',    name:'Wetenschapper',            desc:'Voltooi 5 research projecten.',          check:(s)=>(s.completedResearch||[]).length>=5 },
    { id:'ai_factory',    name:'AI Fabriek',               desc:'Ontgrendel de AI Print Factory research.', check:(s)=>(s.completedResearch||[]).includes('r_ai_factory') },
    { id:'trend_surfer',  name:'Trend Surfer',             desc:'Voltooi 10 TRENDING orders.',            check:(s)=>(s.stats.trendOrdersDone||0)>=10 },
    { id:'five_printer',  name:'Print God Farm',           desc:'Heb 5 printers tegelijk.',               check:(s)=>s.printerCount>=5 },
  ],

  EVENTS: [
    { title:'📦 Bulk Order Bonus!',  body:'A makespace placed a bulk order! Rewards +30% for next 3 jobs.',   effect:'bulkBonus',    value:3    },
    { title:'🔥 Clog Warning!',      body:'Nozzle temp spiked. Next print +15% fail chance.',                  effect:'nextFailBoost',value:0.15 },
    { title:'⭐ 5-Star Review!',     body:'A customer left a glowing review. +10 Reputation!',                 effect:'repBoost',     value:10   },
    { title:'💸 Material Sale!',     body:'Supplier sale! Filament costs −50% for next 5 jobs.',              effect:'filDiscount',  value:5    },
    { title:'🌡️ Power Surge!',      body:'Minor power fluctuation. Printer health −8.',                       effect:'hpLoss',       value:8    },
    { title:'📰 Local Press!',       body:'A local paper featured your shop! +15 Reputation.',                effect:'repBoost',     value:15   },
    { title:'🎁 Warranty Parts!',    body:'Free maintenance kit arrived. Printer #1 health +20!',             effect:'hpHeal',       value:20   },
    { title:'📱 Viral TikTok!',      body:'Your shop went viral! Reputation +20 and bulk bonus for 5 jobs!',  effect:'repBoost',     value:20   },
    { title:'🧯 Fire Drill!',        body:'Safety check slowed things down. Printer health −5, but +5 rep for compliance.', effect:'hpLoss', value:5 },
    { title:'🏆 Industry Award!',    body:'Your shop won a local 3D printing award! +25 Reputation!',         effect:'repBoost',     value:25   },
    { title:'🎰 Lucky Roll!',        body:'Surprise! Filament discount AND bulk bonus active together!',       effect:'filDiscount',  value:3    },
    { title:'💧 Humidity Warning!',  body:'High humidity detected. Non-PLA filaments +10% fail next 3 jobs.', effect:'nextFailBoost',value:0.10 },
  ],

  EMPLOYEES: [
    { id:'student',   name:'Stage Student',   avatar:'🧑‍🎓', desc:'Start automatisch PLA-bestellingen. Langzaam maar goedkoop.', wagePM:5,  unlockLevel:2, effect:'autoPLA',   cost:200  },
    { id:'technician',name:'Technicus',        avatar:'🔧',   desc:'Repareert printers automatisch zodra health < 40%.', wagePM:12, unlockLevel:4, effect:'autoRepair', cost:800  },
    { id:'manager',   name:'Manager',          avatar:'💼',   desc:'Beheert wachtrij optimaal — pakt altijd de meest lucratieve order.', wagePM:20, unlockLevel:5, effect:'queueOpt',  cost:1500 },
    { id:'engineer',  name:'Print Engineer',   avatar:'👷',   desc:'Vermindert faalkansen met 10% op alle printers.', wagePM:25, unlockLevel:6, effect:'failRedux',  cost:2500 },
    { id:'salesperson',name:'Verkoper',        avatar:'🤝',   desc:'Genereert elke 2 minuten een bonus order met 30% hogere beloning.', wagePM:18, unlockLevel:5, effect:'bonusOrders',cost:1800 },
  ],

  PRODUCTION_CHAINS: [
    { id:'starter',  name:'Starter Kit',    steps:[{fil:'PLA',count:2},{fil:'PETG',count:1}],                  reward:80,  bonusTokens:3,  unlockLevel:2 },
    { id:'technical',name:'Tech Bundle',    steps:[{fil:'PETG',count:2},{fil:'PA6',count:1}],                  reward:200, bonusTokens:8,  unlockLevel:4 },
    { id:'fullspec', name:'Full Spectrum',  steps:[{fil:'PLA',count:2},{fil:'PETG',count:2},{fil:'PA6',count:2}],reward:500, bonusTokens:20, unlockLevel:6 },
    { id:'prototype',name:'Proto Sprint',   steps:[{fil:'PLA',count:1},{fil:'PETG',count:1},{fil:'PA6',count:1}],reward:300, bonusTokens:12, unlockLevel:5 },
  ],

  LOOTBOX_REWARDS: [
    { name:'€50 Cash',       icon:'💰', rarity:'common',  apply:(s)=>{ s.money=r2(s.money+50); s.stats.totalEarned=r2(s.stats.totalEarned+50); TaxSystem.accrue(50); return '+€50 cash!'; } },
    { name:'+20 Reputatie',  icon:'⭐', rarity:'common',  apply:(s)=>{ s.reputation=Math.min(200,s.reputation+20); return '+20 reputatie!'; } },
    { name:'+30 Health',     icon:'🔧', rarity:'common',  apply:(s)=>{ s.printers.forEach(p=>p.health=Math.min(100,p.health+30)); return 'Alle printers +30 health!'; } },
    { name:'€200 Cash',      icon:'💎', rarity:'rare',    apply:(s)=>{ s.money=r2(s.money+200); s.stats.totalEarned=r2(s.stats.totalEarned+200); TaxSystem.accrue(200); return '+€200 cash!'; } },
    { name:'+50 Reputatie',  icon:'🌟', rarity:'rare',    apply:(s)=>{ s.reputation=Math.min(200,s.reputation+50); return '+50 reputatie!'; } },
    { name:'3× Bulkbonus',   icon:'📦', rarity:'rare',    apply:(s)=>{ s.bulkBonusJobs+=3; return '3 jobs op 30% bulk bonus!'; } },
    { name:'€500 Jackpot!',  icon:'🎰', rarity:'epic',    apply:(s)=>{ s.money=r2(s.money+500); s.stats.totalEarned=r2(s.stats.totalEarned+500); TaxSystem.accrue(500); return '🎰 JACKPOT: +€500!'; } },
    { name:'+100 XP',        icon:'⚡', rarity:'rare',    apply:(s)=>{ s.xp+=100; return '+100 XP!'; } },
    { name:'Gratis reparatie',icon:'🛠️',rarity:'common',  apply:(s)=>{ s.printers.forEach(p=>p.health=100); return 'Alle printers volledig gerepareerd!'; } },
    { name:'+5 Tokens',      icon:'🎲', rarity:'common',  apply:(s)=>{ s.tokens+=5; return '+5 bonus tokens!'; } },
  ],

  CUSTOMER_QUOTES: {
    accept: [
      "Can't wait to see how this turns out!",
      "I've heard great things about your shop.",
      "Please get this done on time — it's important.",
      "Quality first! I'll pay extra if it's perfect.",
      "This is for a prototype, precision matters.",
      "My last shop messed this up. Don't disappoint.",
      "Rush order — I'll tip if it's done quickly!",
      "Engineering grade requested. No shortcuts.",
    ],
    loyalAccept: [
      "Great working with you again! You never disappoint.",
      "Back again — your quality speaks for itself.",
      "My go-to print shop. Keep it up!",
      "Returning customer here — you've earned my trust.",
    ],
  },
  ORDER_NAMES_TPU:  ['Flexible Gasket','Phone Bumper','Silicone Grip','Door Stop','Bike Handlebar','RC Tire','Shock Absorber','Cable Protector','Wearable Band','Soft Toy Part','Flexible Hinge','Seal Ring','Custom Insole','Grip Pad','Boot Cover'],
  ORDER_NAMES_RESIN: ['Miniature Figure','Dental Model','Jewelry Mold','Detailed Bust','Architectural Detail','Watch Housing','Gem Setting','Filigree Part','Portrait Figurine','Game Piece','Trophy Ornament','Scale Model','Fine Art Piece','Precision Gear','Medical Prototype'],
  ORDER_NAMES:  ['Figurine','Bracket','Enclosure','Gear','Phone Stand','Vase','Tool Holder','Lamp Shade','Cable Clip','Plant Pot','Drone Frame','RC Part','Jig','Sensor Housing','Architectural Model','Prosthetic','Robot Chassis','Custom Badge','Turbine Blade','Fluid Manifold'],
  // Filament-specific order names (used when rep unlocks them)
  ORDER_NAMES_PLA:  ['Figurine','Desktop Organizer','Phone Stand','Plant Pot','Cable Clip','Vase','Toy Robot','Name Tag','Coaster Set','Key Holder','Lamp Shade','Card Stand','Pencil Cup','Bookmark','Mini Trophy'],
  ORDER_NAMES_PETG: ['Bicycle Adapter','Enclosure','Drone Frame','RC Part','Electronic Housing','Waterproof Case','Mechanical Arm','Water Pump Housing','Ventilation Duct','Fan Shroud','Camera Mount','Cable Duct','Hinge Set','Bracket Set','Snap Clip'],
  ORDER_NAMES_PA6:  ['Turbine Blade','Gear Set','Fluid Manifold','Sensor Housing','Jig & Fixture','Industrial Bracket','Structural Connector','Motor Housing','Drive Shaft','Timing Pulley','Impeller','Wear Pad','Slide Rail','Bearing Housing','Coupling Flange'],
  ORDER_CUSTOMERS: ['TechHobbyist99','MakerMike','DIYQueen','PrintFan','RoboGeek','LocalMakespace','StartupXYZ','ArtStudio7','EngineerJane','HomeLab42','FabLab','DesignSprint','PrototypePete','IndustrialIvo','NanoLab'],

  CONTRACT_NAMES: ['Batch Order','Prototype Run','Bulk Delivery','Series Print','Custom Set','Volume Order','Design Sprint','Production Run','Rapid Prototype','Multi-Material Kit','Precision Batch','Engineering Set'],
  CONTRACT_CUSTOMERS: ['TechLab Inc.','DesignHub','AeroStartup','MedDevice Co.','UniversityLab','StartupXYZ','ArchStudio','FabLab Berlin','NanoTech GmbH','OpenSource Co.'],

  SUPPLIERS: [
    {
      id: 'cheapfil',
      name: 'CheapFil GmbH',
      avatar: '🏭',
      desc: 'Goedkope bulk filament. Wisselende kwaliteit.',
      basePrice: { PLA: 0.8, PETG: 2.0, PA6: 5.0, TPU: 3.5, RESIN: 7.0, CF: 12.0, GLOW: 4.0 },
      reliabilityBase: 0.75,
      discount: { preferred: 0.10, trusted: 0.20 },
    },
    {
      id: 'prusament',
      name: 'Prusament Pro',
      avatar: '🇨🇿',
      desc: 'Hoge kwaliteit Europees filament. Betrouwbaar.',
      basePrice: { PLA: 1.4, PETG: 3.2, PA6: 8.0, TPU: 5.5, RESIN: 11.0, CF: 18.0, GLOW: 6.0 },
      reliabilityBase: 0.95,
      discount: { preferred: 0.08, trusted: 0.15 },
    },
    {
      id: 'localprint',
      name: 'LocalPrint NL',
      avatar: '🇳🇱',
      desc: 'Snelle levering. Specialiseert in TPU & Resin.',
      basePrice: { PLA: 1.2, PETG: 2.8, PA6: 7.0, TPU: 3.0, RESIN: 8.5, CF: 15.0, GLOW: 3.5 },
      reliabilityBase: 0.88,
      discount: { preferred: 0.12, trusted: 0.22 },
      speciality: ['TPU','RESIN'],
    },
  ],

  MARKET_CRISES: [
    { id:'pla_shortage',  name:'PLA Tekort!',         icon:'🌾', desc:'Mais-oogst mislukt — PLA prijs +60%',          affected:'PLA',   priceMult:1.6, duration:180, stockDrain:0.3 },
    { id:'petg_spikes',   name:'PETG Prijspiek!',      icon:'⚡', desc:'Energiekosten — petrochemisch duurder',        affected:'PETG',  priceMult:1.4, duration:120, stockDrain:0.2 },
    { id:'pa6_embargo',   name:'PA6 Embargo!',         icon:'🚫', desc:'Import gestopt — PA6 schaars',                affected:'PA6',   priceMult:2.0, duration:240, stockDrain:0.5 },
    { id:'tpu_shortage',  name:'TPU Schaarste!',       icon:'🔴', desc:'Olie-derivaten duurder — TPU boven budget',   affected:'TPU',   priceMult:1.5, duration:150, stockDrain:0.4 },
    { id:'resin_recall',  name:'Resin Terugroep!',     icon:'☣️', desc:'Veiligheidsincident — Resin leveringen stop', affected:'RESIN', priceMult:2.5, duration:300, stockDrain:0.8 },
    { id:'global_boom',   name:'3D Print Boom!',       icon:'📈', desc:'Vraag explodeert — alle filament duurder',    affected:'ALL',   priceMult:1.3, duration:90,  stockDrain:0.1 },
  ],

  WEEKLY_CHALLENGES: [
    { id:'speed_king',   icon:'⚡', name:'Speed King',     desc:'Voltooi 20 jobs in één sessie.',        reward:150, bonusRep:15, target:20,  type:'jobs',      difficulty:'normal' },
    { id:'quality_run',  icon:'💎', name:'Quality Run',    desc:'Print 10 Ultra-kwaliteit jobs.',         reward:200, bonusRep:20, target:10,  type:'ultra',     difficulty:'hard'   },
    { id:'filament_mix', icon:'🌈', name:'Filament Mix',   desc:'Gebruik alle 5 filamenttypes deze week.', reward:350, bonusRep:25, target:5,  type:'filamix',   difficulty:'hard'   },
    { id:'no_failures',  icon:'🎯', name:'Perfectionist',  desc:'Voltooi 15 jobs zonder storing.',        reward:250, bonusRep:30, target:15,  type:'nofail',    difficulty:'hard'   },
    { id:'millionaire',  icon:'💰', name:'Millionaire Run',desc:'Verdien €500 in één sessie.',            reward:400, bonusRep:40, target:500, type:'earn',      difficulty:'epic'   },
    { id:'contract_king',icon:'📋', name:'Contract King',  desc:'Voltooi 5 contracts.',                  reward:180, bonusRep:20, target:5,   type:'contracts', difficulty:'normal' },
    { id:'chain_master', icon:'🔗', name:'Chain Master',   desc:'Voltooi 3 productieketens.',             reward:220, bonusRep:18, target:3,   type:'chains',    difficulty:'normal' },
    { id:'night_worker', icon:'🌙', name:'Night Worker',   desc:'Print 10 jobs na 22:00.',                reward:160, bonusRep:12, target:10,  type:'night',     difficulty:'normal' },
    { id:'tpu_run',      icon:'🧲', name:'TPU Runner',     desc:'Print 5 TPU flexible jobs.',             reward:200, bonusRep:18, target:5,   type:'tpu',       difficulty:'normal' },
    { id:'resin_master', icon:'🔮', name:'Resin Master',   desc:'Print 3 Resin precision jobs.',          reward:280, bonusRep:22, target:3,   type:'resin',     difficulty:'hard'   },
    { id:'vip_service',  icon:'👑', name:'VIP Service',    desc:'Voltooi 5 VIP orders.',                  reward:320, bonusRep:28, target:5,   type:'vip',       difficulty:'hard'   },
    { id:'rush_runner',  icon:'🚨', name:'Rush Runner',    desc:'Voltooi 8 Rush orders op tijd.',         reward:260, bonusRep:22, target:8,   type:'rush',      difficulty:'hard'   },
    { id:'bounty_hunter',icon:'🎯', name:'Bounty Hunter',  desc:'Claim 2 bounties.',                      reward:500, bonusRep:35, target:2,   type:'bounty',    difficulty:'epic'   },
  ],

  // ── v8: RESEARCH TREE ─────────────────────────────────────
  RESEARCH: [
    // Tier 1 – Early game (unlockLevel 1-2)
    { id:'r_fast_slicing',  name:'Rapid Slicing',       icon:'⚡', tier:1, desc:'Optimised slicer profiles cut setup time by 10%.', effect:'-10% print time', cost:300,  researchTime:30,  unlockLevel:1, apply:(s)=>{ s.speedMult *= 0.90; } },
    { id:'r_bed_adhesion',  name:'Bed Adhesion Science', icon:'🔬', tier:1, desc:'Surface chemistry research. PLA fail rate halved.', effect:'-50% PLA fail',   cost:250,  researchTime:25,  unlockLevel:1, apply:(s)=>{ s.researchFlags.bedAdhesion=true; } },
    { id:'r_thermal_mgmt',  name:'Thermal Management',  icon:'🌡️', tier:1, desc:'Better heat dissipation extends printer lifespan.', effect:'-30% heat wear', cost:400,  researchTime:40,  unlockLevel:2, apply:(s)=>{ s.researchFlags.thermalMgmt=true; } },
    // Tier 2 – Mid game
    { id:'r_material_sci',  name:'Material Science',    icon:'🧪', tier:2, desc:'Advanced polymer knowledge. All material costs -15%.', effect:'-15% filament cost', cost:800, researchTime:60, unlockLevel:3, requires:'r_bed_adhesion', apply:(s)=>{ s.researchFlags.materialSci=true; } },
    { id:'r_speed_opt',     name:'Speed Optimisation',  icon:'🏎️', tier:2, desc:'Velocity profiling and pressure advance. Faster prints.', effect:'-20% time, +5% fail', cost:1000, researchTime:80, unlockLevel:3, requires:'r_fast_slicing', apply:(s)=>{ s.speedMult *= 0.80; s.failBonus += 0.05; } },
    { id:'r_quality_ctrl',  name:'Quality Control Lab', icon:'🔭', tier:2, desc:'Statistical process control. Ultra quality rewarded more.', effect:'+20% Ultra reward', cost:1200, researchTime:90, unlockLevel:4, requires:'r_thermal_mgmt', apply:(s)=>{ s.researchFlags.qualityCtrl=true; } },
    { id:'r_vip_network',   name:'VIP Network',         icon:'🤝', tier:2, desc:'High-value customer relationships. VIP orders appear more.', effect:'2× VIP spawn rate', cost:1500, researchTime:100, unlockLevel:4, requires:'r_bed_adhesion', apply:(s)=>{ s.researchFlags.vipNetwork=true; } },
    // Tier 3 – Late game
    { id:'r_automation',    name:'Process Automation',  icon:'🤖', tier:3, desc:'Robotic handling system. Passive income +€25/min.',    effect:'+€25/min passive',  cost:3000, researchTime:150, unlockLevel:5, requires:'r_speed_opt', apply:(s)=>{ s.passivePerMin += 25; } },
    { id:'r_auto_dispatch', name:'Auto Dispatch', icon:'📦', tier:3, desc:'Automatically assigns queued orders to any free printer.', effect:'Unlock Auto-Dispatch', cost:3200, researchTime:150, unlockLevel:5, requires:'r_automation', apply:(s)=>{ s.researchFlags.autoDispatch=true; if(!s.automation) s.automation={autoDispatch:false,autoRepair:false}; } },
    { id:'r_auto_repair',   name:'Auto Maintenance', icon:'🛠️', tier:3, desc:'Idle printers repair themselves slowly. Fewer surprise breakdowns.', effect:'Unlock Auto-Repair', cost:3600, researchTime:170, unlockLevel:5, requires:'r_automation', apply:(s)=>{ s.researchFlags.autoRepair=true; if(!s.automation) s.automation={autoDispatch:false,autoRepair:false}; } },
    { id:'r_premium_mats',  name:'Premium Materials',   icon:'💎', tier:3, desc:'Exclusive supplier partnerships. Unlock premium filament blends.', effect:'+35% all rewards', cost:4000, researchTime:180, unlockLevel:6, requires:'r_material_sci', apply:(s)=>{ s.rewardMult += 0.35; } },
    { id:'r_predictive',    name:'Predictive Maintenance', icon:'🔮', tier:3, desc:'ML-based failure prediction. Drastically fewer breakdowns.', effect:'-40% fail chance', cost:5000, researchTime:200, unlockLevel:6, requires:'r_quality_ctrl', apply:(s)=>{ s.failBonus -= 0.40; } },
    { id:'r_bounty_intel',  name:'Bounty Intelligence', icon:'📡', tier:3, desc:'Market intel platform. 3 active bounties at once.', effect:'3× bounty slots', cost:3500, researchTime:160, unlockLevel:5, requires:'r_vip_network', apply:(s)=>{ s.researchFlags.bountyIntel=true; } },
    // Tier 4 – End game
    { id:'r_ai_factory',    name:'AI Print Factory',    icon:'🏭', tier:4, desc:'Full automation. Every 90s a free job completes automatically.', effect:'Auto-complete jobs', cost:12000, researchTime:300, unlockLevel:7, requires:'r_automation', apply:(s)=>{ s.researchFlags.aiFactory=true; } },
    { id:'r_monopoly',      name:'Market Monopoly',     icon:'👑', tier:4, desc:'Industry dominance. All rewards +50%, unlock legendary orders.', effect:'+50% rewards, legendary orders', cost:15000, researchTime:360, unlockLevel:8, requires:'r_premium_mats', apply:(s)=>{ s.rewardMult += 0.50; s.researchFlags.monopoly=true; } },
  ],

  // ── v8: SPECIAL ORDER TYPES ──────────────────────────────
  SPECIAL_ORDER_CHANCE: {
    rush:    0.12,  // 12% of orders are rush
    vip:     0.08,  // 8% are VIP
    bulk:    0.06,  // 6% are bulk
    mystery: 0.04,  // 4% are mystery
  },

  // ── v8: MILESTONES ───────────────────────────────────────
  MILESTONES: [
    { id:'m_100',   name:'First €100',        icon:'💵', desc:'You made your first hundred euros!',              check:(s)=>s.stats.totalEarned>=100,   reward:{ money:50, xp:20  }, rewardText:'+€50 & 20 XP' },
    { id:'m_500',   name:'€500 Club',         icon:'💰', desc:'Half a grand. You\'re a real business now.',       check:(s)=>s.stats.totalEarned>=500,   reward:{ money:100, xp:50 }, rewardText:'+€100 & 50 XP' },
    { id:'m_1k',    name:'Grand Milestone',   icon:'🎯', desc:'One thousand euros in revenue!',                 check:(s)=>s.stats.totalEarned>=1000,  reward:{ money:200, xp:100, rep:10 }, rewardText:'+€200, 100 XP & 10 Rep' },
    { id:'m_5k',    name:'Five-Figure Start', icon:'📈', desc:'€5,000 revenue — investors are calling.',        check:(s)=>s.stats.totalEarned>=5000,  reward:{ money:500, xp:200, tokens:5 }, rewardText:'+€500, 200 XP & 5 Tokens' },
    { id:'m_10k',   name:'Ten K Club',        icon:'💎', desc:'€10,000! You\'re running a serious operation.',   check:(s)=>s.stats.totalEarned>=10000, reward:{ money:1000, xp:500, rep:25 }, rewardText:'+€1,000, 500 XP & 25 Rep' },
    { id:'m_25k',   name:'Quarter Century',   icon:'🏆', desc:'€25,000 total revenue. Industry respect!',       check:(s)=>s.stats.totalEarned>=25000, reward:{ money:2500, xp:1000, tokens:15 }, rewardText:'+€2,500, 1000 XP & 15 Tokens' },
    { id:'m_jobs50',name:'50 Jobs',           icon:'⚙️', desc:'50 completed prints. Veteran printer!',          check:(s)=>s.stats.jobsDone>=50,       reward:{ money:100, xp:75 }, rewardText:'+€100 & 75 XP' },
    { id:'m_jobs200',name:'200 Jobs',         icon:'🏭', desc:'200 prints — true print farm territory.',        check:(s)=>s.stats.jobsDone>=200,      reward:{ money:300, xp:200 }, rewardText:'+€300 & 200 XP' },
    { id:'m_streak15',name:'15-Job Streak',   icon:'🔥', desc:'15 perfect prints in a row. Masterclass!',       check:(s)=>s.stats.longestStreak>=15,  reward:{ money:150, xp:100, rep:5 }, rewardText:'+€150, 100 XP & 5 Rep' },
    { id:'m_rep100', name:'Rep Legend',       icon:'⭐', desc:'100 reputation. Customers know your name.',      check:(s)=>s.reputation>=100,          reward:{ money:200, xp:150, tokens:3 }, rewardText:'+€200, 150 XP & 3 Tokens' },
    { id:'m_prestige1',name:'First Prestige', icon:'♻️', desc:'You reset to grow stronger. Respect.',          check:(s)=>s.prestige>=1,              reward:{ money:500, xp:300, rep:20 }, rewardText:'+€500, 300 XP & 20 Rep' },
    { id:'m_farm',   name:'Four-Printer Farm',icon:'🏗️', desc:'Four printers humming. Full factory mode.',       check:(s)=>s.printerCount>=4,          reward:{ money:1000, xp:400, tokens:10 }, rewardText:'+€1,000, 400 XP & 10 Tokens' },
  ],

  // ── v8: EQUIPMENT EVENTS ─────────────────────────────────
  EQUIPMENT_EVENTS: [
    { id:'nozzle_clog',  name:'Nozzle Clog!',       icon:'🔴', desc:'Your nozzle is clogged. Next 3 jobs have +20% fail unless you repair.', effect:'clog',    severity:'warning', chance:0.04 },
    { id:'belt_slip',    name:'Belt Slippage!',      icon:'⚠️', desc:'Print quality drops. Fix for €30 or risk layer shifts.', effect:'belt',    severity:'warning', chance:0.03, fixCost:30 },
    { id:'hotend_fail',  name:'Hotend Failure!',     icon:'🔥', desc:'Temperature inconsistency. Printer offline until repaired.', effect:'offline', severity:'critical', chance:0.02, fixCost:80 },
    { id:'bed_crack',    name:'Cracked Print Bed!',  icon:'💥', desc:'First layer adhesion ruined. Repair needed.', effect:'bed',     severity:'critical', chance:0.02, fixCost:60 },
    { id:'motor_whine',  name:'Motor Whining',       icon:'🔊', desc:'Stepper noise detected. Prints 15% slower until serviced.', effect:'slow',    severity:'minor',    chance:0.05, fixCost:20 },
    { id:'spool_tangle', name:'Spool Tangle!',       icon:'🎃', desc:'Filament tangled mid-print. Current job cancelled.', effect:'cancel',  severity:'warning', chance:0.04 },
    { id:'power_fluctuation',name:'Power Fluctuation',icon:'⚡',desc:'Voltage spike detected. All printers lose 15 HP.', effect:'hploss',  severity:'warning', chance:0.03 },
  ],

  // ── v8: BOUNTIES ─────────────────────────────────────────
  BOUNTIES: [
    { id:'b_pa6_rush',   name:'PA6 Rush Order',     icon:'🏭', desc:'Print 3 PA6 jobs within 2 minutes each.',  reward:400,  bonusRep:15, type:'pa6_rush',   target:3, timeLimit:120 },
    { id:'b_ultra_vip',  name:'Ultra VIP Delivery', icon:'👑', desc:'Complete a VIP order at Ultra quality.',    reward:300,  bonusRep:20, type:'ultra_vip',  target:1 },
    { id:'b_no_fail_5',  name:'Flawless Five',       icon:'🎯', desc:'Complete 5 jobs without a single failure.', reward:250,  bonusRep:12, type:'nofail',    target:5 },
    { id:'b_bulk_bonanza',name:'Bulk Bonanza',       icon:'📦', desc:'Print 3 Bulk orders in one session.',      reward:350,  bonusRep:10, type:'bulk',       target:3 },
    { id:'b_tpu_sprint',  name:'TPU Sprint',         icon:'🧲', desc:'Print 4 TPU jobs in rapid succession.',    reward:280,  bonusRep:12, type:'tpu',        target:4 },
    { id:'b_mystery_box', name:'Mystery Haul',       icon:'🎲', desc:'Accept and complete 2 Mystery orders.',   reward:320,  bonusRep:14, type:'mystery',    target:2 },
    { id:'b_repair_zero', name:'Iron Machine',       icon:'🔧', desc:'Maintain 100% health for 5 minutes.',      reward:200,  bonusRep:8,  type:'health',     target:300, timeLimit:300 },
    { id:'b_resin_art',   name:'Artisan Resin',      icon:'🔮', desc:'Complete 3 Resin jobs at Fine+ quality.',  reward:450,  bonusRep:20, type:'resin_fine', target:3 },
    { id:'b_combo_god',   name:'Combo God',          icon:'🔥', desc:'Reach a 15× combo multiplier.',            reward:600,  bonusRep:25, type:'combo',      target:15 },
    { id:'b_big_earner',  name:'Big Earner',         icon:'💰', desc:'Earn €200 in a single session minute.',   reward:500,  bonusRep:18, type:'earn_burst',  target:200 },
  ],

  // ── v10: LEGACY PERKS (chosen at each prestige) ─────────
  LEGACY_PERKS: [
    { id:'speed_legacy',    icon:'⚡', name:'Speed Legacy',      desc:'All print times permanently −10%.',           effect: s=>{ s.speedMult *= 0.90; } },
    { id:'wealth_legacy',   icon:'💰', name:'Wealth Legacy',     desc:'All job rewards permanently +10%.',           effect: s=>{ s.rewardMult += 0.10; } },
    { id:'durable_legacy',  icon:'🔧', name:'Durable Legacy',    desc:'All printers degrade 30% slower.',            effect: s=>{ s.durabilityBonus = (s.durabilityBonus||0) + 0.30; } },
    { id:'rep_legacy',      icon:'⭐', name:'Reputation Legacy', desc:'+1 bonus rep on every completed job.',        effect: s=>{ s.repLegacyBonus = (s.repLegacyBonus||0) + 1; } },
    { id:'tax_legacy',      icon:'🧾', name:'Tax Dodger',        desc:'VAT rate permanently reduced by 5%.',         effect: s=>{ s.taxRate = Math.max(0.03, (s.taxRate||0.15) - 0.05); } },
    { id:'rival_legacy',    icon:'🤖', name:'Rival Blocker',     desc:'PrintBot steals 50% less often.',             effect: s=>{ s.rivalBlocker = (s.rivalBlocker||0) + 0.50; } },
    { id:'scrap_legacy',    icon:'♻️', name:'Scrap Master',      desc:'Failed prints generate 2× scrap.',           effect: s=>{ s.scrapBonus = (s.scrapBonus||0) + 1; } },
    { id:'surge_legacy',    icon:'🔥', name:'Surge Rider',       desc:'Demand surge rewards +25%.',                 effect: s=>{ s.surgeBonus = (s.surgeBonus||0) + 0.25; } },
  ],

  // ── v10: FRANCHISE BRANCHES ──────────────────────────────
  FRANCHISE_BRANCHES: [
    { id:'branch_garage',  name:'Garage Branch',    baseCost:5000,  incomePerMin:15, upgradeCost:8000,  maxLevel:3, icon:'🏠' },
    { id:'branch_studio',  name:'Print Studio',     baseCost:12000, incomePerMin:40, upgradeCost:15000, maxLevel:3, icon:'🏢' },
    { id:'branch_factory', name:'MiniFactory',      baseCost:30000, incomePerMin:100,upgradeCost:40000, maxLevel:3, icon:'🏭' },
  ],

  // ── v10: COMPLAINT MESSAGES ──────────────────────────────
  COMPLAINT_MESSAGES: [
    '"I paid good money for this — it came out like spaghetti!"',
    '"This is completely unusable. I demand a refund!"',
    '"Your quality control is non-existent. Absolutely livid."',
    '"I told you I needed this for a deadline. Now my project is ruined!"',
    '"This is the worst print I\'ve ever received. Refund me NOW."',
    '"My colleague warned me about you. This confirms it."',
    '"I\'ve been 3D printing for 10 years. This is embarrassing."',
  ],
  COMPLAINT_FACES: ['😤','😡','🤬','😠','👿'],

  // ── v10: CLIENT TIER THRESHOLDS (jobs with same customer) ─
  CLIENT_TIER_THRESHOLDS: { bronze: 2, silver: 8, gold: 20, platinum: 40 },
  CLIENT_TIER_BONUS:       { bronze:1.05, silver:1.12, gold:1.20, platinum:1.35 },

  // ── v10: SUBSCRIPTION CLIENT TEMPLATES ──────────────────
  SUBSCRIPTION_CLIENTS: [
    { name:'MakerSpace HQ',      filament:'PLA',   quality:'NORMAL', intervalS:90,  bonusMult:1.1 },
    { name:'PrototypeLab Berlin',filament:'PETG',  quality:'FINE',   intervalS:120, bonusMult:1.2 },
    { name:'NanoTech GmbH',      filament:'PA6',   quality:'NORMAL', intervalS:150, bonusMult:1.3 },
    { name:'ArtStudio Creative', filament:'RESIN', quality:'ULTRA',  intervalS:180, bonusMult:1.5 },
  ],

  ORDER_NAMES_LEGENDARY: ['Satellite Component','Medical Implant Mold','Aerospace Bracket','Formula E Part','Surgical Tool','Nano-lattice Structure','Quantum Sensor Housing','Deep-Sea Probe','Racing Caliper','Bionic Limb Prototype'],

  // ── v8: EXTRA UPGRADES ───────────────────────────────────
  UPGRADES_V8: [
    { id:'predictive_maint',name:'Predictive Maintenance',desc:'Sensors predict failures before they happen. −20% all fail.',effect:'−20% all fail',    cost:4500, unlockLevel:6, category:'reliability', apply:(s)=>{ s.failBonus -= 0.20; } },
    { id:'carbon_rods',     name:'Carbon Fibre Rods',    desc:'Lighter motion system — eliminates vibration artifacts.',    effect:'−20% time, +quality',cost:6000,unlockLevel:7,category:'speed',       apply:(s)=>{ s.speedMult *= 0.80; s.failBonus -= 0.05; } },
    { id:'ai_slicer',       name:'Neural Net Slicer',    desc:'AI-generated optimal print paths. Best-in-class speed.',     effect:'−35% print time',   cost:10000,unlockLevel:8,category:'speed',       apply:(s)=>{ s.speedMult *= 0.65; } },
    { id:'franchise',       name:'Franchise Model',      desc:'License your brand. Passive income goes through the roof.',  effect:'+€100/min passive', cost:20000,unlockLevel:8,category:'profit',      apply:(s)=>{ s.passivePerMin += 100; } },
    { id:'printer5',        name:'5th Printer (Titan)',  desc:'Massive delta printer for huge jobs. Legendary orders.',     effect:'Fifth printer + legendary', cost:15000,unlockLevel:8,category:'expansion', apply:(s)=>{ s.printerCount = 5; s.legendaryUnlocked = true; } },
    { id:'rush_handler',    name:'Rush Order System',    desc:'Dedicated rush lane. Rush orders worth +30% more.',          effect:'+30% rush reward',  cost:3000, unlockLevel:5, category:'profit',      apply:(s)=>{ s.researchFlags = s.researchFlags||{}; s.researchFlags.rushBonus=true; } },
    { id:'vip_lounge',      name:'VIP Client Portal',   desc:'White-glove service. VIP order frequency doubles.',          effect:'2× VIP orders',     cost:5000, unlockLevel:6, category:'profit',      apply:(s)=>{ s.researchFlags = s.researchFlags||{}; s.researchFlags.vipPortal=true; } },
  ],
};

// ── STATE ────────────────────────────────────────────────────
const State = {
  money:          CONFIG.STARTING_MONEY,
  reputation:     0,
  xp:             0,
  bizLevel:       1,
  isPro:          false,

  // Printer modifiers
  printerCount:   1,
  speedMult:      1.0,
  failBonus:      0.0,
  abrasiveBonus:  0.0,
  dryerBonus:     0.0,
  rewardMult:     1.0,
  passivePerMin:  0,
  smartQueue:     false,
  aiQuality:      false,
  packagingBonus: false,

  // Idle Economy (Layer 1)
  // Operating expenses (per minute)
  ops: {
    facilityLevel: 1,          // 1=Garage, 2=Workshop, 3=Small Factory, 4=Factory
    rentPM: 8,                 // base rent per minute
    electricityPerActivePM: 1.2, // per active printer per minute
    maintenancePerPrinterPM: 0.6, // per owned printer per minute
    marketingPM: 0,            // optional later
  },
  autoAcceptToQueue: false,    // when true: auto-queue orders until queue full

  // Automation (Layer 3 unlocks)
  automation: {
    autoDispatch: false,   // start queued jobs on any free printer
    autoRepair:   false,   // slowly repair idle printers over time
  },
  printers: [
    { id:0, name:'Printer #1', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 },
  ],

  orders:    [],
  contracts: [],
  activeContractId: null,
  miniIntroSeen: false,
  dailyContractDoneAt: 0,

  nextOrderIn:     15,
  nextContractIn:  CONFIG.CONTRACT_REFRESH_S,

  pendingOrder:       null,
  selectedPrinterIdx: 0,
  viewingPrinterIdx:  0,
  selectedFilament:   'PLA',
  selectedQuality:    'NORMAL',

  ownedUpgrades: [],

  // Active event effects
  bulkBonusJobs:  0,
  nextFailBoost:  0,
  filDiscountJobs:0,

  // Market multipliers (new v2)
  market: { PLA: 1.0, PETG: 1.0, PA6: 1.0, TPU: 1.0, RESIN: 1.0, CF: 1.0, GLOW: 1.0 },
  marketTimer: 120,

  // v3: Customer loyalty
  customers: {}, // name → { jobs: 0, satisfaction: 0 }
  activeSkin: 'default',

  // v5: Prestige
  prestige: 0,          // number of prestiges done
  prestigeBonus: 0,     // permanent income multiplier (0.1 per prestige)

  // v5: Printer specializations (per printer id)
  printerSpecs: {},     // { 0: 'speed', 1: 'quality', 2: 'economy' }

  // v5: Combo system
  combo: 0,
  comboTimer: 0,        // seconds left before combo resets
  COMBO_WINDOW: 30,     // seconds between jobs to keep combo

  // v5: Daily goals
  dailyGoals: [],
  dailyGoalsDate: '',
  dailyGoalsEarned: 0,

  // v5: Speedrun
  speedrunActive: false,
  speedrunStart: 0,
  speedrunEarned: 0,
  speedrunJobs: 0,

  // v6: Print tokens & lootbox
  tokens: 0,

  // v6: Print wachtrij
  printQueue: [],   // array of { order, filament, quality }

  // v6: Employees
  hiredEmployees: [],  // array of employee ids

  // v6: Production chains
  activeChains: [],  // array of { id, progress: [done per step] }

  // v6: Printer temperatures
  printerTemps: {},  // printerIdx → 0..100

  achievements: [],

  incomeHistory: [],

  stats: {
    jobsDone:       0,
    jobsFailed:     0,
    totalEarned:    0,
    totalPrints:    0,
    upgradesBought: 0,
    pa6Done:        0,
    petgDone:       0,
    tpuDone:        0,
    resinDone:      0,
    repEarned:      0,
    contractsDone:  0,
    dailyDone:      0,
    longestStreak:  0,
    currentStreak:  0,
    sessionStart:   Date.now(),
    sessionEarned:  0,
    nightShiftJobs: 0,
    fastestJob:     9999,
    marketSurgeJobs:0,
    passiveEarned:  0,
    maxCombo:       0,
    bestSpeedrun:   0,
    chainsDone:     0,
    ultraJobs:      0,
    failStreak:     0,   // consecutive failures
    filamentsUsed:  [],       // array of filament ids used (array, not Set — must serialize)
    // v9 stats
    surgesDone:     0,
    loansRepaid:    0,
    clogWins:       0,
  },

  passiveTick: 0,

  // v7: Filament stock system
  filamentStock: { PLA: 100, PETG: 80, PA6: 50, TPU: 0, RESIN: 0, CF: 0, GLOW: 0 },
  supplierRelations: { cheapfil: 0, prusament: 0, localprint: 0 }, // 0=neutral,1=preferred,2=trusted
  supplierOrderCount: { cheapfil: 0, prusament: 0, localprint: 0 }, // orders placed with each

  // v7: Market crisis
  activeCrisis: null,
  crisisTimer: 0,
  crisisCountdown: 200, // seconds until next possible crisis

  // v7: Weekly challenges
  activeChallenges: [],
  challengeSessionData: { jobs:0, ultra:0, filamix:[], nofail:0, earn:0, contracts:0, chains:0, night:0, tpu:0, resin:0 },

  // v7: New upgrade flags
  tpuUnlocked: false,
  resinUnlocked: false,
  flexBed: false,
  uvCuring: false,
  bulkDealActive: false,
  supplierAI: false,

  // v11: New filament unlock flags
  cfUnlocked: false,
  glowUnlocked: false,
  cfNozzle: false,

  // v11: Inventory system
  inventory: { keychains: 0, planters: 0 },

  // v11: Trending system
  activeTrend: null,
  trendTimer: 0,
  trendCountdown: 120,

  // v8: Research system
  completedResearch: [],    // array of research ids
  activeResearch: null,     // { id, progress, total }
  researchFlags: {},        // dynamic flags set by research apply()

  // v8: Bounty board
  activeBounties: [],       // array of { ...bountyDef, progress, expiresAt, claimed }
  bountyRefreshTimer: 300,  // seconds until next bounty refresh
  claimedBounties: [],      // ids of claimed bounties this session

  // v8: Milestones
  claimedMilestones: [],    // milestone ids already claimed

  // v8: Equipment events
  activeEquipmentEvents: [],// array of { printerIdx, eventId, fixCost, resolved }

  // v8: Special order tracking
  stats_v8: {
    vipDone: 0,
    rushDone: 0,
    bulkDone: 0,
    mysteryDone: 0,
    legendaryDone: 0,
    bountiesClaimed: 0,
    milestonesHit: 0,
    researchCompleted: 0,
    equipmentEventsFixed: 0,
    sessEarnedPerMin: 0,    // highest €/min this session
  },

  // v8: Dashboard data
  lastMinuteEarnings: [],   // rolling window: last 10 per-minute earnings
  legendaryUnlocked: false,

  // v9: New systems
  rivalScore: 0,
  playerVsRival: 0,
  rivalActive: false,
  rivalSteals: 0,
  activeSurge: null,
  surgeCountdown: 120,
  activeLoans: [],
  totalDebt: 0,
  clogActive: false,

  // v10: New systems
  taxAccum: 0,          // earnings accumulated since last tax bill
  taxTimer: 180,        // seconds until next tax bill
  taxRate: 0.15,        // 15% VAT default
  hasAccountant: false,
  hasInsurance: false,
  insuranceTimer: 0,    // seconds until insurance premium due
  scrap: 0,             // scrap units from failed prints
  morale: {},           // employeeId → 0..100
  legacyPerks: [],      // array of perk ids chosen at prestige
  franchiseBranches: [],// array of { id, name, level, incomePerMin, upgradeCost }
  franchiseUnlocked: false,
  hofRecords: [],       // hall of fame entries
  clientTiers: {},      // customerName → 'bronze'|'silver'|'gold'|'platinum'
  subscriptionClients: [], // recurring clients
  subscriptionTimer: 0,
  pendingComplaint: null, // { client, refundAmt, repPenalty, msg }
  stats_v10: {
    taxPaid: 0,
    complaintsReceived: 0,
    complaintsRefunded: 0,
    scrapsRecycled: 0,
    franchiseEarned: 0,
    subscriptionJobsDone: 0,
    insurancePayouts: 0,
  },
};

// ── SOUND MODULE ─────────────────────────────────────────────
const Sound = {
  ctx:    null,
  muted:  false,
  _hums:  {}, // printerIdx → { osc, gain }

  play(type) {
    // Named sound aliases
    if (type === 'milestone') this.success(); // reuse success sound for milestones
    else if (type === 'bounty') this.cash(100);
  },

  _ensureCtx() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (this.ctx.state === 'suspended') this.ctx.resume();
    return this.ctx;
  },

  toggle() {
    this.muted = !this.muted;
    const btn = $el('sound-btn');
    btn.textContent = this.muted ? '🔇' : '🔊';
    btn.classList.toggle('muted', this.muted);
    if (this.muted) {
      // Stop all hums
      Object.values(this._hums).forEach(h => {
        try { h.gain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.1); } catch(e){}
      });
    }
  },

  // Short synthesised click for UI interactions
  click() {
    if (this.muted) return;
    const c = this._ensureCtx();
    const osc = c.createOscillator(); const g = c.createGain();
    osc.connect(g); g.connect(c.destination);
    osc.frequency.setValueAtTime(1200, c.currentTime);
    osc.frequency.exponentialRampToValueAtTime(800, c.currentTime + 0.04);
    g.gain.setValueAtTime(0.08, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.05);
    osc.start(c.currentTime); osc.stop(c.currentTime + 0.06);
  },

  // Pleasant success chime
  success() {
    if (this.muted) return;
    const c = this._ensureCtx();
    [523.25, 659.25, 783.99].forEach((freq, i) => {
      const osc = c.createOscillator(); const g = c.createGain();
      osc.type = 'sine';
      osc.connect(g); g.connect(c.destination);
      const t = c.currentTime + i * 0.1;
      osc.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.15, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
      osc.start(t); osc.stop(t + 0.5);
    });
  },

  // Harsh buzz for failure
  failure() {
    if (this.muted) return;
    const c = this._ensureCtx();
    const osc = c.createOscillator(); const g = c.createGain();
    osc.type = 'sawtooth';
    osc.connect(g); g.connect(c.destination);
    osc.frequency.setValueAtTime(180, c.currentTime);
    osc.frequency.exponentialRampToValueAtTime(60, c.currentTime + 0.4);
    g.gain.setValueAtTime(0.22, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.45);
    osc.start(c.currentTime); osc.stop(c.currentTime + 0.5);
  },

  // Cash register ding
  cash(amount) {
    if (this.muted) return;
    const c = this._ensureCtx();
    const pitch = Math.min(1800, 600 + amount * 8);
    const osc = c.createOscillator(); const g = c.createGain();
    osc.type = 'triangle';
    osc.connect(g); g.connect(c.destination);
    osc.frequency.setValueAtTime(pitch, c.currentTime);
    osc.frequency.exponentialRampToValueAtTime(pitch * 1.5, c.currentTime + 0.05);
    g.gain.setValueAtTime(0.18, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.5);
    osc.start(c.currentTime); osc.stop(c.currentTime + 0.55);
  },

  // Level-up fanfare
  levelUp() {
    if (this.muted) return;
    const c = this._ensureCtx();
    [392, 494, 587, 784].forEach((f, i) => {
      const osc = c.createOscillator(); const g = c.createGain();
      osc.type = 'sine'; osc.connect(g); g.connect(c.destination);
      const t = c.currentTime + i * 0.12;
      osc.frequency.setValueAtTime(f, t);
      g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t+0.03);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
      osc.start(t); osc.stop(t + 0.55);
    });
  },

  // Contract complete fanfare
  contractComplete() {
    if (this.muted) return;
    const c = this._ensureCtx();
    [523, 659, 784, 1047].forEach((f, i) => {
      const osc = c.createOscillator(); const g = c.createGain();
      osc.type = 'triangle'; osc.connect(g); g.connect(c.destination);
      const t = c.currentTime + i * 0.09;
      osc.frequency.setValueAtTime(f, t);
      g.gain.setValueAtTime(0.18, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
      osc.start(t); osc.stop(t + 0.5);
    });
  },

  // Continuous printer hum — starts and stops with print job
  startHum(printerIdx) {
    if (this.muted) return;
    this.stopHum(printerIdx);
    const c = this._ensureCtx();
    const osc  = c.createOscillator();
    const osc2 = c.createOscillator();
    const gain = c.createGain();
    osc.type  = 'sawtooth'; osc.frequency.value  = 62 + printerIdx * 8;
    osc2.type = 'square';   osc2.frequency.value = 124 + printerIdx * 16;
    osc.connect(gain); osc2.connect(gain); gain.connect(c.destination);
    gain.gain.setValueAtTime(0, c.currentTime);
    gain.gain.linearRampToValueAtTime(0.025, c.currentTime + 0.5);
    osc.start(); osc2.start();
    this._hums[printerIdx] = { osc, osc2, gain };
  },

  stopHum(printerIdx) {
    const h = this._hums[printerIdx];
    if (!h) return;
    try {
      const c = this._ensureCtx();
      h.gain.gain.setTargetAtTime(0, c.currentTime, 0.3);
      setTimeout(() => { try { h.osc.stop(); h.osc2.stop(); } catch(e){} }, 600);
    } catch(e) {}
    delete this._hums[printerIdx];
  },
};

// ── SKINS MODULE ─────────────────────────────────────────────
const Skins = {
  SKINS: ['default','midnight','lava','forest'],
  set(skin) {
    State.activeSkin = skin;
    const panel = $el('active-job-panel');
    if (panel) {
      this.SKINS.forEach(s => panel.classList.remove('skin-' + s));
      if (skin !== 'default') panel.classList.add('skin-' + skin);
    }
    // Update dot active state
    this.SKINS.forEach(s => {
      const dot = document.getElementById('skin-' + s);
      if (dot) dot.classList.toggle('active-skin', s === skin);
    });
    localStorage.setItem('pnp_skin', skin);
    Sound.click();
  },
  load() {
    const saved = localStorage.getItem('pnp_skin') || 'default';
    this.set(saved);
  },
};

// ── MINI-GAME MODULE ─────────────────────────────────────────
const MiniGame = {
  _printerIdx: null,
  _sequence: [],
  _step: 0,
  _timer: null,
  _timeLeft: 10,
  SYMBOLS: ['🔴','🔵','🟢','🟡'],

  trigger(printerIdx) {
    // One-time intro to make the mini-game feel like a dopamine micro-event
    if (!State.miniIntroSeen) {
      State.miniIntroSeen = true;
      UI.showPopup(
        '⚡ Quick Calibration',
        `<div style="line-height:1.65;font-size:11px;color:var(--text-dim)">
          Soms raakt een printer uit calibratie. Dit mini-spel duurt <strong style="color:var(--text)">10–12 seconden</strong> en kan je printer gratis herstellen.<br><br>
          <span style="color:var(--accent)">Win</span>: +50 health (gratis) · minder downtime<br>
          <span style="color:var(--danger)">Lose/Skip</span>: je betaalt normale repair kosten
        </div>`,
        () => { this._start(printerIdx); },
        () => { this._printerIdx = printerIdx; this.skip(); }
      );
      return;
    }
    this._start(printerIdx);
  },

  _start(printerIdx) {
    this._printerIdx = printerIdx;
    const difficulty = Math.min(4, 2 + Math.floor(State.bizLevel / 2));
    this._sequence = Array.from({length: difficulty}, () => this.SYMBOLS[Math.floor(Math.random() * 4)]);
    this._step = 0;
    this._timeLeft = 8 + difficulty;
    $el('mg-sub').textContent =
      `Match the ${difficulty}-step calibration sequence! Time limit: ${this._timeLeft}s`;
    this._renderSequence();
    $el('mg-feedback').textContent = '';
    $el('mg-feedback').style.color = 'var(--text)';
    $el('minigame-overlay').classList.add('active');
    this._startTimer();
    Sound.failure();
    UI.log(`⚠️ Printer #${printerIdx+1} heeft kalibratie nodig! Minispel gestart.`, 'warn');
  },

  _renderSequence() {
    const el = document.getElementById('mg-sequence');
    el.innerHTML = this._sequence.map((s, i) =>
      `<div class="mg-key" style="opacity:${i < this._step ? '0.3' : '1'};border-color:${i === this._step ? 'var(--accent)' : 'var(--border)'}">${i < this._step ? '✓' : s}</div>`
    ).join('');
    $el('mg-progress').textContent = `Step ${this._step} / ${this._sequence.length}`;
  },

  _startTimer() {
    clearInterval(this._timer);
    const fill = $el('mg-timer-fill');
    const total = this._timeLeft;
    const interval = 100;
    let elapsed = 0;
    this._timer = setInterval(() => {
      elapsed += interval / 1000;
      const pct = Math.max(0, 100 * (1 - elapsed / total));
      if (fill) fill.style.width = pct + '%';
      if (elapsed >= total) {
        clearInterval(this._timer);
        this._fail('Time\'s up!');
      }
    }, interval);
  },

  press(symbol) {
    const btn = [...document.querySelectorAll('.mg-btn')].find(b => b.textContent === symbol);
    if (btn) { btn.classList.add('pressed'); setTimeout(() => btn.classList.remove('pressed'), 150); }

    if (symbol === this._sequence[this._step]) {
      this._step++;
      this._renderSequence();
      Sound.click();
      if (this._step === this._sequence.length) {
        clearInterval(this._timer);
        this._win();
      }
    } else {
      const fb = $el('mg-feedback');
      fb.textContent = '✗ Wrong! Try again from the start.';
      fb.style.color = 'var(--danger)';
      this._step = 0;
      this._renderSequence();
      Sound.failure();
    }
  },

  _win() {
    $el('mg-feedback').textContent = '✓ Calibrated! Free repair!';
    $el('mg-feedback').style.color = 'var(--accent3)';
    Sound.success();
    setTimeout(() => {
      const p = State.printers[this._printerIdx];
      if (p) p.health = Math.min(100, p.health + 50);
      this._close();
      UI.renderPrinters();
      UI.log(`🔧 Minispel gewonnen! Printer #${this._printerIdx+1} gedeeltelijk gratis gerepareerd.`, 'success');
    }, 1200);
  },

  _fail(reason) {
    $el('mg-feedback').textContent = `✗ ${reason} Paying repair cost.`;
    $el('mg-feedback').style.color = 'var(--danger)';
    Sound.failure();
    setTimeout(() => { this.skip(); }, 1200);
  },

  skip() {
    clearInterval(this._timer);
    this._close();
    if (this._printerIdx !== null) Game.repairPrinter(this._printerIdx);
  },

  _close() {
    $el('minigame-overlay').classList.remove('active');
    this._printerIdx = null;
  },
};

// ── NOTIFICATIONS MODULE ─────────────────────────────────────
const Notifications = {
  enabled: false,

  toggle() {
    if (!('Notification' in window)) {
      UI.showPopup('Not Supported', 'Your browser does not support notifications.');
      return;
    }
    if (Notification.permission === 'granted') {
      this.enabled = !this.enabled;
      this._updateBtn();
      UI.log(this.enabled ? '🔔 Meldingen ingeschakeld.' : '🔕 Meldingen uitgeschakeld.', 'info');
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          this.enabled = true;
          this._updateBtn();
          UI.log('🔔 Meldingen ingeschakeld!', 'info');
        }
      });
    } else {
      UI.showPopup('Blocked', 'Notifications are blocked in your browser. Enable them in site settings.');
    }
  },

  notify(title, body) {
    if (!this.enabled || document.hasFocus()) return;
    try {
      new Notification(title, { body, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🖨️</text></svg>' });
    } catch(e) {}
  },

  _updateBtn() {
    const btn = $el('notif-btn');
    if (btn) {
      // Update only the text node; preserve the .notif-dot child
      const icon = this.enabled ? '🔔' : '🔕';
      const dot = btn.querySelector('.notif-dot');
      btn.textContent = icon;
      if (dot) btn.appendChild(dot);
      else { const d = document.createElement('div'); d.className='notif-dot'; btn.appendChild(d); }
    }
  },
};

// ── CUSTOMER LOYALTY MODULE ──────────────────────────────────
const CustomerLoyalty = {
  track(customerName, filament, quality) {
    if (!State.customers[customerName]) {
      State.customers[customerName] = { jobs: 0, satisfaction: 0 };
    }
    const c = State.customers[customerName];
    c.jobs++;
    const qualBonus = { DRAFT: -0.5, NORMAL: 0.5, FINE: 1.0, ULTRA: 1.5 }[quality] || 0.5;
    c.satisfaction = Math.min(10, c.satisfaction + qualBonus);
  },

  getBonus(customerName) {
    const c = State.customers[customerName];
    if (!c || c.jobs < 2) return 1.0;
    return 1.0 + Math.min(0.3, c.satisfaction * 0.03);
  },

  getLoyaltyLevel(customerName) {
    const c = State.customers[customerName];
    if (!c || c.jobs < 2) return null;
    if (c.jobs >= 10) return '⭐⭐⭐';
    if (c.jobs >= 5) return '⭐⭐';
    return '⭐';
  },

  showQuote(order) {
    const c = State.customers[order.customer];
    const isLoyal = c && c.jobs >= 2;
    const quotes = isLoyal ? CONFIG.CUSTOMER_QUOTES.loyalAccept : CONFIG.CUSTOMER_QUOTES.accept;
    const quote = quotes[Math.floor(Math.random() * quotes.length)];
    const toast = document.createElement('div');
    toast.className = 'quote-toast';
    toast.innerHTML = `<div class="q-name">💬 ${order.customer}</div><div class="q-text">"${quote}"</div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  },
};

// ── LEADERBOARD MODULE ───────────────────────────────────────
const Leaderboard = {
  MAX_ENTRIES: 10,
  KEY: 'pnp_leaderboard',

  load() {
    try { return JSON.parse(localStorage.getItem(this.KEY) || '[]'); } catch(e) { return []; }
  },

  save(entries) {
    localStorage.setItem(this.KEY, JSON.stringify(entries));
  },

  submit() {
    const score = r0(State.stats.totalEarned);
    if (score < 10) return;
    const entries = this.load();
    const name = `Run #${entries.length + 1}`;
    entries.push({
      name, score,
      level: State.bizLevel,
      jobs: State.stats.jobsDone,
      date: new Date().toLocaleDateString('nl-NL'),
      isYou: true,
    });
    entries.sort((a, b) => b.score - a.score);
    const pruned = entries.slice(0, this.MAX_ENTRIES);
    // Only mark the top "you" entry
    let marked = false;
    pruned.forEach(e => { if (e.isYou && !marked) { e.isYou = true; marked = true; } else { e.isYou = false; } });
    this.save(pruned);
  },

  render() {
    const el = document.getElementById('leaderboard-list'); if (!el) return;
    const entries = this.load();
    if (entries.length === 0) {
      el.innerHTML = `<div class="lb-empty">Nog geen runs.<br><span style="font-size:11px">Speel en verdien €10+ om hier te verschijnen.</span></div>`;
      return;
    }
    const rankClass = i => i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
    el.innerHTML = entries.map((e, i) => `
      <div class="lb-row ${e.isYou ? 'lb-you' : ''}">
        <div class="lb-rank ${rankClass(i)}">${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : i + 1}</div>
        <div class="lb-name">
          <div class="lb-name-main">${e.name} ${e.isYou ? '<span style="font-size:11px;color:var(--accent)">(jij)</span>' : ''}</div>
          <div class="lb-name-sub">Lv.${e.level} · ${e.jobs} jobs · ${e.date}</div>
        </div>
        <div class="lb-score">
          <div class="lb-score-val">€${e.score.toLocaleString()}</div>
        </div>
      </div>`).join('');
  },
};

// ── COMBO SYSTEM ─────────────────────────────────────────────
const Combo = {
  WINDOW: 30, // seconds to maintain combo

  onJobComplete() {
    State.combo++;
    State.comboTimer = this.WINDOW;
    if (State.combo > (State.stats.maxCombo || 0)) State.stats.maxCombo = State.combo;
    this.render();
    BountyBoard.onCombo(State.combo);
    if (State.combo >= 2) {
      const mult = this.getMultiplier();
      UI.log(`🔥 ${State.combo}× Combo! +${Math.round((mult-1)*100)}% bonus`, 'money');
    }
    Achievements.check();
  },

  getMultiplier() {
    if (State.combo < 2) return 1;
    return 1 + Math.min(0.5, (State.combo - 1) * 0.05);
  },

  tick(dt) {
    if (State.combo < 2) return;
    State.comboTimer -= dt;
    // Update bar
    const bar = $el('combo-bar');
    if (bar) bar.style.width = Math.max(0, (State.comboTimer / this.WINDOW * 100)) + '%';
    if (State.comboTimer <= 0) this.reset();
  },

  reset() {
    if (State.combo >= 2) UI.log(`Combo verlopen (was ${State.combo}×)`, 'warn');
    State.combo = 0;
    State.comboTimer = 0;
    const el = document.getElementById('combo-display');
    if (el) el.style.display = 'none';
  },

  render() {
    const el = document.getElementById('combo-display');
    if (!el) return;
    if (State.combo < 2) { el.style.display = 'none'; return; }
    el.style.display = 'block';
    const num = $el('combo-number');
    const mult = $el('combo-mult');
    if (num) { num.textContent = State.combo + '×'; num.style.animation = 'none'; void num.offsetWidth; num.style.animation = 'comboPop 0.3s cubic-bezier(0.34,1.8,0.64,1)'; }
    if (mult) mult.textContent = `+${Math.round((this.getMultiplier()-1)*100)}% bonus`;
    const bar = $el('combo-bar');
    if (bar) bar.style.width = '100%';
  },
};

// ── DAILY GOALS ──────────────────────────────────────────────
const DailyGoals = {
  GOAL_TEMPLATES: [
    { id:'jobs5',     icon:'🖨️', name:'Print 5 jobs',          desc:'Voltooi 5 afdruktaken',          reward:25,  check:(s,g)=>({cur:s.jobsDone-g.baseJobs,   max:5})  },
    { id:'earn50',    icon:'💰', name:'Verdien €50',            desc:'Druk genoeg om €50 te verdienen', reward:15,  check:(s,g)=>({cur:s.totalEarned-g.baseEarned, max:50}) },
    { id:'petg3',     icon:'💜', name:'3 PETG jobs',            desc:'Druk 3 PETG-orders af',          reward:30,  check:(s,g)=>({cur:s.petgDone-(g.basePetg||0), max:3}) },
    { id:'pa61',      icon:'🟠', name:'1 PA6 job',              desc:'Druk een engineering-order af',  reward:40,  check:(s,g)=>({cur:s.pa6Done-(g.basePa6||0),  max:1})  },
    { id:'streak5',   icon:'🔥', name:'5 op rij',               desc:'Haal een streak van 5',          reward:35,  check:(s,g)=>({cur:s.longestStreak,          max:5})  },
    { id:'contract1', icon:'📋', name:'1 contract',             desc:'Voltooi een contract',           reward:50,  check:(s,g)=>({cur:s.contractsDone-g.baseContracts, max:1}) },
    { id:'repair0',   icon:'🔧', name:'Niet repareren',         desc:'Speel 10 min zonder reparatie',  reward:20,  check:(s,g)=>({cur:g.repairFree?10:0,        max:10}) },
    { id:'combo5',    icon:'⚡', name:'5× Combo',               desc:'Bereik een combo van 5×',        reward:45,  check:(s,g)=>({cur:s.maxCombo,              max:5})  },
    { id:'earn100',   icon:'💎', name:'Verdien €100',           desc:'Druk genoeg om €100 te verdienen',reward:30, check:(s,g)=>({cur:s.totalEarned-g.baseEarned,max:100}) },
    { id:'jobs10',    icon:'🏭', name:'Print 10 jobs',          desc:'Voltooi 10 afdruktaken',         reward:40,  check:(s,g)=>({cur:s.jobsDone-g.baseJobs,   max:10}) },
  ],

  _todayKey() { return new Date().toISOString().slice(0, 10); },

  refresh() {
    const today = this._todayKey();
    if (State.dailyGoalsDate === today && State.dailyGoals.length > 0) return; // already generated today
    // Pick 3 random goals
    const shuffled = [...this.GOAL_TEMPLATES].sort(() => Math.random() - 0.5);
    State.dailyGoals = shuffled.slice(0, 3).map(t => ({
      ...t,
      done: false,
      baseJobs:      State.stats.jobsDone,
      baseEarned:    State.stats.totalEarned,
      basePetg:      State.stats.petgDone || 0,
      basePa6:       State.stats.pa6Done  || 0,
      baseContracts: State.stats.contractsDone,
      repairFree:    true,
    }));
    State.dailyGoalsDate = today;
    State.dailyGoalsEarned = 0;
    UI.log('🎯 Nieuwe dagelijkse doelen beschikbaar!', 'info');
  },

  check() {
    State.dailyGoals.forEach(g => {
      if (g.done) return;
      // v17.5 fix: after save/load, g.check (a function) is lost from JSON serialization
      // Restore it from the template by matching on id
      if (typeof g.check !== 'function') {
        const tpl = this.GOAL_TEMPLATES.find(t => t.id === g.id);
        if (tpl) g.check = tpl.check; else return;
      }
      const { cur, max } = g.check(State.stats, g);
      if (cur >= max) {
        g.done = true;
        State.money = r2(State.money + g.reward);
        // Note: intentionally NOT adding to totalEarned — goal rewards are bonuses,
        // not production income, and would otherwise count toward earn-type goals themselves.
        TaxSystem.accrue(g.reward);
        State.dailyGoalsEarned = (State.dailyGoalsEarned || 0) + g.reward;
        UI.log(`🎯 Dagelijks doel behaald: ${g.name} → +€${g.reward}`, 'money');
        // Toast
        const t = document.createElement('div');
        t.className = 'contract-toast';
        t.innerHTML = `<div style="font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--warn);margin-bottom:4px">🎯 Dagelijks Doel!</div><div style="font-family:var(--display);font-weight:700;font-size:15px;color:var(--text-bright)">${g.icon} ${g.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">+€${g.reward} beloond</div>`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 5000);
        Achievements.check();
      }
    });
    this.render();
  },

  render() {
    const el = document.getElementById('daily-goals-list');
    const earned = $el('goals-earned');
    if (!el) return;
    if (State.dailyGoals.length === 0) { el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px;font-size:11px">Geen doelen geladen.</div>'; return; }
    el.innerHTML = State.dailyGoals.map(g => {
      // v17.5 fix: restore check function from template if lost after save/load
      if (typeof g.check !== 'function') { const tpl = this.GOAL_TEMPLATES.find(t => t.id === g.id); if (tpl) g.check = tpl.check; }
      if (typeof g.check !== 'function') return '';
      const {cur, max} = g.check(State.stats, g);
      const pct = Math.min(100, r0(cur / max * 100));
      return `<div class="goal-card${g.done?' goal-done':''}">
        <div class="goal-icon">${g.icon}</div>
        <div class="goal-info">
          <div class="goal-name">${g.name}</div>
          <div class="goal-desc">${g.desc}</div>
          <div class="goal-progress">
            <div class="goal-prog-bar"><div class="goal-prog-fill" style="width:${pct}%"></div></div>
            <div class="goal-prog-text">${Math.min(cur,max)} / ${max}</div>
          </div>
        </div>
        ${g.done ? '<div class="goal-done-check">✅</div>' : `<div class="goal-reward">€${g.reward}</div>`}
      </div>`;
    }).join('');
    if (earned) earned.textContent = `€${(State.dailyGoalsEarned || 0).toFixed(2)}`;
    // Reset timer
    const rt = $el('goals-reset-timer');
    if (rt) {
      const now = new Date();
      const midnight = new Date(); midnight.setHours(24,0,0,0);
      const diff = Math.round((midnight - now) / 1000);
      const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60);
      rt.textContent = `Reset over ${h}u ${m}m`;
    }
  },
};

// ── SEASON SYSTEM ─────────────────────────────────────────────
const Season = {
  SEASONS: [
    { months:[11,0], name:'Holiday Rush 🎄',  icon:'🎄', desc:'+40% PLA reward · Meer urgente orders', mult:{PLA:1.4}, urgentBoost:0.15 },
    { months:[1],    name:'Valentijn 💝',      icon:'💝', desc:'+30% decoratie reward',                  mult:{PLA:1.3}, urgentBoost:0 },
    { months:[2,3],  name:'Lente Sprint 🌱',   icon:'🌱', desc:'+20% alle rewards · Lagere reparatiekosten', mult:{PLA:1.2,PETG:1.2,PA6:1.2}, repairDiscount:0.8 },
    { months:[6,7],  name:'Zomerslump ☀️',     icon:'☀️', desc:'-15% bestellingen · PA6 +50% reward',  mult:{PA6:1.5}, orderDelay:1.5 },
    { months:[8,9],  name:'Terug naar school 🎒', icon:'🎒', desc:'+25% PETG reward · Meer contracten', mult:{PETG:1.25}, extraContracts:1 },
    { months:[10],   name:'Hacktober 🎃',       icon:'🎃', desc:'+30% alle rewards · Meer events',      mult:{PLA:1.3,PETG:1.3,PA6:1.3}, eventBoost:1.5 },
  ],

  current: null,

  check() {
    const month = new Date().getMonth();
    const found = this.SEASONS.find(s => s.months.includes(month)) || null;
    if (found && this.current?.name !== found.name) {
      this.current = found;
      this.showBanner();
      UI.log(`🌟 Seizoensevent: ${found.name} — ${found.desc}`, 'info');
    } else if (!found) {
      this.current = null;
      const banner = $el('season-banner');
      if (banner) banner.classList.remove('active');
    }
  },

  showBanner() {
    if (!this.current) return;
    const banner = $el('season-banner');
    const icon   = $el('season-icon');
    const name   = $el('season-name');
    const effect = $el('season-effect');
    if (!banner) return;
    if (icon)   icon.textContent   = this.current.icon;
    if (name)   name.textContent   = this.current.name;
    if (effect) effect.textContent = this.current.desc;
    banner.classList.add('active');
  },

  getRewardMult(filament) {
    if (!this.current) return 1;
    return this.current.mult?.[filament] || 1;
  },
};

// ── SPEEDRUN MODE ─────────────────────────────────────────────
const Speedrun = {
  DURATION: 600, // 10 minutes
  _timer: null,
  _remaining: 600,

  start() {
    if (State.speedrunActive) return;
    UI.showPopup('⚡ Speedrun Modus',
      'Verdien zoveel mogelijk in 10 minuten! Jouw score wordt opgeslagen in het leaderboard. Klaar?',
      () => {
        State.speedrunActive  = true;
        State.speedrunStart   = Date.now();
        State.speedrunEarned  = 0;
        State.speedrunJobs    = 0;
        this._remaining = this.DURATION;
        $el('speedrun-bar').classList.add('active');
        this._startTimer();
        UI.log('⚡ Speedrun gestart! 10 minuten — ga!', 'warn');
      },
      () => {}
    );
  },

  _startTimer() {
    clearInterval(this._timer);
    this._timer = setInterval(() => {
      if (!State.speedrunActive) { clearInterval(this._timer); return; }
      this._remaining--;
      this._updateUI();
      if (this._remaining <= 0) this.end(false);
    }, 1000);
  },

  _updateUI() {
    const m = Math.floor(this._remaining / 60);
    const s = this._remaining % 60;
    const el = document.getElementById('sr-timer');
    if (el) { el.textContent = `${m}:${s.toString().padStart(2,'0')}`; el.style.color = this._remaining < 60 ? 'var(--danger)' : 'var(--warn)'; }
    const sc = $el('sr-score');
    if (sc) sc.textContent = `€${State.speedrunEarned.toFixed(0)}`;
    const jb = $el('sr-jobs');
    if (jb) jb.textContent = State.speedrunJobs;
  },

  recordJob(profit) {
    if (!State.speedrunActive) return;
    State.speedrunEarned += profit;
    State.speedrunJobs++;
  },

  end(manual) {
    clearInterval(this._timer);
    if (!State.speedrunActive) return;
    State.speedrunActive = false;
    $el('speedrun-bar').classList.remove('active');
    const score = State.speedrunEarned;
    if (score > (State.stats.bestSpeedrun || 0)) State.stats.bestSpeedrun = score;
    // Save to leaderboard with speedrun tag
    const entries = Leaderboard.load();
    entries.push({ name:`Speedrun #${entries.length+1}`, score:r0(score), level:State.bizLevel, jobs:State.speedrunJobs, date:new Date().toLocaleDateString('nl-NL'), isYou:true, tag:'⚡SR' });
    entries.sort((a,b)=>b.score-a.score);
    const pruned = entries.slice(0,10);
    Leaderboard.save(pruned);
    UI.showPopup('⚡ Speedrun Klaar!', `<div style="text-align:center"><div style="font-family:var(--display);font-weight:900;font-size:36px;color:var(--warn)">€${score.toFixed(0)}</div><div style="color:var(--text-dim);margin-top:4px">${State.speedrunJobs} jobs · ${manual?'handmatig gestopt':'tijd op'}</div>${score>200?'<div style="color:var(--accent3);margin-top:8px">🏆 Achievement unlocked!</div>':''}</div>`);
    Achievements.check();
    UI.log(`⚡ Speedrun klaar: €${score.toFixed(0)} in ${this.DURATION - this._remaining}s`, 'money');
  },
};

// ── PRESTIGE SYSTEM ──────────────────────────────────────────
const Prestige = {
  REQUIRED_LEVEL: 7,
  REQUIRED_EARNED: 5000,

  canPrestige() {
    return State.bizLevel >= this.REQUIRED_LEVEL && State.stats.totalEarned >= this.REQUIRED_EARNED;
  },

  doPrestige() {
    if (!this.canPrestige()) return;
    const msg = `
      <div style="text-align:center">
        <div style="font-size:32px;margin-bottom:8px">🔥</div>
        <div style="font-family:var(--display);font-weight:900;font-size:20px;color:#fbbf24;margin-bottom:8px">Prestige ${State.prestige + 1}</div>
        <div style="color:var(--text-dim);font-size:11px;line-height:1.7">
          Je reset je bedrijf maar behoudt:<br>
          <strong style="color:var(--text)">+10% permanente inkomensbonus</strong><br>
          <strong style="color:var(--text)">Badges & statistieken</strong><br>
          <strong style="color:var(--text)">Klantentrouw</strong><br><br>
          Je verliest: geld, upgrades, level, printers.
        </div>
      </div>`;
    UI.showPopup('🔥 Prestige?', msg, () => this._execute(), () => {});
  },

  _execute() {
    // v10: Submit this run to Hall of Fame before reset
    HallOfFame.submit();

    State.prestige++;
    State.prestigeBonus = State.prestige * 0.10;
    // Reset everything except stats, achievements, customers, prestige itself
    State.money = CONFIG.STARTING_MONEY;
    State.reputation = 0;
    State.xp = 0;
    State.bizLevel = 1;
    State.ownedUpgrades = [];
    State.speedMult = 1.0;
    State.failBonus = 0.0;
    State.abrasiveBonus = 0.0;
    State.dryerBonus = 0.0;
    State.rewardMult = 1.0 + State.prestigeBonus;
    State.passivePerMin = 0;
    State.smartQueue = false;
    State.aiQuality = false;
    State.packagingBonus = false;
    State.printers = [{ id:0, name:'Printer #1', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 }];
    State.printerCount = 1;
    State.printerSpecs = {};
    State.orders = [];
    State.contracts = [];
    State.combo = 0;
    State.comboTimer = 0;

    // v11: Reset new feature state
    State.cfUnlocked = false;
    State.glowUnlocked = false;
    State.cfNozzle = false;
    State.tpuUnlocked = false;   // fix: was not reset on prestige
    State.resinUnlocked = false; // fix: was not reset on prestige
    State.activeTrend = null;
    State.trendTimer = 0;
    State.trendCountdown = 120;
    State.inventory = { keychains: 0, planters: 0 };

    // Reset research (upgrades are gone, so research bonuses must go too)
    State.completedResearch = [];  // fix: research bonuses survived prestige
    State.activeResearch    = null;
    State.researchFlags     = {};

    // Reset employees & economy (they were bought with old money)
    State.hiredEmployees = [];    // fix: employees kept after prestige
    State.tokens         = 0;    // fix: tokens kept after prestige
    State.printQueue     = [];   // fix: queue kept after prestige
    State.pendingOrder   = null;

    // Reset loans (can't carry debt across prestige)
    State.activeLoans = [];       // fix: loans kept after prestige
    State.totalDebt   = 0;

    // Reset facility (expensive facility with no printers to fill it)
    State.ops = { facilityLevel:1, rentPM:3, electricityPerActivePM:1.2, maintenancePerPrinterPM:0.6, marketingPM:0 }; // fix: ops not reset

    // Reset bounties & challenges
    State.activeBounties  = [];
    State.claimedBounties = [];
    State.activeChallenges = [];
    State.challengeSessionData = { jobs:0, ultra:0, filamix:[], nofail:0, earn:0, contracts:0, chains:0, night:0, tpu:0, resin:0 };

    // v10: Reset business-cycle state (keep legacy perks, hof, franchise, client tiers)
    State.taxAccum = 0;
    State.taxTimer = 180;
    State.taxRate  = 0.15; // prestige resets to default (accountant upgrade can lower it again)
    State.hasAccountant = false;
    State.hasInsurance  = false;
    State.scrap = 0;
    State.morale = {};
    State.subscriptionClients = [];
    State.pendingComplaint = null;
    // Franchise stays open (passive branches survive prestige)
    // Legacy perks also survive (that's the point)

    // v17.4 fix: reset fields that were incorrectly surviving prestige
    State.filamentStock = { PLA: 100, PETG: 0, PA6: 0, TPU: 0, RESIN: 0, CF: 0, GLOW: 0 };
    State.activeEquipmentEvents = [];
    State.activeContractId = null;
    State.claimedMilestones = [];     // reset so milestone rewards can be earned again
    State.dailyGoals = [];
    State.dailyGoalsDate = '';
    State.dailyGoalsEarned = 0;
    State.speedrunActive = false;
    State._internJobs = 0;
    State.rivalScore = 0;
    State.rivalActive = false;
    State._rivalDefeated = false;
    State.activeChains = [];          // reset chain progress (level-dependent)

    // fix: automation verkregen via research — moet weg na prestige
    State.automation = { autoDispatch: false, autoRepair: false };
    State.autoAcceptToQueue = false;

    // fix: leveranciersrelaties zijn gekoppeld aan upgrades die gereset worden
    State.supplierRelations  = {};
    State.supplierOrderCount = {};

    // fix: openstaande belastingrekening wissen (prestige = nieuw bedrijf)
    TaxSystem._pending = 0;
    const taxOverlay = document.getElementById('tax-overlay');
    if (taxOverlay) taxOverlay.classList.remove('active');

    // fix: PowerOutage state resetten zodat printers niet bevroren blijven
    PowerOutage._active    = false;
    PowerOutage._countdown = 300;
    State.printers.forEach(p => { p._pausedByOutage = false; });

    // fix: complaint overlay wissen zodat hij niet blijft hangen na prestige
    State.pendingComplaint = null;
    const complaintOverlay = document.getElementById('complaint-overlay');
    if (complaintOverlay) complaintOverlay.classList.remove('active');

    // Re-apply legacy perks after reset
    if ((State.legacyPerks||[]).length > 0) LegacyPerks.reapply();

    // Update prestige display
    const pill = $el('prestige-pill');
    const val  = $el('prestige-val');
    if (pill) pill.classList.add('active');
    if (val)  val.textContent = `P${State.prestige}`;
    Sound.levelUp();
    UI.log(`🔥 Prestige ${State.prestige}! +${State.prestige*10}% permanente bonus. Nieuw begin!`, 'success');
    UI.renderAll();
    Game.saveGame();
    Achievements.check();
    HallOfFame.render();

    // v10: Show legacy perk picker after a short delay
    setTimeout(() => LegacyPerks.showPicker(), 1500);
  },

  render() {
    const el = document.getElementById('prestige-section');
    if (!el) return;
    const can = this.canPrestige();
    el.innerHTML = `
      <div style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:#fbbf24;margin-bottom:6px;">🔥 Prestige Systeem</div>
      <div style="font-size:10px;color:var(--text-dim);line-height:1.6;margin-bottom:8px;">
        Reset je bedrijf voor <strong style="color:#fbbf24">+10% permanente inkomensbonus</strong> per prestige.<br>
        Vereist: Level ${this.REQUIRED_LEVEL} + €${this.REQUIRED_EARNED.toLocaleString()} verdiend.
      </div>
      ${State.prestige > 0 ? `<div style="margin-bottom:8px;color:#fbbf24;font-size:11px;">Huidige bonus: +${State.prestige*10}% inkomen (P${State.prestige})</div>` : ''}
      <button class="prestige-btn" onclick="Prestige.doPrestige()" ${can?'':'disabled'}>
        ${can ? `🔥 PRESTIGE → P${State.prestige+1}` : `🔒 Level ${this.REQUIRED_LEVEL} + €${this.REQUIRED_EARNED} nodig`}
      </button>`;
  },
};

// ── PRINTER SPECIALIZATION ────────────────────────────────────
const Specialization = {
  SPECS: {
    speed:   { name:'Snel',     icon:'⚡', desc:'-25% printtijd', timeMult: 0.75, profitMult: 0.9 },
    quality: { name:'Kwaliteit',icon:'💎', desc:'+20% winst, -10% fail', profitMult: 1.2, failBonus: -0.10 },
    economy: { name:'Zuinig',   icon:'💰', desc:'-50% filamentkosten', filCostMult: 0.5 },
  },

  set(printerIdx, spec) {
    if (!State.printerSpecs) State.printerSpecs = {};
    if (State.printerSpecs[printerIdx] === spec) {
      delete State.printerSpecs[printerIdx]; // toggle off
      UI.log(`Printer #${printerIdx+1}: Specialisatie verwijderd`, 'info');
    } else {
      State.printerSpecs[printerIdx] = spec;
      const s = this.SPECS[spec];
      UI.log(`Printer #${printerIdx+1}: ${s.icon} ${s.name} specialisatie actief`, 'info');
    }
    Sound.click();
    UI.renderPrinters();
    Achievements.check();
  },

  get(printerIdx) {
    return State.printerSpecs?.[printerIdx] || null;
  },

  getTimeMult(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].timeMult || 1) : 1;
  },
  getProfitMult(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].profitMult || 1) : 1;
  },
  getFailBonus(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].failBonus || 0) : 0;
  },
  getFilCostMult(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].filCostMult || 1) : 1;
  },
};

// ── SMART TIPS ───────────────────────────────────────────────
const SmartTips = {
  _shown: new Set(),
  _timer: null,
  TIPS: [
    { id:'first_fail',   trigger: s => s.stats.jobsFailed >= 1 && !s.ownedUpgrades.includes('bed_leveling'), text: 'Je eerste mislukking! Koop Auto Bed Leveling in de Shop — dat verlaagt de kans met 8%.' },
    { id:'low_health',   trigger: s => s.printers.some(p=>p.health<30&&!p.active), text: 'Printer health is laag! Repareer vóór de volgende job om faalkansen te verlagen.' },
    { id:'unlock_petg',  trigger: s => s.reputation >= 18 && s.reputation < 22, text: 'Je bent bijna bij 20 reputatie — dan unlock je PETG filament met 50% meer winst!' },
    { id:'market_surge', trigger: s => Object.values(s.market).some(v=>v>=1.3), text: '📈 De markt piekt! Druk nu PA6 of PETG af voor maximale winst.' },
    { id:'combo_tip',    trigger: s => s.combo === 0 && s.stats.jobsDone >= 5, text: '🔥 Combo-tip: druk jobs snel achter elkaar af voor een combo-multiplier tot +50%!' },
    { id:'contract_tip', trigger: s => s.stats.jobsDone >= 3 && s.stats.contractsDone === 0, text: '📋 Accepteer een contract voor grote beloningen! Klik op het Contracts-tabblad.' },
    { id:'prestige_tip', trigger: s => s.bizLevel >= 6, text: '🔥 Op level 6! Wist je dat Prestige je een permanente +10% inkomensbonus geeft? Check de Settings tab.' },
    { id:'spec_tip',     trigger: s => s.printerCount >= 2 && Object.keys(s.printerSpecs||{}).length === 0, text: '💡 Met 2 printers: geef ze een specialisatie! Eén snel, één voor kwaliteit.' },
    { id:'night_tip',    trigger: s => s.stats.jobsDone >= 10 && s.stats.nightShiftJobs === 0, text: '🌙 Wist je dat printen na 22:00 een nachtbonus van +20% opbrengt? Probeer het eens!' },
    { id:'research_tip', trigger: s => s.bizLevel >= 2 && (s.completedResearch||[]).length === 0, text: '🔬 Research is beschikbaar! Bed Adhesion Science halveert je PLA faalkans voor slechts €250.' },
    { id:'cf_tip',       trigger: s => s.reputation >= 100 && !s.ownedUpgrades.includes('cf_nozzle'), text: '⚫ Je hebt genoeg reputatie voor Carbon Fiber! Koop CF Nozzle + Enclosure voor 5× winst.' },
    { id:'bulk_deal_tip',trigger: s => s.bizLevel >= 4 && !s.ownedUpgrades.includes('bulk_deals') && s.stats.jobsDone >= 30, text: '💡 Bulk Deal Contracts (-20% filamentkosten) is nu beschikbaar in de Shop!' },
    { id:'trending_tip', trigger: s => (s.stats.trendOrdersDone||0) === 0 && s.stats.jobsDone >= 15, text: '🔥 Let op de TRENDING banner! Trending orders leveren tot 3× meer op — druk ze snel af.' },
  ],

  check(state) {
    for (const tip of this.TIPS) {
      if (!this._shown.has(tip.id) && tip.trigger(state)) {
        this._shown.add(tip.id);
        this.show(tip.text);
        break;
      }
    }
  },

  show(text) {
    const el = document.getElementById('smart-tip');
    const t  = $el('tip-text');
    if (!el || !t) return;
    t.textContent = text;
    el.classList.add('visible');
    clearTimeout(this._timer);
    this._timer = setTimeout(() => el.classList.remove('visible'), 6000);
  },
};

// ── PRINT WACHTRIJ ───────────────────────────────────────────
const Queue = {
  MAX: 8,

  add(order, filament, quality) {
    // Queue is Pro-only
    if (!State.isPro) {
      switchPTab('queue');
      return;
    }
    if (State.printQueue.length >= this.MAX) { UI.log('Wachtrij is vol (max 8)!', 'warn'); return; }
    if (State.printQueue.find(q => q.order.id === order.id)) { UI.log('Al in de wachtrij!', 'warn'); return; }
    State.orders = State.orders.filter(o => o.id !== order.id);
    State.printQueue.push({ order, filament: filament || State.selectedFilament, quality: quality || State.selectedQuality });
    Sound.click();
    UI.log(`➕ ${order.name} toegevoegd aan wachtrij`, 'info');
    this.render();
    UI.renderOrders();
  },

  remove(idx) {
    const item = State.printQueue[idx];
    if (item) { State.orders.push(item.order); }
    State.printQueue.splice(idx, 1);
    this.render();
    UI.renderOrders();
    Sound.click();
  },

  tryAutoStart() {
    if (State.printQueue.length === 0) return;

    // Layer 3 automation: Auto-Dispatch can fill *all* free printers in one go
    const canAutoDispatch = !!(State.researchFlags?.autoDispatch) && !!(State.automation);
    const autoDispatchOn  = canAutoDispatch && State.automation.autoDispatch;

    const startOne = (freePrinter) => {
      if (!freePrinter) return false;
      const item = State.printQueue.shift();
      if (!item) return false;
      // v17.5 fix: use indexOf (array position) not printer.id so startJob picks the right slot
      const printerIdx = State.printers.indexOf(freePrinter);
      if (printerIdx < 0) return false;
      const fil = State.reputation >= CONFIG.FILAMENTS[item.order.filament]?.unlockRep ? item.filament : 'PLA';
      Printer.startJob(printerIdx, item.order, fil, item.quality);
      // v17.5 fix: clear pendingOrder so the UI doesn't stay locked in configure-mode
      State.pendingOrder = null;
      State.viewingPrinterIdx = printerIdx;
      UI.log('🤖 Wachtrij: automatisch gestart ' + item.order.name + ' op ' + freePrinter.name, 'info');
      return true;
    };

    if (autoDispatchOn) {
      // Fill every available printer (idle management vibe)
      let started = 0;
      while (State.printQueue.length > 0) {
        const free = State.printers.find(p => !p.active && !p._offline);
        if (!free) break;
        if (startOne(free)) started++;
        else break;
      }
      if (started > 0) {
        this.render();
        UI.renderPrinters();
        UI.renderCenterPanel();
      }
      return;
    }

    // Default: start one printer
    const freePrinter = State.printers.find(p => !p.active && !p._offline);
    if (!freePrinter) return;
    if (startOne(freePrinter)) {
      this.render();
      UI.renderPrinters();
      UI.renderCenterPanel();
    }
  },

  render() {
    const el = document.getElementById('queue-slots'); if (!el) return;
    // Toon pro gate of pro info naargelang account type
    const gate = document.getElementById('queue-pro-gate');
    const info = document.getElementById('queue-pro-info');
    if (gate) gate.style.display = State.isPro ? 'none' : 'block';
    if (info) info.style.display = State.isPro ? 'block' : 'none';
    if (!State.isPro) { el.innerHTML = ''; return; }
    if (State.printQueue.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:16px;font-size:10px;">Wachtrij leeg</div>';
      return;
    }
    el.innerHTML = State.printQueue.map((item, i) => {
      const fc = filClass(item.order.filament);
      return `<div class="queue-slot filled">
        <div class="queue-slot-num">${i+1}</div>
        <div class="queue-slot-name">${item.order.name}<br><span style="font-size:11px;color:var(--text-dim)">${item.quality} · €${item.order.reward.toFixed(0)}</span></div>
        <span class="queue-slot-fil tag tag-${fc}">${item.order.filament}</span>
        <button class="queue-slot-remove" onclick="Queue.remove(${i})">✕</button>
      </div>`;
    }).join('');
  },
};

// ── EXPENSES (Idle Economy Layer 1) ─────────────────────────
const Expenses = {
  // Compute per-minute operating expenses based on facility + printers
  calcPM() {
    const ops = State.ops || {};
    const facility = ops.facilityLevel || 1;

    // Facility scaling (gentle early, steeper later)
    const rentBase = ops.rentPM ?? 8;
    const rentMult = facility === 1 ? 1 : facility === 2 ? 2.2 : facility === 3 ? 4.2 : 7.0;

    const rentPM = rentBase * rentMult;

    const activePrinters = State.printers.filter(p => p.active).length;
    const ownedPrinters  = State.printers.length;

    const electricityPM = (ops.electricityPerActivePM ?? 1.2) * activePrinters;
    const maintenancePM = (ops.maintenancePerPrinterPM ?? 0.6) * ownedPrinters;

    // Employees wages are handled in Employees.tick (existing)
    // Debt interest handled in Loans.tick, taxes in TaxSystem.tick

    const total = rentPM + electricityPM + maintenancePM + (ops.marketingPM ?? 0);
    return {
      rentPM: r2(rentPM),
      electricityPM: r2(electricityPM),
      maintenancePM: r2(maintenancePM),
      marketingPM: r2(ops.marketingPM ?? 0),
      totalPM: r2(total),
      facility,
      activePrinters,
      ownedPrinters,
    };
  },

  tick(dt) {
    // dt in seconds
    if (!State.ops) return;
    const pm = this.calcPM();
    const costPerSec = pm.totalPM / 60;
    const cost = costPerSec * dt;
    if (cost <= 0) return;

    State.money = r2(State.money - cost);
    State.stats.totalExpenses = r2((State.stats.totalExpenses || 0) + cost);

    // Soft penalty if you go negative: reputation slowly drops (feels like "bad business")
    if (State.money < -50) {
      State.reputation = Math.max(0, State.reputation - 0.004 * dt);
    }

    // Cache latest breakdown for UI
    State._lastExpenseBreakdown = pm;
  },

  render() {
    const el = document.getElementById('expenses-panel');
    if (!el) return;
    const pm = State._lastExpenseBreakdown || this.calcPM();

    const facilityNames = {
      1: 'Garage',
      2: 'Workshop',
      3: 'Small Factory',
      4: 'Factory'
    };

    el.innerHTML = `
      <div style="padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
          <div>
            <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;">Facility</div>
            <div style="font-family:var(--display);font-weight:900;font-size:16px;color:var(--text);line-height:1.1;">${facilityNames[pm.facility] || 'Facility'} L${pm.facility}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;">Total / min</div>
            <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--danger);">€${pm.totalPM.toFixed(1)}</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr auto;gap:6px;font-size:10px;">
          <div style="color:var(--text-dim)">🏠 Rent</div><div>€${pm.rentPM.toFixed(1)}</div>
          <div style="color:var(--text-dim)">⚡ Electricity (active ${pm.activePrinters})</div><div>€${pm.electricityPM.toFixed(1)}</div>
          <div style="color:var(--text-dim)">🔧 Maintenance (printers ${pm.ownedPrinters})</div><div>€${pm.maintenancePM.toFixed(1)}</div>
          ${pm.marketingPM > 0 ? `<div style="color:var(--text-dim)">📣 Marketing</div><div>€${pm.marketingPM.toFixed(1)}</div>` : ``}
        </div>

        <div style="margin-top:10px;display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" style="flex:1" onclick="Expenses.upgradeFacility()">🏗 Upgrade Facility</button>
          <button class="btn btn-ghost btn-sm" style="flex:1" onclick="Expenses.toggleAutoAccept()">${State.autoAcceptToQueue ? '🤖 Auto-Queue: ON' : '🤖 Auto-Queue: OFF'}</button>
        </div>

        <div style="margin-top:6px;display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" style="flex:1" onclick="PrinterFarm.buyPrinter()">🖨️ Buy Printer (${fmtEur(PrinterFarm.nextCost())})</button>
          <button class="btn btn-ghost btn-sm" style="flex:1" onclick="PrinterFarm.renameAll()">✏️ Rename Farm</button>
        </div>

        <div style="margin-top:6px;display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" style="flex:1;opacity:${State.researchFlags?.autoDispatch?1:0.55}" onclick="Automation.toggleDispatch()">
            ${State.automation?.autoDispatch ? '📦 Auto-Dispatch: ON' : '📦 Auto-Dispatch: OFF'}
          </button>
          <button class="btn btn-ghost btn-sm" style="flex:1;opacity:${State.researchFlags?.autoRepair?1:0.55}" onclick="Automation.toggleRepair()">
            ${State.automation?.autoRepair ? '🛠 Auto-Repair: ON' : '🛠 Auto-Repair: OFF'}
          </button>
        </div>

        <div style="margin-top:10px;padding:8px;background:rgba(0,229,255,0.04);border:1px solid rgba(0,229,255,0.12);border-radius:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase">📈 Market</div>
            <div style="font-size:11px;color:var(--text-dim)">Shift in <strong style="color:var(--accent)">${fmtTime(Math.max(0,State.marketTimer||0))}</strong></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:space-between;font-size:10px">
            <div><span style="color:var(--text-dim)">PLA</span> <strong id="mval2-pla">×${(State.market?.PLA||1).toFixed(2)}</strong> <span id="marr2-pla" style="color:var(--text-dim)">→</span></div>
            <div><span style="color:var(--text-dim)">PETG</span> <strong id="mval2-petg">×${(State.market?.PETG||1).toFixed(2)}</strong> <span id="marr2-petg" style="color:var(--text-dim)">→</span></div>
            <div><span style="color:var(--text-dim)">PA6</span> <strong id="mval2-pa6">×${(State.market?.PA6||1).toFixed(2)}</strong> <span id="marr2-pa6" style="color:var(--text-dim)">→</span></div>
          </div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:6px;line-height:1.5">
            Market multipliers affect order rewards. Watch surges and shift production.
          </div>
        </div>

        <div style="margin-top:8px;font-size:11px;color:var(--text-dim);line-height:1.5;">
          Tip: meer printers = meer output, maar ook hogere vaste kosten. Balans = winst.
        </div>
      </div>
    `;
  },

  upgradeFacility() {
    const ops = State.ops;
    const next = (ops.facilityLevel || 1) + 1;
    if (next > 4) { UI.log('🏭 Je facility is al max level.', 'info'); return; }

    const costs = { 2: 2500, 3: 12000, 4: 45000 };
    const cost = costs[next] || 0;

    if (State.money < cost) { UI.showPopup('Te weinig geld', `Upgrade naar facility L${next} kost €${cost}.`); return; }
    if (State.bizLevel < (next + 1)) { UI.showPopup('Locked', `Facility L${next} vereist Business Level ${next + 1}.`); return; }

    State.money = r2(State.money - cost);
    ops.facilityLevel = next;

    // Facility upgrades also improve reputation cap slightly (signals "more legit business")
    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + 3);

    Sound.success();
    UI.log(`🏗 Faciliteit geüpgraded: L${next}`, 'success');
    this.render();
    UI.updateTopBar();
  },

  toggleAutoAccept() {
    State.autoAcceptToQueue = !State.autoAcceptToQueue;
    Sound.click();
    UI.log(State.autoAcceptToQueue ? '🤖 Auto-wachtrij ingeschakeld (orders worden automatisch toegevoegd)' : '🤖 Auto-wachtrij uitgeschakeld', 'info');
    this.render();
  }
};

// ── PRINTER FARM (Multi-printer management) ──────────────────
// Goal: allow owning many printers (simultaneous jobs) without relying on fixed shop upgrades.
// Printers are stored in State.printers; printerCount is kept in sync for achievements/UI.
const PrinterFarm = {
  // Cost curve: matches the old fixed upgrades for first 5, then scales.
  nextCost() {
    const n = State.printers?.length || 1;
    const fixed = { 1: 1200, 2: 3500, 3: 8000, 4: 15000 };
    if (fixed[n]) return fixed[n];
    // Beyond 5 printers, scale up.
    const base = 15000;
    const k = Math.max(0, n - 4);
    return r0(base * Math.pow(1.85, k));
  },

  // Soft gating so early game doesn't explode.
  canBuyNext() {
    const n = State.printers?.length || 1;
    // Need higher biz levels as you scale.
    const minBiz = Math.min(12, 3 + n); // 2nd @4, 3rd @5, ... caps at 12
    const minFacility = Math.min(4, 1 + Math.floor((n) / 2)); // every 2 printers needs +1 facility
    return {
      ok: State.bizLevel >= minBiz && (State.ops?.facilityLevel || 1) >= minFacility,
      minBiz,
      minFacility,
    };
  },

  ensureSlots() {
    if (!Array.isArray(State.printers)) State.printers = [];
    // Keep ids aligned with array index; UI/Queue/Printer uses id as index.
    for (let i = 0; i < State.printers.length; i++) {
      const p = State.printers[i];
      if (!p) continue;
      p.id = i;
      if (!p.name)  p.name  = `Printer #${i + 1}`;
      if (!p.model) p.model = (i === 4 ? 'DELTA' : 'BASIC');
      if (p.health === undefined) p.health = 100;
      if (p.active === undefined) p.active = false;
      if (p.job === undefined) p.job = null;
      if (p.progress === undefined) p.progress = 0;
      if (p.timeLeft === undefined) p.timeLeft = 0;
      if (p.totalTime === undefined) p.totalTime = 0;
    }
    // Sync printerCount.
    State.printerCount = Math.max(1, State.printers.length);
  },

  buyPrinter() {
    this.ensureSlots();
    const gate = this.canBuyNext();
    if (!gate.ok) {
      UI.showPopup('Locked', `To expand your farm you need Business Level ${gate.minBiz} and Facility Level ${gate.minFacility}.`);
      return;
    }

    const cost = this.nextCost();
    if (State.money < cost) {
      UI.showPopup('Insufficient Funds', `You need ${fmtEur(cost)} to buy a new printer.`);
      return;
    }

    State.money = r2(State.money - cost);

    const idx = State.printers.length;
    const isTitan = idx === 4; // 5th printer special
    State.printers.push({
      id: idx,
      name: isTitan ? `Titan #${idx + 1}` : `Printer #${idx + 1}`,
      model: isTitan ? 'DELTA' : 'BASIC',
      health: 100,
      active: false,
      job: null,
      progress: 0,
      timeLeft: 0,
      totalTime: 0,
    });
    State.printerCount = State.printers.length;
    if (idx >= 4) State.legendaryUnlocked = true;

    Sound.success();
    UI.log(`🖨️ Nieuwe printer toegevoegd! Farm: ${State.printerCount} printers`, 'success');
    Confetti.burst(30);
    UI.renderPrinters();
    UI.updateTopBar();
    Expenses.render();
    Achievements.check();
    Milestones.check();
  },

  renameAll() {
    const base = prompt('Farm prefix name? (e.g. “Loire” → Loire #1, Loire #2 …)', '');
    if (base === null) return;
    const clean = String(base || '').trim();
    if (!clean) return;
    this.ensureSlots();
    State.printers.forEach((p, i) => {
      const suffix = (i === 4) ? 'Titan' : '#'+(i+1);
      p.name = `${clean} ${suffix}`;
    });
    UI.renderPrinters();
    UI.log('✏️ Farm hernoemd.', 'info');
  }
};

// ── AUTOMATION (Layer 3) ──────────────────────────────────────
const Automation = {
  // Toggles are gated by completed research
  canDispatch() { return !!State.researchFlags?.autoDispatch; },
  canRepair()   { return !!State.researchFlags?.autoRepair; },

  toggleDispatch() {
    if (!this.canDispatch()) { UI.toast('🔒 Research "Auto Dispatch" required', 'warn'); return; }
    if (!State.automation) State.automation = { autoDispatch:false, autoRepair:false };
    State.automation.autoDispatch = !State.automation.autoDispatch;
    Sound.click();
    UI.toast(State.automation.autoDispatch ? '📦 Auto-Dispatch: ON' : '📦 Auto-Dispatch: OFF', 'info');
    Expenses.render();
  },

  toggleRepair() {
    if (!this.canRepair()) { UI.toast('🔒 Research "Auto Maintenance" required', 'warn'); return; }
    if (!State.automation) State.automation = { autoDispatch:false, autoRepair:false };
    State.automation.autoRepair = !State.automation.autoRepair;
    Sound.click();
    UI.toast(State.automation.autoRepair ? '🛠 Auto-Repair: ON' : '🛠 Auto-Repair: OFF', 'info');
    Expenses.render();
  },

  tick(dt) {
    // Auto-repair: idle printers slowly regain health
    if (!this.canRepair() || !State.automation?.autoRepair) return;
    for (const p of State.printers) {
      if (p.active) continue;
      if (p.health < 100) {
        // gentle idle repair, scaled by facility level
        const facility = State.ops?.facilityLevel || 1;
        const rate = facility >= 4 ? 0.14 : facility >= 3 ? 0.10 : facility >= 2 ? 0.07 : 0.05; // HP per second
        p.health = Math.min(100, p.health + rate * dt);
      }
    }
  },
};

// ── EMPLOYEES ────────────────────────────────────────────────
const Employees = {
  hire(id) {
    const emp = CONFIG.EMPLOYEES.find(e => e.id === id);
    if (!emp) return;
    if (State.hiredEmployees.includes(id)) { UI.log('Al in dienst!', 'warn'); return; }
    if (State.money < emp.cost) { UI.showPopup('Te weinig geld', `Inhuren kost €${emp.cost}.`); return; }
    if (State.bizLevel < emp.unlockLevel) { UI.showPopup('Niveau te laag', `Vereist niveau ${emp.unlockLevel}.`); return; }
    State.money = r2(State.money - emp.cost);
    State.hiredEmployees.push(id);
    Sound.click();
    UI.log(`👥 ${emp.name} in dienst genomen!`, 'success');
    if (emp.effect === 'failRedux') State.failBonus -= 0.10;
    this.render();
    UI.updateTopBar();
  },

  fire(id) {
    State.hiredEmployees = State.hiredEmployees.filter(e => e !== id);
    const emp = CONFIG.EMPLOYEES.find(e => e.id === id);
    if (emp?.effect === 'failRedux') State.failBonus += 0.10;
    Sound.click();
    UI.log(`👋 ${emp?.name} ontslagen.`, 'warn');
    this.render();
  },

  tick(dt) {
    State.hiredEmployees.forEach(id => {
      const emp = CONFIG.EMPLOYEES.find(e => e.id === id);
      if (!emp) return;
      // Morale efficiency: low morale → employee contributes less
      const eff = Morale.getEff(id);
      // Pay wages per second (always full — they show up regardless)
      const wagePerSec = emp.wagePM / 60;
      State.money = r2(State.money - wagePerSec * dt);

      // Effects scaled by morale efficiency
      if (emp.effect === 'autoRepair') {
        // Low morale technician repairs less aggressively
        const repairThreshold = eff >= 1.0 ? 40 : eff >= 0.8 ? 30 : 20;
        State.printers.forEach((p, idx) => {
          if (!p.active && p.health < repairThreshold) {
            const cost = Math.round((100 - p.health) * CONFIG.REPAIR_COST_PER_HP * 100) / 100;
            if (State.money >= cost) Game.repairPrinter(idx);
          }
        });
      }
      // failRedux engineer: morale below 30% = bonus shrinks to half
      if (emp.effect === 'failRedux' && eff < 1.0 && !emp._moraleWarnShown) {
        emp._moraleWarnShown = true;
        UI.log(`😴 ${emp.name} werkt op laag moreel — fail-reductie verminderd!`, 'warn');
      } else if (eff >= 1.0 && emp._moraleWarnShown) {
        emp._moraleWarnShown = false;
      }
      if (emp.effect === 'autoPLA' || emp.effect === 'queueOpt') {
        // Handled in tick via Queue.tryAutoStart
      }
    });
  },

  tickBonus: 0,
  tickSalesBonus(dt) {
    if (!State.hiredEmployees.includes('salesperson')) return;
    this.tickBonus = (this.tickBonus || 0) + dt;
    if (this.tickBonus >= 120) {
      this.tickBonus = 0;
      if (State.orders.length < CONFIG.MAX_ORDERS) {
        const o = Orders.generate();
        o.reward = r2(o.reward * 1.3 );
        State.orders.push(o);
        UI.log('🤝 Verkoper scoorde een bonus order!', 'info');
        UI.renderOrders();
      }
    }
  },

  render() {
    const el = document.getElementById('employee-list'); if (!el) return;
    el.innerHTML = CONFIG.EMPLOYEES.map(emp => {
      const hired = State.hiredEmployees.includes(emp.id);
      const canAfford = State.money >= emp.cost;
      const canUnlock = State.bizLevel >= emp.unlockLevel;
      return `<div class="employee-card ${hired ? 'hired' : ''}">
        <div class="employee-header">
          <div class="employee-avatar">${emp.avatar}</div>
          <div class="employee-name">${emp.name}</div>
          <div class="employee-wage">€${emp.wagePM}/min</div>
        </div>
        <div class="employee-desc">${emp.desc}</div>
        ${hired
          ? `<div style="display:flex;justify-content:space-between;align-items:center;">
              <span class="employee-status working">✓ In dienst</span>
              <button class="btn btn-ghost btn-sm" onclick="Employees.fire('${emp.id}')">Ontslaan</button>
             </div>`
          : `<div style="display:flex;justify-content:space-between;align-items:center;">
              <span class="employee-status idle">${canUnlock ? 'Beschikbaar' : `🔒 Level ${emp.unlockLevel}`}</span>
              <button class="btn btn-primary btn-sm" onclick="Employees.hire('${emp.id}')" ${canUnlock&&canAfford?'':'disabled'}>
                €${emp.cost} Inhuren
              </button>
             </div>`
        }
      </div>`;
    }).join('');
  },
};

// ── PRODUCTIEKETENS ──────────────────────────────────────────
const Chains = {
  init() {
    if (State.activeChains.length > 0) return;
    State.activeChains = CONFIG.PRODUCTION_CHAINS.map(c => ({
      id: c.id,
      progress: c.steps.map(() => 0),
      completed: false,
    }));
  },

  trackJob(filament) {
    State.activeChains.forEach(ac => {
      if (ac.completed) return;
      const template = CONFIG.PRODUCTION_CHAINS.find(c => c.id === ac.id);
      if (!template || State.bizLevel < template.unlockLevel) return;
      // Find next unfilled step matching filament
      const stepIdx = template.steps.findIndex((s, i) => s.fil === filament && ac.progress[i] < s.count);
      if (stepIdx >= 0) {
        ac.progress[stepIdx]++;
        // Check completion
        const done = template.steps.every((s, i) => ac.progress[i] >= s.count);
        if (done) {
          ac.completed = true;
          State.money = r2(State.money + template.reward);
          State.stats.totalEarned = r2(State.stats.totalEarned + template.reward);
          TaxSystem.accrue(template.reward);
          State.tokens = (State.tokens || 0) + template.bonusTokens;
          Sound.contractComplete();
          UI.floatMoney(`+€${template.reward} KETEN`);
          UI.log(`🔗 Productieketen voltooid: ${template.name} → +€${template.reward} + ${template.bonusTokens}🎲`, 'contract');
          this._showTokenAnim(template.bonusTokens);
          this._showCompletionToast(template);
          this.reset(ac.id);
          this.updateTokenDisplay();
          // v7: Challenge tracking
          Challenges.onChainComplete();
        }
      }
    });
    this.render();
  },

  reset(id) {
    const ac = State.activeChains.find(a => a.id === id);
    if (ac) { ac.progress = ac.progress.map(() => 0); ac.completed = false; }
  },

  updateTokenDisplay() {
    const el = document.getElementById('token-val');
    if (el) el.textContent = State.tokens || 0;
    const td = $el('token-display');
    if (td) td.textContent = `${State.tokens || 0} Tokens`;
    const pill = $el('token-pill');
    if (pill) pill.style.display = (State.tokens || 0) > 0 ? 'flex' : 'none';
  },

  _showTokenAnim(count) {
    const el = document.createElement('div');
    el.style.cssText = `position:fixed;top:80px;right:24px;font-family:var(--display);font-weight:900;font-size:24px;color:#fbbf24;z-index:500;pointer-events:none;animation:floatUp 1.5s ease forwards;`;
    el.textContent = `+${count}🎲`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1600);
  },

  _showCompletionToast(template) {
    const t = document.createElement('div');
    t.className = 'contract-toast';
    t.innerHTML = `<div style="font-size:11px;letter-spacing:2px;color:#fbbf24;margin-bottom:4px">🔗 KETEN VOLTOOID!</div><div style="font-family:var(--display);font-weight:700;font-size:15px;color:var(--text-bright)">${template.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">+€${template.reward} · +${template.bonusTokens}🎲</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 5000);
  },

  render() {
    const el = document.getElementById('chain-list'); if (!el) return;
    el.innerHTML = CONFIG.PRODUCTION_CHAINS.map(template => {
      const ac = State.activeChains.find(a => a.id === template.id);
      const locked = State.bizLevel < template.unlockLevel;
      if (locked) return `<div class="chain-card" style="opacity:0.4;"><div class="chain-header"><div class="chain-name">🔒 ${template.name}</div><div style="font-size:11px;color:var(--text-dim)">Level ${template.unlockLevel}</div></div></div>`;
      const totalSteps = template.steps.reduce((s,step)=>s+step.count,0);
      const doneSoFar  = ac ? ac.progress.reduce((s,v)=>s+v,0) : 0;
      const pct = r0(doneSoFar / totalSteps * 100);
      const stepsHtml = template.steps.map((s,i) => {
        const done = ac ? ac.progress[i] : 0;
        const fc = filClass(s.fil);
        return `<div class="chain-step"><span class="tag tag-${fc}">${s.fil}</span> ${done}/${s.count}</div>${i<template.steps.length-1?'<div class="chain-arrow">→</div>':''}`;
      }).join('');
      return `<div class="chain-card">
        <div class="chain-header"><div class="chain-name">${template.name}</div><div class="chain-reward">€${template.reward} + ${template.bonusTokens}🎲</div></div>
        <div class="chain-steps">${stepsHtml}</div>
        <div class="chain-progress"><div class="chain-prog-fill" style="width:${pct}%"></div></div>
        <div style="font-size:11px;color:var(--text-dim);text-align:right;">${doneSoFar}/${totalSteps} stappen (${pct}%)</div>
      </div>`;
    }).join('');
  },
};

// ── LOOTBOX ──────────────────────────────────────────────────
const LootBox = {
  COST: 10,

  open() {
    if ((State.tokens || 0) < this.COST) {
      UI.showPopup('Niet genoeg tokens', `Je hebt ${this.COST} tokens nodig. Voltooi productieketens voor tokens!`);
      return;
    }
    State.tokens -= this.COST;
    Chains.updateTokenDisplay();
    // Weighted random: common=60%, rare=30%, epic=10%
    const roll = Math.random();
    const pool = roll < 0.1 ? CONFIG.LOOTBOX_REWARDS.filter(r=>r.rarity==='epic') :
                 roll < 0.4 ? CONFIG.LOOTBOX_REWARDS.filter(r=>r.rarity==='rare') :
                              CONFIG.LOOTBOX_REWARDS.filter(r=>r.rarity==='common');
    const reward = pool[Math.floor(Math.random() * pool.length)];
    const result = reward.apply(State);
    Confetti.burst();
    Sound.levelUp();
    UI.showPopup(`${reward.icon} Lootbox!`, `<div style="text-align:center;padding:8px 0"><div style="font-size:40px;margin-bottom:8px">${reward.icon}</div><div style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--warn);margin-bottom:4px">${reward.name}</div><div style="font-size:11px;color:var(--accent3)">${result}</div><div style="font-size:11px;color:var(--text-dim);margin-top:8px;text-transform:uppercase;letter-spacing:1px">${reward.rarity}</div></div>`);
    UI.log(`🎲 Lootbox: ${reward.name} — ${result}`, 'money');
    UI.updateTopBar();
    Achievements.check();
  },
};

// ── CONFETTI ─────────────────────────────────────────────────
const Confetti = {
  COLORS: ['#00e5ff','#ff6b35','#7fff6e','#ffcc00','#ff3d5a','#a78bfa','#4fc3f7'],

  burst(count = 60) {
    for (let i = 0; i < count; i++) {
      setTimeout(() => this._piece(), Math.random() * 600);
    }
  },

  _piece() {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = 6 + Math.random() * 8;
    el.style.cssText = `
      left: ${Math.random() * 100}%;
      width: ${size}px; height: ${size}px;
      background: ${this.COLORS[Math.floor(Math.random() * this.COLORS.length)]};
      animation-duration: ${1.5 + Math.random() * 2}s;
      border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  },

  levelUp() {
    this.burst(100);
    Particles.screenBurst('#00e5ff', 30);
    const overlay = document.createElement('div');
    overlay.className = 'levelup-flash';
    overlay.innerHTML = `<div class="levelup-text">LEVEL UP!</div>`;
    document.body.appendChild(overlay);
    setTimeout(() => overlay.remove(), 2600);
  },
};

const Particles = {
  // Shower money text particles from a source element
  moneyShower(text, sourceEl) {
    const count = Math.min(8, 3 + Math.floor(text.length / 3));
    const rect = sourceEl ? sourceEl.getBoundingClientRect() : { left: window.innerWidth/2, top: window.innerHeight/2, width:0, height:0 };
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    for (let i = 0; i < count; i++) {
      setTimeout(() => {
        const el = document.createElement('div');
        el.className = 'money-particle';
        const angle = (Math.PI * 2 / count * i) + (Math.random() - 0.5) * 0.5;
        const dist  = 60 + Math.random() * 80;
        const dx    = Math.cos(angle) * dist;
        const dy    = -(Math.random() * 120 + 60);
        const r1    = (Math.random() - 0.5) * 20;
        const r2_   = r1 + (Math.random() - 0.5) * 40;
        const size  = 11 + Math.random() * 6;
        el.style.cssText = `
          left:${cx}px; top:${cy}px;
          font-size:${size}px;
          color:${i % 2 === 0 ? '#7fff6e' : '#ffcc00'};
          text-shadow:0 0 8px currentColor;
          --dy:${dy}px; --dx:${dx}px; --r:${r1}deg; --r2:${r2_}deg;
          --dur:${0.9 + Math.random()*0.5}s;
        `;
        el.textContent = i === 0 ? text : ['💰','✨','€','★'][Math.floor(Math.random()*4)];
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1600);
      }, i * 60);
    }
  },

  // Circular burst of colored dots from screen center
  screenBurst(color, count = 20) {
    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    for (let i = 0; i < count; i++) {
      const el = document.createElement('div');
      el.className = 'success-burst';
      const angle = (Math.PI * 2 / count) * i;
      const dist  = 80 + Math.random() * 160;
      const tx = Math.cos(angle) * dist;
      const ty = Math.sin(angle) * dist;
      el.style.cssText = `
        left:${cx}px; top:${cy}px;
        background:${color || '#7fff6e'};
        box-shadow:0 0 8px ${color || '#7fff6e'};
        --tx:${tx}px; --ty:${ty}px;
        --dur:${0.7 + Math.random()*0.4}s;
      `;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1200);
    }
  },

  // Flash the whole screen green (success) or red (failure)
  screenFlash(type) {
    const el = document.createElement('div');
    el.className = 'screen-success-flash';
    if (type === 'fail') {
      el.style.background = 'radial-gradient(ellipse at center, rgba(255,61,90,0.22) 0%, transparent 70%)';
    }
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 700);
  },

  // Shake the whole viewport (failure)
  shake() {
    document.body.classList.add('shaking');
    setTimeout(() => document.body.classList.remove('shaking'), 520);
  },

  // Pulse the money display in topbar
  pulseMoney() {
    const el = document.getElementById('money-val');
    if (!el) return;
    el.classList.remove('money-gained');
    void el.offsetWidth; // reflow to re-trigger
    el.classList.add('money-gained');
    setTimeout(() => el.classList.remove('money-gained'), 450);
  },

  // Spark effect on the printer SVG nozzle area
  nozzleSparks(svgContainer) {
    if (!svgContainer) return;
    const canvas = svgContainer.querySelector('.spark-canvas') || (() => {
      const c = document.createElement('canvas');
      c.className = 'spark-canvas';
      c.width = svgContainer.offsetWidth || 200;
      c.height = svgContainer.offsetHeight || 200;
      svgContainer.style.position = 'relative';
      svgContainer.appendChild(c);
      return c;
    })();
    const ctx = canvas.getContext('2d');
    const sparks = Array.from({length:8}, () => ({
      x: (canvas.width * 0.52) + (Math.random()-0.5)*10,
      y: canvas.height * 0.44,
      vx: (Math.random()-0.5)*3,
      vy: -Math.random()*4 - 1,
      life: 1, fade: 0.06 + Math.random()*0.04,
      color: ['#ffcc00','#ff6b35','#fff','#00e5ff'][Math.floor(Math.random()*4)],
      r: 1.5 + Math.random()*2
    }));
    let frame = 0;
    const animate = () => {
      if (frame++ > 25) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
      ctx.clearRect(0,0,canvas.width,canvas.height);
      sparks.forEach(s => {
        s.x += s.vx; s.y += s.vy; s.vy += 0.25; s.life -= s.fade;
        if (s.life <= 0) return;
        ctx.globalAlpha = s.life;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = s.color; ctx.fill();
      });
      ctx.globalAlpha = 1;
      requestAnimationFrame(animate);
    };
    animate();
  },

  // Show an outcome toast after a narrative choice
  outcomeToast(text, color) {
    const el = document.createElement('div');
    el.className = 'outcome-toast';
    el.style.borderTop = `3px solid ${color || '#00e5ff'}`;
    el.style.color = color || '#fff';
    el.textContent = text;
    document.body.appendChild(el);
    setTimeout(() => {
      el.style.transition = 'opacity 0.4s';
      el.style.opacity = '0';
      setTimeout(() => el.remove(), 450);
    }, 2400);
  },
};

const NarrativeEvents = {
  _cooldown: 0,
  _minInterval: 180, // seconds between narrative events
  _pendingEvent: null,

  EVENTS: [
    {
      id: 'supplier_deal',
      portrait: '🤝', tag: 'SUPPLIER VISIT', weight: 3,
      title: 'A Supplier Stops By',
      body: `A rep from <strong>FilaMaster Pro</strong> walks in, samples in hand. <em>"We're overstocked on PA6-GF,"</em> she says. <em>"I can do 60% off — but only if you commit to 3 bulk orders this week."</em>`,
      choices: [
        { label: 'Take the deal', icon: '🤝', cls: 'good',  effect: 'Take the deal — 3× bulk PA6 orders queued at 60% cost!', apply(s) { s.filDiscountJobs = (s.filDiscountJobs||0) + 9; Particles.outcomeToast('📦 Bulk deal locked in! 9 discounted PA6 jobs.', '#7fff6e'); Confetti.burst(40); } },
        { label: 'Negotiate harder', icon: '💬', cls: 'risky', effect: '50/50 chance: 80% off OR she leaves annoyed', apply(s) { if(Math.random()<0.5){ s.filDiscountJobs=(s.filDiscountJobs||0)+9; s.money=r2(s.money-20); Particles.outcomeToast('🎉 80% off negotiated! Cost €20 rep.','#ffcc00'); Confetti.burst(60); } else { s.reputation=Math.max(0,s.reputation-5); Particles.outcomeToast('😬 She walked. −5 rep.','#ff3d5a'); } } },
        { label: 'Send her away', icon: '🚪', cls: 'bad',   effect: 'Nothing happens. Miss the opportunity.', apply(s) { Particles.outcomeToast('Opportunity passed.','#666'); } },
      ]
    },
    {
      id: 'local_news',
      portrait: '📰', tag: 'PRESS MOMENT', weight: 2,
      title: 'Local Paper Wants a Story',
      body: `A journalist from <strong>TechCity Weekly</strong> emails you. They're running a piece on <em>"garage inventors changing manufacturing."</em> They want a quote — but they'll need access to your shop floor for photos.`,
      choices: [
        { label: 'Open the doors — great PR', icon: '📸', cls: 'good', effect: '+15 reputation. Your story goes live!', apply(s) { s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+15); Particles.screenBurst('#00e5ff',20); Particles.outcomeToast('📰 Article published! +15 reputation.','#00e5ff'); } },
        { label: 'Quote only — no photos', icon: '✍️', cls: 'risky', effect: '+5 rep, but the story is smaller', apply(s) { s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+5); Particles.outcomeToast('+5 rep from a brief mention.','#4fc3f7'); } },
        { label: 'Decline — stay under the radar', icon: '🔇', cls: 'bad', effect: 'Nothing. Privacy maintained.', apply(s) { Particles.outcomeToast('No story. No attention.','#666'); } },
      ]
    },
    {
      id: 'power_surge',
      portrait: '⚡', tag: 'EQUIPMENT EVENT', weight: 3,
      title: 'Power Fluctuation',
      body: `The lights flicker. A sharp <em>crack</em> from the fuse box. Your printers are running hot — if this keeps up, something will fail. The electrician wants <strong>€150</strong> to stabilise the line now, or you can try resetting the breaker yourself.`,
      choices: [
        { label: 'Pay the electrician', icon: '🔧', cls: 'good', effect: '−€150 but all printers fully healed', apply(s) { if(s.money>=150){ s.money=r2(s.money-150); s.printers.forEach(p=>p.health=100); Particles.outcomeToast('🔧 Fixed! All printers at 100% health.','#7fff6e'); } else { Particles.outcomeToast('Not enough money!','#ff3d5a'); } } },
        { label: 'Reset breaker yourself', icon: '🎲', cls: 'risky', effect: '70% success, 30% chance one printer takes damage', apply(s) { if(Math.random()<0.7){ Particles.outcomeToast('✅ Breaker reset! No damage.','#7fff6e'); } else { const p=s.printers[0]; if(p) p.health=Math.max(0,p.health-25); Particles.outcomeToast('💥 Breaker tripped! Printer −25 health.','#ff3d5a'); Particles.shake(); } } },
        { label: 'Ignore it and keep printing', icon: '🙈', cls: 'bad', effect: 'Risky. All printers lose 10 health slowly', apply(s) { s.printers.forEach(p=>p.health=Math.max(0,p.health-10)); Particles.outcomeToast('⚠️ Printers degraded. −10 health each.','#ff6b35'); } },
      ]
    },
    {
      id: 'intern_arrives',
      portrait: '🧑‍🎓', tag: 'STAFF MOMENT', weight: 2,
      title: 'An Intern Applies',
      body: `A design student shows up, portfolio under their arm. <em>"I'll work for free for two weeks,"</em> they say, <em>"in exchange for a recommendation letter."</em> They're enthusiastic but untrained. They could speed things up — or cause chaos.`,
      choices: [
        { label: 'Hire them — the energy is infectious', icon: '🎉', cls: 'good', effect: '+20% speed bonus for 10 jobs', apply(s) { if(s._internJobs>0){ Particles.outcomeToast('An intern is already working here!','#666'); return; } s.speedMult=r2((s.speedMult||1)*1.20); s._internJobs=10; Particles.outcomeToast('🧑‍🎓 Intern onboard! +20% speed for 10 jobs.','#7fff6e'); Confetti.burst(30); } },
        { label: 'Give them a trial task first', icon: '📋', cls: 'risky', effect: '60% chance: they ace it (+€80). 40%: they waste filament (−€40)', apply(s){ if(Math.random()<0.6){ s.money=r2(s.money+80); Particles.outcomeToast('🌟 Trial passed! +€80 and a great attitude.','#7fff6e'); } else { s.money=r2(s.money-40); Particles.outcomeToast('💸 Trial failed. Wasted filament. −€40.','#ff3d5a'); } } },
        { label: "Politely decline — you're too busy", icon: '🙅', cls: 'bad', effect: 'They leave. Nothing changes.', apply(s){ Particles.outcomeToast('They walked out the door.','#666'); } },
      ]
    },
    {
      id: 'competitor_offer',
      portrait: '🦊', tag: 'RIVAL ENCOUNTER', weight: 2,
      title: 'Your Rival Makes an Offer',
      body: `<strong>PrintFox Industries</strong> — your main rival — sends a message. <em>"We're interested in a merger. €500 now, but you operate under our brand for 30 days."</em> A takeover bid disguised as a partnership.`,
      choices: [
        { label: 'Take the money and fight from inside', icon: '💵', cls: 'risky', effect: '+€500 but reputation −10 (brand confusion)', apply(s){ s.money=r2(s.money+500); s.reputation=Math.max(0,s.reputation-10); Particles.moneyShower('+€500', document.getElementById('top-money')); Particles.outcomeToast('💵 Deal done. +€500 but identity costs.','#ffcc00'); } },
        { label: 'Decline and publish their offer publicly', icon: '📢', cls: 'good', effect: '+12 reputation (community respect)', apply(s){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+12); Particles.screenBurst('#00e5ff',18); Particles.outcomeToast('🏆 Community impressed! +12 rep.','#00e5ff'); } },
        { label: 'Demand more — counter at €1000', icon: '🎰', cls: 'risky', effect: '40% chance they agree (€1000). 60% they ghost you.', apply(s){ if(Math.random()<0.4){ s.money=r2(s.money+1000); Particles.moneyShower('+€1000', document.getElementById('top-money')); Confetti.burst(80); Particles.outcomeToast('🤑 They agreed! +€1000.','#7fff6e'); } else { Particles.outcomeToast('📵 They ghosted. Opportunity gone.','#666'); } } },
      ]
    },
    {
      id: 'mystery_filament',
      portrait: '🎁', tag: 'DISCOVERY', weight: 3,
      title: 'A Mystery Package Arrives',
      body: `A plain brown box sits at your door — no return address. Inside: <em>two spools of deep-purple filament</em> you've never seen before. Glows faintly. No label, no safety sheet. Could be valuable. Could be dangerous to your nozzles.`,
      choices: [
        { label: 'Print something test right now', icon: '🖨️', cls: 'risky', effect: '50/50: +€200 for a unique piece, OR clog (+printer damage)', apply(s){ if(Math.random()<0.5){ s.money=r2(s.money+200); Particles.moneyShower('+€200',document.getElementById('top-money')); Confetti.burst(50); Particles.outcomeToast('✨ Stunning results! Collectors are interested. +€200.','#a78bfa'); } else { const p=s.printers[0]; if(p) p.health=Math.max(0,p.health-20); Particles.shake(); Particles.outcomeToast('💀 Catastrophic clog. Printer −20 health.','#ff3d5a'); } } },
        { label: 'Send it to a lab for testing', icon: '🔬', cls: 'good', effect: '−€30 lab fee, but guaranteed +8 rep and filament intel', apply(s){ s.money=r2(s.money-30); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+8); Particles.outcomeToast('🔬 Lab results in! +8 rep, new intel logged.','#4fc3f7'); } },
        { label: 'Sell it as novelty on your shop', icon: '🏷️', cls: 'good', effect: '+€120 fast cash, no risk', apply(s){ s.money=r2(s.money+120); Particles.moneyShower('+€120',document.getElementById('top-money')); Particles.outcomeToast('🏷️ Sold as "mystery art spool"! +€120.','#7fff6e'); } },
      ]
    },
    {
      id: 'charity_request',
      portrait: '❤️', tag: 'COMMUNITY', weight: 2,
      title: 'Local Charity Needs Help',
      body: `A children's hospital contacts you. They need <strong>prosthetic hand components</strong> — 3D printed, ASAP. They can't pay market rate. They're offering <em>€40 and public recognition</em> for a job that would normally pay €180.`,
      choices: [
        { label: 'Do it for free — pay it forward', icon: '❤️', cls: 'good', effect: '+20 reputation, +30 XP, feel great', apply(s){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+20); s.xp+=30; Particles.screenBurst('#ff3d5a',22); Confetti.burst(60); Particles.outcomeToast('❤️ The community loves you! +20 rep.','#ff3d5a'); } },
        { label: 'Accept their €40 offer', icon: '🤝', cls: 'risky', effect: '+€40, +10 rep', apply(s){ s.money=r2(s.money+40); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+10); Particles.outcomeToast('🤝 Done! +€40, +10 rep.','#7fff6e'); } },
        { label: 'Decline — margins matter', icon: '💼', cls: 'bad', effect: '−5 rep (word gets out)', apply(s){ s.reputation=Math.max(0,s.reputation-5); Particles.outcomeToast('🗞️ Word got out. −5 rep.','#ff6b35'); } },
      ]
    },
    {
      id: 'equipment_upgrade',
      portrait: '⚙️', tag: 'TECH MOMENT', weight: 2,
      title: 'Someone Offers a Used Part',
      body: `A retired engineer shows up with a <strong>barely-used dual-zone heated bed</strong> in his van. Asking €90. He claims it'll reduce warping failures by 40%. No receipt, no warranty. Cash only.`,
      choices: [
        { label: 'Buy it and install immediately', icon: '🔧', cls: 'good', effect: '−€90, warping failures reduced by 40% permanently', apply(s){ if(s._equipUpgradeDone){ Particles.outcomeToast('Already installed a similar upgrade!','#666'); return; } if(s.money>=90){ s.money=r2(s.money-90); s.failBonus=r2((s.failBonus||0)-0.40); s._equipUpgradeDone=true; Particles.outcomeToast('⚙️ Installed! Warp failures −40%.','#7fff6e'); Confetti.burst(30); } else { Particles.outcomeToast('Not enough cash!','#ff3d5a'); } } },
        { label: 'Haggle to €50', icon: '💬', cls: 'risky', effect: '60% he accepts, 40% he sells it to someone else', apply(s){ if(s._equipUpgradeDone){ Particles.outcomeToast('Already installed a similar upgrade!','#666'); return; } if(Math.random()<0.6){ if(s.money>=50){ s.money=r2(s.money-50); s.failBonus=r2((s.failBonus||0)-0.40); s._equipUpgradeDone=true; Particles.outcomeToast('🤜 Haggled to €50 and installed!','#7fff6e'); } else { Particles.outcomeToast('Not enough even at €50!','#ff3d5a'); } } else { Particles.outcomeToast('He drove off. Someone else got it.','#666'); } } },
        { label: 'Pass — no receipt is sketchy', icon: '🚶', cls: 'bad', effect: 'Nothing. Save the cash.', apply(s){ Particles.outcomeToast('Passed. Cash saved.','#666'); } },
      ]
    },
  ],

  tick(dt) {
    if (this._cooldown > 0) { this._cooldown -= dt; return; }
    // Only trigger if no popup is open, no crisis active, game is running
    const overlay = document.getElementById('narrative-overlay');
    if (overlay?.classList.contains('active')) return;
    if (document.getElementById('popup-overlay')?.classList.contains('visible')) return;
    if (State.activeCrisis) return;
    if (State.stats.jobsDone < 3) return; // Don't fire too early

    // Weighted random pick
    if (Math.random() < 0.004 * dt) { // ~once every 250 ticks
      this._trigger();
    }
  },

  _trigger() {
    const totalWeight = this.EVENTS.reduce((s,e) => s + (e.weight||1), 0);
    let rnd = Math.random() * totalWeight;
    let evt = null;
    for (const e of this.EVENTS) {
      rnd -= (e.weight||1);
      if (rnd <= 0) { evt = e; break; }
    }
    if (!evt) evt = this.EVENTS[0];
    this._show(evt);
  },

  _show(evt) {
    this._pendingEvent = evt;
    document.getElementById('narrative-portrait').textContent = evt.portrait;
    document.getElementById('narrative-tag').textContent = evt.tag;
    document.getElementById('narrative-title').textContent = evt.title;
    document.getElementById('narrative-body').innerHTML = evt.body;

    const choicesEl = document.getElementById('narrative-choices');
    choicesEl.innerHTML = evt.choices.map((c,i) => `
      <button class="narrative-btn ${c.cls}" onclick="NarrativeEvents.choose(${i})">
        <div class="narrative-btn-icon">${c.icon}</div>
        <div class="narrative-btn-text">
          <div class="narrative-btn-label">${c.label}</div>
          <div class="narrative-btn-effect">${c.effect}</div>
        </div>
      </button>
    `).join('');

    const overlay = document.getElementById('narrative-overlay');
    overlay.classList.add('active');
    Sound.click();
    this._cooldown = this._minInterval;
  },

  choose(idx) {
    const evt = this._pendingEvent;
    if (!evt) return;
    const choice = evt.choices[idx];
    if (!choice) return;
    this.dismiss();
    setTimeout(() => {
      try { choice.apply(State); } catch(e) { console.warn('Narrative apply error:', e); }
      UI.updateTopBar(); UI.renderPrinters();
    }, 300);
  },

  dismiss() {
    document.getElementById('narrative-overlay').classList.remove('active');
    this._pendingEvent = null;
  },
};

const PrintCanvas = {
  _raf: null,
  _headX: 0.5,
  _headDir: 1,
  _time: 0,
  _sparks: [],
  _sparkT: 0,

  // Product shape library – polygons in 0-1 space (x,y), origin = bottom-center
  SHAPES: {
    vase:      [[.5,.00],[.7,.10],[.75,.25],[.7,.50],[.8,.70],[.75,.90],[.6,.98],[.4,.98],[.25,.90],[.2,.70],[.3,.50],[.25,.25],[.3,.10]],
    bracket:   [[.5,.00],[.7,.00],[.7,.40],[.8,.40],[.8,.55],[.2,.55],[.2,.40],[.3,.40],[.3,.00]],
    gear:      [[.5,.00],[.58,.05],[.62,.12],[.75,.12],[.75,.20],[.62,.20],[.65,.30],[.75,.32],[.75,.40],[.65,.38],[.65,.50],[.75,.55],[.72,.63],[.62,.58],[.55,.68],[.58,.78],[.50,.82],[.42,.78],[.45,.68],[.38,.58],[.28,.63],[.25,.55],[.35,.50],[.35,.38],[.25,.40],[.25,.32],[.35,.30],[.38,.20],[.25,.20],[.25,.12],[.38,.12],[.42,.05]],
    figurine:  [[.5,.00],[.55,.06],[.60,.15],[.58,.24],[.50,.26],[.42,.24],[.40,.15],[.45,.06],  [.38,.26],[.34,.44],[.30,.60],[.26,.76],[.31,.78],[.38,.62],[.43,.50],[.43,.80],[.41,.98],[.48,.98],[.50,.82],[.52,.98],[.59,.98],[.57,.80],[.57,.50],[.62,.62],[.69,.78],[.74,.76],[.70,.60],[.66,.44],[.62,.26]],
    cube:      [[.3,.00],[.7,.00],[.7,.85],[.3,.85]],
    arch:      [[.25,.00],[.25,.50],[.29,.66],[.38,.78],[.50,.83],[.62,.78],[.71,.66],[.75,.50],[.75,.00]],
    rocket:    [[.5,.00],[.6,.15],[.65,.35],[.65,.70],[.58,.78],[.58,.92],[.62,.95],[.62,.98],[.38,.98],[.38,.95],[.42,.92],[.42,.78],[.35,.70],[.35,.35],[.40,.15]],
    organic:   [[.5,.00],[.65,.08],[.78,.22],[.82,.40],[.78,.58],[.68,.72],[.56,.82],[.5,.85],[.44,.82],[.32,.72],[.22,.58],[.18,.40],[.22,.22],[.35,.08]],
  },

  // Map filament + order type → shape + color
  _getConfig(job) {
    const type = job?.orderType || 'normal';
    const fil  = job?.filament  || 'PLA';
    const name = (job?.name || '').toLowerCase();

    let shapeName = 'cube';
    if (name.includes('vase') || name.includes('pot') || name.includes('cup'))     shapeName = 'vase';
    else if (name.includes('gear') || name.includes('cogwheel'))                   shapeName = 'gear';
    else if (name.includes('figur') || name.includes('statue'))                    shapeName = 'figurine';
    else if (name.includes('rocket') || name.includes('raket') || name.includes('tower')) shapeName = 'rocket';
    else if (name.includes('arch') || name.includes('boog') || name.includes('ring')) shapeName = 'arch';
    else if (type === 'vip' || type === 'legendary') shapeName = 'organic';
    else if (type === 'rush' || type === 'bulk')     shapeName = 'bracket';
    else if (fil === 'RESIN')                        shapeName = 'figurine';
    else if (fil === 'TPU')                         shapeName = 'arch';
    else if (fil === 'GLOW')                        shapeName = 'organic';
    else {
      // Hash job name to pick shape
      const h = [...(job?.name||'abc')].reduce((a,c)=>a+c.charCodeAt(0),0);
      const keys = Object.keys(this.SHAPES);
      shapeName = keys[h % keys.length];
    }

    const filColors = {
      PLA:   { fill:'#4fc3f7', glow:'rgba(79,195,247,0.4)',  top:'#80d8f5', layer:'rgba(79,195,247,0.15)' },
      PETG:  { fill:'#ce93d8', glow:'rgba(206,147,216,0.4)', top:'#e0b3e8', layer:'rgba(206,147,216,0.12)' },
      PA6:   { fill:'#ffab40', glow:'rgba(255,171,64,0.4)',  top:'#ffc170', layer:'rgba(255,171,64,0.12)' },
      TPU:   { fill:'#ff9f43', glow:'rgba(255,159,67,0.4)',  top:'#ffbe70', layer:'rgba(255,159,67,0.12)' },
      RESIN: { fill:'#ee5a24', glow:'rgba(238,90,36,0.4)',   top:'#f07050', layer:'rgba(238,90,36,0.12)' },
      CF:    { fill:'#636e72', glow:'rgba(99,110,114,0.4)',  top:'#95a5a6', layer:'rgba(99,110,114,0.12)' },
      GLOW:  { fill:'#00e5ff', glow:'rgba(0,229,255,0.5)',   top:'#60ffff', layer:'rgba(0,229,255,0.12)' },
    };

    return { shapeName, shape: this.SHAPES[shapeName], colors: filColors[fil] || filColors.PLA };
  },

  // Draw the isometric-like 3D product on canvas
  draw(progress, job, printing) {
    const canvas = document.getElementById('print-canvas'); if (!canvas) return;
    const wrap   = document.getElementById('product-canvas-wrap');
    if (!wrap) return;

    const dpr = window.devicePixelRatio || 1;
    const W   = wrap.offsetWidth || 300;
    const H   = wrap.offsetHeight || 240;
    canvas.width  = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width  = W + 'px';
    canvas.style.height = H + 'px';

    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, W, H);

// Subtle ambient pass (depth + vignette)
ctx.save();
const bg = ctx.createLinearGradient(0, 0, 0, H);
bg.addColorStop(0, 'rgba(0,0,0,0.25)');
bg.addColorStop(0.55, 'rgba(0,0,0,0)');
bg.addColorStop(1, 'rgba(0,0,0,0.35)');
ctx.fillStyle = bg;
ctx.fillRect(0, 0, W, H);

const vig = ctx.createRadialGradient(W*0.5, H*0.45, Math.min(W,H)*0.25, W*0.5, H*0.45, Math.max(W,H)*0.75);
vig.addColorStop(0, 'rgba(0,0,0,0)');
vig.addColorStop(1, 'rgba(0,0,0,0.55)');
ctx.fillStyle = vig;
ctx.fillRect(0, 0, W, H);
ctx.restore();

    // ── Background grid ──
    this._drawGrid(ctx, W, H);

    // ── Printer frame ──
    this._drawFrame(ctx, W, H, printing);

    if (!job || !printing) {
      this._drawIdleState(ctx, W, H);
      return;
    }

    const cfg = this._getConfig(job);
    this._time += 0.016;

    // ── Moving head ──
    if (printing) {
      this._headX += this._headDir * 0.012;
      if (this._headX > 0.85 || this._headX < 0.15) this._headDir *= -1;
    }

    // ── Draw product ──
    this._drawProduct(ctx, W, H, progress, cfg, printing);

    // ── Draw carriage & nozzle ──
    this._drawHead(ctx, W, H, this._headX, progress, cfg, printing);

    // ── Sparks (canvas-native, subtle) ──
    if (printing && progress > 0.02) {
      this._sparkT += 1;
      // Spawn more when nearing completion for extra hype
      const intensity = progress > 0.85 ? 1.4 : 1;
      if (Math.random() < 0.10) this._spawnHeadSparks(W, H, this._headX, intensity);
    }
    this._drawSparks(ctx);
  },

  _drawGrid(ctx, W, H) {
    ctx.save();
    ctx.strokeStyle = 'rgba(0,229,255,0.04)';
    ctx.lineWidth = 1;
    const step = 30;
    for (let x = 0; x < W; x += step) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
    for (let y = 0; y < H; y += step) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }
// Diagonal iso hints (very subtle)
ctx.strokeStyle = 'rgba(0,229,255,0.025)';
for (let x = -H; x < W + H; x += step) {
  ctx.beginPath(); ctx.moveTo(x, H); ctx.lineTo(x + H, 0); ctx.stroke();
}

    ctx.restore();
  },

  _drawFrame(ctx, W, H, printing) {
    const padL = 20, padR = 20, barH = H * 0.88, topY = H * 0.06;
    const accentAlpha = printing ? 0.7 : 0.3;
    const accent = `rgba(0,229,255,${accentAlpha})`;

    ctx.save();
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#1e2535';
    ctx.fillStyle = '#141922';

    // Left rail
    this._roundRect(ctx, padL, topY, 8, barH - topY, 4, '#141922', '#1e2535');
    // Right rail
    this._roundRect(ctx, W - padR - 8, topY, 8, barH - topY, 4, '#141922', '#1e2535');
    // Top crossbar
    this._roundRect(ctx, padL, topY, W - padL - padR, 10, 4, '#141922', '#1e2535');
    // Build plate
    this._roundRect(ctx, padL + 4, barH - 10, W - padL - padR - 8, 12, 3, '#1a2233', accent);

    // Corner accents
    ctx.beginPath(); ctx.arc(padL + 4, topY + 5, 5, 0, Math.PI * 2);
    ctx.fillStyle = accent; ctx.fill();
    ctx.beginPath(); ctx.arc(W - padR - 4, topY + 5, 5, 0, Math.PI * 2);
    ctx.fill();

    // X-axis rod
    ctx.beginPath();
    ctx.moveTo(padL + 12, topY + 36);
    ctx.lineTo(W - padR - 12, topY + 36);
    ctx.strokeStyle = 'rgba(0,229,255,0.15)'; ctx.lineWidth = 2; ctx.stroke();

    // Grid on build plate
    const plateY = barH - 8;
    const plateL = padL + 8, plateR = W - padR - 8;
    ctx.strokeStyle = 'rgba(0,229,255,0.08)'; ctx.lineWidth = 0.5;
    for (let x = plateL; x < plateR; x += 20) {
      ctx.beginPath(); ctx.moveTo(x, plateY - 4); ctx.lineTo(x, plateY + 4); ctx.stroke();
    }

    ctx.restore();
  },

  _drawProduct(ctx, W, H, progress, cfg, printing) {
    if (progress <= 0.005) return;
    const { shape, colors } = cfg;

    const plateY   = H * 0.88 - 10;
    const maxHeight = H * 0.62;
    const printedH  = maxHeight * progress;

    // Find shape bounds
    const minX = Math.min(...shape.map(p=>p[0]));
    const maxX = Math.max(...shape.map(p=>p[0]));
    const minY = Math.min(...shape.map(p=>p[1]));
    const maxY = Math.max(...shape.map(p=>p[1]));
    const shapeAspect = (maxY - minY) / (maxX - minX);

    const availW = W * 0.55;
    const shapeW = availW;
    const shapeH = shapeW * shapeAspect;

    const oX = (W - shapeW) / 2;
    const oY = plateY;

// Soft contact shadow on the build plate (makes the object feel grounded)
ctx.save();
const shW = shapeW * 0.70;
const shH = Math.max(10, shapeW * 0.10);
const shX = W/2;
const shY = oY - 2;
const sh = ctx.createRadialGradient(shX, shY, 2, shX, shY, shW/2);
sh.addColorStop(0, 'rgba(0,0,0,0.45)');
sh.addColorStop(1, 'rgba(0,0,0,0)');
ctx.fillStyle = sh;
ctx.beginPath();
ctx.ellipse(shX, shY, shW/2, shH/2, 0, 0, Math.PI*2);
ctx.fill();
ctx.restore();

    // Clip to printed height
    ctx.save();
    ctx.beginPath();
    ctx.rect(0, oY - printedH, W, printedH + 10);
    ctx.clip();

    // Shape in screen coords
    const toScreen = ([sx, sy]) => [
      oX + (sx - minX) / (maxX - minX) * shapeW,
      oY - (sy - minY) / (maxY - minY) * shapeH
    ];
    const pts = shape.map(toScreen);

    // Layer lines (horizontal stripes inside the shape)
    const layerSpacing = 6;
    for (let ly = oY; ly > oY - printedH; ly -= layerSpacing) {
      ctx.save();
      ctx.beginPath();
      pts.forEach(([x,y], i) => i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y));
      ctx.closePath();
      ctx.clip();

      const fade = 1 - (oY - ly) / (printedH + 1);
      ctx.fillStyle = `rgba(0,0,0,${0.06 * fade})`;
      ctx.fillRect(0, ly, W, layerSpacing - 1);
      ctx.restore();
    }

    // Main product fill
    ctx.beginPath();
    pts.forEach(([x,y], i) => i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y));
    ctx.closePath();

    const grad = ctx.createLinearGradient(oX, oY, oX + shapeW * 0.6, oY - printedH);
    grad.addColorStop(0,   colors.fill);
    grad.addColorStop(0.4, colors.fill);
    grad.addColorStop(1,   colors.top);
    ctx.fillStyle = grad;
    ctx.globalAlpha = 0.82;
    ctx.fill();
    ctx.globalAlpha = 1;

    // Outline
    ctx.strokeStyle = colors.glow;
    ctx.lineWidth = 1.5;
    ctx.stroke();

// Rim highlight (thin, bright edge) for a more premium 3D feel
ctx.save();
ctx.globalCompositeOperation = 'lighter';
ctx.strokeStyle = 'rgba(255,255,255,0.18)';
ctx.lineWidth = 1;
ctx.stroke();
ctx.restore();

    ctx.restore();

    // Top layer glow (current print line)
    const topY2 = oY - printedH;
    ctx.save();
    ctx.beginPath();
    pts.forEach(([x,y], i) => i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y));
    ctx.closePath();
    ctx.clip();

    const topGrad = ctx.createLinearGradient(0, topY2 - 8, 0, topY2 + 4);
    topGrad.addColorStop(0,   'rgba(255,255,255,0)');
    topGrad.addColorStop(0.5, colors.glow.replace(/,[\d.]+\)$/, ',0.6)'));
    topGrad.addColorStop(1,   colors.top);
    ctx.fillStyle = topGrad;
    ctx.fillRect(0, topY2 - 8, W, 12);
    ctx.restore();

    // Ambient glow below shape
    ctx.save();
    const grd = ctx.createRadialGradient(W/2, oY + 2, 2, W/2, oY + 2, shapeW * 0.4);
    grd.addColorStop(0, colors.glow);
    grd.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grd;
    ctx.globalAlpha = 0.3;
    ctx.fillRect(0, oY - 6, W, 14);
    ctx.globalAlpha = 1;
    ctx.restore();
  },

_spawnHeadSparks(W, H, headX, intensity = 1) {
  // Lightweight sparks around hotend tip (canvas-native)
  const nozzleY = (H * 0.06) + 36 + 8; // rodY + 8 in _drawHead
  const tipX = headX;
  const n = Math.floor(2 + Math.random() * 3 * intensity);
  for (let i = 0; i < n; i++) {
    this._sparks.push({
      x: tipX + (Math.random()-0.5)*6,
      y: nozzleY + (Math.random()-0.5)*4,
      vx:(Math.random()-0.5)*2.2,
      vy:-Math.random()*2.8 - 0.8,
      life: 1,
      fade: 0.06 + Math.random()*0.05,
      r: 0.8 + Math.random()*1.8,
      hue: Math.random() < 0.7 ? 'rgba(255,204,0,' : 'rgba(255,107,53,'
    });
  }
},

_drawSparks(ctx) {
  if (!this._sparks.length) return;
  ctx.save();
  ctx.globalCompositeOperation = 'lighter';
  for (let i = this._sparks.length - 1; i >= 0; i--) {
    const s = this._sparks[i];
    s.x += s.vx;
    s.y += s.vy;
    s.vy += 0.20;
    s.life -= s.fade;
    if (s.life <= 0) { this._sparks.splice(i, 1); continue; }
    ctx.globalAlpha = s.life;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fillStyle = s.hue + (0.55 + s.life*0.35) + ')';
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  ctx.restore();
},
  _drawHead(ctx, W, H, headX, progress, cfg, printing) {
    const topY = H * 0.06;
    const rodY = topY + 36;
    const hX   = 28 + headX * (W - 56);

    const plateY   = H * 0.88 - 10;
    const maxHeight = H * 0.62;
    const productTopY = plateY - maxHeight * progress;
    const nozzleY   = rodY + 28;

    ctx.save();

    // Carriage body
    this._roundRect(ctx, hX - 18, rodY - 12, 36, 18, 4,
      '#1a2540', 'rgba(0,229,255,0.7)');

    // Hotend
    this._roundRect(ctx, hX - 5, rodY + 6, 10, 14, 2, '#242e44', 'rgba(0,229,255,0.4)');

    // Nozzle tip
    ctx.beginPath();
    ctx.moveTo(hX - 5, nozzleY);
    ctx.lineTo(hX + 5, nozzleY);
    ctx.lineTo(hX + 3, nozzleY + 8);
    ctx.lineTo(hX - 3, nozzleY + 8);
    ctx.closePath();
    ctx.fillStyle = '#ff6b35';
    ctx.fill();

    if (printing) {
      // Nozzle glow
      const glowR = 10 + Math.sin(this._time * 6) * 3;
      const ng = ctx.createRadialGradient(hX, nozzleY + 8, 0, hX, nozzleY + 8, glowR);
      ng.addColorStop(0,   'rgba(255,107,53,0.7)');
      ng.addColorStop(0.5, 'rgba(255,107,53,0.2)');
      ng.addColorStop(1,   'rgba(255,107,53,0)');
      ctx.fillStyle = ng; ctx.beginPath();
      ctx.arc(hX, nozzleY + 8, glowR, 0, Math.PI * 2); ctx.fill();

      // Filament strand from nozzle to product top
      if (progress > 0.01) {
        const strandY = Math.max(nozzleY + 8, productTopY);
        ctx.beginPath();
        ctx.moveTo(hX, nozzleY + 8);
        // Slight wobble
        const wobble = Math.sin(this._time * 12) * 2;
        ctx.lineTo(hX + wobble, strandY);
        const strandColor = cfg?.colors?.fill || '#ff6b35';
        const sg = ctx.createLinearGradient(0, nozzleY + 8, 0, strandY);
        sg.addColorStop(0, '#ff6b35');
        sg.addColorStop(1, strandColor);
        ctx.strokeStyle = sg;
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.stroke();
      }

      // Fan (rotating indicator)
      const fanAngle = this._time * 8;
      for (let i = 0; i < 4; i++) {
        const a = fanAngle + (Math.PI / 2) * i;
        ctx.save();
        ctx.translate(hX - 12, rodY - 6);
        ctx.rotate(a);
        ctx.beginPath();
        ctx.moveTo(0, 0); ctx.lineTo(0, -4);
        ctx.strokeStyle = 'rgba(0,229,255,0.5)';
        ctx.lineWidth = 1.2;
        ctx.stroke();
        ctx.restore();
      }
    }

    ctx.restore();
  },

  _drawIdleState(ctx, W, H) {
    ctx.save();
    ctx.font = 'bold 11px system-ui';
    ctx.fillStyle = 'rgba(0,229,255,0.3)';
    ctx.textAlign = 'center';
    ctx.fillText('— PRINTER GEREED —', W/2, H/2);
    ctx.font = '10px system-ui';
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.fillText('Selecteer een order uit de lijst →', W/2, H/2 + 20);
    ctx.restore();
  },

  _roundRect(ctx, x, y, w, h, r, fill, stroke) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.arcTo(x + w, y, x + w, y + r, r);
    ctx.lineTo(x + w, y + h - r);
    ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
    ctx.lineTo(x + r, y + h);
    ctx.arcTo(x, y + h, x, y + h - r, r);
    ctx.lineTo(x, y + r);
    ctx.arcTo(x, y, x + r, y, r);
    ctx.closePath();
    if (fill) { ctx.fillStyle = fill; ctx.fill(); }
    if (stroke) { ctx.strokeStyle = stroke; ctx.lineWidth = 1.5; ctx.stroke(); }
  },

  // Start live animation loop
  startLoop(getPrinter, getJob) {
    if (this._raf) cancelAnimationFrame(this._raf);
    const tick = () => {
      const p = getPrinter();
      const j = getJob();
      if (p && j) {
        this.draw(p.progress || 0, j, p.active);
      } else {
        this.draw(0, null, false);
      }
      this._raf = requestAnimationFrame(tick);
    };
    tick();
  },

  stopLoop() {
    if (this._raf) { cancelAnimationFrame(this._raf); this._raf = null; }
  },

  reset() {
    this._headX = 0.5; this._headDir = 1; this._time = 0;
    this.draw(0, null, false);
  },
};
const Temperature = {
  IDLE_TEMP: 25,
  PRINT_TEMP: 85,
  OVERHEAT: 95,

  tick(dt) {
    if (!State.printerTemps) State.printerTemps = {};
    State.printers.forEach((p, idx) => {
      const cur = State.printerTemps[idx] ?? 25;
      let target = p.active ? this.PRINT_TEMP : this.IDLE_TEMP;
      // Speed specialty = hotter printer
      if (Specialization.get(idx) === 'speed') target += 8;
      const delta = (target - cur) * 0.1 * dt;
      State.printerTemps[idx] = Math.max(0, Math.min(100, cur + delta));
      // Overheat: increase fail chance slightly
      if (State.printerTemps[idx] > this.OVERHEAT && p.active) {
        if (Math.random() < 0.002 * dt) {
          UI.log(`🌡️ Printer #${idx+1} oververhit! Verhoogde faalkans.`, 'warn');
        }
      }
    });
  },

  getColor(temp) {
    if (temp > 90) return 'var(--danger)';
    if (temp > 70) return 'var(--warn)';
    if (temp > 40) return 'var(--accent3)';
    return 'var(--accent)';
  },

  getLabel(temp) {
    if (temp > 90) return '🔴 OVERVERHIT';
    if (temp > 70) return '🟠 Heet';
    if (temp > 40) return '🟢 Warm';
    return '🔵 Koud';
  },
};

// ── NIEUWS TICKER ────────────────────────────────────────────
const NewsTicker = {
  ITEMS: [
    '📈 3D-printmarkt groeit met 24% dit jaar!',
    '🧲 TPU flexibel filament: perfect voor beugels en casings',
    '🔮 Resin SLA printers: ongekend detailniveau voor miniaturen',
    '🏭 LocalPrint NL heeft TPU en Resin op voorraad!',
    '💡 Tip: PA6-GF is ideaal voor industriële onderdelen',
    '⚠️ Marktcrises kunnen filamentprijzen tijdelijk verdubbelen!',
    '🔥 Combo-systeem actief — druk snel achter elkaar!',
    '⭐ VIP klanten geven tot +30% loyaliteitsbonus!',
    '📋 Contracts voor grote beloningen — check het contractbord',
    '🎯 Dagelijkse doelen geven gratis geld — niet vergeten!',
    '🔧 Regelmatig repareren verlaagt je faalkansen significant',
    '🌡️ Printer temperatuur beïnvloedt prestaties',
    '🏆 Wekelijkse challenges voor exclusieve beloningen!',
    '📦 Koop filament bij leveranciers voor betere prijzen',
    '🧲 Direct Drive upgrade maakt TPU prints mogelijk',
    '🔮 SLA Resin Printer voor ultra-gedetailleerde prints',
    '🤖 Watch out! PrintBot is stealing your orders — be faster!',
    '🔥 Demand Surges can pay huge bonuses — watch for them!',
    '💳 Need cash fast? Take a loan — but pay it back before interest spirals!',
    '⚡ Power outages will hit Level 4+ — buy the UPS to stay safe!',
    '🔴 PA6 and Resin can clog mid-print — be ready to smash!',
  ],

  init() {
    const inner = $el('ticker-inner');
    if (!inner) return;
    // Duplicate for seamless loop
    const all = [...this.ITEMS, ...this.ITEMS];
    inner.innerHTML = all.map(t => `<span class="ticker-item">${t}</span>`).join('');
  },

  addItem(text) {
    const inner = $el('ticker-inner');
    if (!inner) return;
    const span = document.createElement('span');
    span.className = 'ticker-item';
    span.textContent = text;
    inner.appendChild(span);
    inner.appendChild(span.cloneNode(true)); // duplicate for loop
  },
};

// ── EINDSPEL CHECK ───────────────────────────────────────────
const Endgame = {
  check() {
    if (State.prestige >= 3 && !State._printGodActive) {
      State._printGodActive = true;
      State.rewardMult *= 1.5;
      Confetti.burst(120);
      UI.showPopup('🌟 PRINT GOD ONTGRENDELD!',
        `<div class="printgod-banner"><div class="printgod-title">⚡ PRINT GOD ⚡</div><div class="printgod-desc">Na 3 prestiges heb jij de ultieme meesterprinter bewezen.<br><br>+50% permanente beloningsbonus · Exclusieve Print God badge · Je naam in de eeuwige leaderboard.<br><br>Gefeliciteerd!</div></div>`);
      UI.log('🌟 PRINT GOD MODUS ACTIEF! +50% permanente bonus!', 'success');
      NewsTicker.addItem('🌟 PRINT GOD ONTGRENDELD! De beste printer ter wereld is actief!');
    }
  },
};

// ── v7: LEVERANCIERS SYSTEEM ─────────────────────────────────
const Suppliers = {
  // Current live prices (fluctuate over time)
  _prices: {},

  init() {
    CONFIG.SUPPLIERS.forEach(s => {
      this._prices[s.id] = { ...s.basePrice };
    });
    if (!State.supplierRelations) State.supplierRelations = {};
    if (!State.supplierOrderCount) State.supplierOrderCount = {};
    CONFIG.SUPPLIERS.forEach(s => {
      if (State.supplierRelations[s.id] === undefined) State.supplierRelations[s.id] = 0;
      if (State.supplierOrderCount[s.id] === undefined) State.supplierOrderCount[s.id] = 0;
    });
  },

  fluctuate() {
    CONFIG.SUPPLIERS.forEach(s => {
      Object.keys(this._prices[s.id]).forEach(fil => {
        const base = s.basePrice[fil];
        const delta = (Math.random() - 0.48) * 0.3 * base;
        this._prices[s.id][fil] = Math.max(base * 0.6, Math.min(base * 2.0, this._prices[s.id][fil] + delta));
        this._prices[s.id][fil] = r2(this._prices[s.id][fil] );
      });
    });
    this.render();
  },

  getPrice(supplierId, filament) {
    const s = CONFIG.SUPPLIERS.find(s => s.id === supplierId);
    if (!s) return 999;
    let price = this._prices[supplierId]?.[filament] ?? s.basePrice[filament] ?? 999;
    // Apply relation discount
    const rel = State.supplierRelations[supplierId] || 0;
    if (rel >= 2) price *= (1 - s.discount.trusted);
    else if (rel >= 1) price *= (1 - s.discount.preferred);
    // Bulk deal upgrade
    if (State.bulkDealActive) price *= 0.80;
    // Crisis markup
    if (State.activeCrisis) {
      const crisis = State.activeCrisis;
      if (crisis.affected === filament || crisis.affected === 'ALL') price *= crisis.priceMult;
    }
    return r2(price );
  },

  order(supplierId, filament, qty) {
    const price = this.getPrice(supplierId, filament);
    const total = price * qty;
    if (State.money < total) {
      UI.showPopup('Te weinig geld', `Bestelling kost €${total.toFixed(2)}.`);
      return;
    }
    const fil = CONFIG.FILAMENTS[filament];
    if (!fil) return;
    // Check unlock requirements
    if (filament === 'TPU' && !State.tpuUnlocked) {
      UI.showPopup('TPU Vergrendeld', 'Koop "Direct Drive" upgrade om TPU te ontgrendelen.'); return;
    }
    if (filament === 'RESIN' && !State.resinUnlocked) {
      UI.showPopup('Resin Vergrendeld', 'Koop "SLA Resin Printer" om Resin te ontgrendelen.'); return;
    }
    if (filament === 'CF' && !State.cfUnlocked) {
      UI.showPopup('Carbon Fiber Vergrendeld', 'Koop "CF Nozzle + Enclosure" upgrade om CF te ontgrendelen.'); return;
    }
    if (filament === 'GLOW' && !State.glowUnlocked) {
      UI.showPopup('Glow Vergrendeld', 'Koop "Glow-in-the-Dark Filament" upgrade om GLOW te ontgrendelen.'); return;
    }

    State.money = r2(State.money - total);
    State.filamentStock[filament] = (State.filamentStock[filament] || 0) + qty;

    // Build relation
    State.supplierOrderCount[supplierId] = (State.supplierOrderCount[supplierId] || 0) + 1;
    const orders = State.supplierOrderCount[supplierId];
    const oldRel = State.supplierRelations[supplierId] || 0;
    if (orders >= 10 && oldRel < 2) { State.supplierRelations[supplierId] = 2; UI.log(`⭐ Vertrouwde relatie met ${CONFIG.SUPPLIERS.find(s=>s.id===supplierId)?.name}!`, 'success'); }
    else if (orders >= 4 && oldRel < 1) { State.supplierRelations[supplierId] = 1; UI.log(`✅ Preferred leverancier: ${CONFIG.SUPPLIERS.find(s=>s.id===supplierId)?.name}`, 'info'); }

    Sound.click();
    UI.log(`📦 ${qty}× ${filament} besteld bij ${supplierId} — €${total.toFixed(2)}`, 'info');
    this.updateStockUI();
    this.render();
    UI.updateTopBar();
  },

  useStock(filament, amount) {
    const current = State.filamentStock[filament] || 0;
    State.filamentStock[filament] = Math.max(0, current - amount);
    this.updateStockUI();
    // Warn if low
    if (State.filamentStock[filament] < 10 && State.filamentStock[filament] > 0) {
      UI.log(`⚠️ ${filament} voorraad laag: ${State.filamentStock[filament]} eenheden!`, 'warn');
    } else if (State.filamentStock[filament] === 0) {
      UI.log(`❌ ${filament} voorraad LEEG! Bestel bij een leverancier.`, 'error');
    }
  },

  hasStock(filament, amount = 1) {
    return (State.filamentStock[filament] || 0) >= amount;
  },

  updateStockUI() {
    ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'].forEach(fil => {
      const val = State.filamentStock[fil] || 0;
      const el = document.getElementById(`sval-${fil.toLowerCase()}`);
      const pill = document.getElementById(`stock-${fil.toLowerCase()}`);
      if (!el || !pill) return;
      if (fil === 'TPU' && !State.tpuUnlocked) { el.textContent = '—'; pill.className='stock-pill'; return; }
      if (fil === 'RESIN' && !State.resinUnlocked) { el.textContent = '—'; pill.className='stock-pill'; return; }
      if (fil === 'CF' && !State.cfUnlocked) { el.textContent = '—'; pill.className='stock-pill'; return; }
      if (fil === 'GLOW' && !State.glowUnlocked) { el.textContent = '—'; pill.className='stock-pill'; return; }
      el.textContent = val;
      pill.className = val <= 0 ? 'stock-pill low stock-critical' : val < 20 ? 'stock-pill low' : val < 50 ? 'stock-pill mid' : 'stock-pill high';
    });
  },

  // Auto-buy for Pro Supplier AI
  autoAI() {
    if (!State.supplierAI) return;
    // v17.3 fix: also auto-order unlocked advanced filaments
    const filsToCheck = ['PLA','PETG','PA6'];
    if (State.tpuUnlocked)   filsToCheck.push('TPU');
    if (State.resinUnlocked) filsToCheck.push('RESIN');
    if (State.cfUnlocked)    filsToCheck.push('CF');
    if (State.glowUnlocked)  filsToCheck.push('GLOW');
    filsToCheck.forEach(fil => {
      if ((State.filamentStock[fil] || 0) < 15) {
        // Find cheapest supplier
        const cheapest = CONFIG.SUPPLIERS.reduce((best, s) => {
          const p = this.getPrice(s.id, fil);
          return p < this.getPrice(best.id, fil) ? s : best;
        }, CONFIG.SUPPLIERS[0]);
        const canAfford = State.money >= this.getPrice(cheapest.id, fil) * 20;
        if (canAfford) this.order(cheapest.id, fil, 20);
      }
    });
  },

  render() {
    const el = document.getElementById('supplier-list'); if (!el) return;
    el.innerHTML = '';
    CONFIG.SUPPLIERS.forEach(s => {
      const rel = State.supplierRelations[s.id] || 0;
      const relClass = rel >= 2 ? 'trusted' : rel >= 1 ? 'preferred' : '';
      const relLabel = rel >= 2 ? '<span class="supplier-rel-trusted supplier-relation">⭐ Trusted</span>' : rel >= 1 ? '<span class="supplier-rel-preferred supplier-relation">✅ Preferred</span>' : '<span class="supplier-rel-neutral supplier-relation">Nieuw</span>';
      const ordersLeft = rel < 1 ? `${Math.max(0, 4 - (State.supplierOrderCount[s.id]||0))} bestellingen → Preferred` : rel < 2 ? `${10 - (State.supplierOrderCount[s.id]||0)} → Trusted` : 'Max niveau bereikt';

      const filaments = ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'];
      const priceRows = filaments.map(fil => {
        const locked = (fil==='TPU'&&!State.tpuUnlocked) || (fil==='RESIN'&&!State.resinUnlocked) || (fil==='CF'&&!State.cfUnlocked) || (fil==='GLOW'&&!State.glowUnlocked);
        if (locked) return '';
        const price = this.getPrice(s.id, fil);
        const base = s.basePrice[fil];
        const trend = price > base * 1.1 ? '<span class="trend-up">▲</span>' : price < base * 0.9 ? '<span class="trend-down">▼</span>' : '→';
        const fc = fil.toLowerCase();
        const stock = State.filamentStock[fil] || 0;
        const isSpecial = s.speciality?.includes(fil) ? ' ✨' : '';
        return `<div class="supplier-stock-row">
          <span class="supplier-stock-name"><span class="tag tag-${fc}" style="font-size:8px">${fil}</span>${isSpecial}</span>
          <div class="stock-bar"><div class="stock-fill ${stock<10?'stock-low':stock<40?'stock-mid':'stock-high'}" style="width:${Math.min(100,stock)}%"></div></div>
          <span style="font-size:10px;min-width:28px;text-align:right;color:var(--text-dim)">${stock}</span>
          <span style="font-size:11px;font-family:var(--display);font-weight:700;min-width:48px;text-align:right">€${price}${trend}</span>
          <div style="display:flex;gap:3px;">
            <button class="btn btn-sm btn-ghost" style="padding:3px 6px;font-size:11px" onclick="Suppliers.order('${s.id}','${fil}',10)">×10</button>
            <button class="btn btn-sm btn-ghost" style="padding:3px 6px;font-size:11px" onclick="Suppliers.order('${s.id}','${fil}',50)">×50</button>
          </div>
        </div>`;
      }).join('');

      el.innerHTML += `<div class="supplier-card ${relClass}">
        <div class="supplier-header">
          <div class="supplier-avatar">${s.avatar}</div>
          <div>
            <div class="supplier-name">${s.name}</div>
            <div style="font-size:11px;color:var(--text-dim)">${s.desc}</div>
          </div>
          ${relLabel}
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">📈 ${ordersLeft}</div>
        ${priceRows}
      </div>`;
    });
  },
};

// ── v7: MARKTCRISIS SYSTEEM ──────────────────────────────────
const MarketCrisis = {
  _timer: null,

  tick(dt) {
    // Count down to next crisis
    if (!State.activeCrisis) {
      // Higher levels see more frequent crises
      const _crisisDt = dt * (1 + Math.max(0, State.bizLevel - 4) * 0.2);
      State.crisisCountdown = (State.crisisCountdown || 200) - _crisisDt;
      if (State.crisisCountdown <= 0 && Math.random() < 0.3) {
        this.trigger();
        State.crisisCountdown = 150 + Math.random() * 200;
      }
      return;
    }
    // Active crisis countdown
    State.crisisTimer = (State.crisisTimer || 0) - dt;
    if (State.crisisTimer <= 0) this.end();
    else this.updateUI();
  },

  trigger() {
    const crisis = CONFIG.MARKET_CRISES[Math.floor(Math.random() * CONFIG.MARKET_CRISES.length)];
    State.activeCrisis = { ...crisis };
    State.crisisTimer = crisis.duration;
    this.showBanner();
    Sound.failure();
    UI.log(`⚠️ Marktcrisis: ${crisis.name} — ${crisis.desc}`, 'warn');
    // Toon als volledige popup (beter leesbaar dan kleine toast)
    UI.showPopup(
      `${crisis.icon} Marktcrisis: ${crisis.name}`,
      `<div style="text-align:center">
        <div style="font-size:36px;margin-bottom:8px">${crisis.icon}</div>
        <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--danger);margin-bottom:8px">${crisis.name}</div>
        <div style="color:var(--text);margin-bottom:12px;line-height:1.6">${crisis.desc}</div>
        <div style="background:rgba(255,61,90,0.08);border:1px solid rgba(255,61,90,0.25);border-radius:var(--radius);padding:10px;font-size:11px;color:var(--text-dim)">
          ⏱ Duurt nog <strong style="color:var(--warn)">${Math.round(crisis.duration / 60)} minuten</strong><br>
          Orders kunnen minder waard zijn of duurder worden.<br>
          <span style="color:var(--accent3)">Tip: Verhoog kwaliteit of focus op hogere-margematerialen.</span>
        </div>
      </div>`
    );
    NewsTicker.addItem(`${crisis.icon} CRISIS: ${crisis.name} — ${crisis.desc}`);
  },

  end() {
    UI.log(`✅ Marktcrisis voorbij: ${State.activeCrisis?.name}`, 'info');
    State.activeCrisis = null;
    State.crisisTimer = 0;
    $el('crisis-banner').classList.remove('active');
    Market.renderTicker(null);
  },

  showBanner() {
    if (!State.activeCrisis) return;
    const b = $el('crisis-banner');
    $el('crisis-icon').textContent = State.activeCrisis.icon;
    $el('crisis-name').textContent = State.activeCrisis.name;
    $el('crisis-desc').textContent = State.activeCrisis.desc;
    b.classList.add('active');
  },

  updateUI() {
    if (!State.activeCrisis) return;
    const t = State.crisisTimer || 0;
    const m = Math.floor(t/60), s = r0(t%60);
    const el = document.getElementById('crisis-timer');
    if (el) el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  },

  getRewardBoost(filament) {
    if (!State.activeCrisis) return 1;
    // Crisis = shortage = customers pay more!
    if (State.activeCrisis.affected === filament || State.activeCrisis.affected === 'ALL') {
      return State.activeCrisis.priceMult * 0.7; // partial boost to reward
    }
    return 1;
  },
};

// ── v7: WEEKLY CHALLENGES ────────────────────────────────────
const Challenges = {
  init() {
    if (!State.activeChallenges || State.activeChallenges.length === 0) {
      this.generateWeekly();
    }
    if (!State.challengeSessionData) this._resetSessionData();
  },

  generateWeekly() {
    const shuffled = [...CONFIG.WEEKLY_CHALLENGES].sort(() => Math.random() - 0.5);
    State.activeChallenges = shuffled.slice(0, 4).map(c => ({
      ...c,
      progress: 0,
      completed: false,
      weekStart: new Date().toISOString().slice(0,10),
    }));
    this._resetSessionData();
    UI.log('🏆 Nieuwe wekelijkse uitdagingen actief!', 'info');
  },

  _resetSessionData() {
    State.challengeSessionData = {
      jobs:0, ultra:0, filamix:[], nofail:0, earn:0,
      contracts:0, chains:0, night:0, tpu:0, resin:0,
      failedThisSession:false,
    };
  },

  onJobComplete(job, filament, quality, profit) {
    const orderType = job?.orderType || 'normal';
    const sd = State.challengeSessionData;
    sd.jobs++;
    sd.earn += (profit||0);
    if (quality === 'ULTRA') sd.ultra++;
    if (filament === 'TPU') sd.tpu++;
    if (filament === 'RESIN') sd.resin++;
    if (!sd.filamix.includes(filament)) sd.filamix.push(filament);
    if (!sd.failedThisSession) sd.nofail++;
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4) sd.night++;
    // v8: track new special types
    if (!sd.vip) sd.vip = 0;
    if (!sd.rush) sd.rush = 0;
    if (!sd.bulk) sd.bulk = 0;
    if (!sd.mystery) sd.mystery = 0;
    if (orderType === 'vip')     sd.vip++;
    if (orderType === 'rush')    sd.rush++;
    if (orderType === 'bulk')    sd.bulk++;
    if (orderType === 'mystery') sd.mystery++;
    this.checkProgress();
  },

  onJobFail() {
    if (State.challengeSessionData) {
      State.challengeSessionData.failedThisSession = true;
      State.challengeSessionData.nofail = 0;
    }
  },

  onContractComplete() {
    if (State.challengeSessionData) State.challengeSessionData.contracts++;
    this.checkProgress();
  },

  onChainComplete() {
    if (State.challengeSessionData) State.challengeSessionData.chains++;
    this.checkProgress();
  },

  _getProgress(c) {
    const sd = State.challengeSessionData || {};
    switch(c.type) {
      case 'jobs':      return sd.jobs || 0;
      case 'ultra':     return sd.ultra || 0;
      case 'filamix':   return (sd.filamix || []).length;
      case 'nofail':    return sd.nofail || 0;
      case 'earn':      return r0(sd.earn || 0);
      case 'contracts': return sd.contracts || 0;
      case 'chains':    return sd.chains || 0;
      case 'night':     return sd.night || 0;
      case 'tpu':       return sd.tpu || 0;
      case 'resin':     return sd.resin || 0;
      case 'vip':       return sd.vip || 0;
      case 'rush':      return sd.rush || 0;
      case 'bulk':      return sd.bulk || 0;
      case 'bounty':    return State.stats_v8?.bountiesClaimed || 0;
      default: return 0;
    }
  },

  checkProgress() {
    State.activeChallenges.forEach(c => {
      if (c.completed) return;
      const progress = this._getProgress(c);
      c.progress = progress;
      if (progress >= c.target) {
        c.completed = true;
        State.money = r2(State.money + c.reward);
        State.stats.totalEarned = r2(State.stats.totalEarned + c.reward);
        TaxSystem.accrue(c.reward);
        State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + c.bonusRep);
        State.xp += 50;
        State.stats.challengesDone = (State.stats.challengesDone||0) + 1;
        Sound.contractComplete();
        Confetti.burst(80);
        UI.floatMoney(`+€${c.reward} CHALLENGE`);
        UI.log(`🏆 Challenge voltooid: ${c.name} → +€${c.reward} +${c.bonusRep} rep`, 'money');
        const t = document.createElement('div');
        t.className = 'achievement-toast';
        t.innerHTML = `<div class="ach-label">🏆 Challenge Voltooid!</div><div class="ach-name">${c.icon} ${c.name}</div><div class="ach-desc">+€${c.reward} · +${c.bonusRep} Rep</div>`;
        document.body.appendChild(t); setTimeout(() => t.remove(), 5000);
      }
    });
    this.render();
  },

  render() {
    const el = document.getElementById('challenge-list'); if (!el) return;
    if (!State.activeChallenges || State.activeChallenges.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px">Geen uitdagingen.</div>';
      return;
    }
    const diffColor = { normal:'var(--accent)', hard:'var(--warn)', epic:'var(--danger)' };
    el.innerHTML = State.activeChallenges.map(c => {
      const prog = Math.min(c.target, this._getProgress(c));
      const pct = r0(prog / c.target * 100);
      const col = diffColor[c.difficulty] || 'var(--accent)';
      return `<div class="challenge-card ${c.completed ? '' : 'active-challenge'}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div class="challenge-name">${c.icon} ${c.name}</div>
          <div class="challenge-reward">€${c.reward}</div>
        </div>
        <div class="challenge-desc">${c.desc}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
          <span style="font-size:11px;color:${col};letter-spacing:1px;text-transform:uppercase">${c.difficulty}</span>
          <span style="font-size:11px;color:var(--text-dim)">+${c.bonusRep} rep</span>
        </div>
        ${c.completed
          ? '<div style="color:var(--accent3);font-size:10px;margin-top:6px;letter-spacing:1px">✅ VOLTOOID</div>'
          : `<div class="challenge-prog-bar"><div class="challenge-prog-fill" style="width:${pct}%"></div></div>
             <div class="challenge-timer">${prog} / ${c.target} (${pct}%)</div>`}
      </div>`;
    }).join('') +
    `<button class="btn btn-ghost btn-sm btn-full" style="margin-top:8px" onclick="Challenges.generateWeekly()">🔄 Nieuwe uitdagingen</button>`;
  },
};

// ── CRM: Platinum Client Special Deals ──────────────────────
const CRM = {
  _platinumDeals: [], // { customerName, expiresAt }

  spawnPlatinumDeal(customerName) {
    // Spawn a mega-order from this Platinum client
    const order = Orders.generate();
    order.reward = r2(order.reward * 4.0);
    order.name = `💎 [PLATINUM DEAL] ${order.name}`;
    order.customer = customerName;
    order.timeLeft = 120; // 2 minutes to accept
    order.expiresIn = 120;
    order.orderType = 'vip';
    order.isPlatinumDeal = true;
    State.orders.unshift(order);
    Sound.levelUp();
    UI.log(`💎 PLATINUM DEAL from ${customerName}: ${order.name} — ${fmtEur(order.reward)}! (2 min)`, 'money');
    UI.showPopup('💎 Platinum Deal!',
      `<div style="text-align:center"><div style="font-size:32px">💎</div><strong style="font-family:var(--display);color:var(--accent);font-size:15px">${customerName} has a Platinum Deal for you!</strong><br><br>${order.name}<br><br><span style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--accent3)">${fmtEur(order.reward)}</span><br><span style="font-size:10px;color:var(--text-dim)">Accept within 2 minutes</span></div>`);
    UI.renderOrders();
  },

  // Call this from VIPCustomers render to show CRM panel
  renderPanel() {
    const el = document.getElementById('crm-panel'); if (!el) return;
    const platinum = Object.entries(State.clientTiers || {})
      .filter(([,tier]) => tier === 'platinum')
      .map(([name]) => name);
    if (platinum.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:12px">Geen Platinum klanten nog. Bereik 40 jobs met dezelfde klant.</div>';
      return;
    }
    el.innerHTML = '<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">💎 Platinum Klanten</div>' +
      platinum.map(name => {
        const c = (State.customers||{})[name] || { jobs:0 };
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);border-radius:6px;margin-bottom:6px">
          <div>
            <div style="font-family:var(--display);font-weight:700;font-size:12px">${name} <span class="tier-platinum" style="font-size:8px;padding:1px 5px;border-radius:3px">💎 PLATINUM</span></div>
            <div style="font-size:11px;color:var(--text-dim);margin-top:2px">${c.jobs} jobs voltoooid · +35% beloning</div>
          </div>
          <button class="btn btn-sm btn-primary" onclick="CRM.spawnPlatinumDeal('${name}')">💎 Deal</button>
        </div>`;
      }).join('');
  },
};

// ── v7: VIP KLANTENPANEL ─────────────────────────────────────
const VIPCustomers = {
  render() {
    const el = document.getElementById('customer-panel'); if (!el) return;
    const customers = Object.entries(State.customers || {})
      .filter(([,c]) => c.jobs >= 1)
      .sort((a,b) => b[1].jobs - a[1].jobs)
      .slice(0, 15);

    if (customers.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px;font-size:11px">Nog geen klanthistorie.<br>Voltooi jobs om klantrelaties op te bouwen.</div>';
      return;
    }

    const rows = customers.map(([name, c]) => {
      const loyaltyBonus = CustomerLoyalty.getBonus(name);
      const level = CustomerLoyalty.getLoyaltyLevel(name);
      const satFilled = r0(Math.min(5, c.satisfaction / 2));
      const stars = Array.from({length:5}, (_,i) => `<span class="sat-star ${i<satFilled?'':'empty'}">★</span>`).join('');
      const isVIP = c.jobs >= 5;
      return `<div class="customer-row">
        <div>
          <div class="customer-name-main">${name} ${isVIP ? '<span class="vip-badge">VIP</span>' : ''}</div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:2px">${c.jobs} jobs</div>
        </div>
        <div class="customer-satisfaction">${stars}</div>
        ${loyaltyBonus > 1.01 ? `<div class="vip-bonus-label">+${Math.round((loyaltyBonus-1)*100)}%</div>` : ''}
        <div class="customer-jobs-count">${level || ''}</div>
      </div>`;
    }).join('');

    const vipCount = customers.filter(([,c]) => c.jobs >= 5).length;
    el.innerHTML = `<div class="customer-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase">Klantenstatus</div>
        <div style="font-size:11px;color:var(--warn)">${vipCount} VIP klanten</div>
      </div>
      ${rows}
    </div>
    <div style="padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);font-size:10px;color:var(--text-dim);line-height:1.6;margin-top:8px">
      💡 VIP klanten (5+ jobs) geven loyaliteitsbonus tot <strong style="color:var(--warn)">+30%</strong>.<br>
      Ultra-kwaliteit prints verhogen tevredenheid sneller.
    </div>`;
  },
};

// ── MARKET MODULE ────────────────────────────────────────────
const Market = {
  update() {
    const prev = { ...State.market };
    ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'].forEach(f => {
      const delta = (Math.random() - 0.48) * 0.3;
      State.market[f] = Math.max(0.6, Math.min(1.7, (State.market[f]||1.0) + delta));
      // Drift back toward 1.0
      State.market[f] = State.market[f] * 0.85 + 1.0 * 0.15;
      State.market[f] = r2(State.market[f] );
    });
    this.renderTicker(prev);
    UI.log(`📈 Market shift — PLA ×${State.market.PLA} · PETG ×${State.market.PETG} · PA6 ×${State.market.PA6}`, 'info');
    // Push significant market moves to news ticker
    ['PLA','PETG','PA6'].forEach(f => {
      const delta = State.market[f] - (prev[f] || 1);
      if (delta >= 0.15) NewsTicker.addItem(`📈 Marktpiek: ${f} prijzen omhoog naar ×${State.market[f].toFixed(2)} — goede tijd om te printen!`);
      else if (delta <= -0.15) NewsTicker.addItem(`📉 Marktdip: ${f} prijzen gezakt naar ×${State.market[f].toFixed(2)}.`);
    });
  },

  renderTicker(prev) {
    ['PLA','PETG','PA6'].forEach(f => {
      const key = f === 'PA6' ? 'pa6' : f.toLowerCase();
      const val = State.market[f];
      const old = prev ? prev[f] : 1;

      const targets = [
        { el: document.getElementById('mval-' + key),  arr: document.getElementById('marr-' + key) },
        { el: document.getElementById('mval2-' + key), arr: document.getElementById('marr2-' + key) },
      ];

      for (const t of targets) {
        if (!t.el) continue;
        t.el.textContent = '×' + val.toFixed(2);
        if (val > old + 0.02) {
          t.el.className = 'market-up';
          if (t.arr) t.arr.textContent = '↑';
        } else if (val < old - 0.02) {
          t.el.className = 'market-down';
          if (t.arr) t.arr.textContent = '↓';
        } else {
          t.el.className = 'market-flat';
          if (t.arr) t.arr.textContent = '→';
        }
      }
    });
  },

  getMultiplier(filament) {
    return State.market[filament] || 1.0;
  },
};

// ── TUTORIAL MODULE ──────────────────────────────────────────
const Tutorial = {
  step: 0,
  active: false,
  steps: [
    {
      targetId: 'ptab-body-orders',
      title: 'Welcome to Print & Profit!',
      body: 'You run a 3D printing business. Orders arrive here on the left — each one wants a specific print job done. Click an order to select it.',
      kbd: null,
    },
    {
      targetId: 'active-job-panel',
      title: 'Configure Your Print',
      body: 'After selecting an order, the center panel lets you choose Filament type and Quality. Higher quality = more profit but slower & riskier.',
      kbd: 'Q / W / E',
    },
    {
      targetId: 'start-job-btn',
      title: 'Start the Print!',
      body: 'Hit START PRINT (or press Space) to begin. Watch the progress bar and animation. Printers can fail — upgrades reduce that chance.',
      kbd: 'Space',
    },
    {
      targetId: 'tab-shop',
      title: 'Upgrade Your Workshop',
      body: 'Spend earnings in the Shop tab to unlock faster printers, better nozzles, and more. Level up your business to unlock new upgrades.',
      kbd: null,
    },
    {
      targetId: 'ptab-contracts',
      title: 'Contracts = Big Money',
      body: 'The Contracts tab has multi-job orders with large rewards. Accept them and they auto-track as you print. Daily contracts refresh each day!',
      kbd: null,
    },
  ],

  start() {
    if (localStorage.getItem('pnp_tutorial_done') && !arguments[0]) return;
    this.step = 0;
    this.active = true;
    this.render();
  },

  render() {
    const overlay = $el('tutorial-overlay');
    overlay.style.display = 'block';
    overlay.innerHTML = '';
    if (this.step >= this.steps.length) {
      this.finish();
      return;
    }
    const s = this.steps[this.step];
    const target = document.getElementById(s.targetId);
    if (target) {
      const rect = target.getBoundingClientRect();
      const spotlight = document.createElement('div');
      spotlight.className = 'tut-spotlight';
      spotlight.style.cssText = `top:${rect.top - 6}px;left:${rect.left - 6}px;width:${rect.width + 12}px;height:${rect.height + 12}px;`;
      overlay.appendChild(spotlight);
    }
    const tooltip = document.createElement('div');
    tooltip.className = 'tut-tooltip';
    const targetRect = target ? target.getBoundingClientRect() : { bottom: 200, left: window.innerWidth / 2 - 130 };
    // v17.5 fix: account for mobile bottom nav bar so tooltip is never hidden behind it
    const navBar = document.querySelector('.main-nav, .tab-row-v2.main-nav');
    const navH = (navBar && navBar.getBoundingClientRect().height > 0) ? navBar.getBoundingClientRect().height + 10 : 80;
    const safeBottom = window.innerHeight - navH - 10;
    const tooltipMaxH = 220;
    let tipTop = targetRect.bottom + 14;
    if (tipTop + tooltipMaxH > safeBottom) {
      tipTop = Math.max(10, (target ? targetRect.top - tooltipMaxH - 14 : safeBottom - tooltipMaxH));
    }
    tipTop = Math.min(tipTop, safeBottom - tooltipMaxH);
    const tipLeft = Math.max(8, Math.min(targetRect.left, window.innerWidth - 290));
    tooltip.style.cssText = 'top:' + tipTop + 'px;left:' + tipLeft + 'px;max-width:min(260px,calc(100vw - 16px));';
    tooltip.innerHTML = `
      <div class="tut-step">Step ${this.step + 1} of ${this.steps.length}</div>
      <div class="tut-title">${s.title}</div>
      <div class="tut-body">${s.body}${s.kbd ? `<br><br>Shortcut: <kbd class="kbd">${s.kbd}</kbd>` : ''}</div>
      <div class="tut-actions">
        <button class="tut-skip" onclick="Tutorial.finish()">Skip tutorial</button>
        <button class="btn btn-primary btn-sm" onclick="Tutorial.next()">${this.step < this.steps.length - 1 ? 'Next →' : 'Done! 🎉'}</button>
      </div>
    `;
    overlay.appendChild(tooltip);
  },

  next() {
    this.step++;
    this.render();
  },

  finish() {
    this.active = false;
    const overlay = $el('tutorial-overlay');
    overlay.style.display = 'none';
    overlay.innerHTML = '';
    localStorage.setItem('pnp_tutorial_done', '1');
    UI.log('Tutorial afgerond! 🎉', 'info');
  },

  _kbdTimer: null,
  showKbdHint() { /* no-op on mobile */ },
};

// ── v11: NEGOTIATION ─────────────────────────────────────────
const Negotiation = {
  counterOffer(orderId) {
    const orderIndex = State.orders.findIndex(o => o.id === orderId);
    if (orderIndex === -1) return;
    const order = State.orders[orderIndex];
    const successChance = 0.40 + (State.reputation / 1000);
    if (Math.random() < successChance) {
      order.reward = r2(order.reward * 1.25);
      order.negotiated = true;
      UI.log(`🤝 Klant ging akkoord! Prijs verhoogd naar €${order.reward}`, 'success');
      Sound.success();
      UI.renderOrders();
    } else {
      UI.log(`😠 Klant vond je te duur en liep weg!`, 'error');
      Sound.failure();
      State.orders.splice(orderIndex, 1);
      UI.renderOrders();
    }
  },
};

// ── v11: TRENDING PRODUCTS ────────────────────────────────────
const Trending = {
  tick(dt) {
    if (State.activeTrend) {
      State.trendTimer -= dt;
      this.updateBanner();
      if (State.trendTimer <= 0) this.end();
      return;
    }
    State.trendCountdown = (State.trendCountdown || 120) - dt;
    if (State.trendCountdown <= 0 && Math.random() < 0.05) {
      this.trigger();
      State.trendCountdown = 180 + Math.random() * 180;
    }
  },
  trigger() {
    const trend = CONFIG.TRENDING_PRODUCTS[Math.floor(Math.random() * CONFIG.TRENDING_PRODUCTS.length)];
    State.activeTrend = { ...trend };
    State.trendTimer = 180;
    this.showBanner();
    NewsTicker.addItem(`🔥 TRENDING: ${trend.item} ×${trend.mult} marge voor ${Math.round(State.trendTimer/60)} min!`);
    UI.log(`📈 Hype Alert! ${trend.item} is trending — ×${trend.mult} marges voor ${Math.round(State.trendTimer/60)} minuten!`, 'success');
    Sound.success();
    const t = document.createElement('div');
    t.className = 'crisis-toast';
    t.style.cssText = 'border-color:rgba(255,204,0,0.5);background:rgba(20,30,20,0.95)';
    t.innerHTML = `<div style="font-size:11px;letter-spacing:2px;color:var(--accent)">📈 TRENDING</div><div style="font-family:var(--display);font-weight:900;font-size:16px;color:var(--accent);margin:4px 0">🔥 ${trend.item}</div><div style="font-size:10px;color:var(--text-dim)">${trend.desc}</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 6000);
  },
  end() {
    State.activeTrend = null;
    State.trendTimer = 0;
    const b = document.getElementById('trend-banner');
    if (b) b.style.display = 'none';
    UI.log('📉 Trend voorbij — marktprijzen normaliseren.', 'info');
  },
  showBanner() {
    const b = document.getElementById('trend-banner');
    if (!b) return;
    b.style.display = 'flex';
    this.updateBanner();
  },
  updateBanner() {
    const b = document.getElementById('trend-banner');
    if (!b || !State.activeTrend) return;
    const n = document.getElementById('trend-name');
    const t = document.getElementById('trend-timer');
    if (n) n.textContent = `🔥 ${State.activeTrend.item} TRENDING ×${State.activeTrend.mult}`;
    if (t) t.textContent = `⏳ ${Math.ceil(State.trendTimer)}s remaining`;
  },
};

// ── v11: INVENTORY SYSTEM ─────────────────────────────────────
const Inventory = {
  ITEMS: {
    keychains: { name:'Sleutelhanger', filament:'PLA',  printTime:8,  sellPrice:2.5,  icon:'🔑' },
    planters:  { name:'Plantenbakje',  filament:'PETG', printTime:20, sellPrice:8.0,  icon:'🌱' },
  },

  startPrint(itemKey, printerIdx) {
    const item = this.ITEMS[itemKey];
    const printer = State.printers[printerIdx];
    if (!printer || printer.active) { UI.toast('Printer bezet!', 'warn'); return; }
    if (printer.health < 10) { UI.toast('Printer kapot!', 'warn'); return; }
    // Check stock
    if ((State.filamentStock[item.filament] || 0) < 3) {
      UI.toast(`Niet genoeg ${item.filament} op voorraad!`, 'warn'); return;
    }
    // Create a pseudo-order
    const pseudoOrder = {
      id: 'inv_' + Date.now(),
      name: item.name,
      customer: 'Voorraad',
      filament: item.filament,
      reward: 0,
      printTime: item.printTime,
      urgent: false,
      expiresIn: 9999,
      timeLeft: 9999,
      xpReward: 2,
      orderType: 'normal',
      isInventory: true,
      inventoryKey: itemKey,
    };
    Printer.startJob(printerIdx, pseudoOrder, item.filament, 'NORMAL');
    UI.log(`📦 Voorraad-print gestart: ${item.name} op ${printer.name}`, 'info');
    UI.renderPrinters();
    this.render();
  },

  onComplete(job) {
    if (!job.isInventory) return;
    const key = job.inventoryKey;
    if (!State.inventory) State.inventory = { keychains:0, planters:0 };
    State.inventory[key] = (State.inventory[key] || 0) + 1;
    UI.log(`📦 ${this.ITEMS[key]?.icon || '📦'} ${this.ITEMS[key]?.name} toegevoegd aan voorraad!`, 'info');
    this.render();
  },

  sellAll() {
    if (!State.inventory) State.inventory = { keychains:0, planters:0 };
    let value = 0;
    let summary = [];
    Object.entries(this.ITEMS).forEach(([key, item]) => {
      const qty = State.inventory[key] || 0;
      if (qty > 0) {
        const v = qty * item.sellPrice;
        value += v;
        summary.push(`${qty}× ${item.icon} ${item.name} = €${v.toFixed(2)}`);
        State.inventory[key] = 0;
      }
    });
    if (value === 0) { UI.toast('Geen voorraad om te verkopen!', 'warn'); return; }
    State.money = r2(State.money + value);
    State.stats.totalEarned = r2(State.stats.totalEarned + value);
    TaxSystem.accrue(value);
    State.incomeHistory.push({ t: Date.now(), v: value, type: 'inventory' });
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();
    Sound.cash(value);
    UI.log(`📦 Voorraad verkocht aan retail voor €${value.toFixed(2)}: ${summary.join(', ')}`, 'money');
    UI.floatMoney(`+€${value.toFixed(2)}`);
    UI.updateTopBar();
    this.render();
  },

  render() {
    const el = document.getElementById('inventory-panel');
    if (!el) return;
    if (!State.inventory) State.inventory = { keychains:0, planters:0 };
    const freePrinters = State.printers.filter(p => !p.active);
    let html = `<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
      📦 Print items op voorraad — geen klant nodig. Verkoop daarna in bulk aan lokale winkels.
    </div>`;
    Object.entries(this.ITEMS).forEach(([key, item]) => {
      const qty = State.inventory[key] || 0;
      const filStock = State.filamentStock[item.filament] || 0;
      const canPrint = freePrinters.length > 0 && filStock >= 3;
      html += `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div>
            <div style="font-family:var(--display);font-weight:700;font-size:13px;">${item.icon} ${item.name}</div>
            <div style="font-size:11px;color:var(--text-dim);">${item.filament} · ${item.printTime}s · €${item.sellPrice}/stuk bulk</div>
          </div>
          <div style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--accent)">${qty}</div>
        </div>
        <div style="display:flex;gap:4px;">
          ${freePrinters.map((p,i) => `<button class="btn btn-sm btn-ghost" style="font-size:11px;flex:1" onclick="Inventory.startPrint('${key}',${p.id})" ${canPrint?'':'disabled'}>▶ ${p.name}</button>`).join('')}
          ${freePrinters.length === 0 ? '<div style="font-size:11px;color:var(--text-dim);flex:1;text-align:center;">Alle printers bezet</div>' : ''}
        </div>
      </div>`;
    });
    const totalValue = Object.entries(this.ITEMS).reduce((sum, [key, item]) => sum + (State.inventory[key] || 0) * item.sellPrice, 0);
    html += `<button class="btn btn-primary btn-full" style="margin-top:4px" onclick="Inventory.sellAll()" ${totalValue > 0 ? '' : 'disabled'}>
      💰 Verkoop aan lokale winkels${totalValue > 0 ? ` — €${totalValue.toFixed(2)}` : ' (leeg)'}
    </button>`;
    el.innerHTML = html;
  },
};

// ── ORDERS ───────────────────────────────────────────────────
const Orders = {
  generate() {
    const rep    = State.reputation;
    const bizLvl = State.bizLevel;
    let filPool  = ['PLA'];
    if (rep >= CONFIG.FILAMENTS.PETG.unlockRep) filPool.push('PETG');
    if (rep >= CONFIG.FILAMENTS.PA6.unlockRep)  filPool.push('PA6');
    if (rep >= CONFIG.FILAMENTS.TPU.unlockRep && State.tpuUnlocked)   filPool.push('TPU');
    if (rep >= CONFIG.FILAMENTS.RESIN.unlockRep && State.resinUnlocked) filPool.push('RESIN');
    if (rep >= CONFIG.FILAMENTS.GLOW.unlockRep && State.glowUnlocked) filPool.push('GLOW');
    if (rep >= CONFIG.FILAMENTS.CF.unlockRep && State.cfUnlocked) filPool.push('CF');
    const weights = filPool.map(f => f==='PLA'?3:f==='PETG'?2:f==='TPU'?1.5:f==='RESIN'?1:f==='CF'?0.8:f==='GLOW'?1.2:1);
    const fil     = this._weighted(filPool, weights);
    const repTimeMult = rep >= 150 ? 1.30 : rep >= 100 ? 1.20 : rep >= 60 ? 1.10 : 1.0; // hoge rep = complexere, langere jobs
    const baseTime   = (20 + Math.random()*20 + bizLvl*5) * repTimeMult;
    const filConf    = CONFIG.FILAMENTS[fil];
    // Apply market multiplier + crisis boost to base reward
    const marketMult = Market.getMultiplier(fil);
    const crisisMult = MarketCrisis.getRewardBoost(fil);
    // Reputatie voordelen: hoge rep = betere deals (hogere beloning, maar langere printtijd)
    const repBonus = rep >= 150 ? 1.40 : rep >= 100 ? 1.28 : rep >= 60 ? 1.15 : rep >= 30 ? 1.07 : 1.0;
    let baseReward = (8 + Math.random()*12 + bizLvl*2) * filConf.profitMult * marketMult * crisisMult * repBonus;
    const _urgentBase = 0.1 + rep * 0.003 + (Season.current?.urgentBoost || 0);
    const urgent      = Math.random() < _urgentBase;
    // Use filament-specific name pool
    // v17.4 fix: PLA now uses the richer ORDER_NAMES pool (was ORDER_NAMES_PLA which excluded
    // Drone Frame, Bracket, Gear etc. causing those trending items to never apply to PLA orders)
    const namePool = fil === 'PETG' ? CONFIG.ORDER_NAMES_PETG :
                     fil === 'PA6'  ? CONFIG.ORDER_NAMES_PA6  :
                     fil === 'TPU'  ? CONFIG.ORDER_NAMES_TPU  :
                     fil === 'RESIN'? CONFIG.ORDER_NAMES_RESIN :
                     fil === 'CF'   ? CONFIG.ORDER_NAMES_PA6  :
                     fil === 'GLOW' ? CONFIG.ORDER_NAMES_PLA  : CONFIG.ORDER_NAMES;
    const orderType = SpecialOrders.getType();
    let orderName = namePool[Math.floor(Math.random()*namePool.length)];
    // Apply trending multiplier
    if (State.activeTrend && orderName.includes(State.activeTrend.item)) {
      baseReward *= State.activeTrend.mult;
      orderName = `🔥 [TRENDING] ${orderName}`;
    }
    const reward = Math.round(baseReward * (0.9 + Math.random()*0.2) * 100)/100;
    let order = {
      id:        Date.now() + "_" + Math.floor(Math.random() * 1e9),
      name:      orderName,
      customer:  CONFIG.ORDER_CUSTOMERS[Math.floor(Math.random()*CONFIG.ORDER_CUSTOMERS.length)],
      filament:  fil,
      reward,
      printTime: r0(baseTime),
      urgent,
      expiresIn: urgent ? 45 : CONFIG.ORDER_EXPIRE_S,
      timeLeft:  urgent ? 45 : CONFIG.ORDER_EXPIRE_S,
      xpReward:  r0(5 + bizLvl*2 + (fil==='PA6'?10:fil==='PETG'?4:fil==='TPU'?6:fil==='RESIN'?12:fil==='CF'?15:fil==='GLOW'?5:0)),
      orderType,
    };
    order = SpecialOrders.applyModifiers(order);
    return order;
  },
  _weighted(arr, w) {
    let r = Math.random() * w.reduce((a,b)=>a+b,0);
    for (let i=0;i<arr.length;i++){ r-=w[i]; if(r<=0) return arr[i]; }
    return arr[arr.length-1];
  },
};

// ── CONTRACTS ────────────────────────────────────────────────
const Contracts = {
  TEMPLATES: [
    { base:'Batch Print',   filaments:['PLA'],             counts:[3,5],  rewardMult:1.8 },
    { base:'PETG Series',   filaments:['PETG'],            counts:[2,4],  rewardMult:2.5, minRep:20 },
    { base:'Mixed Lot',     filaments:['PLA','PETG'],      counts:[2,2],  rewardMult:3.2, minRep:25 },
    { base:'PA6 Run',       filaments:['PA6'],             counts:[2,3],  rewardMult:4.5, minRep:60 },
    { base:'Prototype',     filaments:['PLA','PETG','PA6'],counts:[1,1,1],rewardMult:5.0, minRep:70 },
    { base:'Flex Series',   filaments:['TPU'],             counts:[2,3],  rewardMult:3.5, minRep:40, requireTPU:true },
    { base:'Precision Lot', filaments:['RESIN'],           counts:[2,3],  rewardMult:6.0, minRep:80, requireResin:true },
    { base:'Full Spectrum+',filaments:['PLA','PETG','TPU','RESIN'],counts:[1,1,1,1],rewardMult:8.0, minRep:90, requireTPU:true, requireResin:true },
  ],

  generate(isDaily=false) {
    const rep    = State.reputation;
    const bizLvl = State.bizLevel;
    // Pick eligible template
    const eligible = this.TEMPLATES.filter(t =>
      (!t.minRep || rep >= t.minRep) &&
      (!t.requireTPU || State.tpuUnlocked) &&
      (!t.requireResin || State.resinUnlocked)
    );
    // Fallback to basic templates if none eligible
    const pool = eligible.length > 0 ? eligible : this.TEMPLATES.slice(0, 2);
    const tpl  = pool[Math.floor(Math.random() * pool.length)];
    // Build requirements
    const reqs = tpl.filaments.map((f,i) => {
      const cnt = tpl.counts[Math.min(i, tpl.counts.length-1)];
      return { filament:f, required: cnt, done:0 };
    });
    const totalJobs = reqs.reduce((a,r)=>a+r.required,0);
    const baseReward = totalJobs * (12 + bizLvl*3) * tpl.rewardMult * (isDaily ? 2.5 : 1);
    return {
      id:        'c_'+Date.now()+Math.random(),
      name:      (isDaily ? '🌟 Daily: ' : '') + CONFIG.CONTRACT_NAMES[Math.floor(Math.random()*CONFIG.CONTRACT_NAMES.length)],
      customer:  CONFIG.CONTRACT_CUSTOMERS[Math.floor(Math.random()*CONFIG.CONTRACT_CUSTOMERS.length)],
      reqs,
      reward:    r0(baseReward),
      bonusRep:  isDaily ? 20 : 8 + bizLvl*2,
      bonusXP:   isDaily ? 50 : 15 + bizLvl*5,
      isDaily,
      accepted:  false,
      completed: false,
      expiresIn: isDaily ? CONFIG.DAILY_REFRESH_S : CONFIG.CONTRACT_REFRESH_S,
      timeLeft:  isDaily ? CONFIG.DAILY_REFRESH_S : CONFIG.CONTRACT_REFRESH_S,
    };
  },

  // Called when a job succeeds — checks all accepted contracts
  trackJob(filament) {
    let anyComplete = false;
    const activeId = State.activeContractId;
    State.contracts.forEach(c => {
      if (!c.accepted || c.completed) return;
      if (activeId && c.id !== activeId) return;
      c.reqs.forEach(r => {
        if (r.filament === filament && r.done < r.required) {
          r.done++;
        }
      });
      // Check completion
      if (c.reqs.every(r => r.done >= r.required)) {
        c.completed = true;
        anyComplete = true;
        this.complete(c);
        // v17.2 fix: only clear activeContractId when contract actually completes
        if (State.activeContractId === c.id) State.activeContractId = null;
      }
    });
    if (anyComplete) UI.renderContracts();
  },

  complete(contract) {
    State.money = r2(State.money + contract.reward);
    State.stats.totalEarned = r2(State.stats.totalEarned + contract.reward);
    TaxSystem.accrue(contract.reward);
    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + contract.bonusRep);
    State.xp += contract.bonusXP;
    State.stats.contractsDone++;
    if (contract.isDaily) State.stats.dailyDone++;
    // v7: Challenge tracking
    Challenges.onContractComplete();
    State.incomeHistory.push({ t: Date.now(), v: contract.reward, type:'contract' });
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();

    Sound.contractComplete();
    UI.floatMoney(`+€${contract.reward} CONTRACT`);
    UI.log(`🎯 Contract complete: ${contract.name} → +€${contract.reward}`, 'contract');
    UI.showContractToast(contract);
    Game.checkBizLevel();
    Achievements.check();
    UI.renderStats();
    UI.updateTopBar();
    UI.renderShop();
  },

  accept(contractId) {
    const c = State.contracts.find(x => x.id === contractId);
    if (!c) return;

    // Only one active contract at a time (idle-friendly focus)
    const active = State.contracts.find(x => x.id === State.activeContractId);
    const hasActive = active && active.accepted && !active.completed && active.timeLeft > 0;
    if (hasActive && active.id !== c.id) {
      UI.toast('📄 Eén contract tegelijk! Rond eerst je actieve contract af.', 'warn');
      return;
    }

    // Accept + mark as the single active contract
    State.contracts.forEach(x => { if (x.id !== c.id) x.accepted = false; });
    c.accepted = true;
    State.activeContractId = c.id;

    Sound.click();
    UI.log(`📄 Actief contract: ${c.name}`, 'info');
    UI.renderContracts();
  },

  refresh() {
    // Remove expired / completed contracts, add new ones
    State.contracts = State.contracts.filter(c => !c.completed && c.timeLeft > 0);
    // If active contract expired/removed, clear it
    if (State.activeContractId && !State.contracts.some(c=>c.id===State.activeContractId && c.accepted && !c.completed && c.timeLeft>0)) {
      State.activeContractId = null;
    }
    // Ensure 3 regular contracts
    const regular = State.contracts.filter(c => !c.isDaily).length;
    for (let i = regular; i < 3; i++) {
      State.contracts.push(this.generate(false));
    }
    // Daily: one per day (real time)
    const now = Date.now();
    const hasDaily = State.contracts.some(c => c.isDaily && !c.completed);
    const lastDone = State.dailyContractDoneAt || 0;
    if (!hasDaily && (now - lastDone) > CONFIG.DAILY_REFRESH_S * 1000) {
      State.contracts.push(this.generate(true));
    }
  },
};

// ── PRINTER ──────────────────────────────────────────────────
const Printer = {
  calcTime(order, quality, printerIdx) {
    const q = CONFIG.QUALITY[quality];
    const specMult = Specialization.getTimeMult(printerIdx ?? State.selectedPrinterIdx);
    const printer = State.printers[printerIdx ?? State.selectedPrinterIdx];
    const modelStats = CONFIG.PRINTER_MODELS[printer?.model || 'BASIC'];
    return r0(order.printTime * q.timeMult * State.speedMult * specMult * modelStats.speedMult);
  },
  calcFailChance(filament, quality, printerIdx) {
    const f = CONFIG.FILAMENTS[filament];
    const q = CONFIG.QUALITY[quality];
    let chance = f.failBase + q.failAdd + State.failBonus + State.nextFailBoost;
    if (filament !== 'PLA') { chance += State.abrasiveBonus; chance += State.dryerBonus; }
    // TPU: flex bed reduces failure
    if (filament === 'TPU' && State.flexBed) chance -= 0.20;
    // Resin: UV curing station reduces failure
    if (filament === 'RESIN' && State.uvCuring) chance -= 0.25;
    // CF: hardened nozzle+enclosure reduces failure
    if (filament === 'CF' && State.cfNozzle) chance -= 0.20;
    // Research: Bed Adhesion Science halves PLA fail rate
    if (filament === 'PLA' && State.researchFlags?.bedAdhesion) chance -= f.failBase * 0.50;
    // Research: Thermal Management reduces all heat-related wear effects
    if (State.researchFlags?.thermalMgmt) chance -= 0.03;
    // Low stock = higher failure (stress on printer)
    const stock = State.filamentStock[filament] || 0;
    if (stock < 10 && stock > 0) chance += 0.08; // running low
    chance += Specialization.getFailBonus(printerIdx ?? State.selectedPrinterIdx);
    // Printer model fail modifier
    const printer = State.printers[printerIdx ?? State.selectedPrinterIdx];
    const modelStats = CONFIG.PRINTER_MODELS[printer?.model || 'BASIC'];
    chance += modelStats.failAdd;
    // Printer health penalty: low health = higher fail chance
    if (printer && printer.health < 50) chance += (50 - printer.health) * 0.003;
    return Math.max(0.01, Math.min(0.95, chance));
  },
  calcProfit(order, filament, quality, printerIdx) {
    const f = CONFIG.FILAMENTS[filament];
    const q = CONFIG.QUALITY[quality];
    const seasonMult = Season.getRewardMult(filament);
    const specMult   = Specialization.getProfitMult(printerIdx ?? State.selectedPrinterIdx);
    const filCostMult= Specialization.getFilCostMult(printerIdx ?? State.selectedPrinterIdx);
    const prestigeM  = 1 + (State.prestigeBonus || 0);
    const comboMult  = Combo.getMultiplier();
    const surgeMult  = DemandSurge.getSurgeMultiplier(filament);
    let reward = order.reward * q.profitMult * State.rewardMult * seasonMult * specMult * prestigeM * comboMult * surgeMult;
    if (State.bulkBonusJobs > 0) reward *= 1.3;
    // Research: Quality Control Lab +20% reward for Ultra jobs
    if (quality === 'ULTRA' && State.researchFlags?.qualityCtrl) reward *= 1.20;
    // Night bonus: +20% reward between 22:00 and 04:00
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4) reward *= 1.20;
    let filCost = f.costPerJob * filCostMult;
    if (State.filDiscountJobs > 0) filCost *= 0.5;
    // Research: Material Science -15% filament cost
    if (State.researchFlags?.materialSci) filCost *= 0.85;
    return r2(reward - filCost);
  },
  startJob(printerIdx, order, filament, quality) {
    const printer = State.printers[printerIdx];
    if (printer._offline) { UI.log(`⚠ ${printer.name} is offline — fix the equipment issue first!`, 'error'); return; }
    printer.active    = true;
    printer.job       = { ...order, filament, quality, profit:this.calcProfit(order,filament,quality,printerIdx), fail:this.calcFailChance(filament,quality,printerIdx) };
    printer.progress  = 0;
    printer.timeLeft  = this.calcTime(order, quality, printerIdx);
    printer.totalTime = printer.timeLeft;
    Sound.startHum(printerIdx);
  },
  tick(printer, dt) {
    if (!printer.active || !printer.job) return;
    printer.timeLeft -= dt;
    printer.progress  = 1 - (printer.timeLeft / printer.totalTime);

    // v9: Clog trigger for PA6/RESIN at ~50% progress
    if (!printer._clogTriggered && !State.clogActive &&
        (printer.job.filament === 'PA6' || printer.job.filament === 'RESIN') &&
        printer.progress >= 0.45 && printer.progress <= 0.55) {
      const clogChance = printer.job.filament === 'RESIN' ? 0.08 : 0.05;
      if (Math.random() < clogChance && !State.ownedUpgrades.includes('hardened_nozzle')) {
        printer._clogTriggered = true;
        // Pause printer while clog minigame runs
        printer._clogPause = true;
        const pIdx = State.printers.indexOf(printer);
        setTimeout(() => ClogMinigame.trigger(pIdx), 200);
        return;
      }
      printer._clogTriggered = true; // prevent re-triggering even if no clog
    }

    // Resume from clog
    if (printer._clogPause && !State.clogActive) {
      printer._clogPause = false; // game either won or failed
    }
    if (printer._clogPause) return; // paused during clog minigame

    if (printer.progress >= 1 || printer.timeLeft <= 0) {
      printer.progress = 1;
      printer._clogTriggered = false;
      this.finishJob(printer);
    }
  },
  finishJob(printer) {
    const job = printer.job;
    if (!job) return; // v17.5 fix: guard against double-call or stale tick after reset
    const success = Math.random() > job.fail;

    const pIdx = State.printers.indexOf(printer);
    // AI Quality Control: intercept failure early (50% chance)
    if (!success && State.aiQuality && Math.random() < 0.5) {
      printer.health    = Math.max(0, printer.health - 2);
      State.nextFailBoost = 0;
      Sound.failure();
      UI.log(`🤖 AI QC caught a failure early on ${job.name} — damage minimised`, 'warn');
      UI.showFailureAnimation(pIdx>=0 ? pIdx : printer.id, 'AI QC intervention', job.name);
      this._resetPrinter(printer, false);
      // v17 fix: update UI after AI QC intercept (was missing)
      Game.checkBizLevel();
      Achievements.check();
      UI.renderCenterPanel();
      UI.renderPrinters();
      UI.updateTopBar();
      return;
    }

    Sound.stopHum(pIdx); // fix: use actual printer index, not viewingPrinterIdx
    if (success) this._onSuccess(printer, job);
    else          this._onFailure(printer, job);

    this._resetPrinter(printer, true);
    Game.checkBizLevel();
    Achievements.check();
    UI.renderCenterPanel();
    UI.renderPrinters();
    UI.updateTopBar();
    UI.renderStats();
    UI.renderGraphCanvas();
  },

  _onSuccess(printer, job) {
    // v11: Inventory jobs — short-circuit to inventory handler
    if (job.isInventory) {
      Inventory.onComplete(job);
      Sound.success();
      Suppliers.useStock(job.filament, CONFIG.FILAMENTS[job.filament]?.stockUse || 3);
      // Note: _resetPrinter is called by finishJob after _onSuccess returns
      UI.renderPrinters();
      return;
    }

    const loyaltyMult  = CustomerLoyalty.getBonus(job.customer || '');
    const tierMult     = ClientTiers.getBonus(job.customer || '');
    const finalProfit  = r2(job.profit * loyaltyMult * tierMult);

    // ── Money & core stats ──
    State.money             = r2(State.money + finalProfit);
    State.stats.totalEarned = r2(State.stats.totalEarned + finalProfit);
    State.stats.sessionEarned = r2((State.stats.sessionEarned||0) + finalProfit);
    State.stats.jobsDone++;
    State.stats.totalPrints++;
    State.stats.currentStreak++;
    State.stats.failStreak = 0;
    // Track per-minute earnings for offline snap (rolling window of last 10 job profits)
    if (!Array.isArray(State.lastMinuteEarnings)) State.lastMinuteEarnings = [];
    State.lastMinuteEarnings.push(finalProfit);
    if (State.lastMinuteEarnings.length > 10) State.lastMinuteEarnings.shift();
    // v17.3 fix: intern speed bonus expiry (was set but never decremented)
    if (State._internJobs > 0) {
      State._internJobs--;
      if (State._internJobs === 0) {
        State.speedMult = r2(State.speedMult / 1.20);
        UI.log('🧑‍🎓 Intern stint over — speed back to normal.', 'info');
      }
    }
    if (State.stats.currentStreak > State.stats.longestStreak)
      State.stats.longestStreak = State.stats.currentStreak;

    // ── Reputation & XP ──
    const repGain = r0(CONFIG.REP_PER_SUCCESS * CONFIG.FILAMENTS[job.filament].repBonus
                   * CONFIG.QUALITY[job.quality].repMult) + (State.packagingBonus ? 1 : 0);
    const _repBefore = State.reputation;
    State.reputation      = clamp(State.reputation + repGain, 0, CONFIG.MAX_REP);
    State.stats.repEarned += repGain;
    // Rep milestone meldingen
    const _repMilestones = [
      { at: 20,  msg: 'PETG filament ontgrendeld — 50% hogere marges op jobs!', icon:'🎨' },
      { at: 30,  msg: 'Betere deals! Orders brengen nu 7% meer op.', icon:'⭐' },
      { at: 40,  msg: 'TPU filament bereikbaar (koop Direct Drive in shop).', icon:'🌀' },
      { at: 50,  msg: 'GLOW filament ontgrendeld + 15% hogere beloningen!', icon:'✨' },
      { at: 60,  msg: 'PA6-GF engineering filament ontgrendeld — premium marges!', icon:'⚙️' },
      { at: 80,  msg: 'Resin SLA filament ontgrendeld + klanten betalen 28% meer!', icon:'💎' },
      { at: 100, msg: 'TRUSTED status — premium klanten komen naar jou!', icon:'🏆' },
      { at: 120, msg: 'Carbon Fiber filament bereikbaar (koop CF Nozzle in shop)!', icon:'⚫' },
      { at: 150, msg: 'LEGEND status — 40% bonus op alle beloningen!', icon:'👑' },
    ];
    for (const _m of _repMilestones) {
      if (_repBefore < _m.at && State.reputation >= _m.at) {
        UI.showPopup(`${_m.icon} Reputatie Mijlpaal: ${_m.at} bereikt!`,
          `<div style="text-align:center">
            <div style="font-size:40px;margin-bottom:8px">${_m.icon}</div>
            <div style="font-family:var(--display);font-weight:900;font-size:20px;color:var(--warn);margin-bottom:10px">${_m.at} Reputatie!</div>
            <div style="color:var(--text);line-height:1.8;font-size:12px">${_m.msg}</div>
            <div style="margin-top:10px;font-size:11px;color:var(--text-dim)">Hogere reputatie = betere orders met hogere beloningen maar ook langere printtijden.</div>
          </div>`);
        break;
      }
    }
    Subscriptions.checkUnlockMore();
    State.xp              += job.xpReward || 8;

    // ── Per-filament counters ──
    const filCounters = { PA6:'pa6Done', PETG:'petgDone', TPU:'tpuDone', RESIN:'resinDone', CF:'cfDone', GLOW:'glowDone' };
    if (filCounters[job.filament]) State.stats[filCounters[job.filament]] = (State.stats[filCounters[job.filament]]||0) + 1;
    if (job.quality === 'ULTRA') State.stats.ultraJobs = (State.stats.ultraJobs||0) + 1;
    if (!State.stats.filamentsUsed.includes(job.filament)) State.stats.filamentsUsed.push(job.filament);
    if (job.name && job.name.includes('[TRENDING]')) State.stats.trendOrdersDone = (State.stats.trendOrdersDone||0) + 1;

    // ── Misc tracking ──
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4)                               State.stats.nightShiftJobs++;
    if ((printer.totalTime||999) < State.stats.fastestJob) State.stats.fastestJob = printer.totalTime;
    if (Market.getMultiplier(job.filament) >= 1.2)         State.stats.marketSurgeJobs++;
    if (State.activeCrisis)                                State.stats.crisisJobsDone = (State.stats.crisisJobsDone||0) + 1;
    CustomerLoyalty.track(job.customer || '', job.filament, job.quality);

    // ── Consume bonuses ──
    if (State.bulkBonusJobs   > 0) State.bulkBonusJobs--;
    if (State.filDiscountJobs > 0) State.filDiscountJobs--;
    State.nextFailBoost  = 0;
    // Health degradation — reduced by Durable Legacy perk and Thermal Management research
    let healthDrain = 1 + Math.random() * 2;
    if (State.durabilityBonus) healthDrain *= Math.max(0.1, 1 - State.durabilityBonus);
    if (State.researchFlags?.thermalMgmt) healthDrain *= 0.70;
    printer.health = Math.max(0, printer.health - healthDrain);

    // ── Income history ──
    State.incomeHistory.push({ t: Date.now(), v: finalProfit, type: 'job' });
    // Track total filament cost for net profit stat
    const _filCost = r2(CONFIG.FILAMENTS[job.filament]?.costPerJob || 0);
    State.stats.totalFilamentCost = r2((State.stats.totalFilamentCost||0) + _filCost);
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();

    // ── Feedback ──
    Sound.success();
    Sound.cash(finalProfit);
    const loyaltyNote = loyaltyMult > 1.01 ? ` (⭐×${loyaltyMult.toFixed(2)})` : '';
    const tierNote    = tierMult > 1.01    ? ` (🏅×${tierMult.toFixed(2)})`     : '';
    const _hr = new Date().getHours();
    const nightNote   = (_hr >= 22 || _hr < 4) ? ' 🌙+20%' : '';
    UI.log(`✓ ${job.name} done → ${fmtEur(finalProfit)}${loyaltyNote}${tierNote}${nightNote}`, 'money');
    UI.floatMoney(fmtEur(finalProfit));
    UI.showSuccessAnimation();
    // v14: Juicy particle effects
    const moneyEl = document.getElementById('money-val');
    Particles.moneyShower(fmtEur(finalProfit), moneyEl);
    Particles.screenFlash('success');
    Particles.pulseMoney();
    Confetti.burst(70);

    // Nozzle sparks on the SVG printer graphic
    const svgWrap = document.querySelector('.printer-svg-wrap') || document.querySelector('.printer-visual');
    if (svgWrap) Particles.nozzleSparks(svgWrap);
    Notifications.notify('Print Complete! 🖨️', `${job.name} finished → ${fmtEur(finalProfit)}`);

    // ── Downstream systems ──
    Combo.onJobComplete();
    Speedrun.recordJob(finalProfit);
    DailyGoals.check();
    Challenges.onJobComplete(job, job.filament, job.quality, finalProfit);
    Suppliers.useStock(job.filament, CONFIG.FILAMENTS[job.filament]?.stockUse || 3);
    Chains.trackJob(job.filament);
    Contracts.trackJob(job.filament);
    SmartTips.check(State);
    if (State.stats.jobsDone % 5 === 0) Leaderboard.submit();
    setTimeout(() => Queue.tryAutoStart(), 300);

    // v8: special order tracking + bounty + milestone
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0 };
    if (!State.stats_v10) State.stats_v10 = { taxPaid:0, complaintsReceived:0, complaintsRefunded:0, scrapsRecycled:0, franchiseEarned:0, subscriptionJobsDone:0, insurancePayouts:0 };
    if (job.orderType === 'vip')       State.stats_v8.vipDone++;
    if (job.orderType === 'rush')      State.stats_v8.rushDone++;
    if (job.orderType === 'bulk')      State.stats_v8.bulkDone++;
    if (job.orderType === 'mystery')   State.stats_v8.mysteryDone++;
    if (job.orderType === 'legendary') State.stats_v8.legendaryDone++;
    if (job.orderType === 'subscription') State.stats_v10.subscriptionJobsDone = (State.stats_v10.subscriptionJobsDone||0) + 1;
    if (!State.stats.bestSingleJob || finalProfit > State.stats.bestSingleJob) State.stats.bestSingleJob = finalProfit;
    BountyBoard.onJobComplete(job, job.filament, job.quality);
    BountyBoard.onEarn(finalProfit);
    Milestones.check();

    // v9: New system hooks
    DemandSurge.onJobComplete(job.filament);
    Rival.onJobComplete();

    // v10: New system hooks
    TaxSystem.accrue(finalProfit);
    if (job.customer) {
      // Track jobs per customer for tier system
      if (!State.customers) State.customers = {};
      if (!State.customers[job.customer]) State.customers[job.customer] = { jobs: 0 };
      State.customers[job.customer].jobs = (State.customers[job.customer].jobs || 0) + 1;
      ClientTiers.update(job.customer);
    }
    // Legacy rep bonus
    if (State.repLegacyBonus) {
      State.reputation = clamp(State.reputation + State.repLegacyBonus, 0, CONFIG.MAX_REP);
    }

    if (State.smartQueue && State.orders.length > 0) {
      setTimeout(() => {
        const best    = [...State.orders].sort((a, b) => b.reward - a.reward)[0];
        const freeIdx = State.printers.findIndex(p => !p.active && p.id === printer.id);
        if (best && freeIdx >= 0) Game._autoStartJob(freeIdx, best);
      }, 500);
    }
  },

  _onFailure(printer, job) {
    const pIdx = State.printers.indexOf(printer);
    State.stats.jobsFailed++;
    State.stats.totalPrints++;
    State.stats.currentStreak = 0;
    State.stats.failStreak    = (State.stats.failStreak||0) + 1;
    State.reputation = Math.max(0, State.reputation - Math.abs(CONFIG.REP_PER_FAILURE));

    if (State.bulkBonusJobs   > 0) State.bulkBonusJobs--;
    if (State.filDiscountJobs > 0) State.filDiscountJobs--;
    State.nextFailBoost = 0;
    printer.health = Math.max(0, printer.health - (4 + Math.random() * 5));

    Challenges.onJobFail();
    BountyBoard.onFail();
    Combo.reset(); // fix: combo should break on failure
    const reason = Math.random() < 0.5 ? 'Clog detected' : 'Warping failure';
    Sound.failure();
    UI.log(`✗ ${job.name} FAILED — ${reason}`, 'error');
    UI.showFailureAnimation(pIdx>=0 ? pIdx : printer.id, reason, job.name);
    // v14: failure impact effects
    Particles.shake();
    Particles.screenFlash('fail');

    // v10: Recycling scrap + complaint chance
    Recycling.onFailure(job.filament);
    if (!Insurance.cover(`${job.name} failure`)) {
      Complaints.maybeComplain(job);
    }

    if (printer.health < 20 && printer.health > 0 && Math.random() < 0.5) {
      setTimeout(() => MiniGame.trigger(printer.id), 800);
    }
  },
  _resetPrinter(printer, clearJobState) {
    const idx = State.printers.indexOf(printer);
    printer.active   = false;
    printer.job      = null;
    printer.progress = 0;
    printer.timeLeft = 0;
    // v17.5 fix: clear pendingOrder if it was for this printer OR if no other printer is still active
    // (prevents UI getting stuck in configure-mode after queue auto-start finishes)
    if (State.selectedPrinterIdx === idx || !State.printers.some(p => p !== printer && p.active)) {
      State.pendingOrder = null;
    }
    if (State.viewingPrinterIdx === idx && !State.pendingOrder) {
      const other = State.printers.find(p => p !== printer && p.active);
      State.viewingPrinterIdx = other ? State.printers.indexOf(other) : 0;
    }
  },
};

// ── SHOP ─────────────────────────────────────────────────────
const Shop = {
  buy(id) {
    // Check both CONFIG.UPGRADES and CONFIG.UPGRADES_V8
    const upg = CONFIG.UPGRADES.find(u => u.id===id) || CONFIG.UPGRADES_V8.find(u => u.id===id);
    if (!upg) return;
    if (upg.premium) {
      if (!State.isPro) { Game.showProModal(); return; }
      if (State.ownedUpgrades.includes(id)) return;
      State.ownedUpgrades.push(id);
      upg.apply(State);
      State.stats.upgradesBought++;
      Sound.success();
      UI.log(`Pro upgrade activated: ${upg.name}`, 'info');
      UI.renderShop(); return;
    }
    if (State.ownedUpgrades.includes(id)) return;
    if (r2(State.money) < upg.cost) { UI.showPopup('Onvoldoende saldo', `Je hebt €${upg.cost.toLocaleString('nl-NL',{minimumFractionDigits:2})} nodig voor ${upg.name}. Huidig saldo: €${r2(State.money).toFixed(2)}`); return; }
    if (State.bizLevel < upg.unlockLevel) { UI.showPopup('Locked', `${upg.name} requires Business Level ${upg.unlockLevel}.`); return; }
    State.money = r2(State.money - upg.cost);
    State.ownedUpgrades.push(id);
    if (!State.researchFlags) State.researchFlags = {};
    upg.apply(State);
    State.stats.upgradesBought++;
    if (id==='printer2') State.printers.push({ id:1, name:'Printer #2', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='printer3') State.printers.push({ id:2, name:'Printer #3', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='printer4') State.printers.push({ id:3, name:'Printer #4', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='printer5') State.printers.push({ id:4, name:'Titan #5',   model:'DELTA', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='passive_income' || id==='etsy_store' || id==='franchise') $el('passive-pill').style.display='flex';
    if (id==='direct_drive') { State.tpuUnlocked = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    if (id==='resin_printer') { State.resinUnlocked = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    if (id==='glow_filament') { State.glowUnlocked = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    if (id==='cf_nozzle') { State.cfUnlocked = true; State.cfNozzle = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    Sound.click();
    UI.log(`Purchased: ${upg.name}`, 'info');
    UI.renderShop(); UI.renderPrinters(); UI.updateTopBar();
    Achievements.check();
    Milestones.check();
  },
};

// ── ACHIEVEMENTS ─────────────────────────────────────────────
const Achievements = {
  check() {
    CONFIG.ACHIEVEMENTS.forEach(a => {
      if (!State.achievements.includes(a.id) && a.check(State)) {
        State.achievements.push(a.id);
        this._show(a);
      }
    });
    UI.renderAchievements();
  },
  _show(ach) {
    const el = document.createElement('div');
    el.className = 'achievement-toast';
    el.innerHTML = `<div class="ach-label">🏆 Achievement Unlocked</div><div class="ach-name">${ach.name}</div><div class="ach-desc">${ach.desc}</div>`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 4500);
  },
};

// ── Floating Text Juice ─────────────────────────────────────
function spawnFloatingText(x, y, text, opts={}) {
  try {
    const layer = document.getElementById('float-layer');
    if (!layer) return;
    const el = document.createElement('div');
    el.className = 'float-text' + (opts.cls?(' '+opts.cls):'');
    el.textContent = text;
    el.style.left = `${x}px`;
    el.style.top  = `${y}px`;
    if (opts.color) el.style.color = opts.color;
    layer.appendChild(el);
    setTimeout(()=>el.remove(), 1000);
  } catch(e) { /* non-fatal */ }
}

// ── UI ───────────────────────────────────────────────────────
const UI = {
  toast(msg, type='info') {
    const colors = { info:'var(--accent)', success:'var(--accent3)', warn:'var(--warn)', error:'var(--danger)' };
    const t = document.createElement('div');
    t.style.cssText = `position:fixed;bottom:${70 + (UI._toastCount||0)*44}px;right:16px;z-index:9999;background:var(--panel);border:1px solid ${colors[type]||colors.info};border-radius:8px;padding:8px 14px;font-size:11px;color:var(--text-bright);box-shadow:0 4px 16px rgba(0,0,0,0.4);transition:opacity 0.3s;max-width:280px;`;
    t.className = 'ui-toast';
    UI._toastCount = (UI._toastCount||0)+1;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity='0'; setTimeout(()=>{ t.remove(); UI._toastCount=Math.max(0,(UI._toastCount||1)-1); }, 300); }, 2800);
  },
  log(msg, type='info') {
    const p = $el('log-panel');
    const now = new Date();
    const t = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
    const el = document.createElement('div'); el.className='log-entry';
    el.innerHTML=`<span class="log-time">${t}</span><span class="log-msg ${type}">${msg}</span>`;
    p.insertBefore(el, p.firstChild);
    while (p.children.length>50) p.removeChild(p.lastChild);
  },
  floatMoney(text, anchorEl=null) {
    // Spawn a floating number near the cash display (or near an anchor)
    const a = anchorEl || document.getElementById('top-money') || document.getElementById('money-val');
    let x = 180, y = 70;
    if (a && a.getBoundingClientRect) {
      const r = a.getBoundingClientRect();
      x = r.left + r.width*0.5 + (Math.random()*18-9);
      y = r.top  + r.height*0.2 + (Math.random()*10-5);
    }
    const cls = (String(text).includes('-') ? 'bad' : 'good') + (String(text).length>8 ? ' big' : '');
    spawnFloatingText(x, y, text, { cls });
    const mv=$el('money-val');
    if (mv) { mv.classList.remove('money-gained'); void mv.offsetWidth; mv.classList.add('money-gained'); }
  },
  // Cached topbar element refs
  _tbEls: null,
  _getTopBarEls() {
    if (!this._tbEls) this._tbEls = {
      money: document.getElementById('money-val'),
      rep:   document.getElementById('rep-val'),
      level: document.getElementById('level-val'),
      passive: document.getElementById('passive-val'),
      burnPill: document.getElementById('burn-pill'),
      burnVal:  document.getElementById('burn-val'),
      proBt:    document.getElementById('pro-btn'),
      streakPill: document.getElementById('streak-pill'),
      streakVal:  document.getElementById('streak-val'),
    };
    return this._tbEls;
  },
  updateTopBar() {
    const e = this._getTopBarEls();
    if (e.money) e.money.textContent=`€${State.money.toFixed(2)}`;
    if (e.rep)   e.rep.textContent=`★ ${r0(State.reputation)}`;
    if (e.level) e.level.textContent=State.bizLevel;
    if (State.passivePerMin>0 && e.passive) e.passive.textContent=`€${(State.passivePerMin*60).toFixed(0)}/h`;
    if (e.burnPill && e.burnVal) {
      const pm = (State._lastExpenseBreakdown || Expenses.calcPM());
      e.burnVal.textContent = `€${pm.totalPM.toFixed(1)}`;
      e.burnVal.style.color = pm.totalPM > 0 ? 'var(--danger)' : 'var(--text-dim)';
    }
    if (e.proBt && State.isPro) { e.proBt.textContent='⚡ Pro Active'; e.proBt.classList.add('owned'); }
    if (e.streakPill && e.streakVal) {
      if (State.stats.currentStreak >= 3) {
        e.streakPill.style.display = 'flex';
        e.streakVal.textContent = State.stats.currentStreak;
      } else {
        e.streakPill.style.display = 'none';
      }
    }
  },
  renderPrinters() {
    const panel = $el('printers-panel'); panel.innerHTML='';
    State.printers.forEach((p,idx)=>{
      const div=document.createElement('div');
      div.className=`printer-card ${p.active?'active':p.health<20?'error':'idle'}`;
      const hc = p.health>60?'var(--accent3)':p.health>30?'var(--warn)':'var(--danger)';
      const sc = p.active?'status-printing':(p.health<10?'status-error':'status-idle');
      const st = p.active?'● Bezig':(p.health<10?'! Fout':'○ Vrij');
      const stDot = p.active ? 'var(--accent)' : (p.health<10 ? 'var(--danger)' : 'var(--text-dim)');
      const spec = Specialization.get(idx);
      const specTag = spec ? `<span class="spec-tag spec-tag-${spec}">${Specialization.SPECS[spec].icon} ${Specialization.SPECS[spec].name}</span>` : '';
      const model = p.model || 'BASIC';
      const modelConf = CONFIG.PRINTER_MODELS[model];
      const modelTagIcon = model === 'SPEED' ? '⚡' : model === 'DELTA' ? '🔷' : '🏭';
      const modelTagColor = model === 'SPEED' ? 'rgba(255,61,90,0.15);border-color:rgba(255,61,90,0.3);color:#ff6b8a' : model === 'DELTA' ? 'rgba(0,229,255,0.15);border-color:rgba(0,229,255,0.3);color:var(--accent)' : 'rgba(127,255,110,0.15);border-color:rgba(127,255,110,0.3);color:#7fff6e';
      const modelTag = model !== 'BASIC' ? `<span class="spec-tag" style="background:${modelTagColor};">${modelTagIcon} ${modelConf.name}</span>` : '';
      let prog='';
      if (p.active&&p.job) prog=`<div class="progress-wrap"><div class="progress-label"><span>${p.job.name}</span><span>${Math.round(p.progress*100)}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${p.progress*100}%"></div></div></div>`;
      const specBtns = !p.active ? `<div style="display:flex;gap:4px;margin-top:6px;">
        <div class="spec-btn${spec==='speed'?' active-spec spec-speed':''}" onclick="Specialization.set(${idx},'speed')" title="Snel: -25% printtijd">⚡ Snel</div>
        <div class="spec-btn${spec==='quality'?' active-spec spec-quality':''}" onclick="Specialization.set(${idx},'quality')" title="Kwaliteit: +20% winst">💎 Kwal.</div>
        <div class="spec-btn${spec==='economy'?' active-spec spec-economy':''}" onclick="Specialization.set(${idx},'economy')" title="Zuinig: -50% filamentkosten">💰 Zuinig</div>
      </div>` : '';
      const temp = r0(State.printerTemps?.[idx] ?? 25);
      const tempColor = Temperature.getColor(temp);
      const tempLabel = Temperature.getLabel(temp);
      const tempHtml = `<div class="temp-bar-wrap"><div class="temp-bar-label"><span>🌡️ ${temp}°C</span><span style="color:${tempColor}">${tempLabel}</span></div><div class="temp-bar"><div class="temp-fill" style="width:${temp}%;background:${tempColor}"></div></div></div>`;
      div.innerHTML=`<div class="printer-name" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <span class="printer-name-editable" onclick="UI.renamePrinter(${idx})" title="Tik om te hernoemen">✏️ ${p.name}</span>${specTag}${modelTag}
        <span class="printer-status ${sc}" style="border-left:3px solid ${stDot};padding-left:6px">${st}</span>
      </div>${prog}<div class="printer-stats"><div class="pstat"><div class="pstat-label">Gezondheid</div><div class="pstat-value" style="color:${hc}">${r0(p.health)}%</div></div><div class="pstat"><div class="pstat-label">Filament</div><div class="pstat-value" style="color:var(--accent)">${p.active&&p.job?p.job.filament:'—'}</div></div></div><div class="health-bar"><div class="health-fill" style="width:${p.health}%;background:${hc}"></div></div>${tempHtml}${!p.active&&p.health<100?`<button class="btn btn-sm btn-warn btn-full" style="margin-top:8px" onclick="Game.repairPrinter(${idx})">🔧 Repareer (€${(((100-p.health)*CONFIG.REPAIR_COST_PER_HP)*(Season.current?.repairDiscount||1)).toFixed(0)})</button>`:''}${p.active?`<button class="btn btn-sm btn-ghost btn-full" style="margin-top:4px;font-size:11px" onclick="State.viewingPrinterIdx=${idx};UI.renderCenterPanel()">👁 Bekijk Job</button>`:''}${specBtns}`;
      panel.appendChild(div);
    });
  },
  renderOrders() {
    const body   = $el('ptab-body-orders');
    const noMsg  = $el('no-orders-msg');
    Array.from(body.children).forEach(c=>{ if(c.id!=='no-orders-msg') c.remove(); });
    const badge  = $el('order-badge');
    if (State.orders.length===0) { noMsg.style.display='block'; badge.style.display='none'; return; }
    noMsg.style.display='none'; badge.style.display='inline-block'; badge.textContent=State.orders.length;
    State.orders.forEach(o=>{
      const card=document.createElement('div');
      const fc = o.filament === 'RESIN' ? 'resin' : o.filament === 'TPU' ? 'tpu' : filClass(o.filament);
      card.className=`order-card order-${fc}${o.urgent ? ' urgent-card' : ''}${o.isFlash ? ' order-flash' : ''}`;
      const sel = State.pendingOrder&&State.pendingOrder.id===o.id;
      if (sel) card.style.borderColor='var(--accent)';
      const tpct=(o.timeLeft/((o.expiresIn||o.expireTime)||(o.urgent?45:CONFIG.ORDER_EXPIRE_S)))*100;
      const mMult = Market.getMultiplier(o.filament);
      const mBadge = mMult >= 1.15 ? `<span class="market-bonus">▲ ×${mMult.toFixed(2)}</span>` :
                     mMult <= 0.85 ? `<span class="market-bonus market-malus">▼ ×${mMult.toFixed(2)}</span>` : '';
      const loyaltyLevel = CustomerLoyalty.getLoyaltyLevel(o.customer);
      const loyBadge = loyaltyLevel ? `<span class="loyalty-badge">${loyaltyLevel}</span>` : '';
      const tierBadge = ClientTiers.getBadge(o.customer);
      const ot = o.orderType || 'normal';
      const specialBadge = ot !== 'normal' ? `<span class="tag ${SpecialOrders.getTagClass(ot)}">${SpecialOrders.getLabel(ot)}</span>` : '';
      if (ot !== 'normal') card.classList.add(`order-${ot}`);
      const hr = new Date().getHours();
      const isNight = hr >= 22 || hr < 4;
      const nightBadge = isNight ? '<span class="tag" style="background:rgba(100,80,200,0.3);color:#b39ddb">🌙 +20%</span>' : '';
      const countdownStr = o.isFlash
        ? `<span class="flash-countdown" style="margin-left:4px">⚡${r0(o.timeLeft)}s</span>`
        : o.urgent ? `<span style="color:var(--danger);font-weight:900;font-size:10px;margin-left:4px">⏱${r0(o.timeLeft)}s</span>` : '';
      card.innerHTML=`<div class="order-header"><div><div class="order-name">${o.name}${mBadge}</div><div style="color:var(--text-dim);font-size:11px;margin-top:2px">${o.customer}${loyBadge}${tierBadge}</div></div><div class="order-reward">€${o.reward.toFixed(2)}</div></div><div class="order-meta"><span class="tag tag-${fc}">${o.filament}</span><span class="tag tag-time">⏱ ${r0(o.printTime)}s</span>${specialBadge}${o.urgent?`<span class="tag tag-diff">⚡ URGENT${countdownStr}</span>`:''}${nightBadge}</div><div class="order-timer"><div class="order-timer-fill" style="width:${tpct}%"></div></div><div style="display:flex;gap:4px;margin-top:6px;"><button class="btn btn-primary btn-sm" style="flex:2;font-size:10px;letter-spacing:0.5px;" id="accept-${o.id}" title="Selecteer deze order: kies filament &amp; kwaliteit, dan start de print">▶ Selecteer</button>${State.isPro ? `<button class="btn btn-sm btn-ghost" style="flex:1;font-size:11px" id="q-${o.id}" title="Voeg toe aan wachtrij — start automatisch bij vrije printer">📋 Queue</button>` : `<button class="btn btn-sm" style="flex:1;font-size:10px;background:rgba(124,58,237,0.15);color:var(--pro);border:1px solid rgba(167,139,250,0.3)" onclick="event.stopPropagation();switchPTab('queue')" title="Queue is een Pro functie — tik voor meer info">⚡ Queue</button>`}${!o.negotiated?`<button class="btn btn-sm btn-ghost" style="font-size:11px;color:var(--accent)" id="neg-${o.id}" title="Onderhandel voor +25% beloning (40% kans)">🤝</button>`:''}</div>`;
      card.querySelector(`#accept-${o.id}`)?.addEventListener('click', ev => { ev.stopPropagation(); Game.selectOrder(o); });
      card.querySelector(`#q-${o.id}`)?.addEventListener('click', ev => { ev.stopPropagation(); Queue.add(o, null, null); });
      card.querySelector(`#neg-${o.id}`)?.addEventListener('click', ev => { ev.stopPropagation(); Negotiation.counterOffer(o.id); });
      card.onclick=()=>Game.selectOrder(o);
      body.appendChild(card);
    });
  },
  renderContracts() {
    const body   = $el('ptab-body-contracts');
    const noMsg  = $el('no-contracts-msg');
    Array.from(body.children).forEach(c=>{ if(c.id!=='no-contracts-msg') c.remove(); });
    const badge  = $el('contract-badge');
    const active = State.contracts.filter(c=>!c.completed&&c.timeLeft>0);
    if (active.length===0) { noMsg.style.display='block'; badge.style.display='none'; return; }
    noMsg.style.display='none'; badge.style.display='inline-block'; badge.textContent=active.length;
    active.forEach(c=>{
      const card=document.createElement('div');
      card.className=`contract-card ${c.isDaily?'daily':'regular'} ${c.accepted?'active-c':''} ${c.completed?'completed-c':''}`;
      const timeStr=c.timeLeft>3600?`${Math.floor(c.timeLeft/3600)}h`:c.timeLeft>60?`${Math.floor(c.timeLeft/60)}m`:r0(c.timeLeft)+'s';
      const reqsHtml=c.reqs.map(r=>{
        const pct=Math.round((r.done/r.required)*100);
        const fc=filClass(r.filament);
        return `<div class="contract-req-item"><span class="tag tag-${fc}" style="font-size:8px">${r.filament}</span><div class="contract-req-bar"><div class="contract-req-fill" style="width:${pct}%"></div></div><span class="contract-req-label">${r.done}/${r.required}</span></div>`;
      }).join('');
      card.innerHTML=`<div class="contract-header"><div><div class="contract-name">${c.name}</div><div style="color:var(--text-dim);font-size:11px;margin-top:2px">${c.customer}</div></div><div style="text-align:right"><div class="contract-reward">€${c.reward}</div><div style="color:var(--text-dim);font-size:11px">+${c.bonusRep} rep</div></div></div><div class="contract-req">${reqsHtml}</div><div class="contract-timer">⏳ Expires in ${timeStr}</div>${!c.accepted?`<div class="contract-actions"><button class="btn btn-warn btn-sm btn-full" onclick="Contracts.accept('${c.id}')">Accept Contract</button></div>`:'<div style="color:var(--accent);font-size:11px;margin-top:6px;letter-spacing:1px">✓ TRACKING PROGRESS</div>'}`;
      body.appendChild(card);
    });
  },

  // ── CENTER PANEL ──────────────────────────────────────────
  renderCenterPanel() {
    const empty   = $el('job-empty');
    const content = $el('job-content');
    const anyActive = State.printers.some(p=>p.active);

    if (State.pendingOrder) {
      empty.style.display='none'; content.style.display='flex';
      this._renderConfigureMode(State.pendingOrder); return;
    }
    // Keep content visible if a spaghetti failure overlay is still showing
    const hasSpaghettiOverlay = document.querySelector('#job-content .spaghetti-overlay');
    if (anyActive || hasSpaghettiOverlay) {
      empty.style.display='none'; content.style.display='flex';
      const viewed = State.printers[State.viewingPrinterIdx];
      if (!viewed||!viewed.active) {
        const first=State.printers.find(p=>p.active);
        if (first) State.viewingPrinterIdx=State.printers.indexOf(first);
      }
      if (anyActive) this._renderMonitorMode(); return;
    }
    empty.style.display='flex'; empty.style.flexDirection='column'; content.style.display='none';
    const tabs=$el('center-printer-tabs'); if(tabs) tabs.innerHTML='';
    // Draw idle canvas even when empty state is shown
    const badge = document.getElementById('stage-badge');
    const nameEl2 = document.getElementById('stage-job-name');
    if (badge)   { badge.textContent = 'IDLE'; badge.className = 'stage-status-badge idle'; }
    if (nameEl2) nameEl2.textContent = 'Printer gereed';
    const stage = document.getElementById('print-stage');
    if (stage) { stage.classList.remove('printing','success-flash','fail-flash','stage-pop','stage-fail'); }
    PrintCanvas.draw(0, null, false);
    // v17.5 fix: reset arc/progress elements so stale % never shows after job ends
    const _rArcTrack = document.getElementById('arc-track');
    const _rArcPct   = document.getElementById('arc-pct');
    const _rArcTime  = document.getElementById('arc-time');
    const _rLayerFill= document.getElementById('layer-fill-bar');
    const _rLayerTxt = document.getElementById('layer-count-text');
    if (_rArcTrack) _rArcTrack.setAttribute('stroke-dashoffset','163.4');
    if (_rArcPct)   _rArcPct.textContent  = '—';
    if (_rArcTime)  _rArcTime.textContent  = 'Selecteer een order om te beginnen';
    if (_rLayerFill) _rLayerFill.style.width = '0%';
    if (_rLayerTxt)  _rLayerTxt.textContent = 'Laag 0 / 0';
  },
  renderActiveJob() { this.renderCenterPanel(); }, // alias

  _renderConfigureMode(order) {
    const fil=State.selectedFilament; const qual=State.selectedQuality;
    $el('job-title').textContent=order.name;
    $el('job-subtitle').innerHTML=`<span class="mode-label mode-configure">Configure</span> ${order.customer}`;
    $el('jstat-filament').textContent=fil;
    $el('jstat-filament').style.color=CONFIG.FILAMENTS[fil].color;
    $el('jstat-quality').textContent=qual;
    $el('jstat-time').textContent=`${Printer.calcTime(order,qual,State.selectedPrinterIdx)}s`;
    const profit=Printer.calcProfit(order,fil,qual,State.selectedPrinterIdx);
    const _hr2 = new Date().getHours();
    const _isNight = _hr2 >= 22 || _hr2 < 4;
    $el('jstat-profit').textContent=`€${profit.toFixed(2)}${_isNight ? ' 🌙' : ''}`;
    const failPct=Math.round(Printer.calcFailChance(fil,qual,State.selectedPrinterIdx)*100);

    // Update new stage UI
    const nameEl = document.getElementById('stage-job-name');
    const badge  = document.getElementById('stage-badge');
    if (nameEl) nameEl.textContent = order.name;
    if (badge)  { badge.textContent = 'CONFIG'; badge.className = 'stage-status-badge configuring'; }

    const stage = document.getElementById('print-stage');
    if (stage) { stage.classList.remove('printing'); stage.classList.remove('success-flash','fail-flash'); }

    const arcPctEl = document.getElementById('arc-pct');
    const arcTimeEl = document.getElementById('arc-time');
    if (arcPctEl)  arcPctEl.textContent = failPct + '%';
    if (arcTimeEl) arcTimeEl.innerHTML = `<span style="color:var(--warn)">⚠ faalrisico</span> · ${order.filament} · ${Printer.calcTime(order,qual,State.selectedPrinterIdx)}s`;
    const arcTrack = document.getElementById('arc-track');
    if (arcTrack) {
      arcTrack.setAttribute('stroke-dashoffset', '163.4');
      arcTrack.setAttribute('stroke', 'var(--warn)');
      arcTrack.style.filter = 'drop-shadow(0 0 4px var(--warn))';
    }

    const layerFill = document.getElementById('layer-fill-bar');
    const layerText = document.getElementById('layer-count-text');
    if (layerFill) layerFill.style.width = '0%';
    if (layerText) layerText.textContent = 'Laag 0 / 0';

    // Telemetry — show idle state
    const nEl = document.getElementById('telem-nozzle');
    const bEl = document.getElementById('telem-bed');
    const sEl = document.getElementById('telem-speed');
    const lEl = document.getElementById('telem-layer');
    if (nEl) { nEl.textContent = '25°'; nEl.className = 'telem-value cool'; }
    if (bEl) { bEl.textContent = '25°'; bEl.className = 'telem-value cool'; }
    if (sEl) sEl.textContent = '0';
    if (lEl) lEl.textContent = '0';

    $el('start-job-btn').style.display='block';
    $el('cancel-job-btn').style.display='none';
    this._renderCenterTabs(false);
    this.renderFilamentRow(fil); this.renderQualityRow(qual);
    this._renderEffectBanner();

    // Show product preview in canvas at 0%
    PrintCanvas.draw(0, order, false);
  },
  _renderMonitorMode() {
    const printer=State.printers[State.viewingPrinterIdx]; if(!printer||!printer.job) return;
    const job=printer.job;

    // Stage header
    const nameEl = document.getElementById('stage-job-name');
    const badge  = document.getElementById('stage-badge');
    if (nameEl) nameEl.textContent = job.name;
    if (badge)  { badge.textContent = 'PRINTING'; badge.className = 'stage-status-badge'; }
    const stage = document.getElementById('print-stage');
    if (stage) { stage.classList.add('printing'); stage.classList.remove('success-flash','fail-flash'); }

    // Arc progress
    const pct = Math.round(printer.progress * 100);
    const arcTrack = document.getElementById('arc-track');
    if (arcTrack) {
      const circ = 163.4;
      arcTrack.setAttribute('stroke-dashoffset', (circ - circ * printer.progress).toFixed(1));
      // Color by progress
      const col = printer.progress < 0.5 ? 'var(--accent)' : printer.progress < 0.85 ? 'var(--accent3)' : '#ff6b35';
      arcTrack.setAttribute('stroke', col);
      arcTrack.style.filter = `drop-shadow(0 0 5px ${col})`;
    }
    const arcPct = document.getElementById('arc-pct');
    if (arcPct) arcPct.textContent = pct + '%';
    const arcTime = document.getElementById('arc-time');
    if (arcTime) {
      const left = Math.max(0, Math.round(printer.timeLeft));
      arcTime.innerHTML = `Nog <strong>${left}s</strong> · ${job.filament} / ${job.quality}`;
    }

    // Layer counter (simulate layers)
    const totalLayers = Math.round((printer.totalTime || 60) * 0.8);
    const currentLayer = Math.round(printer.progress * totalLayers);
    const layerEl = document.getElementById('telem-layer');
    const layerSub = document.getElementById('telem-layer-sub');
    const layerFill = document.getElementById('layer-fill-bar');
    const layerText = document.getElementById('layer-count-text');
    if (layerEl)   layerEl.textContent = currentLayer;
    if (layerSub)  layerSub.textContent = '/ ' + totalLayers;
    if (layerFill) layerFill.style.width = pct + '%';
    if (layerText) layerText.textContent = `Laag ${currentLayer} / ${totalLayers}`;

    // Telemetry (temperature from Temperature system)
    const tempData = State.printerTemps?.[State.viewingPrinterIdx] ?? 25;
    const nozzleTemp = Math.round(25 + tempData * 1.95); // scale 25-220
    const bedTemp    = Math.round(20 + tempData * 0.4);  // scale 20-60
    const speedMM    = Math.round(40 + (State.speedMult || 1) * 20);
    const nozzleEl = document.getElementById('telem-nozzle');
    const bedEl    = document.getElementById('telem-bed');
    const speedEl  = document.getElementById('telem-speed');
    if (nozzleEl) { nozzleEl.textContent = nozzleTemp + '°'; nozzleEl.className = 'telem-value ' + (nozzleTemp > 180 ? 'hot' : 'cool'); }
    if (bedEl)    { bedEl.textContent = bedTemp + '°'; bedEl.className = 'telem-value cool'; }
    if (speedEl)  { speedEl.textContent = speedMM; }

    // Legacy compat (for code that still references these)
    const lbpf = $el('big-prog-fill'); if (lbpf) lbpf.style.width = pct + '%';
    const lbpt = $el('big-prog-text'); if (lbpt) lbpt.textContent = `${pct}%`;
    const jts  = $el('jstat-time');    if (jts)  jts.textContent = `${Math.max(0,r0(printer.timeLeft))}s`;
    const jfl  = $el('jstat-filament'); if (jfl) { jfl.textContent=job.filament; jfl.style.color=CONFIG.FILAMENTS[job.filament]?.color||'var(--text)'; }
    const jq   = $el('jstat-quality'); if (jq)  jq.textContent = job.quality;
    const jp   = $el('jstat-profit');  if (jp)  jp.textContent = `€${job.profit.toFixed(2)}`;

    // job title / subtitle (legacy center panel)
    const jt = $el('job-title');    if (jt) jt.textContent = job.name;
    const js = $el('job-subtitle'); if (js) js.innerHTML = `<span class="mode-label mode-monitor">Printing</span> ${job.customer} · ${printer.name}`;

    $el('start-job-btn').style.display='none';
    $el('cancel-job-btn').style.display='block';
    this._renderCenterTabs(true);
    const fr=$el('filament-row'); if(fr) fr.parentElement.style.display='none';
    const qr=$el('quality-row'); if(qr) qr.parentElement.style.display='none';
    this._renderEffectBanner();

    // Drive the print canvas
    PrintCanvas.draw(printer.progress || 0, job, true);
  },
  _renderCenterTabs(monitorMode) {
    const el = document.getElementById('center-printer-tabs'); if(!el) return; el.innerHTML='';
    if (State.printers.length<2) return;
    State.printers.forEach((p,idx)=>{
      const isViewing = State.viewingPrinterIdx===idx&&monitorMode;
      const isSelected= State.selectedPrinterIdx===idx&&!monitorMode;
      const btn=document.createElement('div');
      const dc=p.active?'printing':(p.health<10?'error':'idle');
      btn.className=`printer-tab ${(isViewing||isSelected)?(p.active?'active-printing':'active'):''}`;
      btn.innerHTML=`<span class="tab-dot ${dc}"></span>${p.name}`;
      if (monitorMode) { btn.onclick=()=>{ State.viewingPrinterIdx=idx; this.renderCenterPanel(); }; }
      else {
        if (p.active) { btn.style.opacity='0.4'; btn.style.cursor='not-allowed'; btn.title='Busy'; }
        else btn.onclick=()=>{ State.selectedPrinterIdx=idx; this.renderCenterPanel(); };
      }
      el.appendChild(btn);
    });
  },
  _renderEffectBanner() {
    const b=$el('effect-banner'); if(!b) return; b.innerHTML='';
    if (State.bulkBonusJobs>0)     b.innerHTML+=`<span class="effect-tag effect-bulk">📦 Bulk ×${State.bulkBonusJobs}</span>`;
    if (State.filDiscountJobs>0)   b.innerHTML+=`<span class="effect-tag effect-disc">💸 −50% filament ×${State.filDiscountJobs}</span>`;
    if (State.nextFailBoost>0)     b.innerHTML+=`<span class="effect-tag effect-warn">⚠ Fail +${Math.round(State.nextFailBoost*100)}%</span>`;
  },

  renderFilamentRow(sel) {
    const row=$el('filament-row'); if(!row) return;
    row.parentElement.style.display='';
    row.innerHTML='';
    ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'].forEach(id=>{
      const f=CONFIG.FILAMENTS[id];
      const locked=State.reputation<f.unlockRep;
      const upgradeRequired = (id==='TPU' && !State.tpuUnlocked) || (id==='RESIN' && !State.resinUnlocked) || (id==='CF' && !State.cfUnlocked) || (id==='GLOW' && !State.glowUnlocked);
      const stock = State.filamentStock[id] || 0;
      const noStock = stock <= 0 && !locked && !upgradeRequired;
      const fc=id.toLowerCase();
      const btn=document.createElement('div');
      btn.className=`filament-btn ${(locked||upgradeRequired||noStock)?'locked-fil':''} ${sel===id?`selected-${fc}`:''}`;
      const statText = locked ? `★${f.unlockRep} rep` : upgradeRequired ? '🔒 upgrade nodig' : noStock ? '📦 geen voorraad' : `${stock} stuks`;
      btn.innerHTML=`<div class="fil-name fil-${fc}">${f.name}</div><div class="fil-stat">${statText}</div>`;
      if (!locked && !upgradeRequired && !noStock) btn.onclick=()=>{ State.selectedFilament=id; UI.renderCenterPanel(); };
      row.appendChild(btn);
    });
  },
  renderQualityRow(sel) {
    const row=$el('quality-row'); if(!row) return;
    row.parentElement.style.display='';
    row.innerHTML='';
    Object.entries(CONFIG.QUALITY).forEach(([id,q])=>{
      const btn=document.createElement('div'); btn.className=`quality-btn ${sel===id?'selected':''}`;
      btn.innerHTML=`<div class="quality-label">${q.name}</div>`;
      btn.onclick=()=>{ State.selectedQuality=id; UI.renderCenterPanel(); };
      row.appendChild(btn);
    });
  },
  renderShop() {
    const container=$el('shop-upgrades'); container.innerHTML='';
    // Pro banner if not owned
    if (!State.isPro) {
      const banner=document.createElement('div');
      banner.style.cssText='background:linear-gradient(135deg,rgba(124,58,237,0.15),rgba(167,139,250,0.08));border:1px solid rgba(167,139,250,0.4);border-radius:var(--radius);padding:12px;margin-bottom:2px;cursor:pointer;';
      banner.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><span style="font-family:var(--display);font-weight:900;font-size:15px;color:var(--pro)">⚡ GO PRO</span><span style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--pro)">€4.99</span></div><div style="color:var(--text-dim);font-size:10px;">Unlock Smart Queue, AI QC, Supplier AI. One-time purchase.</div>`;
      banner.onclick=()=>Game.showProModal();
      container.appendChild(banner);
    }
    // Group by category
    const categories = [
      { id:'reliability', label:'🔧 Betrouwbaarheid' },
      { id:'speed',       label:'⚡ Snelheid' },
      { id:'profit',      label:'💰 Winst & Passief' },
      { id:'expansion',   label:'🏭 Uitbreiding' },
      { id:'pro',         label:'⚡ Pro Upgrades', proOnly:true },
    ];
    categories.forEach(cat => {
      const upgrades = CONFIG.UPGRADES.filter(u => u.category === cat.id);
      if (upgrades.length === 0) return;
      const header = document.createElement('div');
      header.className = 'upgrade-category';
      header.textContent = cat.label;
      container.appendChild(header);
      upgrades.forEach(upg=>{
        const owned=State.ownedUpgrades.includes(upg.id);
        const affordable=r2(State.money)>=upg.cost;
        const unlocked=State.bizLevel>=upg.unlockLevel;
        const proLocked=upg.premium&&!State.isPro;
        const card=document.createElement('div');
        card.className=`upgrade-card ${owned?'owned':proLocked?'pro-locked':(affordable&&unlocked?'affordable':'')} ${!unlocked&&!upg.premium?'locked-upg':''}`;
        const _btnLabel = owned ? '' : proLocked ? '⚡ Ontgrendel met Pro' : !unlocked ? `🔒 Vereist Level ${upg.unlockLevel}` : !affordable ? `Nog €${r2(upg.cost - r2(State.money)).toFixed(2)} te kort` : 'KOPEN';
        const _btnDis = (!upg.premium && (!unlocked || !affordable)) ? 'disabled' : '';
        card.innerHTML=`<div class="upgrade-header"><div class="upgrade-name">${upg.name} ${owned?'✓':''} ${upg.premium?`<span class="pro-badge">PRO</span>`:''}</div><div class="upgrade-cost">${owned?'✓ Gekocht':upg.premium?'PRO':'€'+upg.cost.toLocaleString()}</div></div><div class="upgrade-desc">${upg.desc}</div><div class="upgrade-effect">${upg.effect}</div>${!owned?`<button class="btn btn-${proLocked?'pro':'primary'} btn-sm btn-full" style="margin-top:6px" onclick="Shop.buy('${upg.id}')" ${_btnDis}>${_btnLabel}</button>`:''}`;
        container.appendChild(card);
      });
    });
    // v8: Late-game upgrades section
    const v8Upgs = (CONFIG.UPGRADES_V8||[]).filter(u => !u.premium);
    if (v8Upgs.length > 0) {
      const header = document.createElement('div');
      header.className = 'upgrade-category';
      header.innerHTML = '🚀 Geavanceerde Upgrades';
      container.appendChild(header);
      v8Upgs.forEach(upg=>{
        const owned=State.ownedUpgrades.includes(upg.id);
        const affordable=r2(State.money)>=upg.cost;
        const unlocked=State.bizLevel>=upg.unlockLevel;
        const tier = upg.cost >= 10000 ? 'tier4' : upg.cost >= 5000 ? 'tier3' : '';
        const card=document.createElement('div');
        card.className=`upgrade-card ${tier} ${owned?'owned':(affordable&&unlocked?'affordable':'')} ${!unlocked?'locked-upg':''}`;
        card.innerHTML=`<div class="upgrade-header"><div class="upgrade-name">${upg.name} ${owned?'✓':''}</div><div class="upgrade-cost">${owned?'Gekocht':'€'+upg.cost.toLocaleString()}</div></div><div class="upgrade-desc">${upg.desc}</div><div class="upgrade-effect">${upg.effect}</div>${!unlocked?`<div style="color:var(--danger);font-size:11px;margin-top:4px">🔒 Level ${upg.unlockLevel}</div>`:''}${!owned&&unlocked?`<button class="btn btn-primary btn-sm btn-full" style="margin-top:6px" onclick="Shop.buy('${upg.id}')" ${!affordable?'disabled':''}>Kopen</button>`:''}`;
        container.appendChild(card);
      });
    }
  },
  renderBizLevel() {
    const lvls=CONFIG.BIZ_LEVELS;
    const cur=lvls[State.bizLevel-1]||lvls[lvls.length-1];
    const nxt=lvls[State.bizLevel]||null;
    const xpN=nxt?nxt.xp-cur.xp:1; const xpH=nxt?State.xp-cur.xp:xpN;
    const pct=Math.min(100,Math.round((xpH/xpN)*100));
    $el('biz-level-name').textContent=cur.name.toUpperCase();
    $el('biz-level-sub').textContent=`Level ${State.bizLevel} · ${r0(xpH)} / ${r0(xpN)} XP`;
    $el('biz-xp-fill').style.width=pct+'%';
  },
  renderAchievements() {
    const el = document.getElementById('achiev-list'); if (!el) return;
    el.innerHTML = CONFIG.ACHIEVEMENTS.map(a => {
      const u = State.achievements.includes(a.id);
      return `<div class="achiev-card ${u?'unlocked':'locked'}">
        <div class="achiev-header"><span class="achiev-icon">${u?'🏆':'🔒'}</span><span class="achiev-title" style="color:${u?'var(--accent3)':'var(--text-dim)'}">${a.name}</span></div>
        <div class="achiev-desc">${a.desc}</div>
      </div>`;
    }).join('');
  },
  renderStats() {
    const s=State.stats; const el = document.getElementById('stats-panel'); if(!el) return;
    const sessionMin=Math.round((Date.now()-s.sessionStart)/60000);
    const earningsPerMin=sessionMin>0?(s.totalEarned/sessionMin).toFixed(2):0;
    const successRate=s.totalPrints>0?Math.round((s.jobsDone/s.totalPrints)*100):0;
    el.innerHTML=[
      ['Jobs Gedaan',   s.jobsDone,    `${s.jobsFailed} mislukt`],
      ['Totaal Verdiend', `€${s.totalEarned.toFixed(2)}`, `€${earningsPerMin}/min gem.`],
      ['Slaagkans',    `${successRate}%`, `${s.totalPrints} totaal`],
      ['Beste Streak', s.longestStreak, `Huidig: ${s.currentStreak||0}`],
      ['Reputatie',    r0(State.reputation), `${s.repEarned} verdiend`],
      ['Contracten',   s.contractsDone, `${s.dailyDone} dagelijks`],
      ['Upgrades',     s.upgradesBought, State.isPro?'PRO':'Gratis'],
      ['Sessie',       `${sessionMin}m`, 'sinds laden'],
      ['PA6 Jobs',     s.pa6Done||0, 'engineeringkwaliteit'],
      ['PETG Jobs',    s.petgDone||0, 'flexibele jobs'],
      ['TPU Jobs',     s.tpuDone||0, 'flexibel materiaal'],
      ['Resin Jobs',   s.resinDone||0, 'SLA precisie'],
      ['Nachtdiensten', s.nightShiftJobs||0, 'na 22:00'],
      ['Passief €',    `€${(s.passiveEarned||0).toFixed(0)}`, 'via winkel'],
      ['Ketens Klaar', s.chainsDone||0, 'productieketens'],
    ].map(([k,v,sub])=>`<div class="stat-box"><div class="stat-box-label">${k}</div><div class="stat-box-value">${v}</div><div class="stat-box-sub">${sub||''}</div></div>`).join('');
  },

  // ── CANVAS GRAPH ──────────────────────────────────────────
  renderGraphCanvas() {
    const canvas=$el('income-canvas'); if(!canvas) return;
    const data=State.incomeHistory;
    const W=canvas.offsetWidth||240; const H=120;
    canvas.width=W; canvas.height=H;
    const ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,W,H);
    if (data.length<2) {
      ctx.fillStyle='rgba(90,100,128,0.4)'; ctx.font='11px monospace'; ctx.textAlign='center';
      ctx.fillText('Complete jobs to see income history',W/2,H/2); return;
    }
    const vals=data.map(d=>d.v);
    const max=Math.max(...vals)*1.2||1;
    const min=0;
    const pad={l:36,r:10,t:12,b:20};
    const cW=W-pad.l-pad.r; const cH=H-pad.t-pad.b;
    // Grid
    ctx.strokeStyle='rgba(42,48,69,0.6)'; ctx.lineWidth=1;
    [0,0.25,0.5,0.75,1].forEach(f=>{
      const y=pad.t+cH*(1-f);
      ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
      ctx.fillStyle='rgba(90,100,128,0.6)'; ctx.font='9px monospace'; ctx.textAlign='right';
      ctx.fillText('€'+r0(max*f),pad.l-4,y+3);
    });
    // Area fill
    const pts=data.map((d,i)=>({ x:pad.l+i*(cW/(data.length-1)), y:pad.t+cH*(1-(d.v-min)/(max-min)) }));
    const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+cH);
    grad.addColorStop(0,'rgba(0,229,255,0.3)'); grad.addColorStop(1,'rgba(0,229,255,0)');
    ctx.beginPath(); ctx.moveTo(pts[0].x,pad.t+cH);
    pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.lineTo(pts[pts.length-1].x,pad.t+cH); ctx.closePath();
    ctx.fillStyle=grad; ctx.fill();
    // Line
    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
    pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.strokeStyle='var(--accent)'; ctx.lineWidth=2; ctx.stroke();
    // Dots — color by type
    const typeColor={job:'var(--accent)',passive:'var(--accent3)',contract:'var(--warn)'};
    data.forEach((d,i)=>{
      ctx.beginPath(); ctx.arc(pts[i].x,pts[i].y,3,0,Math.PI*2);
      ctx.fillStyle=typeColor[d.type]||'var(--accent)'; ctx.fill();
    });
    // Latest value
    const last=data[data.length-1];
    ctx.fillStyle='var(--text-bright)'; ctx.font='bold 10px monospace'; ctx.textAlign='left';
    ctx.fillText(fmtEur(last.v),pts[pts.length-1].x-20,pts[pts.length-1].y-8);
  },

  renderPieChart() {
    const canvas = $el('pie-canvas'); if (!canvas) return;
    const s = State.stats;
    const petg = s.petgDone || 0;
    const pa6  = s.pa6Done  || 0;
    const tpu  = s.tpuDone  || 0;
    const resin= s.resinDone|| 0;
    const cf   = s.cfDone   || 0;
    const glow = s.glowDone || 0;
    const pla  = Math.max(0, (s.jobsDone || 0) - petg - pa6 - tpu - resin - cf - glow);
    const total = pla + petg + pa6 + tpu + resin + cf + glow;
    const legend = $el('pie-legend');
    if (total === 0) {
      const ctx = canvas.getContext('2d');
      canvas.width = 120; canvas.height = 120;
      ctx.clearRect(0,0,120,120);
      ctx.fillStyle = 'rgba(90,100,128,0.3)'; ctx.beginPath(); ctx.arc(60,60,54,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(90,100,128,0.6)'; ctx.font = '10px monospace'; ctx.textAlign = 'center'; ctx.fillText('No data yet', 60, 64);
      if (legend) legend.innerHTML = '';
      return;
    }
    const slices = [
      { label: 'PLA',   value: pla,   color: '#4fc3f7' },
      { label: 'PETG',  value: petg,  color: '#ce93d8' },
      { label: 'PA6',   value: pa6,   color: '#ffab40' },
      { label: 'TPU',   value: tpu,   color: '#ff9f43' },
      { label: 'Resin', value: resin, color: '#ee5a24' },
      { label: 'CF',    value: cf,    color: '#8888aa' },
      { label: 'Glow',  value: glow,  color: '#ccff00' },
    ].filter(s => s.value > 0);
    const ctx = canvas.getContext('2d');
    canvas.width = 120; canvas.height = 120;
    ctx.clearRect(0,0,120,120);
    let angle = -Math.PI / 2;
    slices.forEach(slice => {
      const sweep = (slice.value / total) * Math.PI * 2;
      ctx.beginPath(); ctx.moveTo(60,60);
      ctx.arc(60,60,54,angle,angle+sweep);
      ctx.closePath(); ctx.fillStyle = slice.color; ctx.fill();
      ctx.strokeStyle = '#0d0f14'; ctx.lineWidth = 2; ctx.stroke();
      angle += sweep;
    });
    ctx.beginPath(); ctx.arc(60,60,28,0,Math.PI*2);
    ctx.fillStyle = '#161b26'; ctx.fill();
    ctx.fillStyle = '#d4dae8'; ctx.font = 'bold 11px monospace'; ctx.textAlign = 'center';
    ctx.fillText(total, 60, 64);
    if (legend) {
      legend.innerHTML = slices.map(s =>
        `<div class="pie-legend-item"><div class="pie-dot" style="background:${s.color}"></div>${s.label} ${Math.round(s.value/total*100)}%</div>`
      ).join('');
    }
  },

  // ── FAILURE + SUCCESS ANIMATIONS ──────────────────────────
  showFailureAnimation(printerIdx, reason, jobName) {
  // Legacy red flash element (if present)
  const flash=$el('fail-flash');
  if (flash) {
    flash.classList.remove('flashing'); void flash.offsetWidth; flash.classList.add('flashing');
    setTimeout(()=>flash.classList.remove('flashing'),800);
  }

  // Shake specific printer card (left panel) + whole viewport (pain!)
  const cards=document.querySelectorAll('.printer-card');
  if (cards[printerIdx]) {
    cards[printerIdx].classList.remove('shaking'); void cards[printerIdx].offsetWidth;
    cards[printerIdx].classList.add('shaking');
    setTimeout(()=>cards[printerIdx].classList.remove('shaking'),600);
  }
  Particles.screenFlash('fail');
  Particles.shake();

  // Stage fail pulse (center panel)
  const stage = document.getElementById('print-stage');
  if (stage) {
    stage.classList.remove('fail-flash','stage-fail');
    void stage.offsetWidth;
    stage.classList.add('fail-flash','stage-fail');
    setTimeout(()=>stage.classList.remove('fail-flash','stage-fail'), 900);
  }

  // Nozzle sparks (fallback: sparks on canvas wrapper)
  const sparkTarget = document.getElementById('product-canvas-wrap') || document.querySelector('.printer-svg-wrap') || document.querySelector('.printer-visual');
  if (sparkTarget) Particles.nozzleSparks(sparkTarget);

  if (State.viewingPrinterIdx===printerIdx) this._spaghettiOverlay(reason,jobName);
},
  _spaghettiOverlay(reason, jobName) {
    const visual=$el('printer-visual'); if(!visual) return;
    const old=visual.querySelector('.spaghetti-overlay'); if(old) old.remove();
    const ov=document.createElement('div'); ov.className='spaghetti-overlay';
    const canvas=document.createElement('canvas'); canvas.style.cssText='position:absolute;inset:0;width:100%;height:100%;opacity:0.5;';
    ov.appendChild(canvas);
    ov.innerHTML+=`<div style="font-size:32px;z-index:1;position:relative;">🍝</div><div class="spaghetti-text">PRINT FAILED</div><div class="spaghetti-sub">${reason.toUpperCase()}</div><button class="btn btn-ghost btn-sm" style="margin-top:10px;z-index:1;position:relative;" onclick="this.closest('.spaghetti-overlay').remove()">Dismiss</button>`;
    visual.appendChild(ov);
    requestAnimationFrame(()=>{
      const rect=visual.getBoundingClientRect(); const W=rect.width||300; const H=rect.height||160;
      canvas.width=W; canvas.height=H;
      const c=canvas.getContext('2d');
      ['#ff3d5a','#ff6b35','#ffcc00','#ce93d8','#ff3d5a'].forEach(color=>{
        for (let s=0;s<4;s++) {
          c.beginPath(); c.strokeStyle=color; c.lineWidth=1.5+Math.random()*2; c.globalAlpha=0.4+Math.random()*0.4;
          let x=Math.random()*W; let y=Math.random()*H; c.moveTo(x,y);
          for(let j=0;j<10;j++){x+=(Math.random()-0.5)*60;y+=(Math.random()-0.5)*30;c.bezierCurveTo(x+(Math.random()-.5)*40,y+(Math.random()-.5)*20,x+(Math.random()-.5)*40,y+(Math.random()-.5)*20,x,y);}
          c.stroke();
        }
      });
    });
    setTimeout(()=>ov.remove(),7000);
  },
  showSuccessAnimation() {
  // Old SVG pulse (legacy)
  const v=$el('printer-visual');
  if (v) {
    v.classList.remove('success-pulse'); void v.offsetWidth; v.classList.add('success-pulse');
    setTimeout(()=>v.classList.remove('success-pulse'),900);
  }

  // New rich print stage pop + green border flash
  const stage = document.getElementById('print-stage');
  if (stage) {
    stage.classList.remove('success-flash','stage-pop');
    void stage.offsetWidth;
    stage.classList.add('success-flash','stage-pop');
    setTimeout(()=>stage.classList.remove('success-flash','stage-pop'), 900);
  }

  // Extra celebration burst (small, so it doesn't get noisy)
  Particles.screenBurst('#7fff6e', 18);
},

  showPopup(title, body, okCb, cancelCb) {
    $el('popup-title').textContent=title;
    $el('popup-body').innerHTML=body;
    $el('popup-box').className='popup';
    const ok=$el('popup-ok'); const can=$el('popup-cancel');
    can.style.display=cancelCb?'block':'none';
    ok.onclick=()=>{ closePopup(); if(okCb) okCb(); };
    can.onclick=()=>{ closePopup(); if(cancelCb) cancelCb(); };
    $el('popup-overlay').classList.add('visible');
  },

  showContractToast(c) {
    const el=document.createElement('div'); el.className='contract-toast';
    el.innerHTML=`<div style="font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--warn);margin-bottom:4px">🎯 Contract Complete!</div><div style="font-family:var(--display);font-weight:700;font-size:15px;color:var(--text-bright)">${c.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">+€${c.reward} · +${c.bonusRep} Rep</div>`;
    document.body.appendChild(el); setTimeout(()=>el.remove(),5000);
  },

  renderAll() {
    this.updateTopBar(); this.renderPrinters(); this.renderOrders(); this.renderContracts();
    this.renderCenterPanel(); this.renderShop(); this.renderBizLevel();
    this.renderAchievements(); this.renderStats(); this.renderGraphCanvas();
    this.updateBgLevel();
  },

  renamePrinter(idx) {
    const p = State.printers[idx];
    if (!p) return;
    const newName = prompt(`Nieuwe naam voor ${p.name}:`, p.name);
    if (newName && newName.trim()) {
      p.name = newName.trim().slice(0, 20);
      this.renderPrinters();
      UI.log(`Printer hernoemd naar "${p.name}"`, 'info');
    }
  },

  updateBgLevel() {
    const body = document.body;
    body.classList.remove('level-5','level-6','level-7','level-8');
    if (State.bizLevel >= 8) body.classList.add('level-8');
    else if (State.bizLevel >= 7) body.classList.add('level-7');
    else if (State.bizLevel >= 6) body.classList.add('level-6');
    else if (State.bizLevel >= 5) body.classList.add('level-5');
  },

  renderAchievements() {
    const el = document.getElementById('achiev-list'); el.innerHTML='';
    CONFIG.ACHIEVEMENTS.forEach(a=>{
      const u=State.achievements.includes(a.id);
      // Calculate progress for numeric achievements
      let progress = null;
      const checkSrc = a.check.toString();
      const numMatch = checkSrc.match(/>=(\d+)/);
      if (numMatch && !u) {
        const target = parseInt(numMatch[1]);
        let cur = 0;
        try { cur = a.check({...State, stats:{...State.stats}, reputation:State.reputation, printerCount:State.printerCount, ownedUpgrades:State.ownedUpgrades, prestige:State.prestige}, null) ? target : (
          // Try to extract current value from state for common patterns
          checkSrc.includes('jobsDone')        ? State.stats.jobsDone        :
          checkSrc.includes('totalEarned')     ? State.stats.totalEarned     :
          checkSrc.includes('reputation')      ? State.reputation            :
          checkSrc.includes('contractsDone')   ? State.stats.contractsDone   :
          checkSrc.includes('longestStreak')   ? State.stats.longestStreak   :
          checkSrc.includes('pa6Done')         ? State.stats.pa6Done         :
          checkSrc.includes('petgDone')        ? State.stats.petgDone        :
          checkSrc.includes('printerCount')    ? State.printerCount          :
          checkSrc.includes('upgradesBought')  ? State.stats.upgradesBought  :
          checkSrc.includes('maxCombo')        ? State.stats.maxCombo        :
          checkSrc.includes('prestige')        ? State.prestige              :
          checkSrc.includes('passiveEarned')   ? State.stats.passiveEarned   : 0
        ); } catch(e) { cur = 0; }
        if (typeof cur === 'boolean') cur = cur ? target : 0;
        progress = { cur: Math.min(cur, target), max: target };
      }

      const card = document.createElement('div');
      card.className = `achiev-card ${u ? 'unlocked' : 'locked'}`;
      const pctBar = progress ? `<div class="achiev-prog-bar"><div class="achiev-prog-fill" style="width:${Math.round(progress.cur/progress.max*100)}%"></div></div><div class="achiev-prog-text">${r0(progress.cur).toLocaleString()} / ${progress.max.toLocaleString()}</div>` : '';
      card.innerHTML = `<div class="achiev-header"><div class="achiev-icon">${u?'🏆':'🔒'}</div><div class="achiev-title-text" style="color:${u?'var(--accent3)':'var(--text-dim)'}">${a.name}</div></div><div class="achiev-desc">${a.desc}</div>${!u && progress ? pctBar : ''}`;
      el.appendChild(card);
    });
  },
};

// ── GAME ─────────────────────────────────────────────────────
const Game = {
  tickCount: 0,
  lastTick:  Date.now(),
  paused:    false,
  speed:     1,          // 1 | 2 | 5
  _eventCountdown: 60,
  _tickTimer: null,
  _eventTimer: null,
  _autoSaveTimer: null,

  init() {
    this.loadGame();
    Contracts.refresh();
    if (State.orders.length===0) this._spawnOrder();
    Market.renderTicker(null);
    UI.renderAll();
    UI.log(`Welkom bij Print & Profit v${APP_VERSION}.0! Accepteer een bestelling of contract om te beginnen.`,'info');
    clearInterval(this._tickTimer);
    clearInterval(this._eventTimer);
    clearInterval(this._autoSaveTimer);
    this._tickTimer  = setInterval(()=>this.tick(), CONFIG.TICK_MS);
    this._eventTimer = setInterval(()=>this._maybeEvent(), 1000);
    // Veiligheids-autosave elke 30 seconden
    this._autoSaveTimer = setInterval(()=>{ if (!this.paused) this.saveGame(); }, 30000);
    this._eventCountdown=45+Math.random()*45;

    // Night badge
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4) $el('night-badge').classList.add('active');

    // Load skin preference
    Skins.load();

    // v5: Init all new systems
    Season.check();
    DailyGoals.refresh();
    DailyGoals.render();

    // v6: Init new systems
    Chains.init();
    NewsTicker.init();
    Queue.render();
    Employees.render();
    Chains.render();
    Chains.updateTokenDisplay();
    Prestige.render();

    // v7: Init new systems
    Suppliers.init();
    Suppliers.updateStockUI();
    Challenges.init();
    Challenges.render();

    // v8: Init new systems
    if (!State.activeBounties || State.activeBounties.length === 0) BountyBoard.init();
    else BountyBoard.render();
    if (!State.researchFlags) State.researchFlags = {};
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0, sessEarnedPerMin:0 };
    Research.render();
    EquipmentEvents.render();
    Dashboard.render();
    Milestones.check();

    // Prestige badge
    if (State.prestige > 0) {
      const pill = $el('prestige-pill');
      const val  = $el('prestige-val');
      if (pill) pill.classList.add('active');
      if (val)  val.textContent = `P${State.prestige}`;
    }

    // Update dynamic background
    UI.updateBgLevel();

    // Keyboard shortcuts
    // v9: Init new systems
    if (!State.activeLoans) State.activeLoans = [];
    if (!State.totalDebt) State.totalDebt = 0;
    if (!State.activeSurge) State.activeSurge = null;
    // v17.6 fix: restore surge timer from duration if save was made before timer field existed
    if (State.activeSurge && (State.activeSurge.timer === undefined || isNaN(State.activeSurge.timer))) {
      State.activeSurge.timer = State.activeSurge.duration || 60;
    }
    if (!State.rivalScore) State.rivalScore = 0;
    setTimeout(() => {
      if (State.bizLevel >= 3) Rival.init();
    }, 8000); // Rival appears after 8s so player can settle in
    Loans.render();
    Expenses.render();

    // v10: Init new systems
    if (!State.stats_v10) State.stats_v10 = { taxPaid:0, complaintsReceived:0, complaintsRefunded:0, scrapsRecycled:0, franchiseEarned:0, subscriptionJobsDone:0, insurancePayouts:0 };
    if (!State.legacyPerks) State.legacyPerks = [];
    if (!State.franchiseBranches) State.franchiseBranches = [];
    if (!State.clientTiers) State.clientTiers = {};
    if (!State.subscriptionClients) State.subscriptionClients = [];
    if (State.scrap === undefined) State.scrap = 0;
    if (State.taxAccum === undefined) State.taxAccum = 0;
    if (State.taxRate === undefined) State.taxRate = 0.15;
    if (State.taxTimer === undefined) State.taxTimer = 180;
    // Restore unpaid tax bill if player reloaded with one pending
    if (State.taxPending && State.taxPending > 0) {
      TaxSystem._pending = State.taxPending;
      TaxSystem._bill._reshow = true;
      // Re-show the overlay immediately
      const overlay = document.getElementById('tax-overlay');
      const amtEl   = document.getElementById('tax-amount');
      const breakEl = document.getElementById('tax-breakdown');
      const warnEl  = document.getElementById('tax-warning');
      const rate = State.taxRate || 0.15;
      if (amtEl)   amtEl.textContent = fmtEur(TaxSystem._pending);
      if (breakEl) breakEl.innerHTML = `<div class="tax-row"><span>Pending bill</span><span>${fmtEur(TaxSystem._pending)}</span></div>`;
      if (warnEl)  warnEl.textContent = State.money < TaxSystem._pending ? '⚠ Insufficient funds! Rep penalty if unpaid.' : '';
      if (overlay) overlay.classList.add('active');
    }
    if (State.morale === undefined) State.morale = {};
    if (State.pendingComplaint === undefined) State.pendingComplaint = null;
    // Re-apply legacy perks if loaded from save
    if (State.legacyPerks.length > 0) LegacyPerks.reapply();
    Recycling._updatePill();
    LegacyPerks.render();
    HallOfFame.render();
    Franchise.render();
    Subscriptions.render();

    // v11: Init new systems
    if (!State.inventory) State.inventory = { keychains: 0, planters: 0 };
    if (!State.activeTrend) State.activeTrend = null;
    if (!State.trendTimer) State.trendTimer = 0;
    if (!State.trendCountdown) State.trendCountdown = 120;
    if (!State.cfUnlocked) State.cfUnlocked = false;
    if (!State.glowUnlocked) State.glowUnlocked = false;
    if (!State.cfNozzle) State.cfNozzle = false;
    // Ensure all printers have model field
    State.printers.forEach(p => { if (!p.model) p.model = 'BASIC'; });
    // Ensure farm consistency (ids aligned, printerCount synced)
    try { PrinterFarm.ensureSlots(); } catch(e) {}
    Inventory.render();
    Suppliers.updateStockUI();

    UI.log(`Welkom bij Print & Profit v${APP_VERSION}.0! Auto-pauze na inactiviteit, snellere chat, verbeterde mobile UX.`, 'info');

    // Tutorial: show on first visit
    setTimeout(() => Tutorial.start(), 800);
  },

  tick() {
    if (this.paused) return;
    if (window.Bankruptcy && Bankruptcy._gameoverShown) return; // game over — stop tick
    const now = Date.now();
    const rawDt = Math.min((now - this.lastTick) / 1000, 5); // max 5s per tick — voorkomt schulden bij lang wegblijven
    const dt  = rawDt * this.speed;
    this.lastTick = now;
    this.tickCount++;

    const anyActive = this._tickPrinters(dt);
    this._tickOrders(dt);
    this._tickPassiveIncome(dt);
    Expenses.tick(dt);
    this._tickLiveProgress(anyActive);
    this._tickPeriodicSystems(dt);
  },

  _tickPrinters(dt) {
    let anyActive = false;
    State.printers.forEach(p => {
      if (p.active) { anyActive = true; Printer.tick(p, dt); }
    });
    return anyActive;
  },

  _tickOrders(dt) {
    // Spawn new orders
    State.nextOrderIn -= dt;
    if (State.nextOrderIn <= 0 && State.orders.length < CONFIG.MAX_ORDERS) {
      const _seasonDelay = Season.current?.orderDelay || 1;
      State.nextOrderIn = (CONFIG.ORDER_MIN_SEC + Math.random() * (CONFIG.ORDER_MAX_SEC - CONFIG.ORDER_MIN_SEC)) * _seasonDelay;
      this._spawnOrder();
    }
    // Refresh contracts
    State.nextContractIn -= dt;
    if (State.nextContractIn <= 0) {
      Contracts.refresh();
      State.nextContractIn = CONFIG.CONTRACT_REFRESH_S;
      UI.renderContracts();
    }
    // Expire orders
    State.orders.forEach(o => { o.timeLeft -= dt; });
    const prevLen = State.orders.length;
    State.orders = State.orders.filter(o => {
      if (o.timeLeft <= 0) {
        State.reputation = Math.max(0, State.reputation + CONFIG.REP_PER_EXPIRED);
        UI.log(`Order expired: ${o.name}`, 'warn');
        // Clear pendingOrder if this was the selected order
        if (State.pendingOrder && State.pendingOrder.id === o.id) {
          State.pendingOrder = null;
          UI.renderCenterPanel();
        }
        return false;
      }
      return true;
    });
    if (State.orders.length !== prevLen) UI.renderOrders();
    // Contract timers
    State.contracts.forEach(c => { if (!c.completed) c.timeLeft -= dt; });
  },

  _tickPassiveIncome(dt) {
    if (State.passivePerMin <= 0) return;
    State.passiveTick += dt;
    if (State.passiveTick < 60) return;
    const earned = State.passivePerMin;
    State.money             = r2(State.money + earned);
    State.stats.totalEarned = r2(State.stats.totalEarned + earned);
    State.stats.passiveEarned = (State.stats.passiveEarned||0) + earned;
    State.passiveTick -= 60;
    State.incomeHistory.push({ t: Date.now(), v: earned, type: 'passive' });
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();
    UI.floatMoney(`+€${earned} (passive)`);
    UI.log(`Passive income: +€${earned}`, 'money');
    UI.renderGraphCanvas();
  },

  // Cached DOM refs for hot live-progress path (populated on first use)
  _liveEls: null,
  _getLiveEls() {
    if (!this._liveEls) {
      this._liveEls = {
        jstatTime: document.getElementById('jstat-time'),
        arcTrack:  document.getElementById('arc-track'),
        arcPct:    document.getElementById('arc-pct'),
        arcTime:   document.getElementById('arc-time'),
        layerFill: document.getElementById('layer-fill-bar'),
        layerText: document.getElementById('layer-count-text'),
        telemLayer:document.getElementById('telem-layer'),
        telemLayerSub:document.getElementById('telem-layer-sub'),
        telemNozzle:document.getElementById('telem-nozzle'),
        telemBed:  document.getElementById('telem-bed'),
        telemSpeed:document.getElementById('telem-speed'),
      };
    }
    return this._liveEls;
  },
  _tickLiveProgress(anyActive) {
    // UI perf: throttle heavy DOM updates to ~10fps
    const _nowPerf = (window.performance && performance.now) ? performance.now() : Date.now();
    if ((_nowPerf - (this._liveUiLast||0)) < 100) {
      const viewed = State.printers[State.viewingPrinterIdx];
      if (viewed?.active && viewed.job) PrintCanvas.draw(viewed.progress || 0, viewed.job, true);
      return;
    }
    this._liveUiLast = _nowPerf;
    if (!anyActive || State.pendingOrder) return;
    const viewed = State.printers[State.viewingPrinterIdx];
    if (viewed?.active && viewed.job) {
      const pct  = r0(viewed.progress * 100);
      const els  = this._getLiveEls();
      if (els.jstatTime) els.jstatTime.textContent = `${Math.max(0, r0(viewed.timeLeft))}s`;

      // v15: Drive the new visual elements
      if (els.arcTrack) {
        const circ = 163.4;
        els.arcTrack.setAttribute('stroke-dashoffset', (circ - circ * viewed.progress).toFixed(1));
      }
      if (els.arcPct)  els.arcPct.textContent = pct + '%';
      if (els.arcTime) els.arcTime.innerHTML = `Nog <strong>${Math.max(0,r0(viewed.timeLeft))}s</strong> · ${viewed.job.filament} / ${viewed.job.quality}`;

      // Layer counter
      const totalLayers  = Math.round((viewed.totalTime || 60) * 0.8);
      const currentLayer = Math.round(viewed.progress * totalLayers);
      if (els.layerFill) els.layerFill.style.width = pct + '%';
      if (els.layerText) els.layerText.textContent = `Laag ${currentLayer} / ${totalLayers}`;
      if (els.telemLayer) els.telemLayer.textContent = currentLayer;
      if (els.telemLayerSub) els.telemLayerSub.textContent = '/ ' + totalLayers;

      // Temp telemetry
      const tempRaw = State.printerTemps?.[State.viewingPrinterIdx] ?? 0;
      const nozzleT = Math.round(25 + tempRaw * 1.95);
      const bedT    = Math.round(20 + tempRaw * 0.4);
      const spdT    = Math.round(40 + (State.speedMult || 1) * 20);
      if (els.telemNozzle) { els.telemNozzle.textContent = nozzleT + '°'; els.telemNozzle.className = 'telem-value ' + (nozzleT > 180 ? 'hot' : 'cool'); }
      if (els.telemBed)   { els.telemBed.textContent = bedT + '°'; els.telemBed.className = 'telem-value cool'; }
      if (els.telemSpeed)   els.telemSpeed.textContent = spdT;

      // Draw canvas
      PrintCanvas.draw(viewed.progress || 0, viewed.job, true);
    }
  },

  _tickPeriodicSystems(dt) {
    const tc = this.tickCount;
    if (tc % 6   === 0) { UI.updateTopBar(); Expenses.render(); }
    if (tc % 10  === 0) UI.renderOrders();
    if (tc % 20  === 0) UI.renderPrinters();
    if (tc % 12  === 0) UI.renderContracts();
    if (tc % 40  === 0)   SmartTips.check(State);
    if (tc % 60  === 0) { DailyGoals.refresh(); DailyGoals.render(); Suppliers.autoAI(); }
    if (tc % 120 === 0)   this.saveGame();
    if (tc % 360 === 0)   Suppliers.fluctuate();

    // Market
    State.marketTimer -= dt;
    if (State.marketTimer <= 0) { Market.update(); State.marketTimer = 120; }

    // Sub-systems
    Combo.tick(dt);
    Temperature.tick(dt);
    Employees.tick(dt);
    Employees.tickSalesBonus(dt);
    Automation.tick(dt);
    MarketCrisis.tick(dt);
    Endgame.check();
    Bankruptcy.tick();

    // v8 sub-systems
    Research.tick(dt);
    EquipmentEvents.tick(dt);
    BountyBoard.tick(dt);
    Milestones.check();
    if (this.tickCount % 20 === 0) { BountyBoard.render(); Research.render(); EquipmentEvents.render(); Dashboard.render(); }

    // v9 sub-systems
    Rival.tick(dt);
    DemandSurge.tick(dt);
    Loans.tick(dt);
    PowerOutage.tick(dt);

    // v10 sub-systems
    TaxSystem.tick(dt);
    Morale.tick(dt);
    Franchise.tick(dt);
    Subscriptions.tick(dt);
    Insurance.tick(dt);

    // v11 sub-systems
    Trending.tick(dt);
    FlashOrders.tick(dt);
    // v14: Narrative events
    NarrativeEvents.tick(dt);
    ClientChat.tick(dt);
    // Refresh franchise payout bars every few seconds
    if (!this._franchiseRenderTimer) this._franchiseRenderTimer = 0;
    this._franchiseRenderTimer += dt;
    if (this._franchiseRenderTimer >= 3) { this._franchiseRenderTimer = 0; Franchise.render(); }

    // Research: AI Print Factory — auto-completes the best pending order every 90s for free
    if (State.researchFlags?.aiFactory && State.orders.length > 0) {
      if (!State.aiFactoryTimer) State.aiFactoryTimer = 90;
      State.aiFactoryTimer -= dt;
      if (State.aiFactoryTimer <= 0) {
        State.aiFactoryTimer = 90;
        const bestOrder = [...State.orders].sort((a, b) => b.reward - a.reward)[0];
        if (bestOrder) {
          State.orders = State.orders.filter(o => o.id !== bestOrder.id);
          const profit = r2(bestOrder.reward * 0.8);
          State.money = r2(State.money + profit);
          State.stats.totalEarned = r2(State.stats.totalEarned + profit);
          State.stats.jobsDone++;
          State.xp += 5;
          // v17.3 fix: hook AI Factory into all downstream systems it was skipping
          TaxSystem.accrue(profit);
          Contracts.trackJob(bestOrder.filament);
          Chains.trackJob(bestOrder.filament);
          BountyBoard.onJobComplete(bestOrder, bestOrder.filament, bestOrder.quality || 'NORMAL');
          BountyBoard.onEarn(profit);
          DailyGoals.check();
          Combo.onJobComplete();
          State.incomeHistory.push({ t: Date.now(), v: profit, type: 'ai_factory' });
          if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();
          UI.log(`🏭 AI Factory auto-printed ${bestOrder.name} — +€${profit}`, 'success');
          UI.updateTopBar();
          UI.renderOrders();
        }
      }
    }

    // Refresh night badge every minute
    if (tc % 60 === 0) {
      const hr = new Date().getHours();
      const nb = document.getElementById('night-badge');
      if (nb) nb.classList.toggle('active', hr >= 22 || hr < 4);
    }

    if (State.hiredEmployees.includes('student') || State.hiredEmployees.includes('manager') || State.automation?.autoDispatch) {
      Queue.tryAutoStart();
    }
  },

  _spawnOrder() {
    const o = Orders.generate();
    State.orders.push(o);

    // Idle Economy Layer 1: optional auto-accept into print queue
    if (State.autoAcceptToQueue && State.printQueue && State.printQueue.length < Queue.MAX) {
      Queue.add(o, o.filament, State.selectedQuality);
      UI.log(`🤖 Auto-wachtrij: ${o.name} toegevoegd`, 'info');
      return o;
    }

    UI.log(`New order: ${o.name} (${o.filament}) — €${o.reward.toFixed(2)}`,'info');
    UI.renderOrders();
    return o;
  },

  selectOrder(order) {
    const freeIdx=State.printers.findIndex(p=>!p.active);
    if (freeIdx<0) { UI.showPopup('No Free Printer','All printers busy. Wait for a job to finish.'); return; }
    State.pendingOrder=order; State.selectedPrinterIdx=freeIdx;
    if (State.reputation>=CONFIG.FILAMENTS[order.filament].unlockRep) State.selectedFilament=order.filament;
    else State.selectedFilament='PLA';
    Sound.click();
    // Switch to orders tab
    switchPTab('orders');
    // Show customer quote
    CustomerLoyalty.showQuote(order);
    UI.renderCenterPanel(); UI.renderOrders();
  },

  startJob() {
    const order=State.pendingOrder; const printer=State.printers[State.selectedPrinterIdx];
    if (!order||!printer||printer.active) return;
    if (printer.health<10) { UI.showPopup('Printer Broken',`${printer.name} health is critical! Repair first.`); return; }
    // Bug fix: check filament stock before starting
    const stockNeeded = CONFIG.FILAMENTS[State.selectedFilament]?.stockUse || 3;
    if (!Suppliers.hasStock(State.selectedFilament, stockNeeded)) {
      UI.showPopup('Niet genoeg voorraad', `Onvoldoende ${State.selectedFilament} voorraad (${State.filamentStock[State.selectedFilament]||0} eenheden). Bestel bij een leverancier.`); return;
    }
    State.orders=State.orders.filter(o=>o.id!==order.id);
    Printer.startJob(State.selectedPrinterIdx, order, State.selectedFilament, State.selectedQuality);
    State.pendingOrder=null; State.viewingPrinterIdx=State.selectedPrinterIdx;
    Sound.click();
    UI.log(`Gestart: ${order.name} op ${printer.name} [${State.selectedFilament}/${State.selectedQuality}]`,'info');
    UI.renderCenterPanel(); UI.renderPrinters(); UI.renderOrders(); Achievements.check();
  },

  // Auto-start for Smart Queue
  _autoStartJob(printerIdx, order) {
    const printer=State.printers[printerIdx]; if(!printer||printer.active) return;
    State.orders=State.orders.filter(o=>o.id!==order.id);
    const filament=State.reputation>=CONFIG.FILAMENTS[order.filament].unlockRep?order.filament:'PLA';
    Printer.startJob(printerIdx, order, filament, 'NORMAL');
    UI.log(`🤖 Smart Queue: Auto-started ${order.name} on ${printer.name}`,'info');
    UI.renderCenterPanel(); UI.renderPrinters(); UI.renderOrders();
  },

  cancelJob() {
    const printer=State.printers[State.viewingPrinterIdx]; if(!printer||!printer.active) return;
    const jn=printer.job?printer.job.name:'Job';
    Sound.stopHum(State.viewingPrinterIdx);
    printer.active=false; printer.job=null; printer.progress=0; printer.timeLeft=0;
    printer.health=Math.max(0,printer.health-5);
    const other=State.printers.find((p,i)=>i!==State.viewingPrinterIdx && p.active);
    State.viewingPrinterIdx=other?State.printers.indexOf(other):0;
    UI.log(`Cancelled: ${jn} (−5 health)`,'warn');
    UI.renderCenterPanel(); UI.renderPrinters();
  },

  repairPrinter(idx) {
    const p=State.printers[idx];
    const seasonDiscount = Season.current?.repairDiscount || 1;
    const cost=r2(Math.round((100-p.health)*CONFIG.REPAIR_COST_PER_HP*100)/100 * seasonDiscount);
    if (State.money<cost) { UI.showPopup('Not Enough Money',`Repair costs €${cost.toFixed(2)}.`); return; }
    State.money=r2(State.money-cost); p.health=100;
    Sound.click();
    const discountNote = seasonDiscount < 1 ? ` 🌱 (${Math.round((1-seasonDiscount)*100)}% seizoenskorting)` : '';
    UI.log(`${p.name} repaired for €${cost.toFixed(2)}${discountNote}`,'info');
    UI.renderPrinters(); UI.updateTopBar();
  },

  checkBizLevel() {
    const lvls=CONFIG.BIZ_LEVELS;
    for (let i=lvls.length-1;i>=0;i--) {
      if (State.xp>=lvls[i].xp) {
        if (State.bizLevel<lvls[i].level) {
          State.bizLevel=lvls[i].level;
          Sound.levelUp();
          Confetti.levelUp();
          UI.log(`🎉 Level omhoog! ${lvls[i].name}`,'success');
          NewsTicker.addItem(`🎉 LEVEL UP! Je bedrijf is nu: ${lvls[i].name} (Level ${lvls[i].level})`);
          // v17.2 fix: init rival on first reach of level 3 (only done in loadGame before)
          if (lvls[i].level === 3 && !State.rivalActive) {
            setTimeout(() => Rival.init(), 3000);
          } else {
            Rival.resetForNextLevel();
          }
          UI.showPopup(`Level Up! 🎉`,`<strong style="font-size:18px;font-family:var(--display);color:var(--accent)">${lvls[i].name}</strong><br><br>Je bedrijf is nu Level ${lvls[i].level}. Nieuwe upgrades beschikbaar!`);
          UI.renderShop();
          Employees.render();
          UI.updateBgLevel();
        }
        break;
      }
    }
    UI.renderBizLevel();
  },

  showProModal() {
    if (State.isPro) { UI.showPopup('⚡ Pro Active','You already have Pro! Enjoy Smart Queue and AI Quality Control.'); return; }
    const box=$el('popup-box'); box.className='popup pro-modal';
    $el('popup-title').innerHTML='⚡ Print & Profit Pro';
    $el('popup-body').innerHTML=`
      <div style="color:var(--text-dim);font-size:11px;margin-bottom:8px">Unlock professional tools for your print farm:</div>
      <ul class="pro-features">
        <li>Smart Queue — auto-assign orders to free printers</li>
        <li>AI Quality Control — catch failures mid-print</li>
        <li>All future Pro upgrades included</li>
        <li>Support indie development ❤️</li>
      </ul>
      <div class="pro-price">€4.99</div>
      <div class="pro-price-sub">One-time · No subscription · Instant unlock</div>
    `;
    $el('popup-cancel').style.display='block';
    $el('popup-ok').textContent='⚡ Unlock Pro';
    $el('popup-ok').className='btn-pro';
    $el('popup-ok').style.padding='10px 20px';
    $el('popup-ok').onclick=()=>{ this.unlockPro(); closePopup(); };
    $el('popup-cancel').onclick=()=>{ $el('popup-ok').textContent='OK'; $el('popup-ok').className='btn btn-primary'; $el('popup-ok').onclick=()=>closePopup(); closePopup(); };
    $el('popup-overlay').classList.add('visible');
  },

  unlockPro() {
    // ── PAYMENT HOOK ──
    // Replace this block with your real payment integration:
    // e.g. Stripe, Lemon Squeezy, Paddle, or itch.io IAP
    // On success, call: State.isPro = true; this._onProUnlocked();
    //
    // For demo / itch.io free version: uncomment the line below:
    State.isPro = true;
    this._onProUnlocked();
  },

  _onProUnlocked() {
    // Auto-apply Pro upgrades
    CONFIG.UPGRADES.filter(u=>u.premium).forEach(u=>{
      if (!State.ownedUpgrades.includes(u.id)) {
        State.ownedUpgrades.push(u.id);
        u.apply(State);
      }
    });
    Sound.levelUp();
    UI.log('⚡ Pro unlocked! Smart Queue and AI QC activated.','success');
    UI.updateTopBar(); UI.renderShop();
    this.saveGame();
  },

  _maybeEvent() {
    this._eventCountdown-=1;
    if (this._eventCountdown<=0) {
      if (Math.random()<0.6) {
        const evt=CONFIG.EVENTS[Math.floor(Math.random()*CONFIG.EVENTS.length)];
        this._applyEvent(evt);
      }
      this._eventCountdown=45+Math.random()*45;
    }
  },
  _applyEvent(evt) {
    switch(evt.effect) {
      case 'bulkBonus':    State.bulkBonusJobs=evt.value; break;
      case 'nextFailBoost':State.nextFailBoost=evt.value; break;
      case 'repBoost':     State.reputation=Math.min(CONFIG.MAX_REP,State.reputation+evt.value); break;
      case 'filDiscount':  State.filDiscountJobs=evt.value; break;
      case 'hpLoss':       State.printers.forEach(p=>{p.health=Math.max(0,p.health-evt.value);}); break;
      case 'hpHeal':       if(State.printers[0]) State.printers[0].health=Math.min(100,State.printers[0].health+evt.value); break;
    }
    UI.showPopup(evt.title, evt.body);
    UI.log(`Event: ${evt.title}`,'warn');
    UI.updateTopBar(); UI.renderPrinters();
  },

  saveGame(manual=false) {
    // Nooit opslaan als game over actief is of als we bezig zijn met resetten
    if (window.Bankruptcy && Bankruptcy._gameoverShown) return;
    if (this._resetting) return;
    const d={
      money:State.money, reputation:State.reputation, xp:State.xp, bizLevel:State.bizLevel,
      isPro:State.isPro, printerCount:State.printerCount, speedMult:State.speedMult,
      failBonus:State.failBonus, abrasiveBonus:State.abrasiveBonus, dryerBonus:State.dryerBonus,
      rewardMult:State.rewardMult, passivePerMin:State.passivePerMin,
      smartQueue:State.smartQueue, aiQuality:State.aiQuality, packagingBonus:State.packagingBonus,
      market:State.market, customers:State.customers, activeSkin:State.activeSkin,
      tokens:State.tokens||0, hiredEmployees:State.hiredEmployees||[],
      // Idle economy + automation
      ops: State.ops || null,
      autoAcceptToQueue: State.autoAcceptToQueue || false,
      activeContractId: State.activeContractId || null,
      miniIntroSeen: State.miniIntroSeen || false,
      automation: State.automation || null,
      marketTimer: State.marketTimer || 120,
      printQueue: State.printQueue || [],
      activeChains:State.activeChains||[], printerTemps:State.printerTemps||{},
      printerSpecs:State.printerSpecs||{}, prestige:State.prestige||0,
      prestigeBonus:State.prestigeBonus||0, _printGodActive:State._printGodActive||false,
      ownedUpgrades:State.ownedUpgrades, achievements:State.achievements, stats:State.stats,
      incomeHistory: (State.incomeHistory || []).slice(-CONFIG.INCOME_HISTORY_MAX),
      printers: State.printers.map(p => ({
  ...p,
  active: false,
  job: null,
  progress: 0,
  timeLeft: 0,
  // optioneel maar beter consistent:
  // totalTime: 0,
})),
      dailyContractDoneAt:State.dailyContractDoneAt,
      // v7 new fields
      filamentStock: State.filamentStock || {},
      supplierRelations: State.supplierRelations || {},
      supplierOrderCount: State.supplierOrderCount || {},
      activeCrisis: null, // don't persist crisis state
      activeChallenges: State.activeChallenges || [],
      challengeSessionData: State.challengeSessionData || {},
      tpuUnlocked: State.tpuUnlocked || false,
      resinUnlocked: State.resinUnlocked || false,
      flexBed: State.flexBed || false,
      uvCuring: State.uvCuring || false,
      bulkDealActive: State.bulkDealActive || false,
      supplierAI: State.supplierAI || false,
      // v12 fix: persist research state so upgrades survive reload
      completedResearch: State.completedResearch || [],
      researchFlags: State.researchFlags || {},
      activeResearch: State.activeResearch || null,
      cfNozzle: State.cfNozzle || false,
      cfUnlocked: State.cfUnlocked || false,
      glowUnlocked: State.glowUnlocked || false,
      repLegacyBonus: State.repLegacyBonus || 0,
      aiFactoryTimer: State.aiFactoryTimer || 90,
      activeLoans: (State.activeLoans || []).map(l => ({ ...l })), // Bug fix: spread preserves _interestAccum
      totalDebt: State.totalDebt || 0,
      // v17 fix: persist scrap and morale
      scrap: State.scrap || 0,
      morale: State.morale || {},
      stats_v8: State.stats_v8 || {},
      stats_v10: State.stats_v10 || {},
      // v17.2 fix: persist v10 systems that were lost on reload
      legacyPerks: State.legacyPerks || [],
      franchiseBranches: State.franchiseBranches || [],
      franchiseUnlocked: State.franchiseUnlocked || false,
      hasInsurance: State.hasInsurance || false,
      hasAccountant: State.hasAccountant || false,
      taxAccum: State.taxAccum || 0,
      taxTimer: State.taxTimer || 180,
      taxRate: State.taxRate || 0.15,
      taxPending: TaxSystem._pending || 0,
      clientTiers: State.clientTiers || {},
      subscriptionClients: State.subscriptionClients || [],
      subscriptionTimer: State.subscriptionTimer || 0,
      pendingComplaint: State.pendingComplaint || null,
      insuranceTimer: State.insuranceTimer || 0,
      // v17.3 fix: persist milestone, bounty, equipment, daily goal, rival, inventory state
      claimedMilestones: State.claimedMilestones || [],
      activeBounties: State.activeBounties || [],
      bountyRefreshTimer: State.bountyRefreshTimer || 300,
      activeEquipmentEvents: State.activeEquipmentEvents || [],
      dailyGoals: State.dailyGoals || [],
      dailyGoalsDate: State.dailyGoalsDate || '',
      dailyGoalsEarned: State.dailyGoalsEarned || 0,
      rivalScore: State.rivalScore || 0,
      playerVsRival: State.playerVsRival || 0,
      rivalActive: State.rivalActive || false,
      _rivalDefeated: State._rivalDefeated || false,
      activeSurge: State.activeSurge || null,
      surgeCountdown: State.surgeCountdown || 120,
      durabilityBonus: State.durabilityBonus || 0,
      _internJobs: State._internJobs || 0,
      _equipUpgradeDone: State._equipUpgradeDone || false,
      inventory: State.inventory || { keychains:0, planters:0 },
      hofRecords: State.hofRecords || [],
      lastSeen: Date.now(),
      lastMinuteEarnings: State.lastMinuteEarnings || [],
      _offlineSnap: (function(){
        const lme = Array.isArray(State.lastMinuteEarnings) ? State.lastMinuteEarnings : [];
        const avg = lme.length ? (lme.reduce((a,b)=>a+(+b||0),0) / lme.length) : 0;
        const printers = (State.printers && State.printers.length) ? State.printers.length : (State.printerCount||1);
        const perPrinterEPM = printers>0 ? (avg / Math.max(1, printers)) : 0;
        return { printers, perPrinterEPM: r2(perPrinterEPM) };
      })(),
      version:APP_VERSION,
    };
    localStorage.setItem('pnp_save',JSON.stringify(d));
    // Show save indicator
    const ind = $el('save-indicator');
    if (ind) {
      ind.classList.add('visible','saving');
      setTimeout(() => { ind.classList.remove('saving'); setTimeout(() => ind.classList.remove('visible'), 600); }, 1200);
    }
    if (manual) UI.log('Game saved.','info');
  },

  togglePause() {
    this.paused = !this.paused;
    const btn     = document.getElementById('pause-btn');
    const overlay = document.getElementById('pause-overlay');
    const savedMsg = document.getElementById('pause-saved-msg');
    const sub     = document.getElementById('pause-overlay-sub');

    if (this.paused) {
      // Sla op bij pauzeren
      this.saveGame();
      this.lastTick = Date.now();
      btn.textContent = '▶';
      btn.classList.add('paused');
      btn.title = 'Hervat spel';
      overlay.classList.add('visible');
      // Standaard subtitle (idle-systeem kan dit overschrijven)
      if (sub && sub.textContent.trim() === 'Tik om te hervatten') {
        sub.textContent = 'Tik om te hervatten';
      }
      if (savedMsg) {
        savedMsg.classList.add('show');
        setTimeout(() => savedMsg.classList.remove('show'), 2500);
      }
      if (State.speedrunActive) clearInterval(Speedrun._timer);
    } else {
      this.lastTick = Date.now(); // voorkom tijdsprong bij hervatten
      btn.textContent = '⏸';
      btn.classList.remove('paused');
      btn.title = 'Pauzeer spel';
      overlay.classList.remove('visible');
      if (sub) sub.textContent = 'Tik om te hervatten'; // reset voor volgende keer
      if (State.speedrunActive) Speedrun._startTimer();
      // Herstart idle timer na hervatten
      setTimeout(() => document.dispatchEvent(new Event('click')), 100);
    }
  },

  setSpeed(s) {
    this.speed = s;
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById(`speed-${s}x`);
    if (btn) btn.classList.add('active');
    // Reset lastTick to avoid a huge dt jump at new speed
    this.lastTick = Date.now();
    UI.log(`⏩ Spelsnelheid: ${s}×`, 'info');
  },

  exportSave() {
    const raw = localStorage.getItem('pnp_save');
    if (!raw) { UI.showPopup('Nothing to Export','Save your game first!'); return; }
    const blob = new Blob([raw], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'print-profit-save.json';
    a.click(); URL.revokeObjectURL(url);
    UI.log('Opgeslagen als JSON-export.','info');
  },

  importSave(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const d = JSON.parse(e.target.result);

        // Minimal validation to prevent broken saves
        if (!d || typeof d !== 'object') throw new Error('not an object');
        if (typeof d.money !== 'number') throw new Error('missing money');
        if (!Array.isArray(d.printers)) throw new Error('missing printers');

        localStorage.setItem('pnp_save', JSON.stringify(d));
        UI.showPopup('Import Successful','Save loaded! Reloading game…');
        setTimeout(() => location.reload(), 1500);
      } catch(err) {
        UI.showPopup('Import Failed', 'Invalid or incompatible save file.');
      }
    };
    reader.readAsText(file);
  },
  loadGame() {
    const raw=localStorage.getItem('pnp_save'); if(!raw) return;
    try {
      const d=JSON.parse(raw);
      // Load top-level fields (skip stats — handled separately below)
      Object.keys(d).forEach(k=>{
        if (k!=='version' && k!=='stats' && k in State) State[k]=d[k]??State[k];
      });
      // Merge stats: start from defaults so new fields always exist
      if (d.stats) {
        State.stats = { ...State.stats, ...d.stats };
      }
      // filamentsUsed must always be a plain array (Sets don't serialize)
      if (!Array.isArray(State.stats.filamentsUsed)) {
        State.stats.filamentsUsed = [];
      }
      // Guard all v7 fields that may be missing from old saves
      if (!State.filamentStock)     State.filamentStock     = { PLA:100, PETG:80, PA6:50, TPU:0, RESIN:0, CF:0, GLOW:0 };
      // v17.2 fix: patch old saves missing CF/GLOW stock keys
      if (State.filamentStock.CF   === undefined) State.filamentStock.CF   = 0;
      if (State.filamentStock.GLOW === undefined) State.filamentStock.GLOW = 0;
      if (!State.supplierRelations)  State.supplierRelations  = {};
      if (!State.supplierOrderCount) State.supplierOrderCount = {};
      if (!State.activeChallenges)   State.activeChallenges   = [];
      if (!State.challengeSessionData) State.challengeSessionData = {};
      // Guard printers array
      State.printers = d.printers ?? State.printers;
      // Ensure multi-printer farm stays consistent after loading older saves
      try { PrinterFarm.ensureSlots(); } catch(e) {}
      if (State.viewingPrinterIdx == null || State.viewingPrinterIdx >= State.printers.length) {
  State.viewingPrinterIdx = 0;
}
      State.market   = d.market   || State.market;
      State.customers= d.customers|| State.customers;
      if (State.passivePerMin>0) $el('passive-pill').style.display='flex';
      if (State.isPro) { $el('pro-btn').textContent='⚡ Pro Active'; $el('pro-btn').classList.add('owned'); }
      
      // Idle Economy Layer 1 guards
      if (!State.ops) State.ops = { facilityLevel:1, rentPM:8, electricityPerActivePM:1.2, maintenancePerPrinterPM:0.6, marketingPM:0 };
      if (State.autoAcceptToQueue === undefined) State.autoAcceptToQueue = false;
      if (!State.automation) State.automation = { autoDispatch:false, autoRepair:false };
      if (State.marketTimer === undefined) State.marketTimer = 120;
      if (!Array.isArray(State.printQueue)) State.printQueue = [];
      if (State.activeContractId === undefined) State.activeContractId = null;
      if (State.miniIntroSeen === undefined) State.miniIntroSeen = false;
// Guard research state (v12 fix)
      if (!State.researchFlags)    State.researchFlags    = {};
      if (!State.completedResearch) State.completedResearch = [];
      // If save pre-dates v12, re-apply research flags from completedResearch list
      if (d.completedResearch) {
        State.completedResearch = d.completedResearch;
        // Restore research flags if not already saved (backwards compat)
        if (!d.researchFlags || Object.keys(d.researchFlags).length === 0) {
          State.completedResearch.forEach(id => {
            const r = (CONFIG.RESEARCH||[]).find(u => u.id === id);
            if (r && typeof r.apply === 'function') { try { r.apply(State); } catch(e) {} }
          });
        }
      }
      
      // ── Offline Progress ──────────────────────────────────
      try {
        const now = Date.now();
        const last = d.lastSeen || d.lastSave || d.savedAt || 0;
        if (last && now > last + 15000) {
          const offlineSec = Math.min(60*60*24*7, Math.floor((now - last)/1000)); // cap 7 days
          const offlineMin = offlineSec / 60;
          const exp = Expenses.calcPM();
          let gross = 0;

          // Base: passive income
          if (State.passivePerMin) gross += (State.passivePerMin * offlineMin);

          // If automation is on, approximate production while away
          const snap = d._offlineSnap || {};
          const perP = (+snap.perPrinterEPM || 0);
          if (State.automation && State.automation.autoDispatch && State.autoAcceptToQueue && perP > 0) {
            gross += (perP * (State.printers?.length || 1) * offlineMin);
          }

          // Subtract operating expenses while away — cap verlies op max 2 uur om eerlijk te blijven
          const rawCost = (exp.totalPM || 0) * offlineMin;
          const OFFLINE_COST_CAP_MIN = 120; // max 2 uur kosten offline
          const cappedCost = Math.min(rawCost, (exp.totalPM || 0) * OFFLINE_COST_CAP_MIN);
          const net  = r2(gross - cappedCost);

          if (Math.abs(net) >= 0.01) {
            State.money = r2(State.money + net);
            if (net > 0) {
              State.stats.totalEarned = r2((State.stats.totalEarned||0) + net);
              State.stats.passiveEarned = (State.stats.passiveEarned||0) + net;
              // v17.4 fix: accrue tax on offline earnings
              try { TaxSystem.accrue(net); } catch(e) {}
              State.incomeHistory.push({ t: Date.now(), v: net, type: 'offline' });
              if (State.incomeHistory.length > (CONFIG.INCOME_HISTORY_MAX||120)) State.incomeHistory.shift();
              UI.floatMoney(`+${fmtEur(net)} (offline)`);
            }
            const h = Math.floor(offlineSec/3600);
            const m = Math.floor((offlineSec%3600)/60);
            const dur = h>0 ? `${h}u ${m}m` : `${m} min`;
            const msg = net >= 0
              ? `Je printers hebben gedraaid terwijl je weg was!\n\nTijd offline: <b>${dur}</b>\nVerdiend (na kosten): <b>${fmtEur(net)}</b>`
              : `Je bedrijf heeft kosten gemaakt terwijl je weg was.\n\nTijd offline: <b>${dur}</b>\nNetto resultaat: <b>${fmtEur(net)}</b>`;
            UI.showPopup('⏱️ Offline Progress', msg);
          }
        }
      } catch(e) { /* ignore offline calc */ }

      UI.log('Save loaded.','info');
    } catch(e){ UI.log('Could not load save.','error'); }
  },
  resetGame() {
    if (!confirm('Reset all progress? Cannot be undone.')) return;
    // Blokkeer alle saves vanaf dit moment
    this._resetting = true;
    try { localStorage.removeItem('pnp_save'); } catch(e) {}
    location.reload();
  },
};

// ── TAB SWITCHERS ────────────────────────────────────────────
function switchTab(id) {
  State.activeTab = id;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const tab = document.querySelector(`[data-tab="${id}"]`);
  if (tab) tab.classList.add('active');
  const tc=document.getElementById('tab-'+id); if(tc) tc.classList.add('active');

  // Mobile nav: als de actieve tab niet primary is, toon hem tijdelijk in de balk
  // door een "ghost" primary te vervangen, of gewoon de More knop te markeren
  const nav = document.getElementById('main-nav');
  if (nav) {
    // Verwijder eerder toegevoegde ghost tabs
    nav.querySelectorAll('.tab-ghost').forEach(g=>g.remove());
    const isPrimary = !!document.querySelector(`#main-nav .tab[data-tab="${id}"][data-primary="1"]`);
    if (!isPrimary && id !== 'more') {
      // Markeer de More knop als "actief" zodat gebruiker weet waar ze zijn
      const moreBtn = nav.querySelector('.tab.more');
      if (moreBtn) moreBtn.classList.add('active');
    }
  }

  if (id==='stats') { UI.renderStats(); UI.renderGraphCanvas(); UI.renderPieChart(); }
  if (id==='leaderboard') { Leaderboard.submit(); Leaderboard.render(); }
  if (id==='doelen') DailyGoals.render();
  if (id==='personeel') Employees.render();
  if (id==='ketens') { Chains.render(); Chains.updateTokenDisplay(); }
  if (id==='settings') Prestige.render();
  if (id==='suppliers') Suppliers.render();
  if (id==='klanten') { VIPCustomers.render(); CRM.renderPanel(); }
  if (id==='challenges') Challenges.render();
  if (id==='research') Research.render();
  if (id==='bounties') BountyBoard.render();
  if (id==='dashboard') Dashboard.render();
  if (id==='equipment') { EquipmentEvents.render(); renderMilestoneProgress(); }
  if (id==='loans') { Loans.render(); Recycling.renderPanel(); Subscriptions.render(); Morale.renderPanel(); }
  if (id==='franchise') Franchise.render();
  if (id==='legacy') LegacyPerks.render();
  if (id==='hof') HallOfFame.render();
  if (id==='voorraad') Inventory.render();
  Sound.click();
}
function switchPTab(id) {
  ['orders','contracts','queue'].forEach(t=>{
    document.getElementById('ptab-'+t)?.classList.toggle('active',t===id);
    document.getElementById('ptab-body-'+t)?.classList.toggle('active',t===id);
  });
  if (id==='queue') Queue.render();
}
function closePopup() {
  $el('popup-overlay').classList.remove('visible');
  $el('popup-ok').textContent='OK';
  $el('popup-ok').className='btn btn-primary';
  $el('popup-ok').onclick=()=>closePopup();
  $el('popup-cancel').style.display='none';
  $el('popup-box').className='popup';
}

// ── v8: RESEARCH SYSTEM ──────────────────────────────────
const Research = {
  start(id) {
    const res = CONFIG.RESEARCH.find(r=>r.id===id);
    if (!res) return;
    if (State.completedResearch.includes(id)) return;
    if (State.activeResearch) { UI.toast('⚗️ Research already in progress!','warn'); return; }
    if (res.requires && !State.completedResearch.includes(res.requires)) {
      UI.toast('🔒 Requires: '+CONFIG.RESEARCH.find(r=>r.id===res.requires)?.name,'warn'); return;
    }
    if (State.bizLevel < (res.unlockLevel||1)) { UI.toast('🔒 Requires level '+res.unlockLevel,'warn'); return; }
    if (State.money < res.cost) { UI.toast('💸 Insufficient funds for research!','warn'); return; }
    State.money = r2(State.money - res.cost);
    State.activeResearch = { id, progress:0, total: res.researchTime };
    UI.toast(`⚗️ Researching: ${res.name}…`,'info');
    this.render();
    UI.updateTopBar();
  },
  tick(dt) {
    if (!State.activeResearch) return;
    // Safety: ensure numeric totals
    if (!Number.isFinite(State.activeResearch.total) || State.activeResearch.total <= 0) {
      const r = CONFIG.RESEARCH.find(x=>x.id===State.activeResearch.id);
      State.activeResearch.total = (r && Number.isFinite(r.researchTime) && r.researchTime>0) ? r.researchTime : 30;
    }
    State.activeResearch.progress = (State.activeResearch.progress || 0) + dt;

    // Live UI updates (so the countdown actually moves even without a full re-render)
    const fill = document.querySelector('[data-research-fill]');
    const rem  = document.querySelector('[data-research-remaining]');
    if (fill || rem) {
      const pct = Math.min(100, (State.activeResearch.progress / State.activeResearch.total) * 100);
      if (fill) fill.style.width = pct.toFixed(1) + '%';
      if (rem)  rem.textContent = Math.max(0, (State.activeResearch.total - State.activeResearch.progress)).toFixed(0) + 's';
    } else if (State.activeTab === 'research') {
      // If research tab is active but the banner isn't present (first frame), render it.
      this.render();
    }

    if (State.activeResearch.progress >= State.activeResearch.total) {
      this.complete();
    }
  },
  complete() {
    const id = State.activeResearch.id;
    const res = CONFIG.RESEARCH.find(r=>r.id===id);
    if (!res) { State.activeResearch=null; return; }
    State.completedResearch.push(id);
    State.activeResearch = null;
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0 };
    State.stats_v8.researchCompleted++;
    if (!State.researchFlags) State.researchFlags = {};
    res.apply(State);
    State.xp += 80;
    Confetti.burst();
    UI.toast(`✅ Research complete: ${res.name}! ${res.effect}`,'success');
    NewsTicker.addItem(`🔬 Research voltooid: ${res.name} — ${res.effect}`);
    Milestones.check();
    this.render();
  },
  render() {
    const panel = $el('research-panel');
    if (!panel) return;
    if (!State.researchFlags) State.researchFlags = {};
    const tiers = [1,2,3,4];
    let html = '';
    if (State.activeResearch) {
      const r = CONFIG.RESEARCH.find(x=>x.id===State.activeResearch.id);
      const pct = Math.min(100, (State.activeResearch.progress / State.activeResearch.total)*100);
      html += `<div class="active-research-banner">
        <div class="arb-icon">${r?.icon||'⚗️'}</div>
        <div style="flex:1">
          <div class="arb-name">${r?.name||'Research'}</div>
          <div class="arb-sub">${r?.effect||''}</div>
          <div class="arb-bar"><div class="arb-fill" data-research-fill style="width:${pct.toFixed(1)}%"></div></div>
        </div>
        <div class="arb-time" data-research-remaining style="font-family:var(--display);font-weight:900;font-size:14px;color:var(--accent)">${(State.activeResearch.total - State.activeResearch.progress).toFixed(0)}s</div>
      </div>`;
    }
    html += '<div class="research-tree">';
    for (const tier of tiers) {
      const nodes = CONFIG.RESEARCH.filter(r=>r.tier===tier);
      if (!nodes.length) continue;
      html += `<div class="research-tier"><div class="research-tier-label">Tier ${tier} Research</div><div class="research-row">`;
      for (const r of nodes) {
        const done = State.completedResearch.includes(r.id);
        const active = State.activeResearch?.id === r.id;
        const reqMet = !r.requires || State.completedResearch.includes(r.requires);
        const levelMet = State.bizLevel >= (r.unlockLevel||1);
        const locked = !reqMet || !levelMet;
        const pct = active ? Math.min(100, (State.activeResearch.progress / State.activeResearch.total)*100) : 0;
        const cls = done ? 'researched' : active ? 'researching' : locked ? 'locked-node' : 'available';
        html += `<div class="research-node ${cls}" onclick="Research.start('${r.id}')">
          <div class="research-icon">${r.icon}</div>
          <div class="research-name">${r.name}</div>
          <div class="research-desc">${r.desc}</div>
          ${done ? '<div style="font-size:11px;color:var(--accent3);margin-top:4px">✓ Complete</div>' :
            active ? `<div class="research-progress"><div class="research-prog-fill" style="width:${pct.toFixed(1)}%"></div></div>` :
            locked ? `<div class="research-cost">🔒 ${r.requires ? 'Requires: '+CONFIG.RESEARCH.find(x=>x.id===r.requires)?.name : 'Lvl '+r.unlockLevel}</div>` :
            `<div class="research-cost">€${r.cost}</div><div class="research-time">⏱ ${r.researchTime}s</div>`}
        </div>`;
      }
      html += '</div></div>';
    }
    html += '</div>';
    panel.innerHTML = html;
  },
};

// ── v8: MILESTONE SYSTEM ────────────────────────────────
const Milestones = {
  check() {
    for (const m of CONFIG.MILESTONES) {
      if (State.claimedMilestones.includes(m.id)) continue;
      if (m.check(State)) {
        this.claim(m);
      }
    }
  },
  claim(m) {
    State.claimedMilestones.push(m.id);
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0 };
    State.stats_v8.milestonesHit++;
    // Apply reward
    if (m.reward.money)  { State.money = r2(State.money + m.reward.money); State.stats.totalEarned = r2(State.stats.totalEarned + m.reward.money); TaxSystem.accrue(m.reward.money); }
    if (m.reward.xp)     State.xp += m.reward.xp;
    if (m.reward.rep)    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + m.reward.rep);
    if (m.reward.tokens) State.tokens += m.reward.tokens;
    this.show(m);
  },
  show(m) {
    const overlay = $el('milestone-overlay');
    const banner = $el('milestone-banner');
    if (!overlay || !banner) return;
    banner.innerHTML = `
      <div class="milestone-icon">${m.icon}</div>
      <div class="milestone-title">${m.name}</div>
      <div class="milestone-desc">${m.desc}</div>
      <div class="milestone-reward">${m.rewardText}</div>
      <div class="milestone-reward-sub">Milestone Reward</div>
      <button class="btn" style="margin-top:16px;min-width:120px" onclick="Milestones.close()">Collect!</button>
    `;
    overlay.style.display = 'block';
    banner.style.display = 'block';
    Confetti.burst();
    Sound.play?.('milestone');
  },
  close() {
    const overlay = $el('milestone-overlay');
    if (overlay) overlay.style.display = 'none';
    UI.updateTopBar();
  },
};

// ── v8: EQUIPMENT EVENTS ────────────────────────────────
const EquipmentEvents = {
  _cooldown: 0,
  tick(dt) {
    if (this._cooldown > 0) { this._cooldown -= dt; return; }
    for (const [idx, printer] of State.printers.entries()) {
      if (!printer.active) continue;
      for (const evt of CONFIG.EQUIPMENT_EVENTS) {
        if (Math.random() < evt.chance * dt * 0.01) {
          if (State.activeEquipmentEvents.some(e=>e.printerIdx===idx && e.eventId===evt.id)) continue;
          this.trigger(idx, evt);
          this._cooldown = 30; // 30s between events
          return;
        }
      }
    }
  },
  trigger(printerIdx, evt) {
    State.activeEquipmentEvents.push({ printerIdx, eventId: evt.id, fixCost: evt.fixCost||0, resolved: false });
    if (evt.effect === 'offline') {
      // Stop the printer and mark it offline so it can't restart until fixed
      const p = State.printers[printerIdx];
      if (p) {
        p._offline = true;
        if (p.active) {
          Sound.stopHum(printerIdx);
          p.active = false;
          p.job = null;
          p.progress = 0;
          p.timeLeft = 0;
          if (State.viewingPrinterIdx === printerIdx) UI.renderCenterPanel();
        }
      }
    } else if (evt.effect === 'hploss') {
      State.printers.forEach(p=>{ p.health = Math.max(10, p.health-15); });
    } else if (evt.effect === 'cancel' && State.printers[printerIdx].active) {
      // v17.3 fix: properly cancel job with sound + timeLeft reset
      Sound.stopHum(printerIdx);
      State.printers[printerIdx].active = false;
      State.printers[printerIdx].job = null;
      State.printers[printerIdx].progress = 0;
      State.printers[printerIdx].timeLeft = 0;
      if (State.viewingPrinterIdx === printerIdx) UI.renderCenterPanel();
    }
    UI.toast(`${evt.icon} ${evt.name} — Printer #${printerIdx+1}!`, 'warn');
    this.render();
  },
  fix(printerIdx, eventId) {
    const eIdx = State.activeEquipmentEvents.findIndex(e=>e.printerIdx===printerIdx && e.eventId===eventId);
    if (eIdx < 0) return;
    const e = State.activeEquipmentEvents[eIdx];
    if (e.fixCost > 0 && State.money < e.fixCost) { UI.toast('💸 Not enough money to fix!','warn'); return; }
    State.money = r2(State.money - e.fixCost);
    if (State.printers[printerIdx]._offline) delete State.printers[printerIdx]._offline;
    State.activeEquipmentEvents.splice(eIdx, 1);
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0 };
    State.stats_v8.equipmentEventsFixed++;
    UI.toast(`🔧 Fixed! Printer #${printerIdx+1} back online.`,'success');
    this.render();
    UI.updateTopBar();
  },
  render() {
    const panel = $el('equip-events-panel');
    if (!panel) return;
    const active = State.activeEquipmentEvents.filter(e=>!e.resolved);
    if (!active.length) { panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:12px">✅ All systems operational</div>'; return; }
    panel.innerHTML = active.map(e=>{
      const cfg = CONFIG.EQUIPMENT_EVENTS.find(x=>x.id===e.eventId);
      if (!cfg) return '';
      return `<div class="equip-event-card">
        <div class="equip-event-title">${cfg.icon} ${cfg.name} — Printer #${e.printerIdx+1}</div>
        <div class="equip-event-desc">${cfg.desc}</div>
        <button class="btn btn-sm ${e.fixCost?'btn-danger':'btn-ghost'}" onclick="EquipmentEvents.fix(${e.printerIdx},'${e.eventId}')">
          ${e.fixCost ? `🔧 Fix (€${e.fixCost})` : '🔧 Resolve'}
        </button>
      </div>`;
    }).join('');
  },
};

// ── v8: BOUNTY BOARD ────────────────────────────────────
const BountyBoard = {
  _refreshTimer: 0,
  init() {
    State.activeBounties = [];
    this._refreshBounties();
  },
  _refreshBounties() {
    const maxSlots = State.researchFlags?.bountyIntel ? 3 : 2;
    const pool = [...CONFIG.BOUNTIES].sort(()=>Math.random()-0.5);
    State.activeBounties = pool.slice(0, maxSlots).map(b=>({
      ...b,
      progress: 0,
      expiresAt: Date.now() + 600000, // 10 min
      claimed: false,
    }));
    State.bountyRefreshTimer = 600;
    this.render();
  },
  tick(dt) {
    State.bountyRefreshTimer -= dt;
    if (State.bountyRefreshTimer <= 0) this._refreshBounties();
    // Progress tracking for health-type bounty
    for (const b of State.activeBounties) {
      if (b.claimed) continue;
      if (b.type === 'health') {
        const allHealthy = State.printers.every(p=>p.health >= 90);
        if (allHealthy) b.progress += dt;
        else b.progress = 0;
        if (b.progress >= b.target) this.claim(b.id);
      }
    }
  },
  onJobComplete(order, filament, quality) {
    for (const b of State.activeBounties) {
      if (b.claimed) continue;
      if (b.type === 'nofail') b.progress++;
      if (b.type === 'bulk' && order.orderType === 'bulk') b.progress++;
      if (b.type === 'vip' || b.type === 'ultra_vip') {
        if (order.orderType === 'vip') {
          if (b.type === 'ultra_vip' && quality === 'ULTRA') b.progress++;
          else if (b.type !== 'ultra_vip') b.progress++;
        }
      }
      if (b.type === 'tpu' && filament === 'TPU') b.progress++;
      if (b.type === 'mystery' && order.orderType === 'mystery') b.progress++;
      if (b.type === 'resin_fine' && filament === 'RESIN' && (quality==='FINE'||quality==='ULTRA')) b.progress++;
      if (b.type === 'pa6_rush' && filament === 'PA6') b.progress++;
      if (b.progress >= b.target) this.claim(b.id);
    }
  },
  onFail() {
    for (const b of State.activeBounties) {
      if (b.type === 'nofail') b.progress = 0;
    }
  },
  onCombo(combo) {
    for (const b of State.activeBounties) {
      if (b.type === 'combo' && combo >= b.target) this.claim(b.id);
    }
  },
  onEarn(amount) {
    for (const b of State.activeBounties) {
      if (b.type === 'earn_burst') {
        b.progress += amount;
        if (b.progress >= b.target) this.claim(b.id);
      }
    }
  },
  claim(id) {
    const b = State.activeBounties.find(x=>x.id===id);
    if (!b || b.claimed) return;
    b.claimed = true;
    State.claimedBounties.push(id);
    State.money = r2(State.money + b.reward);
    State.stats.totalEarned = r2(State.stats.totalEarned + b.reward);
    TaxSystem.accrue(b.reward);
    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + b.bonusRep);
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0 };
    State.stats_v8.bountiesClaimed++;
    State.xp += 60;
    Confetti.burst();
    UI.toast(`🎯 BOUNTY CLAIMED: ${b.name}! +€${b.reward} +${b.bonusRep} Rep`,'success');
    this.render();
    UI.updateTopBar();
    Milestones.check();
  },
  render() {
    const panel = $el('bounty-panel');
    if (!panel) return;
    const now = Date.now();
    const html = State.activeBounties.map(b=>{
      const pct = Math.min(100, (b.progress / b.target) * 100);
      const msLeft = b.expiresAt - now;
      const secLeft = Math.max(0, Math.floor(msLeft/1000));
      const cls = b.claimed ? 'bounty-claimed' : '';
      return `<div class="bounty-card ${cls}">
        <div class="bounty-name">${b.icon} ${b.name}</div>
        <div class="bounty-req">${b.desc}</div>
        <div style="margin:6px 0">
          <div style="height:5px;background:var(--bg);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${pct.toFixed(1)}%;background:linear-gradient(90deg,#ffd700,#ff9f43);border-radius:3px;transition:width 0.3s"></div>
          </div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:2px">${b.progress}/${b.target} — ${pct.toFixed(0)}%</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="bounty-reward">€${b.reward} <span style="font-size:11px;color:var(--text-dim)">+${b.bonusRep} rep</span></div>
          ${b.claimed ? '<span style="color:var(--accent3);font-size:11px">✓ Claimed</span>' : `<div class="bounty-expires">⏱ ${fmtTime(secLeft)}</div>`}
        </div>
      </div>`;
    }).join('') || '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:16px">No active bounties</div>';
    panel.innerHTML = `<div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;display:flex;justify-content:space-between"><span>🎯 Active Bounties</span><span>Refreshes in ${fmtTime(Math.max(0,State.bountyRefreshTimer))}</span></div>${html}`;
  },
};

// ── v8: SPECIAL ORDER HELPERS ────────────────────────────
const SpecialOrders = {
  getType() {
    const r = Math.random();
    const c = CONFIG.SPECIAL_ORDER_CHANCE;
    // Apply VIP boost from research
    const vipChance = c.vip * (State.researchFlags?.vipNetwork ? 2 : 1) * (State.researchFlags?.vipPortal ? 2 : 1);
    if (r < c.rush)                      return 'rush';
    if (r < c.rush + vipChance)          return 'vip';
    if (r < c.rush + vipChance + c.bulk) return 'bulk';
    if (r < c.rush + vipChance + c.bulk + c.mystery) return 'mystery';
    // Legendary check
    if (State.legendaryUnlocked && State.researchFlags?.monopoly && Math.random() < 0.03) return 'legendary';
    return 'normal';
  },
  applyModifiers(order) {
    const t = order.orderType;
    if (t === 'rush') {
      order.reward *= 1.6;
      order.expireTime *= 0.5; // half the time
      order.rushBonus = State.researchFlags?.rushBonus ? 1.3 : 1;
      order.reward *= order.rushBonus;
    } else if (t === 'vip') {
      order.reward *= 2.0;
      order.expireTime *= 1.5;
      order.printTime *= 1.2; // more careful
    } else if (t === 'bulk') {
      order.reward *= 2.5;
      order.printTime *= 1.8; // bigger job
      order.expireTime *= 2;
    } else if (t === 'mystery') {
      order.reward *= (1.5 + Math.random() * 2.0); // 1.5× to 3.5× random!
      order.mystery = true;
      order.name = '??? ' + order.name;
    } else if (t === 'legendary') {
      order.reward *= 5;
      order.printTime *= 3;
      order.expireTime *= 3;
      order.name = CONFIG.ORDER_NAMES_LEGENDARY[Math.floor(Math.random()*CONFIG.ORDER_NAMES_LEGENDARY.length)];
    }
    return order;
  },
  getLabel(type) {
    return { rush:'🚨 RUSH', vip:'👑 VIP', bulk:'📦 BULK', mystery:'🎲 MYSTERY', legendary:'⭐ LEGENDARY', flash:'⚡ FLASH', normal:'' }[type] || '';
  },
  getTagClass(type) {
    return { rush:'tag-rush', vip:'tag-vip', bulk:'tag-bulk', mystery:'tag-mystery', legendary:'tag-vip', flash:'tag-diff', normal:'' }[type] || '';
  },
};

// ── v8: DASHBOARD ────────────────────────────────────────
const Dashboard = {
  render() {
    const panel = $el('dashboard-panel');
    if (!panel) return;
    const s = State.stats;
    const successRate = s.jobsDone+s.jobsFailed > 0 ? ((s.jobsDone/(s.jobsDone+s.jobsFailed))*100).toFixed(1) : '—';
    const avgEarning = s.jobsDone > 0 ? (s.totalEarned/s.jobsDone).toFixed(2) : '0.00';
    const sessionMin = Math.max(1, (Date.now() - s.sessionStart) / 60000);
    const eph = (s.sessionEarned / sessionMin * 60).toFixed(0);
    const activePrinters = State.printers.filter(p=>p.active).length;
    const efficiency = State.printers.length > 0 ? Math.round(activePrinters/State.printers.length*100) : 0;
    const repTier = State.reputation >= 150 ? 4 : State.reputation >= 100 ? 3 : State.reputation >= 50 ? 2 : State.reputation >= 20 ? 1 : 0;
    const repTierNames = ['Newcomer','Known','Reliable','Trusted','Legend'];
    const research = State.completedResearch.length;
    const totalRes = CONFIG.RESEARCH.length;
    const milestonesDone = State.claimedMilestones.length;
    const totalMilestones = CONFIG.MILESTONES.length;

    panel.innerHTML = `
      <div class="kpi-row">
        <div class="kpi-pill"><div class="kpi-val">${fmtEur(s.sessionEarned)}</div><div class="kpi-lbl">Session</div></div>
        <div class="kpi-pill"><div class="kpi-val">€${eph}/h</div><div class="kpi-lbl">Rate</div></div>
        <div class="kpi-pill"><div class="kpi-val">${successRate}%</div><div class="kpi-lbl">Success</div></div>
        <div class="kpi-pill"><div class="kpi-val">${s.currentStreak}</div><div class="kpi-lbl">Streak</div></div>
      </div>
      <div class="kpi-row" style="margin-top:6px">
        <div class="kpi-pill" style="background:rgba(127,255,110,0.08)"><div class="kpi-val" style="color:var(--accent3)">${fmtEur(s.totalEarned - (s.totalFilamentCost||0))}</div><div class="kpi-lbl">Net Profit</div></div>
        <div class="kpi-pill" style="background:rgba(255,204,0,0.06)"><div class="kpi-val" style="color:var(--warn)">${fmtEur((State.franchiseBranches||[]).reduce((a,b)=>a+(b.incomePerMin||0),0))}/min</div><div class="kpi-lbl">Franchise</div></div>
        <div class="kpi-pill"><div class="kpi-val">${Object.values(State.clientTiers||{}).filter(t=>t==='platinum').length}</div><div class="kpi-lbl">Platinum</div></div>
        <div class="kpi-pill"><div class="kpi-val">${State.xp}</div><div class="kpi-lbl">XP</div></div>
      </div>
      <div class="dashboard-grid">
        <div class="dash-card">
          <div class="dash-card-label">Total Revenue</div>
          <div class="dash-card-value">${fmtEur(s.totalEarned)}</div>
          <div class="dash-card-trend dash-trend-up">↑ Best job: ${fmtEur(s.bestSingleJob||0)}</div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Jobs Completed</div>
          <div class="dash-card-value">${s.jobsDone}</div>
          <div class="dash-card-trend dash-trend-up">↑ Avg ${fmtEur(avgEarning)}/job</div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Printer Efficiency</div>
          <div class="dash-card-value">${efficiency}%</div>
          <div class="dash-efficiency-bar"><div class="dash-eff-fill" style="width:${efficiency}%"></div></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Reputation</div>
          <div class="dash-card-value">${State.reputation}</div>
          <div class="dash-card-trend"><span class="rep-tier-badge rep-tier-${repTier}">${repTierNames[repTier]}</span></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Research</div>
          <div class="dash-card-value">${research}/${totalRes}</div>
          <div style="height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px"><div style="height:100%;width:${(research/totalRes*100).toFixed(0)}%;background:var(--accent);border-radius:2px"></div></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Mijlpalen</div>
          <div class="dash-card-value">${milestonesDone}/${totalMilestones}</div>
          <div style="height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px"><div style="height:100%;width:${(milestonesDone/totalMilestones*100).toFixed(0)}%;background:var(--warn);border-radius:2px"></div></div>
        </div>
      </div>
      <div style="margin-top:6px">
        <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Special Orders Completed</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="tag tag-rush">🚨 Rush: ${State.stats_v8.rushDone}</span>
          <span class="tag tag-vip">👑 VIP: ${State.stats_v8.vipDone}</span>
          <span class="tag tag-bulk">📦 Bulk: ${State.stats_v8.bulkDone}</span>
          <span class="tag tag-mystery">🎲 Mystery: ${State.stats_v8.mysteryDone}</span>
        </div>
      </div>
      <div style="margin-top:8px">
        <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">All-Time Records</div>
        <div class="kpi-row">
          <div class="kpi-pill"><div class="kpi-val">${s.longestStreak}</div><div class="kpi-lbl">Best Streak</div></div>
          <div class="kpi-pill"><div class="kpi-val">${State.stats_v8.bountiesClaimed}</div><div class="kpi-lbl">Bounties</div></div>
          <div class="kpi-pill"><div class="kpi-val">${State.prestige}</div><div class="kpi-lbl">Prestiges</div></div>
        </div>
      </div>
      ${State.bizLevel >= 6 ? `<div style="margin-top:10px;padding:10px;background:linear-gradient(135deg,rgba(0,229,255,0.08),rgba(127,255,110,0.05));border:1px solid rgba(0,229,255,0.2);border-radius:var(--radius)">
        <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">🏆 Endgame Score</div>
        <div style="font-family:var(--display);font-weight:900;font-size:28px;color:var(--accent)">
          ${(()=>{
            const score = Math.floor(
              (s.totalEarned / 100) +
              (s.jobsDone * 2) +
              (State.reputation * 5) +
              (State.prestige * 500) +
              ((s.longestStreak||0) * 10) +
              ((State.stats_v8?.bountiesClaimed||0) * 20) +
              ((State.completedResearch?.length||0) * 50) +
              ((State.franchiseBranches?.length||0) * 200)
            );
            return score.toLocaleString();
          })()}
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:3px">Score = earnings + jobs + rep + prestiges + streaks + bounties + research + franchises</div>
      </div>` : ''}
    `;
  },
};

function renderMilestoneProgress() {
  const el = document.getElementById('milestone-progress-list');
  if (!el) return;
  el.innerHTML = CONFIG.MILESTONES.map(m => {
    const done = State.claimedMilestones.includes(m.id);
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border)">
      <div>
        <span style="font-size:14px">${m.icon}</span>
        <span style="font-size:10px;color:${done?'var(--accent3)':'var(--text)'};margin-left:4px">${m.name}</span>
      </div>
      <span style="font-size:11px;color:${done?'var(--accent3)':'var(--text-dim)'}">${done ? '✓ Claimed' : m.rewardText}</span>
    </div>`;
  }).join('');
}

// ── RIVAL COMPETITOR (PrintBot) ──────────────────────────
const Rival = {
  NAMES: ['PrintBot 3000','FilamentFoe','SpeedPrinter AI','RivalRobot','NozzleNemesis'],
  _name: 'PrintBot',
  _stealTimer: 35, // fix: start with full interval so rival doesn't steal immediately
  _stealInterval: 35, // seconds between steals, decreases with level

  init() {
    this._name = this.NAMES[Math.floor(Math.random() * this.NAMES.length)];
    State.rivalActive = true;
    UI.log(`🤖 ${this._name} has entered the market! Accept orders quickly!`, 'warn');
    // Show the rival banner persistently as scoreboard
    const banner = document.getElementById('rival-banner');
    const msgEl  = document.getElementById('rival-msg');
    if (banner) banner.classList.add('active');
    if (msgEl)  msgEl.textContent = `${this._name} is in de markt — accepteer orders snel!`;
    this._updateScoreDisplay();
  },

  _updateScoreDisplay() {
    const score  = document.getElementById('rival-score');
    const pscore = document.getElementById('rival-player-score');
    if (score)  score.textContent  = State.rivalScore || 0;
    if (pscore) pscore.textContent = State.stats?.jobsDone || 0;
    // Color-code lead/lag
    const lead = (State.stats?.jobsDone || 0) - (State.rivalScore || 0);
    const scoreEl = document.getElementById('rival-score');
    if (scoreEl) scoreEl.style.color = lead >= 0 ? 'var(--accent3)' : 'var(--danger)';
  },

  tick(dt) {
    if (!State.rivalActive) return;
    // Only active from level 3+
    if (State.bizLevel < 3) return;

    this._stealTimer -= dt;
    const interval = Math.max(15, this._stealInterval - State.bizLevel * 2);
    if (this._stealTimer <= 0) {
      this._stealTimer = interval + Math.random() * 15;
      this._maybeSteal();
    }
  },

  _maybeSteal() {
    // Steal the oldest/least valuable order
    if (State.orders.length < 2) return; // leave at least 1
    // v17.4 fix: respect rivalBlocker legacy perk (reduces steal chance)
    if (State.rivalBlocker && Math.random() < Math.min(0.95, State.rivalBlocker)) return;
    // Sort by time left ascending — steal the one about to expire
    const sorted = [...State.orders].sort((a, b) => a.timeLeft - b.timeLeft);
    // fix: never steal the order the player has selected
    const victim = sorted.find(o => !State.pendingOrder || o.id !== State.pendingOrder.id);
    if (!victim) return;

    State.orders = State.orders.filter(o => o.id !== victim.id);
    State.rivalScore = (State.rivalScore || 0) + 1;
    State.reputation = Math.max(0, State.reputation - 1);

    // Show banner
    const banner = $el('rival-banner');
    const msg = $el('rival-msg');
    const score = $el('rival-score');
    const pscore = $el('rival-player-score');
    if (banner) {
      banner.classList.add('active', 'rival-steal');
      setTimeout(() => banner.classList.remove('rival-steal'), 500);
    }
    if (msg) msg.textContent = `${this._name} snatched: "${victim.name}" (€${victim.reward.toFixed(2)}) — Be faster!`;
    this._updateScoreDisplay();

    UI.log(`🤖 ${this._name} stole order: "${victim.name}"! -1 Rep`, 'warn');
    UI.renderOrders();
    UI.updateTopBar();

    // Toon als popup (meer zichtbaar dan kleine toast)
    UI.showPopup(
      `🤖 ${this._name} stal je order!`,
      `<div style="text-align:center">
        <div style="font-size:36px;margin-bottom:8px">🤖😤</div>
        <div style="font-family:var(--display);font-weight:900;font-size:16px;color:var(--danger);margin-bottom:8px">Order gestolen!</div>
        <div style="background:rgba(255,61,90,0.08);border:1px solid rgba(255,61,90,0.2);border-radius:var(--radius);padding:10px;margin-bottom:10px">
          <div style="font-weight:700;color:var(--text)">${victim.name}</div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:3px">€${victim.reward.toFixed(2)} misgelopen · −1 reputatie</div>
        </div>
        <div style="font-size:11px;color:var(--text-dim);line-height:1.6">
          ${this._name} is sneller dan jij.<br>
          <span style="color:var(--warn)">Accepteer orders sneller of koop de Rival Blocker legacy perk.</span>
        </div>
      </div>`
    );
  },

  onJobComplete() {
    State.playerVsRival = (State.playerVsRival || 0) + 1;
    this._updateScoreDisplay();

    // Check if player has beaten rival by 20+ jobs — they win this round!
    const lead = (State.playerVsRival || 0) - State.rivalScore;
    if (lead >= 20 && !State._rivalDefeated) {
      State._rivalDefeated = true;
      this._stealInterval = 50; // fix: was State._stealInterval (had no effect)
      const prize = 200 + State.bizLevel * 50;
      State.money = r2(State.money + prize);
      TaxSystem.accrue(prize);
      State.reputation = Math.min(200, State.reputation + 15);
      State.xp += 100;
      Sound.levelUp();
      Confetti.burst(80);
      UI.log(`🏆 You BEAT ${this._name}! +€${prize} bounty · +15 Rep · +100 XP`, 'success');
      UI.showPopup(`🏆 Rival Defeated!`,
        `<div style="text-align:center"><div style="font-size:32px">🤖💥</div><strong style="font-family:var(--display);color:var(--accent);font-size:16px">${this._name} DESTROYED!</strong><br><br>You outpaced the rival by 20 jobs!<br><br>💰 +€${prize} &nbsp; ⭐ +15 Rep &nbsp; ⚡ +100 XP<br><br><span style="font-size:10px;color:var(--text-dim)">The rival will return stronger at the next level…</span></div>`);
      NewsTicker.addItem(`🏆 RIVAL VERSLAGEN! ${this._name} is van de markt geveegd na ${State.stats.jobsDone} jobs!`);
    }
  },

  resetForNextLevel() {
    // Called when player levels up — rival gets a second wind
    if (!State.rivalActive || !State._rivalDefeated) return;
    State._rivalDefeated = false;
    // Reset both scores so the player has a fair shot at defeating the rival again
    State.playerVsRival = 0;
    State.rivalScore = 0;
    this._stealInterval = Math.max(12, 35 - State.bizLevel * 3); // faster at higher levels
    this._name = this.NAMES[Math.floor(Math.random() * this.NAMES.length)] + ' MkII';
    UI.log(`🤖 ${this._name} is back — and faster! Keep up!`, 'warn');
    NewsTicker.addItem(`⚠️ Rival terug: ${this._name} — nu sneller dan ooit!`);
  },
};

// ── FLASH ORDERS ──────────────────────────────────────────────
// High-value orders that expire in 15 seconds — act fast!
const FlashOrders = {
  _timer: 0,
  _interval: 90, // seconds between flash order chances

  tick(dt) {
    if (State.bizLevel < 2) return;
    this._timer += dt;
    if (this._timer >= this._interval) {
      this._timer = 0;
      const lvlScale = 1 + (State.bizLevel - 1) * 0.15;
      this._interval = (70 + Math.random() * 60) * lvlScale;
      if (Math.random() < 0.4 && State.orders.length < CONFIG.MAX_ORDERS) {
        this._spawn();
      }
    }
  },

  _spawn() {
    const base = Orders.generate();
    base.reward = r2(base.reward * (2.5 + Math.random() * 1.5)); // 2.5–4× normal reward
    base.timeLeft = 15;
    base.expiresIn = 15;
    base.urgent = true;
    base.isFlash = true;
    base.orderType = 'flash';
    base.name = `⚡ FLASH: ${base.name}`;
    State.orders.unshift(base); // put at top of list
    Sound.levelUp();
    UI.log(`⚡ FLASH ORDER! ${base.name} — €${base.reward.toFixed(2)} — only 15 seconds!`, 'warn');
    NewsTicker.addItem(`⚡ FLASH ORDER: ${base.name} — €${base.reward.toFixed(2)} — 15 seconden!`);
    UI.renderOrders();
  },
};

// ── DEMAND SURGE ─────────────────────────────────────────
const DemandSurge = {
  SURGES: [
    { name:'🔥 PLA Frenzy',     filament:'PLA',   target:6,  duration:120, reward:180, bonusRep:8,  bonusMult:1.5 },
    { name:'💜 PETG Rush',      filament:'PETG',  target:4,  duration:100, reward:250, bonusRep:12, bonusMult:1.6 },
    { name:'🟠 PA6 Demand',     filament:'PA6',   target:3,  duration:90,  reward:400, bonusRep:18, bonusMult:1.8 },
    { name:'🧲 TPU Sprint',     filament:'TPU',   target:4,  duration:110, reward:300, bonusRep:14, bonusMult:1.7 },
    { name:'🔮 Resin Bonanza',  filament:'RESIN', target:2,  duration:80,  reward:500, bonusRep:22, bonusMult:2.0 },
    { name:'⚡ Any Material',   filament:null,    target:8,  duration:150, reward:350, bonusRep:15, bonusMult:1.4 },
  ],

  tick(dt) {
    if (State.activeSurge) {
      State.activeSurge.timer -= dt;
      this.updateUI();
      if (State.activeSurge.timer <= 0) this._end(false);
      return;
    }
    // Check if can start
    State.surgeCountdown -= dt;
    if (State.surgeCountdown <= 0) {
      State.surgeCountdown = 90 + Math.random() * 120;
      if (Math.random() < 0.4 && State.bizLevel >= 2) this._start();
    }
  },

  _start() {
    // Filter out locked filaments
    const available = this.SURGES.filter(s => {
      if (!s.filament) return true;
      if (s.filament === 'TPU' && !State.tpuUnlocked) return false;
      if (s.filament === 'RESIN' && !State.resinUnlocked) return false;
      if (s.filament === 'PETG' && State.reputation < 20) return false;
      if (s.filament === 'PA6' && State.reputation < 60) return false;
      return true;
    });
    const surge = available[Math.floor(Math.random() * available.length)];
    State.activeSurge = { ...surge, timer: surge.duration, done: 0, startTime: Date.now() };

    const banner = $el('surge-banner');
    if (banner) banner.classList.add('active');
    const nm = $el('surge-name');
    if (nm) nm.textContent = surge.name;
    const rw = $el('surge-reward');
    if (rw) rw.textContent = `€${surge.reward} Bonus`;

    UI.log(`🔥 DEMAND SURGE: ${surge.name}! Complete ${surge.target} ${surge.filament||'any'} jobs in ${Math.round(surge.duration)}s for a bonus!`, 'warn');
    Sound.success && Sound.success();

    // Ticker
    NewsTicker.addItem(`🔥 DEMAND SURGE: ${surge.name} — Quick, complete orders for a huge bonus!`);
  },

  onJobComplete(filament) {
    if (!State.activeSurge) return;
    const s = State.activeSurge;
    if (s.filament && s.filament !== filament) return;
    s.done++;
    this.updateUI();
    if (s.done >= s.target) this._end(true);
  },

  updateUI() {
    const s = State.activeSurge;
    if (!s) return;
    const fill = $el('surge-fill');
    const text = $el('surge-progress-text');
    const timer = $el('surge-timer');
    if (fill) fill.style.width = Math.min(100, (s.done / s.target) * 100) + '%';
    if (text) text.textContent = `${s.done}/${s.target}`;
    if (timer) {
      const m = Math.floor(s.timer / 60), sec = r0(s.timer % 60);
      timer.textContent = `⏳ ${m}:${sec.toString().padStart(2,'0')} remaining`;
      timer.style.color = s.timer < 20 ? 'var(--danger)' : 'var(--accent3)';
    }
  },

  _end(success) {
    const s = State.activeSurge;
    if (!s) return;
    State.activeSurge = null;
    const banner = $el('surge-banner');
    if (banner) banner.classList.remove('active');

    if (success) {
      // v17.4 fix: apply surgeBonus legacy perk (was set but never read)
      const surgeReward = r2(s.reward * (1 + (State.surgeBonus || 0)));
      State.money = r2(State.money + surgeReward);
      State.stats.totalEarned = r2(State.stats.totalEarned + surgeReward);
      TaxSystem.accrue(surgeReward);
      State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + s.bonusRep);
      State.stats.surgesDone = (State.stats.surgesDone || 0) + 1;
      Confetti.burst(60);
      UI.floatMoney(`+€${surgeReward} SURGE BONUS!`);
      UI.log(`🎉 DEMAND SURGE COMPLETE: ${s.name}! +€${surgeReward} +${s.bonusRep} rep!`, 'money');
      const t = document.createElement('div');
      t.className = 'contract-toast';
      t.innerHTML = `<div style="font-size:11px;letter-spacing:2px;color:var(--accent3)">🔥 DEMAND SURGE COMPLETE!</div><div style="font-family:var(--display);font-weight:700;font-size:15px">${s.name}</div><div style="font-size:10px;color:var(--text-dim)">+€${s.reward} · +${s.bonusRep} Rep</div>`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 5000);
      Sound.success && Sound.success();
    } else {
      UI.log(`❌ Demand Surge failed: ${s.name}. Only completed ${s.done}/${s.target}.`, 'warn');
    }
    State.surgeCountdown = 80 + Math.random() * 100;
  },

  getSurgeMultiplier(filament) {
    if (!State.activeSurge) return 1;
    const s = State.activeSurge;
    if (!s.filament || s.filament === filament) return s.bonusMult;
    return 1;
  },
};

// ── CLOG MINI-GAME ───────────────────────────────────────
const ClogMinigame = {
  _printerIdx: null,
  _clicks: 0,
  _target: 20,
  _timer: null,
  _timeLeft: 8,
  _total: 8,

  trigger(printerIdx) {
    if (State.clogActive) return;
    State.clogActive = true;
    this._printerIdx = printerIdx;
    this._clicks = 0;
    // Scale difficulty with level
    this._target = 15 + State.bizLevel * 2;
    this._timeLeft = 8;
    this._total = 8;

    const overlay = $el('clog-overlay');
    if (overlay) overlay.classList.add('active');
    const pname = $el('clog-printer-name');
    if (pname) pname.textContent = State.printers[printerIdx]?.name || 'Printer #1';
    this._renderProgress();

    clearInterval(this._timer);
    this._timer = setInterval(() => {
      this._timeLeft -= 0.1;
      const fill = $el('clog-timer-fill');
      if (fill) fill.style.width = Math.max(0, (this._timeLeft / this._total) * 100) + '%';
      if (this._timeLeft <= 0) {
        clearInterval(this._timer);
        this._fail();
      }
    }, 100);

    Sound.failure && Sound.failure();
    UI.log(`🔴 NOZZLE VERSTOPT op ${State.printers[printerIdx]?.name}! Snel, maak hem vrij!`, 'error');
  },

  press() {
    if (!State.clogActive) return;
    this._clicks++;
    this._timeLeft = Math.min(this._total, this._timeLeft + 0.3); // small time bonus per press
    this._renderProgress();
    Sound.click && Sound.click();

    const btn = $el('clog-btn');
    if (btn) {
      btn.style.transform = 'scale(0.85)';
      setTimeout(() => btn.style.transform = '', 80);
    }

    if (this._clicks >= this._target) {
      clearInterval(this._timer);
      this._win();
    }
  },

  _renderProgress() {
    const clicks = $el('clog-clicks');
    const target = $el('clog-target');
    const fb = $el('clog-feedback');
    if (clicks) clicks.textContent = this._clicks;
    if (target) target.textContent = this._target;
    if (fb) {
      const pct = this._clicks / this._target;
      if (pct < 0.3) fb.textContent = 'Tik snel op de knop!';
      else if (pct < 0.6) { fb.textContent = 'Keep going! Almost there...'; fb.style.color = 'var(--warn)'; }
      else if (pct < 0.9) { fb.textContent = '💪 Nearly clear! Final push!'; fb.style.color = 'var(--accent3)'; }
      else { fb.textContent = '🔥 So close!'; fb.style.color = 'var(--accent)'; }
    }
  },

  _win() {
    const fb = $el('clog-feedback');
    if (fb) { fb.textContent = '✅ Clog cleared! Print continuing...'; fb.style.color = 'var(--accent3)'; }
    Sound.success && Sound.success();
    State.stats.clogWins = (State.stats.clogWins || 0) + 1;
    Achievements.check();
    setTimeout(() => {
      this._close();
      UI.log(`🔧 Nozzle vrij! Print op ${State.printers[this._printerIdx]?.name} hervat.`, 'success');
    }, 1000);
  },

  _fail() {
    const fb = $el('clog-feedback');
    if (fb) { fb.textContent = '❌ Too slow! The print failed.'; fb.style.color = 'var(--danger)'; }
    Sound.failure && Sound.failure();
    setTimeout(() => {
      const p = State.printers[this._printerIdx];
      if (p && p.active && p.job) {
        // Bug fix: route through Printer._onFailure for full downstream handling
        // (contracts, bounties, combo reset, recycling, insurance, complaints, etc.)
        Sound.stopHum(this._printerIdx);
        p._clogPause = false;
        Printer._onFailure(p, p.job);
        Printer._resetPrinter(p, true);
        Game.checkBizLevel();
        Achievements.check();
        UI.renderCenterPanel();
        UI.renderPrinters();
        UI.updateTopBar();
      }
      this._close();
    }, 1200);
  },

  skip() {
    clearInterval(this._timer);
    this._fail();
  },

  _close() {
    const overlay = $el('clog-overlay');
    if (overlay) overlay.classList.remove('active');
    State.clogActive = false;
    this._printerIdx = null;
    this._clicks = 0;
  },
};

// ── LOAN SYSTEM ──────────────────────────────────────────
const Loans = {
  OFFERS: [
    { id:'loan_sm',  label:'Small Loan',    amount:200,  interestRate:0.02, desc:'€200 instant. 2% interest per minute.' },
    { id:'loan_md',  label:'Business Loan', amount:750,  interestRate:0.025,desc:'€750 capital. 2.5% interest per minute.' },
    { id:'loan_lg',  label:'Growth Loan',   amount:2000, interestRate:0.03, desc:'€2,000 expansion. 3% interest per minute.' },
    { id:'loan_xl',  label:'Venture Loan',  amount:6000, interestRate:0.035,desc:'€6,000 injection. 3.5% interest per minute. High risk!' },
  ],

  take(id) {
    const offer = this.OFFERS.find(o => o.id === id);
    if (!offer) return;
    // Check not already taken
    if (State.activeLoans.find(l => l.id === id)) {
      UI.showPopup('Loan Active', 'You already have this loan. Repay it first!'); return;
    }
    const loan = { id, label: offer.label, amount: offer.amount, remaining: offer.amount, interestRate: offer.interestRate };
    State.activeLoans.push(loan);
    State.money = r2(State.money + offer.amount);
    State.totalDebt = r2(State.totalDebt + offer.amount);
    UI.log(`💳 Loan taken: ${offer.label} — +€${offer.amount} (${(offer.interestRate*100).toFixed(1)}% interest/min)`, 'money');
    UI.updateTopBar();
    this.render();
    // Show debt panel
    this._updateDebtUI();
  },

  tick(dt) {
    if (State.activeLoans.length === 0) return;
    // Bug fix: loan interest uses real seconds (unscaled), not game speed
    const realDt = dt / (Game.speed || 1);
    State.activeLoans.forEach(loan => {
      // Accrue interest every 60s in real time — tick by realDt
      loan._interestAccum = (loan._interestAccum || 0) + realDt;
      if (loan._interestAccum >= 60) {
        const interest = r2(loan.remaining * loan.interestRate);
        loan.remaining = r2(loan.remaining + interest);
        loan._interestAccum -= 60;
        if (loan.remaining > loan.amount * 2 && !loan._warnShown) {
          loan._warnShown = true;
          UI.log(`🚨 Loan "${loan.label}" doubled to €${loan.remaining.toFixed(2)}! Pay now!`, 'error');
          NewsTicker.addItem(`🚨 SCHULD: ${loan.label} verdubbeld naar €${loan.remaining.toFixed(2)}!`);
        }
        if (loan.remaining > loan.amount * 3 && !loan._critWarnShown) {
          loan._critWarnShown = true;
          UI.log(`💀 CRITICAL: "${loan.label}" is 3× original — bank penalty! -5 Rep`, 'error');
          State.reputation = Math.max(0, State.reputation - 5);
          UI.updateTopBar();
        }
      }
    });
    State.totalDebt = r2(State.activeLoans.reduce((sum, l) => sum + l.remaining, 0));
    this._updateDebtUI();
  },

  repayAll() {
    if (State.totalDebt <= 0) { UI.showPopup('No Debt', 'You have no outstanding loans!'); return; }
    if (State.money < State.totalDebt) {
      UI.showPopup('Insufficient Funds', `You need €${State.totalDebt.toFixed(2)} to repay all loans. You have €${State.money.toFixed(2)}.`); return;
    }
    State.money = r2(State.money - State.totalDebt);
    UI.log(`✅ All loans repaid! Total paid: €${State.totalDebt.toFixed(2)}`, 'success');
    State.activeLoans = [];
    State.totalDebt = 0;
    UI.updateTopBar();
    this._updateDebtUI();
    this.render();
  },

  repayOne(id) {
    const loan = State.activeLoans.find(l => l.id === id);
    if (!loan) return;
    if (State.money < loan.remaining) {
      UI.showPopup('Insufficient Funds', `Need €${loan.remaining.toFixed(2)} to repay this loan.`); return;
    }
    State.money = r2(State.money - loan.remaining);
    State.totalDebt = r2(State.totalDebt - loan.remaining);
    State.activeLoans = State.activeLoans.filter(l => l.id !== id);
    State.stats.loansRepaid = (State.stats.loansRepaid || 0) + 1;
    UI.log(`✅ Loan "${loan.label}" repaid!`, 'success');
    UI.updateTopBar();
    this._updateDebtUI();
    this.render();
  },

  _updateDebtUI() {
    const panel = $el('loan-debt-panel');
    const display = $el('loan-debt-display');
    if (panel) panel.style.display = State.totalDebt > 0 ? 'block' : 'none';
    if (display) {
      display.textContent = fmtEur(State.totalDebt);
      display.style.color = State.totalDebt > 1000 ? 'var(--danger)' : 'var(--warn)';
    }
    // Also show a warning pill in topbar if debt is high
    const pill = $el('debt-pill');
    if (pill) {
      if (State.totalDebt > 0) {
        pill.style.display = 'flex';
        pill.querySelector('#debt-val').textContent = fmtEur(State.totalDebt);
        pill.style.borderColor = State.totalDebt > 500 ? 'rgba(255,61,90,0.6)' : 'rgba(255,204,0,0.4)';
      } else {
        pill.style.display = 'none';
      }
    }
  },

  render() {
    const panel = $el('loan-panel'); if (!panel) return;
    panel.innerHTML = '';
    this.OFFERS.forEach(offer => {
      const active = State.activeLoans.find(l => l.id === offer.id);
      const card = document.createElement('div');
      card.className = 'loan-card';
      if (active) {
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-family:var(--display);font-weight:700;font-size:14px;color:var(--danger)">${offer.label}</div>
          <div class="loan-due">${fmtEur(active.remaining)}</div>
        </div>
        <div class="loan-interest">📈 ${(offer.interestRate*100).toFixed(1)}% interest/min — Balance growing!</div>
        <button class="btn btn-danger btn-sm btn-full" style="margin-top:8px" onclick="Loans.repayOne('${offer.id}')">💳 Repay ${fmtEur(active.remaining)}</button>`;
      } else {
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-family:var(--display);font-weight:700;font-size:14px">${offer.label}</div>
          <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--accent3)">€${offer.amount.toLocaleString()}</div>
        </div>
        <div style="font-size:10px;color:var(--text-dim);margin-bottom:8px">${offer.desc}</div>
        <button class="btn btn-warn btn-sm btn-full" onclick="Loans.take('${offer.id}')">💳 Take Loan</button>`;
      }
      panel.appendChild(card);
    });
  },
};

// ── POWER OUTAGE ─────────────────────────────────────────
const PowerOutage = {
  _countdown: 300,
  _active: false,
  _duration: 0,

  tick(dt) {
    if (this._active) {
      this._duration -= dt;
      if (this._duration <= 0) this._end();
      return;
    }
    // Only from level 4+
    if (State.bizLevel < 4) return;
    this._countdown -= dt;
    if (this._countdown <= 0) {
      this._countdown = 200 + Math.random() * 300;
      if (Math.random() < 0.25) this._trigger();
    }
  },

  _trigger() {
    // UPS upgrade prevents outages
    if (State.ownedUpgrades.includes('ups_system')) {
      UI.log('⚡ Power surge detected — UPS protected your printers!', 'success');
      return;
    }
    this._active = true;
    this._duration = 5 + Math.random() * 8;

    // Pause all active printers
    State.printers.forEach(p => {
      if (p.active) {
        p._pausedByOutage = true;
        p.active = false; // temporarily deactivate
      }
    });

    // Flash effect
    const flash = document.createElement('div');
    flash.className = 'outage-flash';
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 1500);

    UI.log('⚡ POWER OUTAGE! All printers paused! Invest in a UPS to prevent this!', 'error');
    UI.showPopup('⚡ Power Outage!', `A power outage hit your workshop! Printers are paused for ${r0(this._duration)} seconds.<br><br><span style="color:var(--danger)">Buy the <strong>UPS System</strong> upgrade to prevent future outages!</span>`);

    UI.renderPrinters();
    UI.renderCenterPanel();
    UI.updateTopBar();
    NewsTicker.addItem('⚡ POWER OUTAGE: Workshop offline! UPS upgrade recommended!');
  },

  _end() {
    this._active = false;
    // Resume printers
    State.printers.forEach(p => {
      if (p._pausedByOutage) {
        p.active = true;
        p._pausedByOutage = false;
      }
    });
    UI.log('✅ Power restored! Printers resuming...', 'success');
    UI.renderPrinters();
    UI.renderCenterPanel();
  },
};

// ── VAT / TAX SYSTEM ─────────────────────────────────────
const TaxSystem = {
  _pending: 0,

  tick(dt) {
    if (State.bizLevel < 2) return;
    State.taxTimer = (State.taxTimer ?? 180) - dt;
    if (State.taxTimer <= 0) {
      State.taxTimer = 180;
      this._bill();
    }
  },

  accrue(amount) {
    State.taxAccum = r2((State.taxAccum || 0) + amount);
  },

  _bill() {
    if ((State.taxAccum || 0) <= 5) { State.taxAccum = 0; return; }
    const rate = State.taxRate || 0.15;
    const base = State.taxAccum;
    const taxDue = r2(base * rate);
    this._pending = taxDue;
    const overlay = document.getElementById('tax-overlay');
    const amtEl   = document.getElementById('tax-amount');
    const breakEl = document.getElementById('tax-breakdown');
    const warnEl  = document.getElementById('tax-warning');
    if (amtEl)   amtEl.textContent = fmtEur(taxDue);
    if (breakEl) breakEl.innerHTML = `
      <div class="tax-row"><span>Taxable revenue</span><span>${fmtEur(base)}</span></div>
      <div class="tax-row"><span>VAT rate</span><span>${(rate*100).toFixed(0)}%</span></div>
      <div class="tax-row"><span>Tax due</span><span>${fmtEur(taxDue)}</span></div>`;
    if (warnEl) warnEl.textContent = State.money < taxDue ? '⚠ Insufficient funds! Rep penalty if unpaid.' : '';
    if (overlay) overlay.classList.add('active');
    State.taxAccum = 0;
    UI.log(`🧾 VAT bill: ${fmtEur(taxDue)} (${(rate*100).toFixed(0)}% of ${fmtEur(base)})`, 'warn');
  },

  pay() {
    const overlay = document.getElementById('tax-overlay');
    if (this._pending > 0) {
      if (State.money >= this._pending) {
        State.money = r2(State.money - this._pending);
        State.stats_v10.taxPaid = r2((State.stats_v10.taxPaid || 0) + this._pending);
        UI.log(`✅ Tax paid: ${fmtEur(this._pending)}`, 'info');
      } else {
        const pen = 10;
        State.reputation = Math.max(0, State.reputation - pen);
        UI.log(`⚠ Couldn't pay tax bill! −${pen} rep`, 'error');
      }
    }
    if (overlay) overlay.classList.remove('active');
    UI.updateTopBar();
    this._pending = 0;
  },
};

// ── CLIENT COMPLAINTS ─────────────────────────────────────
const Complaints = {
  maybeComplain(order) {
    if (!order || order.reward < 15) return;
    if (Math.random() > 0.40) return;
    const msgs  = CONFIG.COMPLAINT_MESSAGES;
    const faces = CONFIG.COMPLAINT_FACES;
    const refundAmt  = r2(order.reward * 0.6);
    const repPenalty = 8 + Math.floor(Math.random() * 8);
    State.pendingComplaint = {
      client: order.customer || 'Client',
      refundAmt, repPenalty,
      msg:  msgs[Math.floor(Math.random() * msgs.length)],
      face: faces[Math.floor(Math.random() * faces.length)],
    };
    const ov      = document.getElementById('complaint-overlay');
    const faceEl  = document.getElementById('complaint-face');
    const clEl    = document.getElementById('complaint-client');
    const msgEl   = document.getElementById('complaint-msg');
    const refEl   = document.getElementById('complaint-refund');
    const repEl   = document.getElementById('complaint-rep');
    if (faceEl) faceEl.textContent = State.pendingComplaint.face;
    if (clEl)   clEl.textContent   = State.pendingComplaint.client;
    if (msgEl)  msgEl.textContent  = State.pendingComplaint.msg;
    if (refEl)  refEl.textContent  = refundAmt.toFixed(2);
    if (repEl)  repEl.textContent  = repPenalty;
    if (ov)     ov.classList.add('active');
    State.stats_v10.complaintsReceived = (State.stats_v10.complaintsReceived || 0) + 1;
  },

  refund() {
    const c = State.pendingComplaint; if (!c) return;
    if (State.money < c.refundAmt) {
      // Can't afford refund — take a rep hit instead
      const pen = Math.round(c.repPenalty * 1.5);
      State.reputation = Math.max(0, State.reputation - pen);
      UI.log(`💸 Kon niet terugbetalen aan ${c.client} — −${pen} reputatie`, 'error');
      this._close(); UI.updateTopBar();
      return;
    }
    State.money = r2(State.money - c.refundAmt);
    State.stats_v10.complaintsRefunded = (State.stats_v10.complaintsRefunded || 0) + 1;
    UI.log(`💸 Refunded ${c.client}: ${fmtEur(c.refundAmt)}`, 'warn');
    this._close(); UI.updateTopBar();
  },

  ignore() {
    const c = State.pendingComplaint; if (!c) return;
    State.reputation = Math.max(0, State.reputation - c.repPenalty);
    UI.log(`😤 Ignored complaint from ${c.client}. −${c.repPenalty} rep.`, 'error');
    this._close(); UI.updateTopBar();
  },

  _close() {
    State.pendingComplaint = null;
    const ov = document.getElementById('complaint-overlay');
    if (ov) ov.classList.remove('active');
  },
};

// ── CLIENT TIER SYSTEM ────────────────────────────────────
const ClientTiers = {
  update(customerName) {
    if (!State.customers || !State.customers[customerName]) return;
    const jobs = State.customers[customerName].jobs || 0;
    const T = CONFIG.CLIENT_TIER_THRESHOLDS;
    let tier = null;
    if      (jobs >= T.platinum) tier = 'platinum';
    else if (jobs >= T.gold)     tier = 'gold';
    else if (jobs >= T.silver)   tier = 'silver';
    else if (jobs >= T.bronze)   tier = 'bronze';
    const old = (State.clientTiers || {})[customerName];
    if (tier && tier !== old) {
      State.clientTiers[customerName] = tier;
      const labels = { bronze:'🥉 Bronze', silver:'🥈 Silver', gold:'🥇 Gold', platinum:'💎 Platinum' };
      UI.log(`⭐ ${customerName} is now a ${labels[tier]} client! +${Math.round((CONFIG.CLIENT_TIER_BONUS[tier]-1)*100)}% reward bonus.`, 'success');
      const t = document.createElement('div');
      t.className = 'contract-toast';
      t.innerHTML = `<div style="font-size:11px;letter-spacing:2px;color:var(--warn)">CLIENT UPGRADE!</div>
        <div style="font-family:var(--display);font-weight:700;font-size:15px">${labels[tier]} · ${customerName}</div>
        <div style="font-size:10px;color:var(--text-dim)">+${Math.round((CONFIG.CLIENT_TIER_BONUS[tier]-1)*100)}% rewards from this client</div>`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 5000);
      // 💎 Platinum: spawn a special mega-order from this client
      if (tier === 'platinum') {
        setTimeout(() => CRM.spawnPlatinumDeal(customerName), 2000);
      }
      Achievements.check();
      NewsTicker.addItem(`💎 ${customerName} is nu een ${labels[tier]} klant! Speciale deals beschikbaar.`);
    }
  },

  getBonus(customerName) {
    const tier = (State.clientTiers || {})[customerName];
    return tier ? (CONFIG.CLIENT_TIER_BONUS[tier] || 1.0) : 1.0;
  },

  getBadge(customerName) {
    const tier = (State.clientTiers || {})[customerName];
    if (!tier) return '';
    const icons = { bronze:'🥉', silver:'🥈', gold:'🥇', platinum:'💎' };
    return `<span class="client-tier-badge tier-${tier}">${icons[tier]} ${tier.toUpperCase()}</span>`;
  },
};

// ── RECYCLING SYSTEM ──────────────────────────────────────
const Recycling = {
  onFailure(filament) {
    if (!State.ownedUpgrades.includes('recycler')) return;
    const base  = (CONFIG.FILAMENTS[filament] && CONFIG.FILAMENTS[filament].stockUse) || 3;
    const bonus = State.scrapBonus || 0;
    const scrap = Math.ceil(base * (0.5 + bonus));
    State.scrap = (State.scrap || 0) + scrap;
    this._updatePill();
    UI.log(`♻️ Salvaged ${scrap} scrap from failed ${filament} print.`, 'info');
  },

  convert(filament) {
    const cost = 15;
    if ((State.scrap || 0) < cost) { UI.showPopup('Not Enough Scrap', `Need ${cost} scrap. You have ${State.scrap||0}.`); return; }
    State.scrap -= cost;
    State.filamentStock[filament] = (State.filamentStock[filament] || 0) + 10;
    State.stats_v10.scrapsRecycled = (State.stats_v10.scrapsRecycled || 0) + 1;
    UI.log(`♻️ Converted ${cost} scrap → 10 ${filament}`, 'money');
    this._updatePill();
    this.renderPanel();
    Suppliers.updateStockUI && Suppliers.updateStockUI();
    Achievements.check && Achievements.check();
    UI.updateTopBar();
  },

  sell() {
    const scrap = State.scrap || 0;
    if (scrap < 5) { UI.showPopup('Not Enough Scrap', 'Need at least 5 scrap to sell.'); return; }
    const val = r2(scrap * 0.8);
    State.money = r2(State.money + val);
    State.stats.totalEarned = r2(State.stats.totalEarned + val);
    TaxSystem.accrue(val);
    UI.log(`♻️ Sold ${scrap} scrap for ${fmtEur(val)}`, 'money');
    State.scrap = 0;
    this._updatePill();
    this.renderPanel();
    UI.updateTopBar();
  },

  _updatePill() {
    const pill = document.getElementById('scrap-pill');
    const val  = document.getElementById('scrap-val');
    if (pill) pill.style.display = State.ownedUpgrades.includes('recycler') ? 'inline-flex' : 'none';
    if (val)  val.textContent    = State.scrap || 0;
  },

  renderPanel() {
    const panel = document.getElementById('recycle-panel'); if (!panel) return;
    if (!State.ownedUpgrades.includes('recycler')) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:20px">Buy the <strong>Filament Recycler</strong> upgrade to unlock this.</div>';
      return;
    }
    const scrap = State.scrap || 0;
    const filaments = ['PLA','PETG','PA6','TPU','RESIN'].filter(f => {
      if (f==='TPU'   && !State.tpuUnlocked)   return false;
      if (f==='RESIN' && !State.resinUnlocked) return false;
      return true;
    });
    panel.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px">
        <div style="font-size:32px">♻️</div>
        <div>
          <div style="font-family:var(--display);font-weight:900;font-size:28px;color:var(--accent3)">${scrap} scrap</div>
          <div style="font-size:11px;color:var(--text-dim)">15 scrap = 10 filament · or sell at €0.80/unit</div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Convert to Filament</div>
      ${filaments.map(f => `
        <button class="btn btn-ghost btn-sm btn-full" style="margin-bottom:4px;display:flex;justify-content:space-between" onclick="Recycling.convert('${f}')" ${scrap<15?'disabled':''}>
          <span class="tag tag-${f.toLowerCase()}">${f}</span>
          <span>15 scrap → 10 units</span>
          <span style="color:var(--accent)">Stock: ${State.filamentStock[f]||0}</span>
        </button>`).join('')}
      <button class="btn btn-warn btn-sm btn-full" style="margin-top:8px" onclick="Recycling.sell()" ${scrap<5?'disabled':''}>💰 Sell all scrap (${fmtEur(r2(scrap*0.8))})</button>`;
  },
};

// ── EMPLOYEE MORALE ───────────────────────────────────────
const Morale = {
  _t: 0,

  tick(dt) {
    if (!State.hiredEmployees || State.hiredEmployees.length === 0) return;
    this._t += dt;
    if (this._t < 30) return;
    this._t = 0;
    State.hiredEmployees.forEach(id => {
      State.morale = State.morale || {};
      if (State.morale[id] === undefined) State.morale[id] = 100;
      State.morale[id] = Math.max(0, State.morale[id] - 2);
      if (State.morale[id] === 30) {
        const emp = CONFIG.EMPLOYEES && CONFIG.EMPLOYEES.find(e => e.id === id);
        if (emp) UI.log(`😴 ${emp.name} morale low (30%)! Buy a Team Lunch to prevent slowdown.`, 'warn');
      }
    });
  },

  getEff(id) {
    const m = (State.morale || {})[id] ?? 100;
    return m >= 60 ? 1.0 : m >= 30 ? 0.80 : 0.55;
  },

  renderPanel() {
    const panel = document.getElementById('morale-panel'); if (!panel) return;
    if (!State.hiredEmployees || State.hiredEmployees.length === 0) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px">No employees hired yet.</div>';
      return;
    }
    panel.innerHTML = State.hiredEmployees.map(id => {
      const emp = CONFIG.EMPLOYEES && CONFIG.EMPLOYEES.find(e => e.id === id);
      const m = (State.morale || {})[id] ?? 100;
      const color = m >= 60 ? 'var(--accent3)' : m >= 30 ? 'var(--warn)' : 'var(--danger)';
      const eff = this.getEff(id);
      return `<div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px">
          <span>${emp ? emp.name : id}</span>
          <span style="color:${color}">${m}% morale · ${Math.round(eff*100)}% eff</span>
        </div>
        <div class="morale-bar"><div class="morale-fill" style="width:${m}%;background:${color}"></div></div>
      </div>`;
    }).join('');
  },

  buyLunch() {
    const cost = 80;
    if (State.money < cost) { UI.showPopup('Insufficient Funds', `Team Lunch costs €${cost}.`); return; }
    if (!State.hiredEmployees || State.hiredEmployees.length === 0) { UI.showPopup('No Staff', 'Hire employees first!'); return; }
    State.money = r2(State.money - cost);
    State.morale = State.morale || {};
    State.hiredEmployees.forEach(id => { State.morale[id] = 100; });
    State.stats.lunchesBought = (State.stats.lunchesBought || 0) + 1;
    UI.log(`🍕 Team Lunch! All staff morale restored to 100%.`, 'success');
    UI.updateTopBar();
    Achievements.check();
  },
};

// ── FRANCHISE SYSTEM ──────────────────────────────────────
const Franchise = {
  canUnlock() { return (State.prestige || 0) >= 2; },

  open(branchId) {
    const def = CONFIG.FRANCHISE_BRANCHES.find(b => b.id === branchId);
    if (!def) return;
    if (!this.canUnlock()) { UI.showPopup('Locked', 'Franchise unlocks after 2 Prestiges.'); return; }
    if (State.money < def.baseCost) { UI.showPopup('Insufficient Funds', `Costs ${fmtEur(def.baseCost)}.`); return; }
    if ((State.franchiseBranches || []).find(b => b.id === branchId)) { UI.showPopup('Already Open', 'This branch is already open.'); return; }
    State.money = r2(State.money - def.baseCost);
    State.franchiseBranches.push({ id: branchId, name: def.name, level: 1, incomePerMin: def.incomePerMin, upgradeCost: def.upgradeCost, _accum: 0 });
    Confetti.burst(40);
    UI.log(`🏭 ${def.name} opened! +€${def.incomePerMin}/min passive income.`, 'money');
    UI.updateTopBar(); this.render();
  },

  upgrade(branchId) {
    const branch = (State.franchiseBranches || []).find(b => b.id === branchId);
    const def    = CONFIG.FRANCHISE_BRANCHES.find(b => b.id === branchId);
    if (!branch || !def) return;
    if (branch.level >= def.maxLevel) { UI.showPopup('Max Level', 'Fully upgraded!'); return; }
    if (State.money < branch.upgradeCost) { UI.showPopup('Insufficient Funds', fmtEur(branch.upgradeCost)); return; }
    State.money = r2(State.money - branch.upgradeCost);
    branch.level++;
    branch.incomePerMin = Math.round(branch.incomePerMin * 1.6);
    branch.upgradeCost  = Math.round(branch.upgradeCost  * 2.2);
    UI.log(`🏭 ${branch.name} upgraded to Lv.${branch.level}! Now €${branch.incomePerMin}/min.`, 'money');
    UI.updateTopBar(); this.render();
  },

  tick(dt) {
    (State.franchiseBranches || []).forEach(b => {
      b._accum = (b._accum || 0) + dt;
      if (b._accum >= 60) {
        b._accum -= 60;
        State.money = r2(State.money + b.incomePerMin);
        State.stats.totalEarned = r2(State.stats.totalEarned + b.incomePerMin);
        State.stats_v10.franchiseEarned = r2((State.stats_v10.franchiseEarned||0) + b.incomePerMin);
        TaxSystem.accrue(b.incomePerMin);
      }
    });
  },

  render() {
    const panel = document.getElementById('franchise-panel'); if (!panel) return;
    if (!this.canUnlock()) {
      panel.innerHTML = `<div style="text-align:center;padding:28px;color:var(--text-dim)">
        <div style="font-size:40px;margin-bottom:8px">🏭</div>
        <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--accent2);margin-bottom:8px">Franchise Mode Locked</div>
        <div style="font-size:11px">Complete <strong style="color:var(--warn)">2 Prestiges</strong> to unlock.</div>
        <div style="margin-top:8px;color:var(--pro);font-family:var(--display);font-size:16px">Prestiges: ${State.prestige||0} / 2</div>
      </div>`; return;
    }
    let html = '';
    CONFIG.FRANCHISE_BRANCHES.forEach(def => {
      const branch = (State.franchiseBranches||[]).find(b=>b.id===def.id);
      if (branch) {
        const pct = Math.min(100, ((branch._accum||0)/60)*100);
        html += `<div class="franchise-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span>${def.icon} <span class="franchise-name">${branch.name}</span> <span style="font-size:11px;color:var(--text-dim)">Lv.${branch.level}</span></span>
            <span class="franchise-income">€${branch.incomePerMin}/min</span>
          </div>
          <div class="franchise-bar"><div class="franchise-fill" style="width:${pct}%"></div></div>
          ${branch.level < def.maxLevel
            ? `<button class="btn btn-primary btn-sm btn-full" style="margin-top:6px" onclick="Franchise.upgrade('${def.id}')">⬆ Upgrade Lv.${branch.level+1} — ${fmtEur(branch.upgradeCost)}</button>`
            : `<div style="color:var(--accent3);font-size:11px;text-align:center;margin-top:4px">✓ MAX LEVEL</div>`}
        </div>`;
      } else {
        html += `<div class="franchise-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <span>${def.icon} <span class="franchise-name">${def.name}</span></span>
            <span style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--warn)">${fmtEur(def.baseCost)}</span>
          </div>
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:6px">€${def.incomePerMin}/min passive · up to Lv.${def.maxLevel}</div>
          <button class="btn btn-warn btn-sm btn-full" onclick="Franchise.open('${def.id}')" ${State.money<def.baseCost?'disabled':''}>🏭 Open Branch</button>
        </div>`;
      }
    });
    const total = (State.franchiseBranches||[]).reduce((s,b)=>s+b.incomePerMin,0);
    if (total > 0) html += `<div style="margin-top:8px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);text-align:center">
      <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">Total Franchise Income</div>
      <div style="font-family:var(--display);font-weight:900;font-size:26px;color:var(--accent3)">€${total}/min</div></div>`;
    panel.innerHTML = html;
  },
};

// ── LEGACY PERKS ──────────────────────────────────────────
const LegacyPerks = {
  showPicker() {
    const overlay = document.getElementById('perk-select-overlay');
    const grid    = document.getElementById('perk-select-grid');
    if (!overlay || !grid) return;
    const available = CONFIG.LEGACY_PERKS.filter(p => !(State.legacyPerks||[]).includes(p.id));
    if (available.length === 0) { UI.showPopup('All Perks Owned', 'You have every legacy perk!'); return; }
    const choices = available.sort(()=>Math.random()-0.5).slice(0, Math.min(4, available.length));
    grid.innerHTML = choices.map(p => `
      <div class="perk-choice" onclick="LegacyPerks.choose('${p.id}')">
        <div class="perk-choice-icon">${p.icon}</div>
        <div class="perk-choice-name">${p.name}</div>
        <div class="perk-choice-desc">${p.desc}</div>
      </div>`).join('');
    overlay.classList.add('active');
  },

  choose(id) {
    const perk = CONFIG.LEGACY_PERKS.find(p => p.id === id); if (!perk) return;
    State.legacyPerks = State.legacyPerks || [];
    State.legacyPerks.push(id);
    perk.effect(State);
    const ov = document.getElementById('perk-select-overlay');
    if (ov) ov.classList.remove('active');
    Confetti.burst(80);
    UI.log(`⭐ Legacy Perk: ${perk.icon} ${perk.name} — ${perk.desc}`, 'success');
    const t = document.createElement('div');
    t.className = 'contract-toast';
    t.innerHTML = `<div style="font-size:11px;letter-spacing:2px;color:var(--pro)">⭐ LEGACY PERK</div>
      <div style="font-family:var(--display);font-weight:700;font-size:16px">${perk.icon} ${perk.name}</div>
      <div style="font-size:10px;color:var(--text-dim);margin-top:2px">${perk.desc}</div>`;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 6000);
    this.render();
  },

  reapply() {
    // Reset all perk-affected fields to base values before re-applying,
    // so repeated reapply() calls (e.g., on every reload) don't stack effects.
    const prestige = State.prestige || 0;
    State.speedMult      = 1.0;
    State.rewardMult     = 1.0;
    State.durabilityBonus= 0;
    State.repLegacyBonus = 0;
    State.taxRate        = State.hasAccountant ? 0.09 : 0.15;
    State.rivalBlocker   = 0;
    State.scrapBonus     = 0;
    State.surgeBonus     = 0;
    // Also re-apply research bonuses that mutate these fields, so they aren't lost
    if (State.completedResearch) {
      State.completedResearch.forEach(id => {
        const res = CONFIG.RESEARCH && CONFIG.RESEARCH.find(r => r.id === id);
        if (res && typeof res.apply === 'function') {
          try { res.apply(State); } catch(e) {}
        }
      });
    }
    // Now apply legacy perks on top
    (State.legacyPerks||[]).forEach(id => {
      const p = CONFIG.LEGACY_PERKS.find(p=>p.id===id);
      if (p) p.effect(State);
    });
  },

  render() {
    const panel = document.getElementById('legacy-panel'); if (!panel) return;
    const owned = State.legacyPerks || [];
    if (owned.length === 0 && (State.prestige||0) === 0) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:20px">Prestige once to earn your first Legacy Perk — a permanent bonus that survives all resets forever.</div>';
      return;
    }
    let html = '';
    if (owned.length > 0) {
      html += `<div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Active Legacy Perks (${owned.length})</div>`;
      owned.forEach(id => {
        const p = CONFIG.LEGACY_PERKS.find(p=>p.id===id); if (!p) return;
        html += `<div class="perk-card perk-owned"><div class="perk-icon">${p.icon}</div><div class="perk-name">${p.name}</div><div class="perk-desc">${p.desc}</div></div>`;
      });
    }
    html += `<div style="margin-top:10px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);font-size:10px;color:var(--text-dim);line-height:1.6">
      Each prestige, pick 1 perk from 4 random choices. They stack forever.<br><br>
      <strong style="color:var(--warn)">Earned: ${owned.length} / ${CONFIG.LEGACY_PERKS.length}</strong></div>`;
    panel.innerHTML = html;
  },
};

// ── HALL OF FAME ──────────────────────────────────────────
const HallOfFame = {
  KEY: 'pnp_hof_v2',

  load() { try { return JSON.parse(localStorage.getItem(this.KEY)||'[]'); } catch(e) { return []; } },
  save(e) { try { localStorage.setItem(this.KEY, JSON.stringify(e)); } catch(e){} },

  submit() {
    const score = Math.round(State.stats.totalEarned || 0);
    if (score < 50) return;
    const entries = this.load();
    entries.push({
      score, prestige: State.prestige||0,
      level: State.bizLevel, jobs: State.stats.jobsDone,
      perks: [...(State.legacyPerks||[])],
      date: new Date().toLocaleDateString(),
    });
    entries.sort((a,b)=>b.score-a.score);
    this.save(entries.slice(0,15));
  },

  render() {
    const panel = document.getElementById('hof-panel'); if (!panel) return;
    const entries = this.load();
    if (entries.length === 0) {
      panel.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:30px;font-size:11px">No records yet. Complete a prestige or reach €50 earned to appear here.</div>';
      return;
    }
    panel.innerHTML = entries.map((e,i) => {
      const rc   = i===0?'gold':i===1?'silver':i===2?'bronze':'';
      const icon = i===0?'🥇':i===1?'🥈':i===2?'🥉':`#${i+1}`;
      const perksHtml = (e.perks||[]).map(id => {
        const p = CONFIG.LEGACY_PERKS.find(p=>p.id===id);
        return p ? `<span class="hof-perk-tag">${p.icon} ${p.name}</span>` : '';
      }).join('');
      return `<div class="hof-entry">
        <div class="hof-rank ${rc}">${icon}</div>
        <div class="hof-info">
          <div class="hof-run-name">Prestige ${e.prestige} Run</div>
          <div class="hof-run-sub">Lv.${e.level} · ${e.jobs} jobs · ${e.date}</div>
          <div class="hof-perks">${perksHtml}</div>
        </div>
        <div class="hof-score">${fmtEur(e.score)}</div>
      </div>`;
    }).join('');
  },
};

// ── SUBSCRIPTION CLIENTS ──────────────────────────────────
const Subscriptions = {
  unlock() {
    if (State.subscriptionClients.length === 0) {
      CONFIG.SUBSCRIPTION_CLIENTS.slice(0,2).forEach(t =>
        State.subscriptionClients.push({ ...t, nextIn: t.intervalS, active: true })
      );
    }
    UI.log('📋 Subscription System active! Regular clients will auto-send repeat orders.', 'success');
    this.render();
  },

  tick(dt) {
    if (!State.ownedUpgrades.includes('subscription_sys')) return;
    if (State.subscriptionClients.length === 0) this.unlock();
    State.subscriptionClients.forEach(c => {
      if (!c.active) return;
      c.nextIn -= dt;
      if (c.nextIn <= 0) {
        c.nextIn = c.intervalS;
        this._spawn(c);
      }
    });
  },

  checkUnlockMore() {
    if (!State.ownedUpgrades.includes('subscription_sys')) return;
    const thresholds = [
      { rep: 60,  idx: 2 },
      { rep: 100, idx: 3 },
    ];
    thresholds.forEach(({ rep, idx }) => {
      const t = CONFIG.SUBSCRIPTION_CLIENTS[idx];
      if (!t) return;
      if (State.reputation >= rep && !State.subscriptionClients.find(c => c.name === t.name)) {
        State.subscriptionClients.push({ ...t, nextIn: t.intervalS, active: true });
        UI.log(`📋 New subscriber unlocked: ${t.name}!`, 'success');
        NewsTicker.addItem(`📋 Nieuwe abonnee: ${t.name} — ${t.filament} orders komen binnen!`);
        this.render();
      }
    });
  },

  _spawn(client) {
    if (State.orders.length >= CONFIG.MAX_ORDERS) return;
    const fil = CONFIG.FILAMENTS[client.filament];
    if (!fil) return;
    const reward = r2(fil.costPerJob * fil.profitMult * 3.5 * client.bonusMult * (1 + (State.prestige||0)*0.1));
    State.orders.push({
      id: Date.now()+Math.random(), name: `${client.name} (subscription)`,
      customer: client.name, filament: client.filament,
      quality: client.quality, reward,
      printTime: 20 + Math.floor(Math.random()*15),
      timeLeft: CONFIG.ORDER_EXPIRE_S * 1.6, expireTime: CONFIG.ORDER_EXPIRE_S * 1.6,
      xpReward: 12, urgent: false, orderType: 'subscription',
    });
    UI.log(`📋 ${client.name} sent a subscription order (${client.filament}) — ${fmtEur(reward)}`, 'info');
    UI.renderOrders();
  },

  render() {
    const panel = document.getElementById('subscription-panel'); if (!panel) return;
    if (!State.ownedUpgrades.includes('subscription_sys')) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:16px">Buy <strong>Subscription System</strong> in upgrades to get recurring client orders.</div>';
      return;
    }
    panel.innerHTML = (State.subscriptionClients||[]).map(c => `
      <div style="background:var(--bg3);border:1px solid rgba(0,229,255,0.2);border-radius:var(--radius);padding:10px 12px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-family:var(--display);font-weight:700">${c.name}</span>
          <span class="tag tag-subscription">📋 SUB</span>
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:3px">${c.filament} · ${c.quality} · ×${c.bonusMult} reward</div>
        <div style="font-size:11px;color:var(--accent);margin-top:2px">Next: ${Math.max(0,Math.round(c.nextIn))}s</div>
      </div>`).join('') || '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:16px">No subscription clients yet.</div>';
  },
};

// ── INSURANCE SYSTEM ──────────────────────────────────────
const Insurance = {
  PREMIUM: 50, INTERVAL: 180,

  tick(dt) {
    if (!State.hasInsurance) return;
    State.insuranceTimer = (State.insuranceTimer||0) + dt;
    if (State.insuranceTimer >= this.INTERVAL) {
      State.insuranceTimer -= this.INTERVAL;
      if (State.money >= this.PREMIUM) {
        State.money = r2(State.money - this.PREMIUM);
        UI.log(`🛡 Insurance premium: −€${this.PREMIUM}`, 'info');
      } else {
        State.hasInsurance = false;
        State.ownedUpgrades = (State.ownedUpgrades||[]).filter(id=>id!=='insurance');
        UI.log(`⚠ Insurance lapsed — couldn't pay premium!`, 'error');
      }
      UI.updateTopBar();
    }
  },

  cover(desc) {
    if (!State.hasInsurance) return false;
    State.stats_v10.insurancePayouts = (State.stats_v10.insurancePayouts||0)+1;
    UI.log(`🛡 Insurance covered: ${desc}!`, 'success');
    return true;
  },
};

// Mobile nav "More" menu
UI.buildMoreMenu = function(){
  const grid = document.getElementById('more-grid');
  const modal = document.getElementById('more-modal');
  if (!grid || !modal) return;

  // Collect unique tab buttons from main nav (exclude group labels + the More button)
  const tabs = Array.from(document.querySelectorAll('#main-nav .tab'))
    .filter(t => t.dataset && t.dataset.tab && t.dataset.tab !== 'more');

  grid.innerHTML = '';
  tabs.forEach(t=>{
    const id = t.dataset.tab;
    const label = t.textContent.trim();
    const btn = document.createElement('button');
    btn.className = 'more-btn';
    btn.type = 'button';
    btn.textContent = label;
    btn.addEventListener('click', ()=>{
      switchTab(id);
      UI.closeMore();
      // ensure the bottom nav scrolls to active tab if needed
      UI.scrollActiveTabIntoView();
    });
    grid.appendChild(btn);
  });
};

UI.openMore = function(){
  const modal = document.getElementById('more-modal');
  if (!modal) return;
  UI.buildMoreMenu(); // bouw/herbouw de grid elke keer zodat actieve staat klopt
  modal.classList.add('open');
};

UI.closeMore = function(evt){
  // evt optional; if click backdrop or Close, close
  const modal = document.getElementById('more-modal');
  if (!modal) return;
  modal.classList.remove('open');
};

UI.scrollActiveTabIntoView = function(){
  const nav = document.getElementById('main-nav');
  if (!nav) return;
  const active = nav.querySelector('.tab.active');
  if (active && nav.scrollTo){
    const left = active.offsetLeft - 24;
    nav.scrollTo({left, behavior:'smooth'});
  }
};

// Expose key modules for inline onclick handlers (const/let are not on window)
Object.assign(window, {
  Game, UI, Shop, Sound, Notifications, Tutorial, Speedrun, MiniGame, Skins, LootBox, Loans, Morale, Suppliers, Temperature,
  Expenses, Automation, PrinterFarm, Queue, Market,
  Research, Contracts, Inventory, Prestige,
  // NOTE: Bankruptcy is added below after its declaration to avoid TDZ error
});

// ── KLANTEN CHAT SYSTEEM ─────────────────────────────────────
const ClientChat = {
  _cooldown:    0,
  _active:      false,
  _current:     null,   // current conversation object
  _msgQueue:    [],     // messages to drip in
  _dripping:    false,

  // Customer personalities: avatar, name, tone
  CLIENTS: [
    { name:'MakerMike',       avatar:'👨‍🔧', tone:'chill'      },
    { name:'DIYQueen',        avatar:'👩‍💻', tone:'demanding'  },
    { name:'TechHobbyist99',  avatar:'🤓',   tone:'nerdy'      },
    { name:'StartupXYZ',      avatar:'💼',   tone:'corporate'  },
    { name:'ArtStudio7',      avatar:'🎨',   tone:'creative'   },
    { name:'EngineerJane',    avatar:'👩‍🔬', tone:'precise'    },
    { name:'LocalMakespace',  avatar:'🏭',   tone:'friendly'   },
    { name:'PrototypePete',   avatar:'🧪',   tone:'impatient'  },
  ],

  // Conversation scripts. Each has: client tone filter, messages (dripped in), then replies with effects
  CONVERSATIONS: [
    {
      id: 'late_complaint',
      minRep: 0, minJobs: 3, weight: 3,
      tones: ['demanding','impatient','corporate'],
      messages: [
        m => `Hoi, ${m.name} hier. Heb jij mijn bestelling al gedrukt?`,
        `Het had er gisteren al moeten zijn. Echt niet oké.`,
        `Ik wacht al uren. Wat is het probleem??`,
      ],
      replies: [
        { label: '😅 Sorry! Kleine vertraging, is zo klaar.', cls:'risky',
          effect: '+5 rep maar −€15 korting beloofd',
          apply(s){ s.reputation = Math.min(CONFIG.MAX_REP, s.reputation+5); s.money = r2(s.money-15); ClientChat._followUp(`Oke, ik vergeef je. Maar geef me wel korting. 🙄`, 'them'); } },
        { label: '📦 Ligt al klaar bij de balie, mijn fout!', cls:'good',
          effect: '+8 rep — leugen die werkt',
          apply(s){ s.reputation = Math.min(CONFIG.MAX_REP, s.reputation+8); ClientChat._followUp(`Oh! Oké dan, ik kom zo langs. Dank je! 😊`, 'them'); } },
        { label: '🔥 Dan zoek je maar iemand anders.', cls:'bad',
          effect: '−10 rep — eerlijk maar duur',
          apply(s){ s.reputation = Math.max(0, s.reputation-10); ClientChat._followUp(`WOW. Geloof het niet. Negatieve review komt eraan. 👋`, 'them'); } },
      ]
    },
    {
      id: 'upsell_request',
      minRep: 10, minJobs: 5, weight: 3,
      tones: ['creative','friendly','nerdy'],
      messages: [
        m => `Hey! Ik heb een vraag over mijn volgend project...`,
        `Kan ik upgraden naar CF filament? Ik heb zoiets nooit geprobeerd maar het klinkt gaaf`,
        `Kost het veel meer? 😬`,
      ],
      replies: [
        { label: '⭐ Absoluut! CF is €30 extra, veel sterker.', cls:'good',
          effect: '+€30 en +6 rep',
          apply(s){ s.money = r2(s.money+30); s.reputation = Math.min(CONFIG.MAX_REP, s.reputation+6); ClientChat._followUp(`Deal! Upgrade maar. Dit wordt zo cool 😄`, 'them'); } },
        { label: '🤔 Alleen als je printer het aankan. Risico bestaat.', cls:'risky',
          effect: '50/50: +€30 of klant haakt af',
          apply(s){ if(Math.random()<0.5){ s.money=r2(s.money+30); ClientChat._followUp(`Goed punt... maar ik ga het risico aan! Doe maar! 💪`, 'them'); } else { ClientChat._followUp(`Hmm, ik hou het toch maar bij PETG. Dankjewel voor je eerlijkheid!`, 'them'); } } },
        { label: '😊 PLA werkt net zo goed voor jouw project.', cls:'risky',
          effect: '+4 rep door eerlijk advies',
          apply(s){ s.reputation = Math.min(CONFIG.MAX_REP, s.reputation+4); ClientChat._followUp(`Haha oké, dan niet. Je hebt gelijk waarschijnlijk 😅`, 'them'); } },
      ]
    },
    {
      id: 'bulk_deal',
      minRep: 20, minJobs: 8, weight: 2,
      tones: ['corporate','demanding','friendly'],
      messages: [
        m => `${m.name} van ${m.org}. We hebben een bulk-project.`,
        `50 onderdelen, allemaal PETG, identiek model. Kunnen jullie dat aan?`,
        `We betalen direct, maar willen 15% korting op batch-orders.`,
      ],
      replies: [
        { label: '✅ Deal! 15% korting, we starten morgen.', cls:'good',
          effect: '+€180 en +10 rep (korting al verrekend)',
          apply(s){ s.money=r2(s.money+180); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+10); ClientChat._followUp(`Top! Stuur ons het bestandje maar. We rekenen morgen af. 👍`, 'them'); } },
        { label: '💬 10% korting, meer kan ik niet doen.', cls:'risky',
          effect: '60% kans op deal (+€210), 40% ze gaan elders',
          apply(s){ if(Math.random()<0.6){ s.money=r2(s.money+210); ClientChat._followUp(`Hmm, akkoord. We doen het! Stuur maar een offerte.`, 'them'); } else { ClientChat._followUp(`Jammer. PrintFox doet het voor 20% korting. Succes nog! 👋`, 'them'); Rival._maybeSteal && (State.rivalScore = (State.rivalScore||0)+2); } } },
        { label: '❌ Geen korting — onze kwaliteit is de prijs waard.', cls:'bad',
          effect: '−5 rep maar je margins blijven intact',
          apply(s){ s.reputation=Math.max(0,s.reputation-5); ClientChat._followUp(`Dat is jammer. We gaan kijken bij de concurrent dan.`, 'them'); } },
      ]
    },
    {
      id: 'quality_complaint',
      minRep: 0, minJobs: 6, weight: 3,
      tones: ['precise','demanding','corporate','nerdy'],
      messages: [
        m => `Ik heb mijn print ontvangen maar er zijn problemen.`,
        `De layerlijnen zijn zichtbaar en er zit een kleine warp aan de onderkant.`,
        `Dit is onder mijn verwachting. Wat gaan jullie hieraan doen?`,
      ],
      replies: [
        { label: '🔁 Gratis herdruk! We sturen het vandaag nog.', cls:'good',
          effect: '−€25 kosten maar +12 rep',
          apply(s){ s.money=r2(s.money-25); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+12); ClientChat._followUp(`Dat stel ik zeer op prijs. Klasse klantenservice! ⭐⭐⭐⭐⭐`, 'them'); } },
        { label: '📸 Stuur foto\'s, dan beoordelen we het.', cls:'risky',
          effect: '70% kans op redelijke oplossing (+5 rep), anders −8 rep',
          apply(s){ if(Math.random()<0.7){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+5); ClientChat._followUp(`Oké, foto's verstuurd. Ik hoor graag van jullie! 📸`, 'them'); } else { s.reputation=Math.max(0,s.reputation-8); ClientChat._followUp(`Dit is te lang wachten op een reactie. Ik post mijn review.`, 'them'); } } },
        { label: '😤 Warp is normaal bij PETG zonder enclosure.', cls:'bad',
          effect: '−15 rep — technisch juist, sociaal desastreus',
          apply(s){ s.reputation=Math.max(0,s.reputation-15); ClientChat._followUp(`Ongelooflijk. Ik verwacht een professionele service en krijg excuses. Dag! 🖕`, 'them'); Particles.shake(); } },
      ]
    },
    {
      id: 'weird_request',
      minRep: 5, minJobs: 4, weight: 2,
      tones: ['creative','chill','nerdy'],
      messages: [
        m => `Heyy! Heb een vraagje dat misschien raar klinkt 😅`,
        `Kan je een levensgrote dinosaurus hoofd printen? Voor een verjaardagsfeest`,
        `Hij moet GLOEIEN 🦕✨`,
      ],
      replies: [
        { label: '🦕 YEP! Glow filament, 3 dagen, €220.', cls:'good',
          effect: '+€220 en +8 rep (unieke order!)',
          apply(s){ if(s.glowUnlocked){ s.money=r2(s.money+220); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+8); ClientChat._followUp(`YESSS!! Ik ben zo blij!! 🥳🦕 wanneer kan ik betalen?`, 'them'); } else { s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+4); ClientChat._followUp(`Oh... oké jammer. Ik zoek verder! Maar bedankt! 😊`, 'them'); } } },
        { label: '🤔 Kan, maar kost meer: €350 voor zo\'n formaat.', cls:'risky',
          effect: '45% kans op deal, 55% te duur',
          apply(s){ if(Math.random()<0.45){ s.money=r2(s.money+350); ClientChat._followUp(`Doe maar!! Mijn vriend gaat flip gaan. 🎉`, 'them'); } else { ClientChat._followUp(`Ooof dat is een lot. Ik vraag het thuis maar... zal wel nee zijn lol`, 'them'); } } },
        { label: '😂 Sorry, dat gaat onze printer te boven.', cls:'risky',
          effect: '+3 rep voor eerlijkheid',
          apply(s){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+3); ClientChat._followUp(`Haha oké begrijpelijk! Misschien gewoon een kleine dan? 😅`, 'them'); } },
      ]
    },
    {
      id: 'loyalty_bonus',
      minRep: 30, minJobs: 15, weight: 2,
      tones: ['friendly','chill','creative'],
      messages: [
        m => `Hey, ik ben al een tijdje klant bij jullie! ❤️`,
        `Hebben jullie iets voor trouwe klanten? Korting of zo?`,
        `Ik bestel zo'n 3 keer per maand bij jullie 😊`,
      ],
      replies: [
        { label: '🎁 10% loyaliteitskorting voor jou!', cls:'good',
          effect: '−€20 eenmalig maar +15 rep en herhalingsorder',
          apply(s){ s.money=r2(s.money-20); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+15); ClientChat._followUp(`Wow!! Super lief! Ik bestel meteen iets nieuws! 🥹`, 'them'); } },
        { label: '⭐ VIP status! Jij krijgt prioriteit voortaan.', cls:'good',
          effect: '+12 rep (geen kosten, maar commitment)',
          apply(s){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+12); ClientChat._followUp(`Echt?! Dat is zo gaaf! Ik vertel mijn vrienden over jullie! ✨`, 'them'); } },
        { label: '😅 We doen geen kortingen standaard, sorry.', cls:'bad',
          effect: '−5 rep',
          apply(s){ s.reputation=Math.max(0,s.reputation-5); ClientChat._followUp(`Oh... oké. Beetje teleurstellend eerlijk gezegd.`, 'them'); } },
      ]
    },
    {
      id: 'rush_order',
      minRep: 0, minJobs: 2, weight: 3,
      tones: ['impatient','corporate','demanding'],
      messages: [
        m => `URGENT. Ik heb een print nodig voor vanavond 21:00.`,
        `Het is voor een presentatie morgenochtend. Levensbelangrijk.`,
        `Ik betaal extra. Hoeveel?`,
      ],
      replies: [
        { label: '⚡ +€60 voor spoedservice. Deal?', cls:'good',
          effect: '+€60 en +6 rep',
          apply(s){ s.money=r2(s.money+60); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+6); ClientChat._followUp(`DEAL. Maak het af. Ik kom het ophalen. Dankjewel!! 🙏`, 'them'); } },
        { label: '🙏 We doen ons best, geen garantie.', cls:'risky',
          effect: '+€30 maar 50/50 of het lukt (rep impact)',
          apply(s){ s.money=r2(s.money+30); if(Math.random()<0.5){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+8); ClientChat._followUp(`Gelukt!! Je bent een ster! ⭐⭐⭐`, 'them'); } else { s.reputation=Math.max(0,s.reputation-8); ClientChat._followUp(`Het is nu 20:55 en niets ontvangen. Ik bel je advocaat.`, 'them'); } } },
        { label: '❌ Sorry, volle planning vanavond.', cls:'risky',
          effect: 'Geen impact maar geen geld',
          apply(s){ ClientChat._followUp(`Oké begrijpelijk. Dan zoek ik iemand anders. Bedankt toch.`, 'them'); } },
      ]
    },
    {
      id: 'referral',
      minRep: 40, minJobs: 20, weight: 2,
      tones: ['friendly','chill','creative','nerdy'],
      messages: [
        m => `Hoi! Ik heb jullie aanbevolen bij mijn collega's.`,
        `Ze zijn onder de indruk van de kwaliteit! Iedereen is enthousiast.`,
        `Je kunt zo'n 5-6 nieuwe klanten verwachten 😄`,
      ],
      replies: [
        { label: '🎉 Super! Ik stuur jou gratis credits!', cls:'good',
          effect: '+20 rep en je geeft €40 cadeau (winstgevend!)',
          apply(s){ s.money=r2(s.money-40); s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+20); ClientChat._followUp(`Wow!! Zo onverwacht! Dankjewel! Ik kom snel iets nieuws printen! 💛`, 'them'); Confetti && Confetti.burst(40); } },
        { label: '🙌 Geweldig! Ik ben blij dat ze tevreden zijn.', cls:'good',
          effect: '+12 rep, geen kosten',
          apply(s){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+12); ClientChat._followUp(`😊 Houd het zo! Ze nemen zelf binnenkort contact op!`, 'them'); } },
        { label: '📊 Kunnen ze een offerte aanvragen op de site?', cls:'risky',
          effect: '+4 rep maar beetje koud antwoord',
          apply(s){ s.reputation=Math.min(CONFIG.MAX_REP,s.reputation+4); ClientChat._followUp(`Uhh ja... zal ik doorgeven. Succes? 😅`, 'them'); } },
      ]
    },
  ],

  // Public: tick each second to maybe trigger a chat
  tick(dt) {
    if (this._cooldown > 0) { this._cooldown = Math.max(0, this._cooldown - dt); return; }
    if (this._active) return;
    if (State.stats.jobsDone < 2) return;
    if (Math.random() > 0.004 * dt) return; // ~once per 250s average

    // Don't spawn if any overlay is open
    if (document.getElementById('popup-overlay')?.classList.contains('visible')) return;
    if (document.getElementById('narrative-overlay')?.classList.contains('active')) return;
    if (document.getElementById('minigame-overlay')?.classList.contains('active')) return;

    this._trigger();
  },

  _trigger() {
    // Pick eligible conversations
    const eligible = this.CONVERSATIONS.filter(c =>
      State.reputation >= c.minRep &&
      State.stats.jobsDone >= c.minJobs
    );
    if (eligible.length === 0) return;

    // Weighted pick
    const totalW = eligible.reduce((s,c) => s + (c.weight||1), 0);
    let rnd = Math.random() * totalW;
    let conv = eligible[0];
    for (const c of eligible) { rnd -= (c.weight||1); if (rnd <= 0) { conv = c; break; } }

    // Pick a matching client
    const matching = this.CLIENTS.filter(cl => conv.tones.includes(cl.tone));
    const client = matching.length ? matching[Math.floor(Math.random() * matching.length)] : this.CLIENTS[0];
    client.org = CONFIG.CONTRACT_CUSTOMERS[Math.floor(Math.random() * CONFIG.CONTRACT_CUSTOMERS.length)];

    this._active = true;
    this._current = { conv, client };
    this._msgQueue = [];
    this._dripping = false;

    // Set up header
    document.getElementById('chat-avatar').textContent  = client.avatar;
    document.getElementById('chat-sender').textContent  = client.name;
    document.getElementById('chat-messages').innerHTML  = '';
    document.getElementById('chat-replies').innerHTML   = '';

    // Queue messages (no delay property needed — drip handles timing)
    const msgs = conv.messages;
    msgs.forEach(m => {
      this._msgQueue.push({ text: typeof m === 'function' ? m(client) : m });
    });
    this._msgQueue.push({ showReplies: true });

    // Show notification
    const notif = document.getElementById('chat-notification');
    notif.classList.add('visible');

    // Start drip with short initial delay
    setTimeout(() => this._drip(), 400);

    Sound.click && Sound.click();
    UI.log(`💬 Bericht van ${client.name}`, 'info');
  },

  _drip() {
    if (!this._msgQueue.length || !this._active) return;
    const item = this._msgQueue.shift();

    if (item.showReplies) {
      this._showReplies();
      return;
    }

    this._addMsg(item.text, 'them');
    if (!this._msgQueue.length) return;

    const next = this._msgQueue[0];
    if (next.showReplies) {
      // Just show replies after a brief pause
      setTimeout(() => this._drip(), 600);
    } else {
      // Show typing dots then next message
      setTimeout(() => {
        if (!this._active) return;
        this._showTyping();
        setTimeout(() => {
          if (!this._active) return;
          this._removeTyping();
          this._drip();
        }, 1100);
      }, 300);
    }
  },

  _addMsg(text, who) {
    const msgs = document.getElementById('chat-messages');
    if (!msgs) return;
    const div = document.createElement('div');
    div.className = `chat-msg ${who}`;
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  },

  _showTyping() {
    const msgs = document.getElementById('chat-messages');
    if (!msgs) return;
    const div = document.createElement('div');
    div.className = 'chat-msg typing'; div.id = 'chat-typing';
    div.innerHTML = '<div class="chat-typing-dots"><span></span><span></span><span></span></div>';
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  },

  _removeTyping() {
    document.getElementById('chat-typing')?.remove();
  },

  _showReplies() {
    const repliesEl = document.getElementById('chat-replies');
    if (!repliesEl || !this._current) return;
    const { conv } = this._current;
    repliesEl.innerHTML = conv.replies.map((r, i) =>
      `<button class="chat-reply-btn ${r.cls}" onclick="ClientChat.reply(${i})" title="${r.effect}">${r.label}</button>`
    ).join('');
    repliesEl.style.opacity = '0';
    requestAnimationFrame(() => {
      repliesEl.style.transition = 'opacity 0.25s ease';
      repliesEl.style.opacity = '1';
    });
  },

  _dismissTimer: null,

  reply(idx) {
    const conv = this._current?.conv;
    if (!conv) return;
    const r = conv.replies[idx];
    if (!r) return;

    // Show my reply bubble (strip leading emoji for clean text)
    const cleanLabel = r.label.replace(/^\S+\s/, '').trim() || r.label;
    this._addMsg(cleanLabel, 'me');
    document.getElementById('chat-replies').innerHTML = '';

    // Apply effect
    setTimeout(() => {
      try { r.apply(State); } catch(e) { console.warn('Chat reply error', e); }
      UI.updateTopBar();
      UI.renderPrinters();
    }, 350);

    // Auto-close after follow-up
    clearTimeout(this._dismissTimer);
    this._dismissTimer = setTimeout(() => this.dismiss(), 5500);
    this._cooldown = 120 + Math.random() * 180;
  },

  _followUp(text, who) {
    setTimeout(() => {
      if (!this._active) return;
      this._showTyping();
      setTimeout(() => {
        if (!this._active) return;
        this._removeTyping();
        this._addMsg(text, who);
      }, 900);
    }, 500);
  },

  dismiss() {
    clearTimeout(this._dismissTimer);
    const notif = document.getElementById('chat-notification');
    notif?.classList.remove('visible');
    this._active = false;
    this._current = null;
    this._msgQueue = [];
    if (!this._cooldown) this._cooldown = 60;
  },

  expand() {
    const msgs = document.getElementById('chat-messages');
    if (msgs) msgs.scrollTop = msgs.scrollHeight;
  },
};

// ── BANKRUPTCY SYSTEM ────────────────────────────────────────
const Bankruptcy = {
  WARN_AT:     -10000,  // toon banner
  GAMEOVER_AT: -15000,  // game over
  _triggered:  false,
  _gameoverShown: false,
  _emergencyUsed: false,

  tick() {
    if (this._gameoverShown) return;
    const m = State.money;
    const banner = document.getElementById('bankruptcy-banner');
    const amountEl = document.getElementById('bankruptcy-amount');

    if (m <= this.GAMEOVER_AT) {
      this._triggerGameOver();
      return;
    }

    if (m <= this.WARN_AT) {
      if (banner) banner.classList.add('visible');
      if (amountEl) amountEl.textContent = fmtEur(Math.abs(m));
      if (!this._triggered) {
        this._triggered = true;
        Sound.error && Sound.error();
        UI.log(`🚨 WAARSCHUWING: Schuld van ${fmtEur(Math.abs(m))}! Game over bij −€15.000!`, 'error');
        NewsTicker.addItem(`🚨 FAILLISSEMENT DREIGT: ${fmtEur(Math.abs(m))} schuld — acteer NU!`);
        UI.showPopup('🚨 Faillissementswaarschuwing!',
          `<div style="text-align:center">
            <div style="font-size:32px;margin-bottom:8px">💸</div>
            <strong style="color:var(--danger);font-family:var(--display);font-size:18px">Schuld: ${fmtEur(Math.abs(m))}</strong><br><br>
            Je printshop heeft ernstige financiële problemen.<br>
            <strong style="color:var(--warn)">Game Over bij −€15.000!</strong><br><br>
            Accepteer snel orders, neem een noodlening, of verlaag kosten.
          </div>`);
      }
    } else {
      if (banner) banner.classList.remove('visible');
      if (m > -500) this._triggered = false; // reset warning when recovered
    }
  },

  _triggerGameOver() {
    if (this._gameoverShown) return;
    this._gameoverShown = true;
    // Stop the game and ALL timers
    clearInterval(Game._tickTimer);
    clearInterval(Game._eventTimer);
    clearInterval(Game._autoSaveTimer);
    Game._tickTimer = null;
    Game._eventTimer = null;
    Game._autoSaveTimer = null;
    // Wis de save DIRECT zodat herstart altijd met schone staat begint
    try { localStorage.removeItem('pnp_save'); } catch(e) {}
    // Hide pause overlay if open
    const pause = document.getElementById('pause-overlay');
    if (pause) pause.classList.remove('visible');
    // Fill in stats
    const el = (id) => document.getElementById(id);
    if (el('go-debt'))   el('go-debt').textContent   = fmtEur(State.money);
    if (el('go-earned')) el('go-earned').textContent  = fmtEur(State.stats?.totalEarned || 0);
    if (el('go-jobs'))   el('go-jobs').textContent    = State.stats?.jobsDone || 0;
    if (el('go-rep'))    el('go-rep').textContent     = `★ ${Math.round(State.reputation || 0)}`;
    if (el('go-level'))  el('go-level').textContent   = State.bizLevel || 1;
    // Show overlay
    const overlay = document.getElementById('gameover-overlay');
    if (overlay) overlay.classList.add('visible');
    // Log & ticker
    UI.log('💀 FAILLIET — Je hebt €15.000 schuld. Game Over!', 'error');
    NewsTicker.addItem('💀 FAILLIET! De printshop is gesloten na te veel schulden.');
  },

  restart() {
    this._gameoverShown = false;
    this._triggered = false;
    this._emergencyUsed = false;
    const overlay = document.getElementById('gameover-overlay');
    if (overlay) overlay.classList.remove('visible');
    const banner = document.getElementById('bankruptcy-banner');
    if (banner) banner.classList.remove('visible');
    // Wis save direct (geen confirm nodig — speler kiest bewust voor herstart)
    try { localStorage.removeItem('pnp_save'); } catch(e) {}
    location.reload();
  },

  emergencyLoan() {
    if (this._emergencyUsed) {
      UI.showPopup('Noodlening', 'Je hebt de noodlening al gebruikt. Geen verdere hulp beschikbaar — herstart het spel.');
      return;
    }
    this._emergencyUsed = true;
    this._gameoverShown = false;
    this._triggered = false;
    const overlay = document.getElementById('gameover-overlay');
    if (overlay) overlay.classList.remove('visible');
    // Give emergency funds and restart timers
    State.money = 2000;
    // Bug fix: clear existing loans so debt doesn't immediately eat the emergency funds
    State.activeLoans = [];
    State.totalDebt = 0;
    Loans._updateDebtUI();
    State.reputation = Math.max(0, State.reputation - 20);
    UI.log('🆘 Noodlening van €2.000 ontvangen! −20 Reputatie. Gebruik dit verstandig!', 'warn');
    NewsTicker.addItem('🆘 NOODLENING: De bank heeft een eenmalige redding van €2.000 goedgekeurd!');
    // Restart timers
    clearInterval(Game._tickTimer);
    clearInterval(Game._eventTimer);
    clearInterval(Game._autoSaveTimer);
    Game.lastTick = Date.now();
    Game._tickTimer  = setInterval(()=>Game.tick(), CONFIG.TICK_MS);
    Game._eventTimer = setInterval(()=>Game._maybeEvent(), 1000);
    Game._autoSaveTimer = setInterval(()=>{ if (!Game.paused) Game.saveGame(); }, 30000);
    UI.updateTopBar();
    UI.showPopup('🆘 Noodlening Goedgekeurd', `De bank heeft eenmalig €2.000 geleend.<br><br>⚠️ <strong style="color:var(--danger)">Dit is je LAATSTE kans.</strong> Herstel de financiën of je bedrijf wordt gesloten.`);
  },
};

// v17.5 fix: expose Bankruptcy AFTER its declaration to avoid TDZ crash
window.Bankruptcy = Bankruptcy;

window.addEventListener('DOMContentLoaded', ()=>{ Game.init(); UI.buildMoreMenu(); UI.scrollActiveTabIntoView(); });

// ── REFRESH WAARSCHUWING ──
window.addEventListener('beforeunload', (e) => {
  // Sla eerst op (maar niet als we aan het resetten zijn)
  if (window.Game && !Game._resetting) Game.saveGame();
  // Waarschuw de gebruiker
  const msg = 'Wil je de pagina echt verlaten? Je voortgang wordt opgeslagen, maar actieve prints gaan verloren.';
  e.preventDefault();
  e.returnValue = msg;
  return msg;
});

// ── AUTO-PAUSE BIJ INACTIVITEIT (30s) + WELKOM TERUG ──────────
(function() {
  const IDLE_TIMEOUT   = 30_000; // 30 seconden
  const RING_CIRCUMFERENCE = 2 * Math.PI * 21; // r=21 → ≈ 131.9
  let _idleTimer       = null;
  let _idleRafId       = null;
  let _idleStartTime   = null;
  let _idlePausedByUs  = false;

  const _pauseBtn  = () => document.getElementById('pause-btn');
  const _ringCircle = () => document.getElementById('idle-ring-circle');

  function _startRing() {
    _idleStartTime = Date.now();
    const btn = _pauseBtn();
    if (btn) btn.classList.add('idle-counting');
    _animateRing();
  }

  function _stopRing() {
    cancelAnimationFrame(_idleRafId);
    _idleStartTime = null;
    const btn = _pauseBtn();
    if (btn) btn.classList.remove('idle-counting');
    const circle = _ringCircle();
    if (circle) { circle.style.strokeDashoffset = RING_CIRCUMFERENCE; circle.style.opacity = '0'; }
  }

  function _animateRing() {
    if (!_idleStartTime) return;
    const elapsed  = Date.now() - _idleStartTime;
    const progress = Math.min(elapsed / IDLE_TIMEOUT, 1); // 0 → 1
    const offset   = RING_CIRCUMFERENCE * (1 - progress);
    const circle   = _ringCircle();
    if (circle) {
      circle.style.transition = 'none';
      circle.style.strokeDasharray  = RING_CIRCUMFERENCE;
      circle.style.strokeDashoffset = offset;
      circle.style.opacity = progress > 0.05 ? '1' : '0';
    }
    if (progress < 1) {
      _idleRafId = requestAnimationFrame(_animateRing);
    }
  }

  function _resetIdleTimer() {
    clearTimeout(_idleTimer);
    _stopRing();
    if (window.Game && !Game.paused) {
      _idleTimer = setTimeout(_onIdle, IDLE_TIMEOUT);
      _startRing();
    }
  }

  function _onIdle() {
    _stopRing();
    if (!window.Game || Game.paused) return;
    _idlePausedByUs = true;
    Game.togglePause();
    const sub = document.getElementById('pause-overlay-sub');
    if (sub) sub.textContent = '😴 Automatisch gepauzeerd na 30s inactiviteit';
  }

  // Luister naar alle relevante gebruikersacties
  const EVENTS = ['touchstart', 'touchend', 'pointerdown', 'click', 'scroll', 'mousemove', 'keydown'];
  EVENTS.forEach(evt =>
    document.addEventListener(evt, _resetIdleTimer, { passive: true, capture: true })
  );

  // ── VISIBILITYCHANGE: scherm uitzetten / app naar achtergrond ──
  document.addEventListener('visibilitychange', () => {
    if (!window.Game) return;

    if (document.hidden) {
      clearTimeout(_idleTimer);
      _stopRing();
      // Sla NIET op als game over actief is of als we aan het resetten zijn
      if ((!window.Bankruptcy || !Bankruptcy._gameoverShown) && !Game._resetting) {
        Game.saveGame();
      }
      if (!Game.paused) {
        _idlePausedByUs = true;
        Game.togglePause();
        const sub = document.getElementById('pause-overlay-sub');
        if (sub) sub.textContent = '📱 Automatisch gepauzeerd — spel opgeslagen';
      }
    } else {
      // Teruggekomen
      if (window.Game && !Game.paused) {
        _resetIdleTimer();
      }
    }
  });

  // Start aftelling zodra spel geladen is
  window.addEventListener('load', () => setTimeout(_resetIdleTimer, 1500));
})();

// Resize graph on window resize
window.addEventListener('resize', ()=>{ UI.renderGraphCanvas(); });

// ── Responsive canvas resize hooks (mobile/orientation)
(function(){
  const c = document.getElementById('print-canvas');
  if(!c) return;
  const _resize = () => {
    try{
      if (window.PrintCanvas && typeof PrintCanvas.resize === 'function') {
        PrintCanvas.resize();
      } else if (window.printCanvas && typeof window.printCanvas.resize === 'function') {
        window.printCanvas.resize();
      } else if (typeof resizeCanvas === 'function') {
        resizeCanvas(c);
      }
    }catch(e){}
  };
  window.addEventListener('resize', _resize, {passive:true});
  window.addEventListener('orientationchange', _resize, {passive:true});
  setTimeout(_resize, 50);
})();

// ── Layout: MOBILE-ONLY (TikTok vertical) ──
(function(){
  try{
    // Always force the mobile app layout, regardless of saved preference
    document.body.classList.remove("layout-desktop");
    document.body.classList.add("layout-mobile");

    // Keep localStorage aligned (so legacy code / older builds won't flip it back)
    
  }catch(e){}
})();
</script>
<!-- Mobile 'More' menu -->
<div class="more-modal" id="more-modal"
     onclick="(typeof UI !== 'undefined' && UI.closeMore) ? UI.closeMore(event) : null">
<div class="more-sheet" onclick="event.stopPropagation()">
<div class="more-sheet-header">
<div class="more-sheet-title">MENU</div>
<button class="btn" onclick="UI.closeMore()">Close</button>
</div>
<div class="more-sheet-body">
<div class="more-grid" id="more-grid"></div>
</div>
</div>
</div>
<!-- Pause Overlay (Mobile Optimized) -->
<div id="pause-overlay" onclick="Game.togglePause()">
  <div class="pause-overlay-title" id="pause-overlay-title">⏸ GEPAUZEERD</div>

  <div class="pause-overlay-sub" id="pause-overlay-sub">
    Tik om te hervatten
  </div>

  <button class="btn btn-primary"
          style="margin-top:16px;min-height:56px;font-size:15px;padding:14px 32px;letter-spacing:1px"
          onclick="event.stopPropagation(); Game.togglePause();">
    ▶ &nbsp;Verder spelen
  </button>

  <div class="pause-overlay-saved" id="pause-saved-msg">
    ✅ Voortgang opgeslagen
  </div>
</div>

<!-- ── KLANTEN CHAT NOTIFICATIE ── -->
<div id="chat-notification">
  <div class="chat-notif-header" onclick="ClientChat.expand()">
    <div class="chat-notif-avatar" id="chat-avatar">👤</div>
    <div class="chat-notif-name" id="chat-sender">Klant</div>
    <div class="chat-notif-close" onclick="event.stopPropagation();ClientChat.dismiss()">×</div>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-replies" id="chat-replies"></div>
</div>

<!-- Bankruptcy Warning Banner -->
<div id="bankruptcy-banner">
  ⚠️ FAILLISSEMENT NADERT — Schuld: <span id="bankruptcy-amount">€0</span> &nbsp;|&nbsp; Game over bij −€15.000 &nbsp;|&nbsp;
  <span onclick="switchTab('loans')" style="cursor:pointer;text-decoration:underline;color:#fff">Neem een noodlening →</span>
</div>

<!-- Game Over Overlay -->
<div id="gameover-overlay">
  <div class="gameover-title">💀 FAILLIET</div>
  <div class="gameover-amount">Schuld: <span id="go-debt">−€15.000</span></div>
  <div class="gameover-sub">Je printshop is financieel ingestort.<br>Schulden zijn te hoog opgelopen om te overleven.</div>
  <div class="gameover-stats">
    <div class="gameover-stat">
      <div class="gameover-stat-label">Totaal verdiend</div>
      <div class="gameover-stat-value" id="go-earned">€0</div>
    </div>
    <div class="gameover-stat">
      <div class="gameover-stat-label">Jobs voltooid</div>
      <div class="gameover-stat-value" id="go-jobs">0</div>
    </div>
    <div class="gameover-stat">
      <div class="gameover-stat-label">Reputatie</div>
      <div class="gameover-stat-value" id="go-rep">0</div>
    </div>
    <div class="gameover-stat">
      <div class="gameover-stat-label">Level bereikt</div>
      <div class="gameover-stat-value" id="go-level">1</div>
    </div>
  </div>
  <div class="gameover-actions">
    <button class="btn btn-danger" onclick="Bankruptcy.restart()" style="font-size:14px;padding:12px 28px;">↺ Opnieuw beginnen</button>
    <button class="btn btn-ghost" onclick="Bankruptcy.emergencyLoan()" style="font-size:14px;padding:12px 28px;">🆘 Noodlening (eenmalig)</button>
  </div>
  <div style="font-size:11px;color:var(--text-dim);margin-top:8px;letter-spacing:1px">TIP: Houd je kosten laag en accepteer orders sneller om schulden te vermijden</div>
</div>
</body>
</html>
